---
title: "ä»é›¶å¼€å§‹ç¼–å†™æ™ºèƒ½åˆçº¦-æ‰‹å·¥æ‰“é€ "
date: 2022-07-01
draft: false
author: yinhui
categories: [BlockChain]
tags: [solidity,  ethereum, go-ethereum, python] 
---

å‰é¢åœ¨ [ä»é›¶å¼€å§‹ç¼–å†™æ™ºèƒ½åˆçº¦-ä½¿ç”¨traffleå¥—ä»¶](https://yinhui1984.github.io/ä»é›¶å¼€å§‹ç¼–å†™æ™ºèƒ½åˆçº¦-ä½¿ç”¨traffleå¥—ä»¶/) ä¸­ ä½¿ç”¨ `truffle`å¥—ä»¶ä»é›¶å¼€å§‹æ­å»ºç¯å¢ƒ, ç¼–å†™ã€éƒ¨ç½²ã€æµ‹è¯•å’Œè°ƒç”¨æ™ºèƒ½åˆçº¦, è¿™æ¬¡æˆ‘ä»¬åªä½¿ç”¨ä¸€äº›å‘½ä»¤è¡Œå·¥å…·æ¥è¿›è¡Œ"æ‰‹å·¥æ‰“é€ "

é…å¥—ä»£ç : https://github.com/yinhui1984/stepByStepSmartContract



<!--more-->



## åˆ›å»ºæµ‹è¯•é“¾

è¿˜æ˜¯ä»¥ETHä¸ºä¾‹, ä½¿ç”¨ `Go Ethereum` https://geth.ethereum.org æ¥åˆ›å»º ä½¿ç”¨`POW`å…±è¯†ç®—æ³•çš„ä¸€ä¸ªç®€å•ç§æœ‰é“¾.

### å®‰è£…geth

å®˜æ–¹æ•™ç¨‹ https://geth.ethereum.org/docs/install-and-build/installing-geth

æˆ–è€…è‡ªå·±ä¸‹è½½å®‰è£…åŒ…è¿›è¡Œå®‰è£…  https://geth.ethereum.org/downloads/

å®‰è£…å®Œæˆå, è¿è¡Œä¸€ä¸‹versionè¡¨ç¤ºæˆåŠŸ

```shell
OSX MP16 ~/Downloads/privateNetwork â¯ geth version
Geth
Version: 1.10.16-stable
Architecture: amd64
Go Version: go1.17.6
Operating System: darwin
GOPATH=
GOROOT=go
```

### åˆ›å»ºä¸€ä¸ªè´¦æˆ·

ä¸‹é¢çš„`åˆ›ä¸–æ–‡ä»¶`ä¸­çš„`coinbase`ä¼šç”¨åˆ°è¿™ä¸ªè´¦æˆ·, ç”¨æ¥æ¥æ”¶æŒ–çŸ¿çš„æ”¶å…¥

ä¸ºæ–¹ä¾¿èµ·è§, å°†è´¦æˆ·å¯†ç å†™åˆ°password.txt , å½“ç„¶è¿™æ˜¯ä¸å®‰å…¨çš„è¡Œä¸º.

```shell
echo 123456 > password.txt
```

æ–°å»ºè´¦æˆ·:

```shell
geth --datadir ./data/ account new --password ./password.txt
```

å…¶ä¸­çš„`datadir`æ˜¯æ•°æ®å­˜å‚¨ç›®å½•, åé¢çš„æ•°æ®æ–‡ä»¶éƒ½å°†å­˜åˆ°è¿™ä¸ªç›®å½•ä¸­

```shell
OSX MP16 ~/Downloads/privateNetwork â¯ geth --datadir ./data/ account new --password ./password.txt
INFO [07-01|10:10:34.007] Maximum peer count                       ETH=50 LES=0 total=50

Your new key was generated

Public address of the key:   0x79dF0D3c23f22370881dC92aF524A1D5E52e3552
Path of the secret key file: data/keystore/UTC--2022-07-01T02-10-34.008109000Z--79df0d3c23f22370881dc92af524a1d5e52e3552

- You can share your public address with anyone. Others need it to interact with you.
- You must NEVER share the secret key with anyone! The key controls access to your funds!
- You must BACKUP your key file! Without the key, it's impossible to access account funds!
- You must REMEMBER your password! Without the password, it's impossible to decrypt the key!
```

æ‰“å°å†…å®¹ä¸­çš„ `0x79dF0D3c23f22370881dC92aF524A1D5E52e3552`æ˜¯å…¬é’¥, ä¹Ÿæ˜¯æˆ‘ä»¬çš„è´¦æˆ·åœ°å€



### æ‰¾ä¸€ä¸ªç½‘ç»œID

`chainId`æˆ–è€…`network ID` ç”¨äºéš”ç¦»ä»¥å¤ªåŠå¯¹ç­‰ç½‘ç»œã€‚åªæœ‰å½“ä¸¤ä¸ªå¯¹ç­‰ç‚¹ä½¿ç”¨ç›¸åŒçš„åˆ›ä¸–å—å’Œç½‘ç»œ ID æ—¶ï¼ŒåŒºå—é“¾èŠ‚ç‚¹ä¹‹é—´æ‰ä¼šå‘ç”Ÿè¿æ¥ã€‚ä½¿ç”¨ --networkid å‘½ä»¤è¡Œé€‰é¡¹è®¾ç½® geth ä½¿ç”¨çš„ç½‘ç»œ IDã€‚

ä»¥å¤ªç½‘ä¸»ç½‘ ID ä¸º 1ã€‚å¦‚æœæ‚¨æä¾›ä¸ä¸»ç½‘ä¸åŒçš„è‡ªå®šä¹‰ç½‘ç»œ IDï¼Œæ‚¨çš„èŠ‚ç‚¹å°†ä¸ä¼šè¿æ¥åˆ°å…¶ä»–èŠ‚ç‚¹å¹¶å½¢æˆä¸“ç”¨ç½‘ç»œã€‚å¦‚æœæ‚¨æ‰“ç®—åœ¨ Internet ä¸Šè¿æ¥åˆ°æ‚¨çš„ç§æœ‰é“¾ï¼Œæœ€å¥½é€‰æ‹©ä¸€ä¸ªå°šæœªä½¿ç”¨çš„ç½‘ç»œ IDã€‚æ‚¨å¯ä»¥åœ¨ https://chainid.network æ‰¾åˆ°ç”±ç¤¾åŒºè¿è¡Œçš„ä»¥å¤ªåŠç½‘ç»œæ³¨å†Œè¡¨ã€‚ è¿™é‡Œæˆ‘ä»¬åªæ˜¯åœ¨æœ¬åœ°è¿è¡Œ, éšä¾¿ä½¿ç”¨ä¸€ä¸ªIDå°±å¯ä»¥äº†, æ¯”å¦‚`1235`

### ç¼–å†™"åˆ›ä¸–æ–‡ä»¶"

ä¸€ä¸ªæ–°çš„åŒºå—é“¾åœ¨ç”Ÿæˆç¬¬ä¸€ä¸ªåŒºå—, ä¹Ÿå°±æ˜¯`åˆ›ä¸–å—`çš„æ—¶å€™, éœ€è¦ä»`åˆ›ä¸–æ–‡ä»¶`æ¥è¿›è¡Œç”Ÿæˆ

```shell
touch genesis.json
```

```json
{
  "nonce": "0x0000000000000042",
  "timestamp": "0x00",
  "parentHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
  "extraData": "0x00",
  "gasLimit": "0x8000000",
  "difficulty": "0x0400",
  "byzantiumBlock": 0,
  "constantinopleBlock": 0,
  "mixhash": "0x0000000000000000000000000000000000000000000000000000000000000000",
  "coinbase": "0x79dF0D3c23f22370881dC92aF524A1D5E52e3552",
  "alloc": {
    "0x79dF0D3c23f22370881dC92aF524A1D5E52e3552":
    {
      "balance": "1000000000000000000000"
    }
  },
  "config": {
    "chainId": 1235,
    "homesteadBlock": 0,
    "eip150Block": 0,
    "eip155Block": 0,
    "eip158Block": 0
  }
}
```

å…³äºåˆ›ä¸–æ–‡ä»¶ä¸­çš„å„ä¸ªå­—æ®µçš„å«ä¹‰, åé¢ä¼šæœ‰ä¸€ç¯‡ä¸“é—¨çš„åšå®¢æ¥è®²

> æ³¨æ„: å°†`coinbase` ä»¥åŠ `alloc`ä¸­çš„åœ°å€ä¿®æ”¹ä¸ºä¸Šé¢åˆ›å»ºè´¦æˆ·æ—¶ä½ æ‰€å¾—åˆ°çš„åœ°å€

### åˆå§‹åŒ–åŒºå—é“¾

```shell
geth --datadir ./data init ./genesis.json
```

è¾“å‡º

```shell
INFO [07-01|10:50:50.915] Maximum peer count                       ETH=50 LES=0 total=50
INFO [07-01|10:50:50.919] Set global gas cap                       cap=50,000,000
INFO [07-01|10:50:50.919] Allocated cache and file handles         database=/Users/zhouyinhui/Downloads/privateNetwork/data/geth/chaindata cache=16.00MiB handles=16
INFO [07-01|10:50:51.007] Writing custom genesis block 
INFO [07-01|10:50:51.010] Persisted trie from memory database      nodes=0 size=0.00B time="21.005Âµs" gcnodes=0 gcsize=0.00B gctime=0s livenodes=1 livesize=0.00B
INFO [07-01|10:50:51.011] Successfully wrote genesis state         database=chaindata hash=0ca0fb..b61b69
INFO [07-01|10:50:51.011] Allocated cache and file handles         database=/Users/zhouyinhui/Downloads/privateNetwork/data/geth/lightchaindata cache=16.00MiB handles=16
INFO [07-01|10:50:51.090] Writing custom genesis block 
INFO [07-01|10:50:51.090] Persisted trie from memory database      nodes=0 size=0.00B time="2.71Âµs"   gcnodes=0 gcsize=0.00B gctime=0s livenodes=1 livesize=0.00B
INFO [07-01|10:50:51.091] Successfully wrote genesis state         database=lightchaindata hash=0ca0fb..b61b69
OSX MP16 ~/Downloads/privateNetwork â¯ 

```

ç”Ÿæˆçš„æ–‡ä»¶åœ¨ ` ./data/geth`ä¸‹

## è¿è¡ŒåŒºå—é“¾

```shell
geth --datadir ./data/ --networkid 1235 --port 8545  --http --http.api 'admin,eth,miner,net,txpool,personal,web3'  --mine --allow-insecure-unlock --unlock '0x79dF0D3c23f22370881dC92aF524A1D5E52e3552' --password password.txt
```

+ ` --datadir` æ•°æ®æ–‡ä»¶ç›®å½•
+ `--networkid` ç½‘ç»œID
+ `--port` RPCç«¯å£
+ `--http` å¯ç”¨`http-rpc`æœåŠ¡
+ `--http.api`æä¾›é‚£äº›API
+ `--mine` å¯ç”¨æŒ–çŸ¿
+  `--allow-insecure-unlock` å½“è´¦æˆ·ç›¸å…³çš„RPCè¢«httpæš´éœ²æ—¶ï¼Œå…è®¸ä¸å®‰å…¨çš„è´¦æˆ·è§£é”
+ `--unlock` è§£é”è´¦æˆ· (å¤šä¸ªè´¦æˆ·ç”¨é€—å·åˆ†å‰²)
+ `--password` è§£é”è´¦æˆ·ç”¨åˆ°çš„å¯†ç æ–‡ä»¶

æˆåŠŸè¿è¡Œå, ä¼šçœ‹åˆ°å¾ˆå¤šæ‰“å°ä¿¡æ¯, å…¶ä¸­å€¼å¾—æ³¨æ„çš„æ˜¯ä¸‹é¢è¿™ä¸¤è¡Œ, ä¸€ä¸ªæ˜¯ipc, ä¸€ä¸ªæ˜¯http server, æˆ‘ä»¬ä¼šä½¿ç”¨ä»–ä»¬æ¥å’Œæˆ‘ä»¬çš„åŒºå—é“¾è¿›è¡Œé€šè®¯

```shell
INFO [07-01|11:08:58.245] IPC endpoint opened                      url=/Users/zhouyinhui/Downloads/privateNetwork/data/geth.ipc
INFO [07-01|11:08:58.245] HTTP server started                      endpoint=127.0.0.1:8545 prefix= cors= vhosts=localhost
```

å¦å¤–ä¸€æ¡æ˜¯ æˆ‘ä»¬ä½œä¸ºåŒºå—é“¾ä¸­çš„å¯¹ç­‰èŠ‚ç‚¹`PEER NODE`æ—¶çš„ä¿¡æ¯, è¿™é‡Œæˆ‘ä»¬è¿˜ç”¨ä¸åˆ°

```shell
 Started P2P networking                   self=enode://de2537c5f309be45bcb2d011cd172138db40295f74a288b07e03635e2194e7c2987cf97c9d295dc502053d9f7adda11052597c7f1bc5a5ec3d8182777138a0f1@127.0.0.1:8545
```



>è¯·ä¿æŒåŒºå—é“¾åœ¨åå°è¿è¡Œ, åé¢çš„ä»£ç éƒ½éœ€è¦ç”¨åˆ°

## ä¸æµ‹è¯•é“¾è¿›è¡Œäº¤äº’

`attach`åˆ°æµ‹è¯•é“¾, å°±å¯ä»¥å¯åŠ¨ä¸€ä¸ªjs console, å’Œ`truffle console`åŠŸèƒ½ä¸€æ ·

**æ–¹å¼1, é€šè¿‡IPCè¿›è¡Œattach**

```shell
geth attach /Users/zhouyinhui/Downloads/privateNetwork/data/geth.ipc
```

```shell
OSX MP16 ~/blockchain/private_net/tempchain â¯ geth attach /Users/zhouyinhui/Downloads/privateNetwork/data/geth.ipc
Welcome to the Geth JavaScript console!

....

To exit, press ctrl-d or type exit
> eth.chainId()
"0x4d3"
>
```

`"0x4d3"` ä¹Ÿå°±æ˜¯ æˆ‘ä»¬çš„ `1235`

å…¶ä¸­ *.ipc å¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„



**æ–¹å¼2, é€šè¿‡httpæœåŠ¡è¿›è¡Œattach**

```
geth attach http://127.0.0.1:8545
```



## ä¸€é”®ç”Ÿæˆæµ‹è¯•é“¾

ä¸Šé¢é‚£äº›ç¹ççš„æ­¥éª¤å¯ä»¥ææˆä¸€ä¸ªè„šæœ¬, ä¸€é”®ç”Ÿæˆ, è¿™æ ·æ¥å¾—æ›´æ–¹ä¾¿

è„šæœ¬åœ¨è¿™é‡Œ: https://github.com/yinhui1984/stepByStepSmartContract/blob/main/autogen/autoGenChain.py



(ç›´æ¥å°†ä»£ç è´´åˆ°è¿™é‡Œä¼šå¯¼è‡´`GitHub Pages failed to build your site`Â   ğŸ˜‚)



## ç¼–å†™æ™ºèƒ½åˆçº¦

æˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ [ä¸Šç¯‡åšå®¢ä¸­çš„](https://yinhui1984.github.io/ä»é›¶å¼€å§‹ç¼–å†™æ™ºèƒ½åˆçº¦-ä½¿ç”¨traffleå¥—ä»¶/)æ™ºèƒ½åˆçº¦

```shell
mkdir ./contracts
cd ./contracts
touch Calculator.sol
```



```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract Calculator {

    function add(int a, int b) public pure returns (int)  {
        return a + b;
    }

    function subtract(int a, int b) public pure returns (int) {
        return a - b;
    }
}
```



## ç¼–è¯‘æ™ºèƒ½åˆçº¦

å¦‚æœä½ çš„ç”µè„‘ä¸Šæ²¡æœ‰`solc`, è¯·äº‹å…ˆå®‰è£…, å®ƒæ˜¯solidityçš„ç¼–è¯‘å™¨, å®˜æ–¹æ•™ç¨‹: https://docs.soliditylang.org/en/v0.8.15/installing-solidity.html#installing-solidity



ç¼–è¯‘:

```shell
solc --bin --abi -o ./build ./Calculator.sol
```

+ `--bin` ç”Ÿæˆ16è¿›åˆ¶æ–‡ä»¶
+ `--abi`ç”Ÿæˆabiæ–‡ä»¶
+ `-o`è¾“å‡ºç›®å½•



å¯ä»¥å†™ä¸€ä¸ª`Makefile`æ¥å¹²è¿™ä¸ªäº‹æƒ…:

```makefile
all:
	solc --bin --abi --overwrite -o ./build ./Calculator.sol
clean:
	rm -rf ./build/*
```



```
OSX MP16 ~/Downloads/privateNetwork/contracts â¯ tree
.
â”œâ”€â”€ Calculator.sol
â”œâ”€â”€ Makefile
â””â”€â”€ build
    â”œâ”€â”€ Calculator.abi
    â””â”€â”€ Calculator.bin
```



## éƒ¨ç½²æ™ºèƒ½åˆçº¦

æ–°å»ºä¸€ä¸ªnode.js é¡¹ç›®`deploy`

```
mkdir -p deploy/
cd deploy/
npm init
touch index.js
```

å®‰è£…`web3.js`

```shell
npm install web3
```

åœ¨`index.js`ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç :

```js
const fs = require('fs');
const Web3 = require('web3');
const web3 = new Web3('http://127.0.0.1:8545');

const bytecode = fs.readFileSync('../build/Calculator.bin').toString();
const abi = JSON.parse(fs.readFileSync('../build/Calculator.abi').toString());

(async function () {
    const accounts = await web3.eth.getAccounts();

    const calculator = new web3.eth.Contract(abi);

    calculator.deploy({
        data: bytecode
    }).send({
        from: accounts[0],
    }).then((deployment) => {
        console.log('Contract was deployed at the following address:');
        console.log(deployment.options.address);
    }).catch((err) => {
        console.error(err);
    });
})();

```

>æ³¨æ„,  ä¸Šé¢çš„éƒ¨ç½²ä»£ç æ²¡æœ‰ä½¿ç”¨è´¦æˆ·çš„ç§é’¥, æ˜¯å› ä¸ºåœ¨å‰é¢çš„æ­¥éª¤ä¸­, è´¦æˆ·å·²ç»è§£é”äº†

**åœ¨éƒ¨ç½²ä¹‹å‰éœ€è¦å…ˆå¯åŠ¨æŒ–çŸ¿**

```shell
OSX MP16 ~/Downloads/pri/mychain â¯ ./attach.sh 

...

> miner.start()
null
> eth.blockNumber
26


```

éƒ¨ç½²:

```shell
OSX MP16 ~/Downloads/pri/c/d/deploy_js â¯ node ./index.js 
Contract was deployed at the following address:
0x1F55d61D5Aa8eC92FD1Da0f19FaC9D552A29DBBF
```

éƒ¨ç½²æˆåŠŸ, åœæ‰æŒ–çŸ¿, å¦åˆ™ç”µè„‘å·¨çƒ«...

```shell
> miner.stop()
null
```



## è°ƒç”¨æ™ºèƒ½åˆçº¦

è°ƒç”¨æ™ºèƒ½åˆçº¦å°±å’Œ [ä»é›¶å¼€å§‹ç¼–å†™æ™ºèƒ½åˆçº¦-ä½¿ç”¨truffleå¥—ä»¶](https://yinhui1984.github.io/ä»é›¶å¼€å§‹ç¼–å†™æ™ºèƒ½åˆçº¦-ä½¿ç”¨truffleå¥—ä»¶/#7-demoappè°ƒç”¨åˆçº¦)ä¸­çš„ä¸€æ ·äº†, å¯ä»¥è·³è½¬åˆ°é‚£é‡Œè¿›è¡Œå‚è€ƒ

