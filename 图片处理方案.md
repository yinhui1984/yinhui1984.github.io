# 图片处理方案文档

## 当前项目状态

### 图片存储方式
- **使用 GitHub 图床**：`https://github.com/yinhui1984/imagehosting`
- **图片路径**：`main/images/`
- **链接格式**：`https://github.com/yinhui1984/imagehosting/blob/main/images/图片文件名.png?raw=true`
- **图床脚本**：在 `imagehosting` 仓库的 `src/main.go`，可以上传图片并生成 markdown 链接

### 当前工作流程
1. 手动上传图片到 GitHub 图床仓库
2. 使用图床脚本生成 markdown 链接：
   ```bash
   go run ./src/main.go ~/Downloads/image.png
   # 输出: ![image](https://github.com/yinhui1984/imagehosting/blob/main/images/xxx.png?raw=true)
   ```
3. 在 markdown 中直接使用生成的链接

---

## Hugo 图片处理机制

### Hugo Build 流程

1. **新建文件时**（`hugo new` 或 `./new.sh`）
   - 只在 `content/posts/` 下创建 markdown 文件
   - **不会**在 `public/` 目录创建任何内容
   - `public/` 目录只在执行 `hugo build` 时生成

2. **Hugo Build 时**（`hugo` 或 `hugo -D`）
   - 读取 `content/posts/*.md` 文件
   - 根据 `Permalinks` 配置生成 URL 路径（当前配置：`posts = ":contentbasename"`）
   - 将 markdown 转换为 HTML
   - 处理资源文件（图片等）
   - 输出到 `public/` 目录

3. **输出结构示例**
   ```
   content/posts/从零开始编写智能合约-使用truffle套件.md
     ↓ (hugo build)
   public/从零开始编写智能合约-使用truffle套件/
     ├── index.html  (生成的 HTML)
     └── index.md    (markdown 副本)
   ```

### Hugo 支持的图片引用方式

Hugo 支持三种方式引用本地图片（优先级从高到低）：

1. **Page Bundle（页面资源包）** - 推荐
   ```
   content/posts/
     └── my-article/
         ├── index.md
         └── image.png  (或 images/ 子目录)
   ```
   - 引用：`![描述](image.png)` 或 `![描述](images/screenshot.png)`
   - 优点：支持图片优化（resize、webp 转换）、响应式图片、资源与文章绑定
   - 缺点：仓库体积会增大

2. **assets 目录**
   ```
   assets/
     └── images/
         └── image.png
   ```
   - 引用：`![描述](/images/image.png)`
   - 优点：全局资源，支持图片处理
   - 缺点：资源分散管理

3. **static 目录**
   ```
   static/
     └── images/
         └── image.png
   ```
   - 引用：`![描述](/images/image.png)`
   - 优点：简单直接，直接复制到输出目录
   - 缺点：不支持图片优化处理

---

## Typora 的工作方式

### Typora 插入图片的行为

当在 Typora 中插入图片时：
- Typora 会在 markdown 文件同级目录创建 `.assets` 目录
- 图片保存在 `文件名.assets/` 目录下
- markdown 中引用格式：`![描述](文件名.assets/image.png)`

### 示例结构
```
content/posts/
  ├── my-article.md
  └── my-article.assets/
      ├── image1.png
      └── image2.jpg
```

### Hugo 如何处理 .assets 目录

- Hugo 会**自动复制** `.assets` 目录到 `public/` 对应位置
- 路径引用需要正确：`![描述](文件名.assets/image.png)`
- **不支持**图片优化处理（因为是 static 资源）

---

## 方案对比

| 特性 | 图床（当前方式） | Page Bundle | Typora .assets |
|------|----------------|-------------|----------------|
| 仓库大小 | ✅ 小 | ❌ 大 | ❌ 大 |
| 加载速度 | ⚠️ 依赖 GitHub CDN | ✅ 依赖服务器 | ✅ 依赖服务器 |
| 图片优化 | ❌ 不支持 | ✅ 自动优化 | ❌ 不支持 |
| 管理便利性 | ✅ 集中管理 | ⚠️ 分散管理 | ⚠️ 分散管理 |
| 离线可用 | ❌ 需要网络 | ✅ 完全离线 | ✅ 完全离线 |
| 自动化 | ⚠️ 需要手动上传 | ✅ 自动处理 | ⚠️ 需要脚本处理 |

---

## 待解决的问题

### 问题描述
使用 Typora 编辑文章时，插入的图片会保存在 `文件名.assets/` 目录下。如果希望：
1. 保持使用 GitHub 图床
2. 自动化处理 Typora 插入的图片
3. 自动上传到图床并替换链接

### 可能的解决方案

#### 方案 1：自动化脚本（推荐）
创建一个脚本，功能：
1. 扫描 `content/posts/` 下的所有 `.assets` 目录
2. 找到 markdown 中引用的本地图片
3. 调用图床脚本上传图片：`go run ~/imagehosting/src/main.go <图片路径>`
4. 解析图床脚本输出，获取 markdown 链接
5. 替换 markdown 中的本地路径为图床链接
6. （可选）删除已上传的本地图片

**脚本位置**：`scripts/upload-images.sh` 或 `scripts/upload-images.py`

**使用方式**：
```bash
# 处理单个文件
./scripts/upload-images.sh content/posts/my-article.md

# 处理所有文件
./scripts/upload-images.sh --all
```

#### 方案 2：Git Hook
在 git commit 时自动触发：
- 检测新增的 `.assets` 目录
- 自动上传图片到图床
- 替换链接
- 提交更改

#### 方案 3：Typora 自定义命令
配置 Typora 的图片插入行为：
- 插入图片时自动调用图床脚本
- 直接使用图床链接

#### 方案 4：改用 Page Bundle
改变工作流程：
- 使用 `hugo new posts/my-article/` 创建 Page Bundle
- 图片放在 bundle 目录下
- 利用 Hugo 的图片优化功能
- 放弃使用图床

---

## 图床脚本信息

### 脚本位置
- 仓库：`https://github.com/yinhui1984/imagehosting`
- 脚本路径：`src/main.go`
- 图片存储：`images/` 目录

### 使用方法
```bash
# 上传本地图片
go run ./src/main.go ~/Downloads/image.png

# 上传网络图片
go run ./src/main.go https://example.com/image.png

# 输出格式
![image](https://github.com/yinhui1984/imagehosting/blob/main/images/1664515782371748000-image.png?raw=true)
```

### 输出解析
脚本输出格式：
```
![image](https://github.com/yinhui1984/imagehosting/blob/main/images/时间戳-文件名.png?raw=true)
```

需要提取：
- 完整的 markdown 链接
- 或只提取 URL 部分

---

## 实施建议

### 短期方案（保持现状）
- 继续使用 GitHub 图床
- 手动上传图片
- 手动复制链接到 markdown

### 中期方案（半自动化）
- 创建自动化脚本
- 在完成文章后运行脚本处理图片
- 保留 `.assets` 目录作为备份

### 长期方案（全自动化）
- 使用 Git Hook 自动处理
- 或改用 Page Bundle + Hugo 图片优化
- 放弃图床，使用本地资源

---

## 相关资源

- [Hugo Page Bundles 文档](https://gohugo.io/content-management/page-bundles/)
- [Hugo Image Processing 文档](https://gohugo.io/content-management/image-processing/)
- [FixIt 主题图片处理](https://fixit.lruihao.cn/documentation/content-management/shortcodes/#image)
- 图床仓库：https://github.com/yinhui1984/imagehosting

---

## 更新记录

- 2024-XX-XX：创建文档，记录图片处理方案和思路
