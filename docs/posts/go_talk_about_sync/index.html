<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[Golang]èŠèŠsync | Zhouyinhui's Space</title><meta name=keywords content="#go#,#golang#,#sync#"><meta name=description content="æˆ‘ä»¬å°†ç”¨äº›ç®€å•çš„ä¾‹å­æ¥å°è¯•golangä¸­syncåŒ…çš„å„ç§æœ‰è¶£çš„æƒ…å†µ
ä¸€ä¸ªç®€å•çš„DEMO package main  import &#34;fmt&#34;  var ( 	sharedCounter = 0 )  func add(count int) { 	for i := 0; i < count; i++ { 	sharedCounter++ 	} }  func sub(count int) { 	for i := 0; i < count; i++ { 	sharedCounter-- 	} }  func show() { 	fmt.Println(sharedCounter) }  func main() { 	add(1000000) 	sub(1000000) 	show() } ç¨‹åºå¾ˆç®€å•, æˆ‘ä»¬ç”¨ä¸€ä¸ªå…±äº«å˜é‡sharedCounterä½œä¸ºä¸€ä¸ªè®¡æ•°å™¨."><meta name=author content="zhouyinhui"><link rel=canonical href=../../posts/go_talk_about_sync/><link crossorigin=anonymous href=../../assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=../../assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.95.0"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="[Golang]èŠèŠsync"><meta property="og:description" content="æˆ‘ä»¬å°†ç”¨äº›ç®€å•çš„ä¾‹å­æ¥å°è¯•golangä¸­syncåŒ…çš„å„ç§æœ‰è¶£çš„æƒ…å†µ
ä¸€ä¸ªç®€å•çš„DEMO package main  import &#34;fmt&#34;  var ( 	sharedCounter = 0 )  func add(count int) { 	for i := 0; i < count; i++ { 	sharedCounter++ 	} }  func sub(count int) { 	for i := 0; i < count; i++ { 	sharedCounter-- 	} }  func show() { 	fmt.Println(sharedCounter) }  func main() { 	add(1000000) 	sub(1000000) 	show() } ç¨‹åºå¾ˆç®€å•, æˆ‘ä»¬ç”¨ä¸€ä¸ªå…±äº«å˜é‡sharedCounterä½œä¸ºä¸€ä¸ªè®¡æ•°å™¨."><meta property="og:type" content="article"><meta property="og:url" content="/posts/go_talk_about_sync/"><meta property="og:image" content="%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-02T09:43:29+08:00"><meta property="article:modified_time" content="2022-06-02T09:43:29+08:00"><meta property="og:site_name" content="zhouyinhui's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="[Golang]èŠèŠsync"><meta name=twitter:description content="æˆ‘ä»¬å°†ç”¨äº›ç®€å•çš„ä¾‹å­æ¥å°è¯•golangä¸­syncåŒ…çš„å„ç§æœ‰è¶£çš„æƒ…å†µ
ä¸€ä¸ªç®€å•çš„DEMO package main  import &#34;fmt&#34;  var ( 	sharedCounter = 0 )  func add(count int) { 	for i := 0; i < count; i++ { 	sharedCounter++ 	} }  func sub(count int) { 	for i := 0; i < count; i++ { 	sharedCounter-- 	} }  func show() { 	fmt.Println(sharedCounter) }  func main() { 	add(1000000) 	sub(1000000) 	show() } ç¨‹åºå¾ˆç®€å•, æˆ‘ä»¬ç”¨ä¸€ä¸ªå…±äº«å˜é‡sharedCounterä½œä¸ºä¸€ä¸ªè®¡æ•°å™¨."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"/posts/"},{"@type":"ListItem","position":3,"name":"[Golang]èŠèŠsync","item":"/posts/go_talk_about_sync/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[Golang]èŠèŠsync","name":"[Golang]èŠèŠsync","description":"æˆ‘ä»¬å°†ç”¨äº›ç®€å•çš„ä¾‹å­æ¥å°è¯•golangä¸­syncåŒ…çš„å„ç§æœ‰è¶£çš„æƒ…å†µ\nä¸€ä¸ªç®€å•çš„DEMO package main  import \u0026#34;fmt\u0026#34;  var ( \tsharedCounter = 0 )  func add(count int) { \tfor i := 0; i \u0026lt; count; i++ { \tsharedCounter++ \t} }  func sub(count int) { \tfor i := 0; i \u0026lt; count; i++ { \tsharedCounter-- \t} }  func show() { \tfmt.Println(sharedCounter) }  func main() { \tadd(1000000) \tsub(1000000) \tshow() } ç¨‹åºå¾ˆç®€å•, æˆ‘ä»¬ç”¨ä¸€ä¸ªå…±äº«å˜é‡sharedCounterä½œä¸ºä¸€ä¸ªè®¡æ•°å™¨.","keywords":["#go#","#golang#","#sync#"],"articleBody":"æˆ‘ä»¬å°†ç”¨äº›ç®€å•çš„ä¾‹å­æ¥å°è¯•golangä¸­syncåŒ…çš„å„ç§æœ‰è¶£çš„æƒ…å†µ\nä¸€ä¸ªç®€å•çš„DEMO package main  import \"fmt\"  var ( \tsharedCounter = 0 )  func add(count int) { \tfor i := 0; i count; i++ { \tsharedCounter++ \t} }  func sub(count int) { \tfor i := 0; i count; i++ { \tsharedCounter-- \t} }  func show() { \tfmt.Println(sharedCounter) }  func main() { \tadd(1000000) \tsub(1000000) \tshow() } ç¨‹åºå¾ˆç®€å•, æˆ‘ä»¬ç”¨ä¸€ä¸ªå…±äº«å˜é‡sharedCounterä½œä¸ºä¸€ä¸ªè®¡æ•°å™¨. addå‡½æ•°åœ¨è®¡æ•°å™¨ä¸Šå¾ªç¯æ·»åŠ ä¸€å®šçš„æ•°å€¼, subåˆ™ç›¸å, showåˆ™æ˜¯æ‰“å°è®¡æ•°å™¨å½“å‰çš„å€¼.\nç¨‹åºè¿è¡Œç»“æŸå, sharedCounteråº”è¯¥ä¸º0, ä¸Šé¢ä»£ç çš„è¾“å‡ºçš„ç¡®å¦‚æ­¤.\nä½¿ç”¨ä¸€ä¸ªåç¨‹ å¦‚æœå¯¹è®¡æ•°å™¨è¿›è¡ŒåŠ å‡çš„è°ƒç”¨åœ¨ä¸åŒçš„åç¨‹é‡Œé¢, ä¼šæ€ä¹ˆæ ·å‘¢?\nfunc main() { \tadd(1000000) \tgo sub(1000000) \tshow() } ä¼šå¾—åˆ°1000000 , å› ä¸ºgo sub(1000000)åˆšå¯åŠ¨, ç¨‹åºå°±é€€å‡ºäº†.\næˆ–è®¸æˆ‘ä»¬åº”è¯¥ç­‰åˆ°subå‡½æ•°æ‰§è¡Œç»“æŸ\nç­‰å¾…åç¨‹ç»“æŸ   é”™è¯¯çš„æ–¹å¼ å¦‚æœæœ‰Cè¯­è¨€å¼€å‘èƒŒæ™¯, å¯èƒ½ä¼šæƒ³åˆ°é€šè¿‡è®¾ç½®ä¸€ä¸ªflagæ¥æŒ‡ç¤ºè¿ç®—æ˜¯å¦ç»“æŸ, æ¯”å¦‚:\nfunc sub(count int, done *bool) { \tfor i := 0; i count; i++ { \tsharedCounter-- \t} \t*done = true } //....  func main() { \tadd(1000000)  \tdone := false \tgo sub(1000000, \u0026done)  \tfor !done { \ttime.Sleep(time.Millisecond * 10) \t}  \tshow() } è¿™è™½ç„¶ä¹Ÿèƒ½å¾—åˆ°æ­£ç¡®çš„è¾“å‡º, ä½†éå¸¸ä¸ä¼˜é›….\n  æ­£ç¡®çš„æ–¹å¼1 å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ— ç¼“å†²çš„ä¿¡é“(æˆ–è€…è¯´å®¹é‡ä¸º1çš„ä¿¡é“)æ¥å……å½“flag\n//... func sub(count int, done chan bool) { \tfor i := 0; i count; i++ { \tsharedCounter-- \t} \tdone  true } //.... func main() { \tadd(1000000)  \tdone := make(chan bool) \tgo sub(1000000, done) \tsubDone \tshow() } è¿™é‡Œåˆ©ç”¨äº†ä¿¡é“çš„ç‰¹ç‚¹: å½“ä»ä¿¡é“ä¸­è¯»å–æ•°æ®æ—¶,å¦‚æœä¿¡é“ä¸ºç©º,è¯»å–å°†è¢«é˜»å¡ç›´åˆ°æœ‰æ•°æ®åˆ°è¾¾. æ‰€ä»¥  ä¼šä¸€ç›´é˜»å¡, ç›´åˆ°é€šè¿‡subDone å‘å…¶ä¸­å†™å…¥äº†æ•°æ®\n  ä½¿ç”¨2ä¸ªåç¨‹ ä¸Šé¢çš„ä¾‹å­ä¸­, sub(1000000, done)æ˜¯åœ¨æ–°çš„åç¨‹ä¸­è¿è¡Œçš„, add(1000000)å´ä¸æ˜¯, å¦‚æœä»–ä»¬éƒ½åœ¨æ–°åç¨‹ä¸­è¿è¡Œ, ä¸»ç¨‹åºåº”è¯¥å¦‚ä½•ç­‰å¾…ä»–ä»¬ç»“æŸå‘¢\nå¾ˆå®¹æ˜“æƒ³åˆ°, ä½¿ç”¨ä¸¤æ¬¡ ä¹Ÿå°±æ˜¯è¯´å‘ä¿¡é“ç´¢è¦ä¸¤ä¸ªè®¡ç®—å®Œæˆçš„æ ‡å¿—, addå’Œ sub è®¡ç®—å®Œæˆååˆ†åˆ«å‘å…¶ä¸­æ”¾å…¥æ ‡å¿—.\npackage main  import \"fmt\"  var ( \tsharedCounter = 0 )  func add(count int, done chan bool) { \tfor i := 0; i count; i++ { \tsharedCounter++ \t}  \tfmt.Println(\"add done\") \tdone  true }  func sub(count int, done chan bool) { \tfor i := 0; i count; i++ { \tsharedCounter-- \t} \tfmt.Println(\"sub done\") \tdone  true }  func show() { \tfmt.Println(sharedCounter) }  func main() { \tdone := make(chan bool) \tgo add(1000000, done) \tgo sub(1000000, done) \tdone \tdone \tshow() } ä¸ºäº†æ˜ç¡®çŸ¥é“mainå‡½æ•°çš„ç¡®æ˜¯ç­‰å¾…ä¸¤ä¸ªåç¨‹æ‰§è¡Œå®Œæ¯•äº†çš„, æˆ‘ä»¬åœ¨å…¶ä¸­åŠ å…¥äº†fmt.Println(\"sub done\")è¿™æ ·çš„è¾“å‡º\nè¿è¡Œç¨‹åº, å¾—åˆ°\nadd done sub done 824933 Opps, è™½ç„¶addå’Œsub éƒ½æ‰§è¡Œå®Œæ¯•äº†,ä½†æ˜¯ç»“æœä¸å¯¹(å¹¶ä¸”å¤šæ¬¡è¿è¡Œçš„ç»“æœè¿˜ä¸ç›¸åŒ), æœŸæœ›æ¥æ”¶åº”è¯¥æ˜¯0\nå†è¿è¡Œä¸€æ¬¡, å¾—åˆ°:\nsub done add done -481342 åŸå› æ˜¯addå’Œsubåœ¨äº¤å‰è¯»å–å’Œå†™å…¥sharedCounterè¿™ä¸ªå˜é‡, ä»–ä»¬å…±äº«äº†å˜é‡, ä½†åœ¨è¯»å–å’Œå†™å…¥çš„æ—¶å€™å‡ºç°**â€œç«æ€â€**\nç«æ€ æœ‰å¤šä¸ªåç¨‹è¿è¡Œæ—¶, å¯¹äºæ¯ä¸ªåç¨‹è€Œè¨€,å…¶å†…éƒ¨ä»£ç æ—¶é¡ºåºæ‰§è¡Œçš„, ä½†æ— æ³•ç¡®å®šåç¨‹ä¹‹é—´çš„æ‰§è¡Œé¡ºåº, é‚£ä¹ˆå°±è¯´è¿™äº›åç¨‹æ˜¯å¹¶å‘çš„\nå¦‚æœä¸€æ®µä»£ç æ— è®ºæ˜¯é¡ºåºæ‰§è¡Œè¿˜æ˜¯å¹¶å‘æ‰§è¡Œ,å…¶ç»“æœéƒ½æ˜¯ç¡®å®šçš„,é‚£ä¹ˆè¿™ä¸ªä»£ç å°±æ˜¯å¹¶å‘å®‰å…¨çš„.\nç›¸å, å¹¶å‘ä¸å®‰å…¨çš„ä»£ç ,å¯èƒ½ä¼šå‡ºç°æ­»é”,æ´»é”,ç«æ€\nç«æ€åˆ™è¡¨ç¤ºä»£ç å¯æ‰§è¡Œ,ä½†å¯èƒ½å‡ºç°ç»“æœä¸ä¸€è‡´(é”™è¯¯ç»“æœ)\n###è§£å†³æ–¹æ³•1, åˆ©ç”¨ä¿¡é“\nfunc main() { \tdone := make(chan bool) \tgo add(1000000, done) \tdone //1 \tgo sub(1000000, done) \tdone //2 \tshow() } åœ¨addæ‰§è¡Œå®Œæ¯•ä¹‹å‰, é¦–å…ˆä¼šå µå¡åœ¨//1å¤„,\nfunc add(count int, done chan bool) { \t//.... \tdone  true } addå‡½æ•°æ‰§è¡Œæœ€åä¸€å¥ done å èƒ½å–åˆ°å€¼, æ¥è§¦é˜»å¡. ç„¶åç»§ç»­å¾€ä¸‹æ‰§è¡Œsubå‡½æ•°.\nè¿™è™½ç„¶èƒ½å¾—åˆ°æ­£ç¡®è¾“å‡º, ä½†, æˆ‘ä»¬å‘ç°, è¿™å®é™…æ˜¯å°†å¹¶è¡Œæ‰§è¡Œä¿®æ”¹æˆäº†ä¸²è¡Œæ‰§è¡Œ.\nè§£å†³æ–¹æ³•2, åˆ©ç”¨ Mutex æˆ– RWMutex sync.Mutex å¯èƒ½æ˜¯åŒæ­¥åŒ…ä¸­ä½¿ç”¨æœ€å¹¿æ³›çš„åŸè¯­ã€‚å®ƒå…è®¸å¯¹å…±äº«èµ„æºè¿›è¡Œäº’æ–¥ï¼ˆä¸èƒ½åŒæ—¶è®¿é—®).\nmutex := \u0026sync.Mutex{}  mutex.Lock() //.... æ›´æ–°å…±äº«å˜é‡ mutex.Unlock() æ³¨æ„: åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æœ‰è¿™ä¹ˆä¸€å¥ â€œValues containing the types defined in this package should not be copied.â€ (â€œåŒ…å«è¿™ä¸ªåŒ…ä¸­å®šä¹‰çš„ç±»å‹çš„å€¼ä¸åº”è¯¥è¢«å¤åˆ¶ã€‚â€) . æˆ‘ä»¬ç›´åˆ°å€¼ä¼ é€’å°±æ˜¯å¤åˆ¶ç„¶åä¼ é€’, æ‰€ä»¥æˆ‘ä»¬ä»£ç ä¸­çš„mutexç”¨çš„æ˜¯å¼•ç”¨ä¼ é€’.\npackage main  import ( \t\"fmt\" \t\"sync\" )  var ( \tsharedCounter = 0 \tmutex = \u0026sync.Mutex{} )  func add(count int, done chan bool) { \tfor i := 0; i count; i++ { \tmutex.Lock() \tsharedCounter++ \tmutex.Unlock() \t}  \tfmt.Println(\"add done\") \tdone  true }  func sub(count int, done chan bool) { \tfor i := 0; i count; i++ { \tmutex.Lock() \tsharedCounter-- \tmutex.Unlock() \t} \tfmt.Println(\"sub done\") \tdone  true }  func show() { \tfmt.Println(sharedCounter) }  func main() { \tdone := make(chan bool) \tgo add(1000000, done) \tgo sub(1000000, done) \tdone \tdone \tshow() } åœ¨è¯»å†™sharedCounterä¹‹å‰å…ˆLock(), ç”¨å®ŒåUnlock()\nå¦‚æœæˆ‘ä»¬åœ¨è¿›è¡Œè®¡ç®—çš„æ—¶å€™åŠ ä¸Šç‚¹æ‰“å°(ä»…æµ‹è¯•ç”¨,éå¸¸å½±å“é€Ÿåº¦)\nfor i := 0; i count; i++ { \tmutex.Lock() \tfmt.Println(\"--\") // fmt.Println(\"++\") \tsharedCounter-- // sharedCounter++ \tmutex.Unlock() \t} åˆ™å¯ä»¥çœ‹åˆ° ++ å’Œ â€“ æ˜¯äº¤å‰ç€æ‰“å°çš„, è¯´æ˜æ˜¯å¹¶è¡Œæ‰§è¡Œçš„.\nå¦å¤–, è¿˜æœ‰RWMutex (è¯»å†™é”), é™¤äº†ä¸Mutexç›¸åŒçš„Lock()å’ŒUnlock()æ–¹æ³•å¤–, å…¶è¿˜æœ‰ç”¨äºå…±äº«è¯»æ“ä½œçš„RLock()å’ŒRUnlock(), åœ¨è¯»å–å…±äº«å˜é‡æ—¶å…è®¸åŒæ—¶å¤šä¸ªè¯»å–å™¨èƒ½æé«˜æ•ˆç‡. æ‰€ä»¥åœ¨é¢‘ç¹è¯»å†™æ“ä½œçš„ä»£ç ä¸­, ä½¿ç”¨RWMutexæ•ˆç‡è¦æ¯”Mutexé«˜\nè§£å†³æ–¹æ³•3, åˆ©ç”¨åŸå­æ“ä½œ åŸå­æ“ä½œåœ¨\"sync/atomic\"åŒ…ä¸­. åˆ©ç”¨è¿™ä¸ªåŒ…ä¸­æä¾›çš„å‡½æ•°å¯å®ç°\"æ— é”ç‰ˆ\"çš„å…±äº«å˜é‡è¯»å†™\nåŸå­æ“ä½œå³æ˜¯è¿›è¡Œè¿‡ç¨‹ä¸­ä¸èƒ½è¢«ä¸­æ–­çš„æ“ä½œï¼Œé’ˆå¯¹æŸä¸ªå€¼çš„åŸå­æ“ä½œåœ¨è¢«è¿›è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒCPUç»ä¸ä¼šå†å»è¿›è¡Œå…¶ä»–çš„é’ˆå¯¹è¯¥å€¼çš„æ“ä½œã€‚ä¸ºäº†å®ç°è¿™æ ·çš„ä¸¥è°¨æ€§ï¼ŒåŸå­æ“ä½œä»…ä¼šç”±ä¸€ä¸ªç‹¬ç«‹çš„CPUæŒ‡ä»¤ä»£è¡¨å’Œå®Œæˆã€‚åŸå­æ“ä½œæ˜¯æ— é”çš„ï¼Œå¸¸å¸¸ç›´æ¥é€šè¿‡CPUæŒ‡ä»¤ç›´æ¥å®ç°ã€‚ äº‹å®ä¸Šï¼Œå…¶å®ƒåŒæ­¥æŠ€æœ¯çš„å®ç°å¸¸å¸¸ä¾èµ–äºåŸå­æ“ä½œ\npackage main  import ( \t\"fmt\" \t\"sync/atomic\" )  var ( \tsharedCounter = int64(0) )  func add(count int, done chan bool) { \tfor i := 0; i count; i++ { \tatomic.AddInt64(\u0026sharedCounter, 1) // \t}  \tfmt.Println(\"add done\") \tdone  true }  func sub(count int, done chan bool) { \tfor i := 0; i count; i++ { \tatomic.AddInt64(\u0026sharedCounter, -1) // \t} \tfmt.Println(\"sub done\") \tdone  true }  func show() { \tfmt.Println(sharedCounter) }  func main() { \tdone := make(chan bool) \tgo add(1000000, done) \tgo sub(1000000, done) \tdone \tdone \tshow() } åŸå­æ“ä½œçš„å¸¸ç”¨æ¥å£å¦‚ä¸‹(ä»¥int32ä¸ºä¾‹)\n//å°†addræŒ‡å‘çš„å€¼å’Œoldè¿›è¡Œæ¯”è¾ƒ, å¦‚æœç›¸ç­‰,åˆ™å°†newèµ‹å€¼åˆ°addræŒ‡å‘çš„ä½ç½®,å¹¶è¿”å›true, å¦‚æœä¸ç›¸ç­‰,åˆ™ç›´æ¥è¿”å›false func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool)   //ä½¿ç”¨åŸå­æ“ä½œ,å°†addræŒ‡å‘çš„ä½ç½®å¢åŠ ä¸€ä¸ªdelta func AddInt32(addr *int32, delta int32) (new int32)  //åŸå­è¯»å– //å½“æˆ‘ä»¬è¦è¯»å–ä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œå¾ˆæœ‰å¯èƒ½è¿™ä¸ªå˜é‡æ­£åœ¨è¢«å†™å…¥ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¾ˆæœ‰å¯èƒ½è¯»å–åˆ°å†™åˆ°ä¸€åŠçš„æ•°æ®ã€‚ æ‰€ä»¥è¯»å–æ“ä½œæ˜¯éœ€è¦ä¸€ä¸ªåŸå­è¡Œä¸ºçš„ã€‚ func LoadInt32(addr *int32) (val int32)  //è¯»å–æ˜¯æœ‰åŸå­æ€§çš„æ“ä½œçš„ï¼ŒåŒæ ·å†™å…¥atomicåŒ…ä¹Ÿæä¾›äº†ç›¸å…³çš„æ“ä½œåŒ… func StoreInt32(addr *int32, val int32)   //æ­¤ç±»å‹çš„å€¼ç›¸å½“äºä¸€ä¸ªå®¹å™¨ï¼Œå¯ä»¥è¢«ç”¨æ¥â€œåŸå­åœ°\"å­˜å‚¨ï¼ˆStoreï¼‰å’ŒåŠ è½½ï¼ˆLoadï¼‰ä»»æ„ç±»å‹çš„å€¼ã€‚å½“ç„¶è¿™ä¸ªç±»å‹ä¹Ÿæ˜¯åŸå­æ€§çš„ã€‚ //æœ‰äº†atomic.Valueè¿™ä¸ªç±»å‹ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥åœ¨ä¸ä¾èµ–Goå†…éƒ¨ç±»å‹unsafe.Pointerçš„æƒ…å†µä¸‹ä½¿ç”¨åˆ°atomicæä¾›çš„åŸå­æ“ä½œã€‚ // A Value must not be copied after first use. type Value struct { \tv interface{} }  åŸå­æ“ä½œä¸äº’æ–¥é”çš„åŒºåˆ«\né¦–å…ˆatomicæ“ä½œçš„ä¼˜åŠ¿æ˜¯æ›´è½»é‡ï¼Œæ¯”å¦‚CASå¯ä»¥åœ¨ä¸å½¢æˆä¸´ç•ŒåŒºå’Œåˆ›å»ºäº’æ–¥é‡çš„æƒ…å†µä¸‹å®Œæˆå¹¶å‘å®‰å…¨çš„å€¼æ›¿æ¢æ“ä½œã€‚è¿™å¯ä»¥å¤§å¤§çš„å‡å°‘åŒæ­¥å¯¹ç¨‹åºæ€§èƒ½çš„æŸè€—ã€‚\nåŸå­æ“ä½œä¹Ÿæœ‰åŠ£åŠ¿ã€‚è¿˜æ˜¯ä»¥CASæ“ä½œä¸ºä¾‹ï¼Œä½¿ç”¨CASæ“ä½œçš„åšæ³•è¶‹äºä¹è§‚ï¼Œæ€»æ˜¯å‡è®¾è¢«æ“ä½œå€¼æœªæ›¾è¢«æ”¹å˜ï¼ˆå³ä¸æ—§å€¼ç›¸ç­‰ï¼‰ï¼Œå¹¶ä¸€æ—¦ç¡®è®¤è¿™ä¸ªå‡è®¾çš„çœŸå®æ€§å°±ç«‹å³è¿›è¡Œå€¼æ›¿æ¢ï¼Œé‚£ä¹ˆåœ¨è¢«æ“ä½œå€¼è¢«é¢‘ç¹å˜æ›´çš„æƒ…å†µä¸‹ï¼ŒCASæ“ä½œå¹¶ä¸é‚£ä¹ˆå®¹æ˜“æˆåŠŸã€‚è€Œä½¿ç”¨äº’æ–¥é”çš„åšæ³•åˆ™è¶‹äºæ‚²è§‚ï¼Œæˆ‘ä»¬æ€»å‡è®¾ä¼šæœ‰å¹¶å‘çš„æ“ä½œè¦ä¿®æ”¹è¢«æ“ä½œçš„å€¼ï¼Œå¹¶ä½¿ç”¨é”å°†ç›¸å…³æ“ä½œæ”¾å…¥ä¸´ç•ŒåŒºä¸­åŠ ä»¥ä¿æŠ¤ã€‚\nä¸‹é¢æ˜¯å‡ ç‚¹åŒºåˆ«ï¼š\n äº’æ–¥é”æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œç”¨æ¥è®©ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç¨‹åºçš„å…³é”®éƒ¨åˆ†ï¼Œå®Œæˆäº’æ–¥çš„å¤šä¸ªæ“ä½œ åŸå­æ“ä½œæ˜¯æ— é”çš„ï¼Œå¸¸å¸¸ç›´æ¥é€šè¿‡CPUæŒ‡ä»¤ç›´æ¥å®ç° åŸå­æ“ä½œä¸­çš„casè¶‹äºä¹è§‚é”ï¼ŒCASæ“ä½œå¹¶ä¸é‚£ä¹ˆå®¹æ˜“æˆåŠŸï¼Œéœ€è¦åˆ¤æ–­ï¼Œç„¶åå°è¯•å¤„ç† å¯ä»¥æŠŠäº’æ–¥é”ç†è§£ä¸ºæ‚²è§‚é”ï¼Œå…±äº«èµ„æºæ¯æ¬¡åªç»™ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œå…¶å®ƒçº¿ç¨‹é˜»å¡ï¼Œç”¨å®Œåå†æŠŠèµ„æºè½¬è®©ç»™å…¶å®ƒçº¿ç¨‹    ä¸è¦è½»æ˜“ä½¿ç”¨atomic\nhttps://texlution.com/post/golang-lock-free-values-with-atomic-value/\n å…¶å®ƒå¹¶å‘æ§åˆ¶æ–¹æ³• ä¸Šé¢çš„ä¾‹å­ä¸­, æˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨çš„ä¿¡é“æ¥è¿›è¡Œå¹¶å‘æ§åˆ¶ (done ä¸), è¿™åªæ˜¯å¸¸ç”¨çš„æ–¹æ³•ä¹‹ä¸€\nWaitGroup sync.WaitGroup æ‹¥æœ‰ä¸€ä¸ªå†…éƒ¨è®¡æ•°å™¨ã€‚å¦‚æœæ­¤è®¡æ•°å™¨ç­‰äº 0ï¼Œåˆ™ Wait() æ–¹æ³•ç«‹å³è¿”å›ã€‚å¦åˆ™ï¼Œå®ƒå°†è¢«é˜»å¡ï¼Œç›´åˆ°è®¡æ•°å™¨ä¸º 0ã€‚\nè¦å¢åŠ è®¡æ•°å™¨ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨ Add(int)ã€‚è¦å‡å°‘å®ƒï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Done() ï¼ˆå°†å‡å°‘ 1ï¼‰æˆ–å…·æœ‰è´Ÿå€¼çš„ç›¸åŒ Add(int) æ–¹æ³•ã€‚\npackage main  import (  \"fmt\"  \"sync\"  \"sync/atomic\" )  var (  sharedCounter = int64(0) )  func add(count int, wg *sync.WaitGroup) {  for i := 0; i count; i++ {  atomic.AddInt64(\u0026sharedCounter, 1)  }   fmt.Println(\"add done\")  wg.Done() }  func sub(count int, wg *sync.WaitGroup) {  for i := 0; i count; i++ {  atomic.AddInt64(\u0026sharedCounter, -1)  }  fmt.Println(\"sub done\")  wg.Done() }  func show() {  fmt.Println(sharedCounter) }  func main() {  wg := sync.WaitGroup{}  wg.Add(2)   go add(1000000, \u0026wg)  go sub(1000000, \u0026wg)   wg.Wait()  show() } æ³¨æ„:ä¼ é€’ WaitGroupæ—¶è¦ä½¿ç”¨å¼•ç”¨ä¼ é€’(æŒ‡é’ˆ), å…¶ä¸åº”è¯¥è¢«å¤åˆ¶. func sub(count int, wg *sync.WaitGroup)\ncontext.Context Contextæä¾›äº†2ä¸ªåŠŸèƒ½\n æ§åˆ¶å­åç¨‹ç»“æŸ ä¼ é€’å€¼  å…¶ä¸åœ¨syncåŒ…ä¸­, åé¢ä¸“é—¨è®²\nsync.Pool å¯¹è±¡å¤ç”¨ å…¶æä¾›ä¸€ä¸ª\"å¹¶å‘å®‰å…¨\"çš„å¯å¤ç”¨çš„å¯¹è±¡æ± . ç”¨æ¥å‡å°‘é¢‘ç¹GCæ‰€ä»£ç†çš„å‹åŠ›.\nå…¶å¤§æ¦‚æ„æ€æ˜¯: å¦‚æœæœ‰æ—§å¯¹è±¡å¯ç”¨,åˆ™ç”¨æ—§çš„, æ²¡æœ‰å†Newä¸€ä¸ª\nå‚è€ƒè¿™æ‰¹æ–‡ç« : https://www.cnblogs.com/qcrao-2018/p/12736031.html\nä»¥åŠè¿™é‡Œ https://geektutu.com/post/hpg-sync-pool.html\nåœ¨å®é™…å¼€å‘å·¥ä½œä¸­, ä¸è¦ä¸€ä¸Šæ¥å°±æƒ³åšä½¿ç”¨sync.Poolå®ƒé€šå¸¸ä¼šå¸¦æ¥é—®é¢˜(å› ä¸ºå…¶Getå‡ºæ¥çš„å¯¹è±¡çš„çŠ¶æ€æ˜¯ä¸ç¡®å®šçš„), è€Œåº”è¯¥éµå¾ªä¸‹é¢çš„åŸåˆ™:\n æ ¹æ®ä½ æ”¶é›†åˆ°çš„éœ€æ±‚è®¾è®¡ä½ çš„ä»£ç ï¼ˆä¸è¦è·³è¿‡è¿™ä¸ªæ­¥éª¤ï¼‰ã€‚ ç¼–å†™æœ€ç®€å•ã€æœ€æ¸…æ™°ã€æœ€æ„šè ¢çš„è®¾è®¡å®ç°ã€‚ å¦‚æœå®¢æˆ·æ»¡æ„ï¼Œå°±åœæ­¢ å¦‚æœå®¢æˆ·ä¸æ»¡æ„ï¼Œè€Œä¸”ä»–ä»¬è®¤ä¸ºåº”ç”¨ç¨‹åºçš„æ€§èƒ½ä¸èƒ½æ»¡è¶³ä»–ä»¬çš„è¦æ±‚ï¼Œé‚£ä¹ˆå°±å‰–æã€‚ è§£å†³æœ€é«˜æ€§èƒ½çš„ä¸»å¯¼è€… å‰–æå¹¶è¿›å…¥ç¬¬äº”é˜¶æ®µã€‚ç„¶åè¿›å…¥3 å¦‚æœå®åœ¨æä¸å®š, å†æƒ³æƒ³sync.Pool  sync.Once åªæ‰§è¡Œä¸€æ¬¡ sync.Once æä¾›äº†ä¸€ç§æ–¹æ³•, è®©ç›¸å…³ä»£ç åªè¢«æ‰§è¡Œä¸€æ¬¡\nå®é™…å¼€å‘è¿‡ç¨‹ä¸­, ç»å¸¸æœ‰è¿™æ ·çš„åœºæ™¯: ä½ åšäº†ä¸€ä¸ªå«åšlowLevelApiçš„åŒ…, ç”¨äºæ§åˆ¶åº•å±‚è®¾å¤‡, æ¯”å¦‚å¼€å…³LED, ä½†åœ¨è°ƒç”¨å¼€å…³LEDä¹‹å‰éœ€è¦ç¡®ä¿ä¸€äº›åˆå§‹åŒ–å·¥ä½œå·²ç»å®Œæˆ, æ‰€ä»¥ä½ å†™äº†ä¸€ä¸ªInitEnvçš„å‡½æ•°, å¹¶å‘Šè¯‰å…¶å®ƒå¼€å‘äººå‘˜: ä¸€å®šè¦å…ˆåˆå§‹åŒ–å“¦.\npackage lowLevelApi  import \"fmt\"  func InitEnv() { \tfmt.Println(\"init environment\") }  func LedOn() { \tfmt.Println(\"LedOn\") }  func LedOff() { \tfmt.Println(\"LedOff\") } å…¶å®ƒå¼€å‘äººå‘˜ç»å¸¸ä¼šé—®ä½ : è¿™ä¸ªåˆå§‹åŒ–å‡½æ•°å¦‚æœè¢«é‡å¤è°ƒç”¨ä¸ä¼šå‡ºé—®é¢˜å§?\nå› ä¸ºä»–ä»¬çš„ä»£ç é€šå¸¸ä¼šè¿™æ ·å†™:\npackage main  import ( \t\"fmt\" \t\"goplayground/lowLevelApi\" )  func turnLedOn() { \tfmt.Println(\"Turning LED on\") \tlowLevelApi.InitEnv() \tlowLevelApi.LedOn() \tfmt.Println(\"LED on\") }  func turnLedOff() { \tfmt.Println(\"Turning LED off\") \tlowLevelApi.InitEnv() \tlowLevelApi.LedOff() \tfmt.Println(\"LED off\") }  func main() { \tturnLedOn() \tturnLedOff() } ä¸Šé¢çš„ä»£ç ä¼šè¾“å‡º\nTurning LED on InitEnv LedOn LED on Turning LED off InitEnv LedOff LED off ä¸ºäº†é˜²æ­¢é‡å¤è°ƒç”¨InitEnv()å¯èƒ½å¸¦æ¥çš„é—®é¢˜, åˆ™å¯ä»¥ä½¿ç”¨sync.Once\nvar ( \tonce sync.Once )  func InitEnv() { \tonce.Do(func() { \tfmt.Println(\"InitEnv\") \t}) } è¿™æ ·InitEnv()å³ä½¿è¢«å¤šæ¬¡è°ƒç”¨, å…¶å†…éƒ¨é€»è¾‘åªä¼šæ‰§è¡Œä¸€æ¬¡\nTurning LED on InitEnv LedOn LED on Turning LED off LedOff LED off sync.Once å¸¸åº”ç”¨äºå•ä¾‹æ¨¡å¼ï¼Œä¾‹å¦‚åˆå§‹åŒ–é…ç½®ã€ä¿æŒæ•°æ®åº“è¿æ¥ç­‰ã€‚ä½œç”¨ä¸ init å‡½æ•°ç±»ä¼¼ï¼Œä½†æœ‰åŒºåˆ«ã€‚\n init å‡½æ•°æ˜¯å½“æ‰€åœ¨çš„ package é¦–æ¬¡è¢«åŠ è½½æ—¶æ‰§è¡Œï¼Œè‹¥è¿Ÿè¿Ÿæœªè¢«ä½¿ç”¨ï¼Œåˆ™æ—¢æµªè´¹äº†å†…å­˜ï¼Œåˆå»¶é•¿äº†ç¨‹åºåŠ è½½æ—¶é—´ã€‚ sync.Once å¯ä»¥åœ¨ä»£ç çš„ä»»æ„ä½ç½®åˆå§‹åŒ–å’Œè°ƒç”¨ï¼Œå› æ­¤å¯ä»¥å»¶è¿Ÿåˆ°ä½¿ç”¨æ—¶å†æ‰§è¡Œï¼Œå¹¶å‘åœºæ™¯ä¸‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚  sync.Cond æ¡ä»¶å˜é‡ sync.Cond ç”¨äºåè°ƒå¤šä¸ªåç¨‹è®¿é—®å…±äº«èµ„æº, å…¶ä¸­æŸäº›åç¨‹å¤„äºé˜»å¡çŠ¶æ€, å¦å¤–ä¸€ä¸ªåç¨‹åœ¨æ¡ä»¶å‡†å¤‡å¥½çš„æ—¶å€™æ¥è®²å…¶å®ƒåç¨‹å”¤é†’.\nä¸‹é¢çš„ä¾‹å­ä¸­ InitEnvå‡½æ•°éœ€è¦ä¸€ç‚¹æ—¶é—´åœ¨å‡†å¤‡sharedCounter çš„åˆå§‹å€¼, åœ¨è¿™æœŸé—´Addå’Œsubå¤„äºWaitçŠ¶æ€, å½“å‡†å¤‡å¥½å, å°†é€šçŸ¥ Addå’ŒSubç»§ç»­å‘ä¸‹æ‰§è¡Œ\npackage main  import ( \t\"fmt\" \t\"sync\" \t\"time\" )  var ( \tsharedCounter int )  func InitEnv(c *sync.Cond) { \tfmt.Println(\"begin InitEnv\") \ttime.Sleep(time.Second * 1) \tc.L.Lock() \tsharedCounter = 10 \tc.L.Unlock() \tfmt.Println(\"Init Env Done, broadcast...\") \tc.Broadcast() }  func Add(cout int, c *sync.Cond) { \tc.L.Lock() \tc.Wait() \tsharedCounter += cout \tc.L.Unlock() \tfmt.Println(\"Add Done\") }  func Sub(count int, c *sync.Cond) { \tc.L.Lock() \tc.Wait() \tsharedCounter -= count \tc.L.Unlock() \tfmt.Println(\"Sub Done\") }  func main() { \tcond := sync.NewCond(\u0026sync.Mutex{}) \tgo InitEnv(cond) \tgo Add(5, cond) \tgo Sub(2, cond)  \ttime.Sleep(2 * time.Second) \tfmt.Println(\"Final Counter:\", sharedCounter) } è¾“å‡º\nbegin InitEnv Init Env Done, broadcast... Add Done Sub Done Final Counter: 13 c.Broadcast()å”¤é†’æ‰€æœ‰ç­‰å¾…çš„åç¨‹, å¦å¤–è¿˜æœ‰ä¸€ä¸ªSignal()æ–¹æ³•, ç”¨äºå”¤é†’ä¸€ä¸ªåç¨‹. sync.Condä¸€èˆ¬ç”¨äºä¸€å¯¹å¤šçš„æƒ…å†µ, å¦‚æœæ˜¯ä¸€å¯¹ä¸€çš„æƒ…å†µ, ç”¨ä¸€ä¸ªä¿¡é“å°±å¯ä»¥è½»æ¾è§£å†³äº†\nsync.Map å†…ç½®çš„mapä¸æ˜¯å¹¶å‘å®‰å…¨çš„, æ‰€ä»¥ sync.Map æä¾›äº†ä¸€ä¸ªåŠŸèƒ½ä¸mapç±»ä¼¼ä½†æ˜¯å¹¶å‘å®‰å…¨çš„ç‰ˆæœ¬\nå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç«  https://juejin.cn/post/6844903895227957262\n","wordCount":"1051","inLanguage":"en","datePublished":"2022-06-02T09:43:29+08:00","dateModified":"2022-06-02T09:43:29+08:00","author":{"@type":"Person","name":"zhouyinhui"},"mainEntityOfPage":{"@type":"WebPage","@id":"/posts/go_talk_about_sync/"},"publisher":{"@type":"Organization","name":"Zhouyinhui's Space","logo":{"@type":"ImageObject","url":"%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href accesskey=h title="Zhouyinhui's Space (Alt + H)">Zhouyinhui's Space</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=../../ title=home><span>home</span></a></li><li><a href=../../tags/ title=tags><span>tags</span></a></li><li><a href=../../archives/ title=archives><span>archives</span></a></li><li><a href=../../search/ title="ğŸ”search (Alt + /)" accesskey=/><span>ğŸ”search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href>Home</a>&nbsp;Â»&nbsp;<a href=../../posts/>Posts</a></div><h1 class=post-title>[Golang]èŠèŠsync</h1><div class=post-meta><span title="2022-06-02 09:43:29 +0800 CST">June 2, 2022</span>&nbsp;Â·&nbsp;zhouyinhui</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84demo aria-label=ä¸€ä¸ªç®€å•çš„DEMO>ä¸€ä¸ªç®€å•çš„DEMO</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e4%b8%80%e4%b8%aa%e5%8d%8f%e7%a8%8b aria-label=ä½¿ç”¨ä¸€ä¸ªåç¨‹>ä½¿ç”¨ä¸€ä¸ªåç¨‹</a><ul><li><a href=#%e7%ad%89%e5%be%85%e5%8d%8f%e7%a8%8b%e7%bb%93%e6%9d%9f aria-label=ç­‰å¾…åç¨‹ç»“æŸ>ç­‰å¾…åç¨‹ç»“æŸ</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a82%e4%b8%aa%e5%8d%8f%e7%a8%8b aria-label=ä½¿ç”¨2ä¸ªåç¨‹>ä½¿ç”¨2ä¸ªåç¨‹</a><ul><li><a href=#%e7%ab%9e%e6%80%81 aria-label=ç«æ€>ç«æ€</a></li><li><a href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%952-%e5%88%a9%e7%94%a8-mutex-%e6%88%96-rwmutex aria-label="è§£å†³æ–¹æ³•2, åˆ©ç”¨ Mutex æˆ– RWMutex">è§£å†³æ–¹æ³•2, åˆ©ç”¨ Mutex æˆ– RWMutex</a></li><li><a href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%953-%e5%88%a9%e7%94%a8%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c aria-label="è§£å†³æ–¹æ³•3, åˆ©ç”¨åŸå­æ“ä½œ">è§£å†³æ–¹æ³•3, åˆ©ç”¨åŸå­æ“ä½œ</a></li></ul></li><li><a href=#%e5%85%b6%e5%ae%83%e5%b9%b6%e5%8f%91%e6%8e%a7%e5%88%b6%e6%96%b9%e6%b3%95 aria-label=å…¶å®ƒå¹¶å‘æ§åˆ¶æ–¹æ³•>å…¶å®ƒå¹¶å‘æ§åˆ¶æ–¹æ³•</a><ul><li><a href=#waitgroup aria-label=WaitGroup>WaitGroup</a></li><li><a href=#contextcontext aria-label=context.Context>context.Context</a></li></ul></li><li><a href=#syncpool-%e5%af%b9%e8%b1%a1%e5%a4%8d%e7%94%a8 aria-label="sync.Pool å¯¹è±¡å¤ç”¨">sync.Pool å¯¹è±¡å¤ç”¨</a></li><li><a href=#synconce-%e5%8f%aa%e6%89%a7%e8%a1%8c%e4%b8%80%e6%ac%a1 aria-label="sync.Once åªæ‰§è¡Œä¸€æ¬¡">sync.Once åªæ‰§è¡Œä¸€æ¬¡</a></li><li><a href=#synccond-%e6%9d%a1%e4%bb%b6%e5%8f%98%e9%87%8f aria-label="sync.Cond æ¡ä»¶å˜é‡">sync.Cond æ¡ä»¶å˜é‡</a></li><li><a href=#syncmap aria-label=sync.Map>sync.Map</a></li></ul></div></details></div><div class=post-content><p>æˆ‘ä»¬å°†ç”¨äº›ç®€å•çš„ä¾‹å­æ¥å°è¯•golangä¸­syncåŒ…çš„å„ç§æœ‰è¶£çš„æƒ…å†µ</p><h2 id=ä¸€ä¸ªç®€å•çš„demo>ä¸€ä¸ªç®€å•çš„DEMO<a hidden class=anchor aria-hidden=true href=#ä¸€ä¸ªç®€å•çš„demo>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sharedCounter</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>count</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>count</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sharedCounter</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sub</span>(<span style=color:#a6e22e>count</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>count</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sharedCounter</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>show</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>sharedCounter</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1000000</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sub</span>(<span style=color:#ae81ff>1000000</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>show</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç¨‹åºå¾ˆç®€å•, æˆ‘ä»¬ç”¨ä¸€ä¸ªå…±äº«å˜é‡<code>sharedCounter</code>ä½œä¸ºä¸€ä¸ªè®¡æ•°å™¨. <code>add</code>å‡½æ•°åœ¨è®¡æ•°å™¨ä¸Šå¾ªç¯æ·»åŠ ä¸€å®šçš„æ•°å€¼, subåˆ™ç›¸å, showåˆ™æ˜¯æ‰“å°è®¡æ•°å™¨å½“å‰çš„å€¼.</p><p>ç¨‹åºè¿è¡Œç»“æŸå, <code>sharedCounter</code>åº”è¯¥ä¸º0, ä¸Šé¢ä»£ç çš„è¾“å‡ºçš„ç¡®å¦‚æ­¤.</p><h2 id=ä½¿ç”¨ä¸€ä¸ªåç¨‹>ä½¿ç”¨ä¸€ä¸ªåç¨‹<a hidden class=anchor aria-hidden=true href=#ä½¿ç”¨ä¸€ä¸ªåç¨‹>#</a></h2><p>å¦‚æœå¯¹è®¡æ•°å™¨è¿›è¡ŒåŠ å‡çš„è°ƒç”¨åœ¨ä¸åŒçš„åç¨‹é‡Œé¢, ä¼šæ€ä¹ˆæ ·å‘¢?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1000000</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>sub</span>(<span style=color:#ae81ff>1000000</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>show</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¼šå¾—åˆ°<code>1000000</code> , å› ä¸º<code>go sub(1000000)</code>åˆšå¯åŠ¨, ç¨‹åºå°±é€€å‡ºäº†.</p><p>æˆ–è®¸æˆ‘ä»¬åº”è¯¥ç­‰åˆ°<code>sub</code>å‡½æ•°æ‰§è¡Œç»“æŸ</p><h3 id=ç­‰å¾…åç¨‹ç»“æŸ>ç­‰å¾…åç¨‹ç»“æŸ<a hidden class=anchor aria-hidden=true href=#ç­‰å¾…åç¨‹ç»“æŸ>#</a></h3><ul><li><p>é”™è¯¯çš„æ–¹å¼
å¦‚æœæœ‰Cè¯­è¨€å¼€å‘èƒŒæ™¯, å¯èƒ½ä¼šæƒ³åˆ°é€šè¿‡è®¾ç½®ä¸€ä¸ªflagæ¥æŒ‡ç¤ºè¿ç®—æ˜¯å¦ç»“æŸ, æ¯”å¦‚:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sub</span>(<span style=color:#a6e22e>count</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>done</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>count</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sharedCounter</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#f92672>*</span><span style=color:#a6e22e>done</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>//....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1000000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>done</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>sub</span>(<span style=color:#ae81ff>1000000</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>done</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>done</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>show</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™è™½ç„¶ä¹Ÿèƒ½å¾—åˆ°æ­£ç¡®çš„è¾“å‡º, ä½†éå¸¸ä¸ä¼˜é›….</p></li><li><p>æ­£ç¡®çš„æ–¹å¼1
å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ— ç¼“å†²çš„ä¿¡é“(æˆ–è€…è¯´å®¹é‡ä¸º1çš„ä¿¡é“)æ¥å……å½“flag</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sub</span>(<span style=color:#a6e22e>count</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>done</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>count</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sharedCounter</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>done</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>//....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1000000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>done</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>sub</span>(<span style=color:#ae81ff>1000000</span>, <span style=color:#a6e22e>done</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>subDone</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>show</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™é‡Œåˆ©ç”¨äº†ä¿¡é“çš„ç‰¹ç‚¹: <strong>å½“ä»ä¿¡é“ä¸­è¯»å–æ•°æ®æ—¶,å¦‚æœä¿¡é“ä¸ºç©º,è¯»å–å°†è¢«é˜»å¡ç›´åˆ°æœ‰æ•°æ®åˆ°è¾¾</strong>. æ‰€ä»¥ <code>&lt;-subDone</code> ä¼šä¸€ç›´é˜»å¡, ç›´åˆ°é€šè¿‡<code>subDone &lt;- true</code>å‘å…¶ä¸­å†™å…¥äº†æ•°æ®</p></li></ul><h2 id=ä½¿ç”¨2ä¸ªåç¨‹>ä½¿ç”¨2ä¸ªåç¨‹<a hidden class=anchor aria-hidden=true href=#ä½¿ç”¨2ä¸ªåç¨‹>#</a></h2><p>ä¸Šé¢çš„ä¾‹å­ä¸­, <code>sub(1000000, done)</code>æ˜¯åœ¨æ–°çš„åç¨‹ä¸­è¿è¡Œçš„, <code>add(1000000)</code>å´ä¸æ˜¯, å¦‚æœä»–ä»¬éƒ½åœ¨æ–°åç¨‹ä¸­è¿è¡Œ, ä¸»ç¨‹åºåº”è¯¥å¦‚ä½•ç­‰å¾…ä»–ä»¬ç»“æŸå‘¢</p><p>å¾ˆå®¹æ˜“æƒ³åˆ°, ä½¿ç”¨ä¸¤æ¬¡<code>&lt;-done</code> ä¹Ÿå°±æ˜¯è¯´å‘ä¿¡é“ç´¢è¦ä¸¤ä¸ªè®¡ç®—å®Œæˆçš„æ ‡å¿—, <code>add</code>å’Œ <code>sub</code> è®¡ç®—å®Œæˆååˆ†åˆ«å‘å…¶ä¸­æ”¾å…¥æ ‡å¿—.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sharedCounter</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>count</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>done</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>count</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sharedCounter</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;add done&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>done</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sub</span>(<span style=color:#a6e22e>count</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>done</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>count</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sharedCounter</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;sub done&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>done</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>show</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>sharedCounter</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>done</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1000000</span>, <span style=color:#a6e22e>done</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>sub</span>(<span style=color:#ae81ff>1000000</span>, <span style=color:#a6e22e>done</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>done</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>done</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>show</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¸ºäº†æ˜ç¡®çŸ¥é“mainå‡½æ•°çš„ç¡®æ˜¯ç­‰å¾…ä¸¤ä¸ªåç¨‹æ‰§è¡Œå®Œæ¯•äº†çš„, æˆ‘ä»¬åœ¨å…¶ä¸­åŠ å…¥äº†<code>fmt.Println("sub done")</code>è¿™æ ·çš„è¾“å‡º</p><p>è¿è¡Œç¨‹åº, å¾—åˆ°</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>add <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>sub <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>824933</span>
</span></span></code></pre></div><p><strong>Opps, è™½ç„¶<code>add</code>å’Œ<code>sub</code> éƒ½æ‰§è¡Œå®Œæ¯•äº†,ä½†æ˜¯ç»“æœä¸å¯¹(å¹¶ä¸”å¤šæ¬¡è¿è¡Œçš„ç»“æœè¿˜ä¸ç›¸åŒ), æœŸæœ›æ¥æ”¶åº”è¯¥æ˜¯<code>0</code></strong></p><p>å†è¿è¡Œä¸€æ¬¡, å¾—åˆ°:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sub <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>add <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>-481342
</span></span></code></pre></div><p>åŸå› æ˜¯<code>add</code>å’Œ<code>sub</code>åœ¨äº¤å‰è¯»å–å’Œå†™å…¥<code>sharedCounter</code>è¿™ä¸ªå˜é‡, ä»–ä»¬å…±äº«äº†å˜é‡, ä½†åœ¨è¯»å–å’Œå†™å…¥çš„æ—¶å€™å‡ºç°**&ldquo;ç«æ€&rdquo;**</p><h3 id=ç«æ€>ç«æ€<a hidden class=anchor aria-hidden=true href=#ç«æ€>#</a></h3><p>æœ‰å¤šä¸ªåç¨‹è¿è¡Œæ—¶, å¯¹äºæ¯ä¸ªåç¨‹è€Œè¨€,å…¶å†…éƒ¨ä»£ç æ—¶é¡ºåºæ‰§è¡Œçš„, ä½†æ— æ³•ç¡®å®šåç¨‹ä¹‹é—´çš„æ‰§è¡Œé¡ºåº, é‚£ä¹ˆå°±è¯´è¿™äº›åç¨‹æ˜¯å¹¶å‘çš„</p><p>å¦‚æœä¸€æ®µä»£ç æ— è®ºæ˜¯é¡ºåºæ‰§è¡Œè¿˜æ˜¯å¹¶å‘æ‰§è¡Œ,å…¶ç»“æœéƒ½æ˜¯ç¡®å®šçš„,é‚£ä¹ˆè¿™ä¸ªä»£ç å°±æ˜¯å¹¶å‘å®‰å…¨çš„.</p><p>ç›¸å, å¹¶å‘ä¸å®‰å…¨çš„ä»£ç ,å¯èƒ½ä¼šå‡ºç°æ­»é”,æ´»é”,ç«æ€</p><p>ç«æ€åˆ™è¡¨ç¤ºä»£ç å¯æ‰§è¡Œ,ä½†å¯èƒ½å‡ºç°ç»“æœä¸ä¸€è‡´(é”™è¯¯ç»“æœ)</p><p>###è§£å†³æ–¹æ³•1, åˆ©ç”¨ä¿¡é“</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>done</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1000000</span>, <span style=color:#a6e22e>done</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>done</span> <span style=color:#75715e>//1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>sub</span>(<span style=color:#ae81ff>1000000</span>, <span style=color:#a6e22e>done</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>done</span> <span style=color:#75715e>//2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>show</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨<code>add</code>æ‰§è¡Œå®Œæ¯•ä¹‹å‰, é¦–å…ˆä¼šå µå¡åœ¨<code>//1</code>å¤„,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>count</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>done</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>//....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>done</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>add</code>å‡½æ•°æ‰§è¡Œæœ€åä¸€å¥ <code>done &lt;- true</code> å <code>&lt;-done //1</code>èƒ½å–åˆ°å€¼, æ¥è§¦é˜»å¡. ç„¶åç»§ç»­å¾€ä¸‹æ‰§è¡Œ<code>sub</code>å‡½æ•°.</p><p>è¿™è™½ç„¶èƒ½å¾—åˆ°æ­£ç¡®è¾“å‡º, ä½†, æˆ‘ä»¬å‘ç°, <strong>è¿™å®é™…æ˜¯å°†å¹¶è¡Œæ‰§è¡Œä¿®æ”¹æˆäº†ä¸²è¡Œæ‰§è¡Œ.</strong></p><h3 id=è§£å†³æ–¹æ³•2-åˆ©ç”¨-mutex-æˆ–-rwmutex>è§£å†³æ–¹æ³•2, åˆ©ç”¨ Mutex æˆ– RWMutex<a hidden class=anchor aria-hidden=true href=#è§£å†³æ–¹æ³•2-åˆ©ç”¨-mutex-æˆ–-rwmutex>#</a></h3><p>sync.Mutex å¯èƒ½æ˜¯åŒæ­¥åŒ…ä¸­ä½¿ç”¨æœ€å¹¿æ³›çš„åŸè¯­ã€‚å®ƒå…è®¸å¯¹å…±äº«èµ„æºè¿›è¡Œäº’æ–¥ï¼ˆä¸èƒ½åŒæ—¶è®¿é—®).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>mutex</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mutex</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span><span style=color:#75715e>//.... æ›´æ–°å…±äº«å˜é‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>mutex</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span></code></pre></div><p>æ³¨æ„: åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æœ‰è¿™ä¹ˆä¸€å¥ &ldquo;Values containing the types defined in this package should not be copied.&rdquo; (&ldquo;åŒ…å«è¿™ä¸ªåŒ…ä¸­å®šä¹‰çš„ç±»å‹çš„å€¼ä¸åº”è¯¥è¢«å¤åˆ¶ã€‚&rdquo;) . æˆ‘ä»¬ç›´åˆ°å€¼ä¼ é€’å°±æ˜¯å¤åˆ¶ç„¶åä¼ é€’, æ‰€ä»¥æˆ‘ä»¬ä»£ç ä¸­çš„mutexç”¨çš„æ˜¯å¼•ç”¨ä¼ é€’.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sharedCounter</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mutex</span>         = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>{}
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>count</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>done</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>count</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mutex</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sharedCounter</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mutex</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;add done&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>done</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sub</span>(<span style=color:#a6e22e>count</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>done</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>count</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mutex</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sharedCounter</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mutex</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;sub done&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>done</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>show</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>sharedCounter</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>done</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1000000</span>, <span style=color:#a6e22e>done</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>sub</span>(<span style=color:#ae81ff>1000000</span>, <span style=color:#a6e22e>done</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>done</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>done</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>show</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨è¯»å†™<code>sharedCounter</code>ä¹‹å‰å…ˆ<code>Lock()</code>, ç”¨å®Œå<code>Unlock()</code></p><p>å¦‚æœæˆ‘ä»¬åœ¨è¿›è¡Œè®¡ç®—çš„æ—¶å€™åŠ ä¸Šç‚¹æ‰“å°(ä»…æµ‹è¯•ç”¨,éå¸¸å½±å“é€Ÿåº¦)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>count</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mutex</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;--&#34;</span>) <span style=color:#75715e>// fmt.Println(&#34;++&#34;)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>sharedCounter</span><span style=color:#f92672>--</span>   <span style=color:#75715e>// sharedCounter++
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>mutex</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>åˆ™å¯ä»¥çœ‹åˆ° ++ å’Œ &ndash; æ˜¯äº¤å‰ç€æ‰“å°çš„, è¯´æ˜æ˜¯å¹¶è¡Œæ‰§è¡Œçš„.</p><p>å¦å¤–, è¿˜æœ‰<code>RWMutex</code> (è¯»å†™é”), é™¤äº†ä¸<code>Mutex</code>ç›¸åŒçš„<code>Lock()</code>å’Œ<code>Unlock()</code>æ–¹æ³•å¤–, å…¶è¿˜æœ‰ç”¨äºå…±äº«è¯»æ“ä½œçš„<code>RLock()</code>å’Œ<code>RUnlock()</code>, åœ¨è¯»å–å…±äº«å˜é‡æ—¶å…è®¸åŒæ—¶å¤šä¸ªè¯»å–å™¨èƒ½æé«˜æ•ˆç‡. æ‰€ä»¥åœ¨é¢‘ç¹è¯»å†™æ“ä½œçš„ä»£ç ä¸­, ä½¿ç”¨<code>RWMutex</code>æ•ˆç‡è¦æ¯”<code>Mutex</code>é«˜</p><h3 id=è§£å†³æ–¹æ³•3-åˆ©ç”¨åŸå­æ“ä½œ>è§£å†³æ–¹æ³•3, åˆ©ç”¨åŸå­æ“ä½œ<a hidden class=anchor aria-hidden=true href=#è§£å†³æ–¹æ³•3-åˆ©ç”¨åŸå­æ“ä½œ>#</a></h3><p>åŸå­æ“ä½œåœ¨<code>"sync/atomic"</code>åŒ…ä¸­. åˆ©ç”¨è¿™ä¸ªåŒ…ä¸­æä¾›çš„å‡½æ•°å¯å®ç°"æ— é”ç‰ˆ"çš„å…±äº«å˜é‡è¯»å†™</p><p><code>åŸå­æ“ä½œ</code>å³æ˜¯è¿›è¡Œè¿‡ç¨‹ä¸­ä¸èƒ½è¢«ä¸­æ–­çš„æ“ä½œï¼Œé’ˆå¯¹æŸä¸ªå€¼çš„åŸå­æ“ä½œåœ¨è¢«è¿›è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒCPUç»ä¸ä¼šå†å»è¿›è¡Œå…¶ä»–çš„é’ˆå¯¹è¯¥å€¼çš„æ“ä½œã€‚ä¸ºäº†å®ç°è¿™æ ·çš„ä¸¥è°¨æ€§ï¼ŒåŸå­æ“ä½œä»…ä¼šç”±ä¸€ä¸ªç‹¬ç«‹çš„CPUæŒ‡ä»¤ä»£è¡¨å’Œå®Œæˆã€‚<strong>åŸå­æ“ä½œæ˜¯æ— é”çš„ï¼Œå¸¸å¸¸ç›´æ¥é€šè¿‡CPUæŒ‡ä»¤ç›´æ¥å®ç°ã€‚</strong> äº‹å®ä¸Šï¼Œå…¶å®ƒåŒæ­¥æŠ€æœ¯çš„å®ç°å¸¸å¸¸ä¾èµ–äºåŸå­æ“ä½œ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;sync/atomic&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sharedCounter</span> = int64(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>count</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>done</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>count</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sharedCounter</span>, <span style=color:#ae81ff>1</span>) <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;add done&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>done</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sub</span>(<span style=color:#a6e22e>count</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>done</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>count</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sharedCounter</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;sub done&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>done</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>show</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>sharedCounter</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>done</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1000000</span>, <span style=color:#a6e22e>done</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>sub</span>(<span style=color:#ae81ff>1000000</span>, <span style=color:#a6e22e>done</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>done</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>done</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>show</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åŸå­æ“ä½œçš„å¸¸ç”¨æ¥å£å¦‚ä¸‹(ä»¥<code>int32</code>ä¸ºä¾‹)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//å°†addræŒ‡å‘çš„å€¼å’Œoldè¿›è¡Œæ¯”è¾ƒ, å¦‚æœç›¸ç­‰,åˆ™å°†newèµ‹å€¼åˆ°addræŒ‡å‘çš„ä½ç½®,å¹¶è¿”å›true, å¦‚æœä¸ç›¸ç­‰,åˆ™ç›´æ¥è¿”å›false
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>CompareAndSwapInt32</span>(<span style=color:#a6e22e>addr</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>int32</span>, <span style=color:#a6e22e>old</span>, <span style=color:#a6e22e>new</span> <span style=color:#66d9ef>int32</span>) (<span style=color:#a6e22e>swapped</span> <span style=color:#66d9ef>bool</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//ä½¿ç”¨åŸå­æ“ä½œ,å°†addræŒ‡å‘çš„ä½ç½®å¢åŠ ä¸€ä¸ªdelta
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>AddInt32</span>(<span style=color:#a6e22e>addr</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>int32</span>, <span style=color:#a6e22e>delta</span> <span style=color:#66d9ef>int32</span>) (<span style=color:#a6e22e>new</span> <span style=color:#66d9ef>int32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//åŸå­è¯»å–
</span></span></span><span style=display:flex><span><span style=color:#75715e>//å½“æˆ‘ä»¬è¦è¯»å–ä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œå¾ˆæœ‰å¯èƒ½è¿™ä¸ªå˜é‡æ­£åœ¨è¢«å†™å…¥ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¾ˆæœ‰å¯èƒ½è¯»å–åˆ°å†™åˆ°ä¸€åŠçš„æ•°æ®ã€‚ æ‰€ä»¥è¯»å–æ“ä½œæ˜¯éœ€è¦ä¸€ä¸ªåŸå­è¡Œä¸ºçš„ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>LoadInt32</span>(<span style=color:#a6e22e>addr</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>int32</span>) (<span style=color:#a6e22e>val</span> <span style=color:#66d9ef>int32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//è¯»å–æ˜¯æœ‰åŸå­æ€§çš„æ“ä½œçš„ï¼ŒåŒæ ·å†™å…¥atomicåŒ…ä¹Ÿæä¾›äº†ç›¸å…³çš„æ“ä½œåŒ…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>StoreInt32</span>(<span style=color:#a6e22e>addr</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>int32</span>, <span style=color:#a6e22e>val</span> <span style=color:#66d9ef>int32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//æ­¤ç±»å‹çš„å€¼ç›¸å½“äºä¸€ä¸ªå®¹å™¨ï¼Œå¯ä»¥è¢«ç”¨æ¥â€œåŸå­åœ°&#34;å­˜å‚¨ï¼ˆStoreï¼‰å’ŒåŠ è½½ï¼ˆLoadï¼‰ä»»æ„ç±»å‹çš„å€¼ã€‚å½“ç„¶è¿™ä¸ªç±»å‹ä¹Ÿæ˜¯åŸå­æ€§çš„ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e>//æœ‰äº†atomic.Valueè¿™ä¸ªç±»å‹ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥åœ¨ä¸ä¾èµ–Goå†…éƒ¨ç±»å‹unsafe.Pointerçš„æƒ…å†µä¸‹ä½¿ç”¨åˆ°atomicæä¾›çš„åŸå­æ“ä½œã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e>// A Value must not be copied after first use.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Value</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>v</span> <span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>åŸå­æ“ä½œä¸äº’æ–¥é”çš„åŒºåˆ«</p><p>é¦–å…ˆatomicæ“ä½œçš„ä¼˜åŠ¿æ˜¯æ›´è½»é‡ï¼Œæ¯”å¦‚CASå¯ä»¥åœ¨ä¸å½¢æˆä¸´ç•ŒåŒºå’Œåˆ›å»ºäº’æ–¥é‡çš„æƒ…å†µä¸‹å®Œæˆå¹¶å‘å®‰å…¨çš„å€¼æ›¿æ¢æ“ä½œã€‚è¿™å¯ä»¥å¤§å¤§çš„å‡å°‘åŒæ­¥å¯¹ç¨‹åºæ€§èƒ½çš„æŸè€—ã€‚</p><p>åŸå­æ“ä½œä¹Ÿæœ‰åŠ£åŠ¿ã€‚è¿˜æ˜¯ä»¥CASæ“ä½œä¸ºä¾‹ï¼Œä½¿ç”¨CASæ“ä½œçš„åšæ³•è¶‹äºä¹è§‚ï¼Œæ€»æ˜¯å‡è®¾è¢«æ“ä½œå€¼æœªæ›¾è¢«æ”¹å˜ï¼ˆå³ä¸æ—§å€¼ç›¸ç­‰ï¼‰ï¼Œå¹¶ä¸€æ—¦ç¡®è®¤è¿™ä¸ªå‡è®¾çš„çœŸå®æ€§å°±ç«‹å³è¿›è¡Œå€¼æ›¿æ¢ï¼Œé‚£ä¹ˆåœ¨è¢«æ“ä½œå€¼è¢«é¢‘ç¹å˜æ›´çš„æƒ…å†µä¸‹ï¼ŒCASæ“ä½œå¹¶ä¸é‚£ä¹ˆå®¹æ˜“æˆåŠŸã€‚è€Œä½¿ç”¨äº’æ–¥é”çš„åšæ³•åˆ™è¶‹äºæ‚²è§‚ï¼Œæˆ‘ä»¬æ€»å‡è®¾ä¼šæœ‰å¹¶å‘çš„æ“ä½œè¦ä¿®æ”¹è¢«æ“ä½œçš„å€¼ï¼Œå¹¶ä½¿ç”¨é”å°†ç›¸å…³æ“ä½œæ”¾å…¥ä¸´ç•ŒåŒºä¸­åŠ ä»¥ä¿æŠ¤ã€‚</p><p>ä¸‹é¢æ˜¯å‡ ç‚¹åŒºåˆ«ï¼š</p><ul><li>äº’æ–¥é”æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œç”¨æ¥è®©ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç¨‹åºçš„å…³é”®éƒ¨åˆ†ï¼Œå®Œæˆäº’æ–¥çš„å¤šä¸ªæ“ä½œ</li><li>åŸå­æ“ä½œæ˜¯æ— é”çš„ï¼Œå¸¸å¸¸ç›´æ¥é€šè¿‡CPUæŒ‡ä»¤ç›´æ¥å®ç°</li><li>åŸå­æ“ä½œä¸­çš„casè¶‹äºä¹è§‚é”ï¼ŒCASæ“ä½œå¹¶ä¸é‚£ä¹ˆå®¹æ˜“æˆåŠŸï¼Œéœ€è¦åˆ¤æ–­ï¼Œç„¶åå°è¯•å¤„ç†</li><li>å¯ä»¥æŠŠäº’æ–¥é”ç†è§£ä¸ºæ‚²è§‚é”ï¼Œå…±äº«èµ„æºæ¯æ¬¡åªç»™ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œå…¶å®ƒçº¿ç¨‹é˜»å¡ï¼Œç”¨å®Œåå†æŠŠèµ„æºè½¬è®©ç»™å…¶å®ƒçº¿ç¨‹</li></ul></blockquote><blockquote><p>ä¸è¦è½»æ˜“ä½¿ç”¨atomic</p><p><a href=https://texlution.com/post/golang-lock-free-values-with-atomic-value/>https://texlution.com/post/golang-lock-free-values-with-atomic-value/</a></p></blockquote><h2 id=å…¶å®ƒå¹¶å‘æ§åˆ¶æ–¹æ³•>å…¶å®ƒå¹¶å‘æ§åˆ¶æ–¹æ³•<a hidden class=anchor aria-hidden=true href=#å…¶å®ƒå¹¶å‘æ§åˆ¶æ–¹æ³•>#</a></h2><p>ä¸Šé¢çš„ä¾‹å­ä¸­, æˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨çš„ä¿¡é“æ¥è¿›è¡Œå¹¶å‘æ§åˆ¶ (<code>done &lt;- true</code>ä¸<code>&lt;-done</code>), è¿™åªæ˜¯å¸¸ç”¨çš„æ–¹æ³•ä¹‹ä¸€</p><h3 id=waitgroup>WaitGroup<a hidden class=anchor aria-hidden=true href=#waitgroup>#</a></h3><p><code>sync.WaitGroup </code>æ‹¥æœ‰ä¸€ä¸ªå†…éƒ¨è®¡æ•°å™¨ã€‚å¦‚æœæ­¤è®¡æ•°å™¨ç­‰äº 0ï¼Œåˆ™ <code>Wait()</code> æ–¹æ³•ç«‹å³è¿”å›ã€‚å¦åˆ™ï¼Œå®ƒå°†è¢«é˜»å¡ï¼Œç›´åˆ°è®¡æ•°å™¨ä¸º 0ã€‚</p><p>è¦å¢åŠ è®¡æ•°å™¨ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨<code> Add(int)</code>ã€‚è¦å‡å°‘å®ƒï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>Done()</code> ï¼ˆå°†å‡å°‘ 1ï¼‰æˆ–å…·æœ‰è´Ÿå€¼çš„ç›¸åŒ <code>Add(int)</code> æ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;sync/atomic&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>sharedCounter</span> = int64(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>count</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>wg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>) {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>count</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sharedCounter</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;add done&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sub</span>(<span style=color:#a6e22e>count</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>wg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>) {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>count</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sharedCounter</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;sub done&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>show</span>() {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>sharedCounter</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>wg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>{}
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1000000</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>wg</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>sub</span>(<span style=color:#ae81ff>1000000</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>wg</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>show</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ³¨æ„:ä¼ é€’ <code>WaitGroup</code>æ—¶è¦ä½¿ç”¨å¼•ç”¨ä¼ é€’(æŒ‡é’ˆ), å…¶ä¸åº”è¯¥è¢«å¤åˆ¶. <code>func sub(count int, wg *sync.WaitGroup)</code></p><h3 id=contextcontext>context.Context<a hidden class=anchor aria-hidden=true href=#contextcontext>#</a></h3><p><code>Context</code>æä¾›äº†2ä¸ªåŠŸèƒ½</p><ol><li>æ§åˆ¶å­åç¨‹ç»“æŸ</li><li>ä¼ é€’å€¼</li></ol><p>å…¶ä¸åœ¨<code>sync</code>åŒ…ä¸­, åé¢ä¸“é—¨è®²</p><h2 id=syncpool-å¯¹è±¡å¤ç”¨>sync.Pool å¯¹è±¡å¤ç”¨<a hidden class=anchor aria-hidden=true href=#syncpool-å¯¹è±¡å¤ç”¨>#</a></h2><p>å…¶æä¾›ä¸€ä¸ª"å¹¶å‘å®‰å…¨"çš„å¯å¤ç”¨çš„å¯¹è±¡æ± . ç”¨æ¥å‡å°‘é¢‘ç¹GCæ‰€ä»£ç†çš„å‹åŠ›.</p><p>å…¶å¤§æ¦‚æ„æ€æ˜¯: å¦‚æœæœ‰æ—§å¯¹è±¡å¯ç”¨,åˆ™ç”¨æ—§çš„, æ²¡æœ‰å†Newä¸€ä¸ª</p><p>å‚è€ƒè¿™æ‰¹æ–‡ç« : <a href=https://www.cnblogs.com/qcrao-2018/p/12736031.html>https://www.cnblogs.com/qcrao-2018/p/12736031.html</a></p><p>ä»¥åŠè¿™é‡Œ <a href=https://geektutu.com/post/hpg-sync-pool.html>https://geektutu.com/post/hpg-sync-pool.html</a></p><p>åœ¨å®é™…å¼€å‘å·¥ä½œä¸­, ä¸è¦ä¸€ä¸Šæ¥å°±æƒ³åšä½¿ç”¨<code>sync.Pool</code>å®ƒé€šå¸¸ä¼šå¸¦æ¥é—®é¢˜(å› ä¸ºå…¶<code>Get</code>å‡ºæ¥çš„å¯¹è±¡çš„çŠ¶æ€æ˜¯ä¸ç¡®å®šçš„), è€Œåº”è¯¥éµå¾ªä¸‹é¢çš„åŸåˆ™:</p><ol><li>æ ¹æ®ä½ æ”¶é›†åˆ°çš„éœ€æ±‚è®¾è®¡ä½ çš„ä»£ç ï¼ˆä¸è¦è·³è¿‡è¿™ä¸ªæ­¥éª¤ï¼‰ã€‚</li><li>ç¼–å†™æœ€ç®€å•ã€æœ€æ¸…æ™°ã€æœ€æ„šè ¢çš„è®¾è®¡å®ç°ã€‚</li><li>å¦‚æœå®¢æˆ·æ»¡æ„ï¼Œå°±åœæ­¢</li><li>å¦‚æœå®¢æˆ·ä¸æ»¡æ„ï¼Œè€Œä¸”ä»–ä»¬è®¤ä¸ºåº”ç”¨ç¨‹åºçš„æ€§èƒ½ä¸èƒ½æ»¡è¶³ä»–ä»¬çš„è¦æ±‚ï¼Œé‚£ä¹ˆå°±å‰–æã€‚</li><li>è§£å†³æœ€é«˜æ€§èƒ½çš„ä¸»å¯¼è€…</li><li>å‰–æå¹¶è¿›å…¥ç¬¬äº”é˜¶æ®µã€‚ç„¶åè¿›å…¥3</li><li>å¦‚æœå®åœ¨æä¸å®š, å†æƒ³æƒ³<code>sync.Pool</code></li></ol><h2 id=synconce-åªæ‰§è¡Œä¸€æ¬¡>sync.Once åªæ‰§è¡Œä¸€æ¬¡<a hidden class=anchor aria-hidden=true href=#synconce-åªæ‰§è¡Œä¸€æ¬¡>#</a></h2><p>sync.Once æä¾›äº†ä¸€ç§æ–¹æ³•, è®©ç›¸å…³ä»£ç åªè¢«æ‰§è¡Œä¸€æ¬¡</p><p>å®é™…å¼€å‘è¿‡ç¨‹ä¸­, ç»å¸¸æœ‰è¿™æ ·çš„åœºæ™¯: ä½ åšäº†ä¸€ä¸ªå«åš<code>lowLevelApi</code>çš„åŒ…, ç”¨äºæ§åˆ¶åº•å±‚è®¾å¤‡, æ¯”å¦‚å¼€å…³LED, ä½†åœ¨è°ƒç”¨å¼€å…³LEDä¹‹å‰éœ€è¦ç¡®ä¿ä¸€äº›åˆå§‹åŒ–å·¥ä½œå·²ç»å®Œæˆ, æ‰€ä»¥ä½ å†™äº†ä¸€ä¸ª<code>InitEnv</code>çš„å‡½æ•°, å¹¶å‘Šè¯‰å…¶å®ƒå¼€å‘äººå‘˜: ä¸€å®šè¦å…ˆåˆå§‹åŒ–å“¦.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>lowLevelApi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>InitEnv</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;init environment&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>LedOn</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;LedOn&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>LedOff</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;LedOff&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å…¶å®ƒå¼€å‘äººå‘˜ç»å¸¸ä¼šé—®ä½ : è¿™ä¸ªåˆå§‹åŒ–å‡½æ•°å¦‚æœè¢«é‡å¤è°ƒç”¨ä¸ä¼šå‡ºé—®é¢˜å§?</p><p>å› ä¸ºä»–ä»¬çš„ä»£ç é€šå¸¸ä¼šè¿™æ ·å†™:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;goplayground/lowLevelApi&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>turnLedOn</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Turning LED on&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lowLevelApi</span>.<span style=color:#a6e22e>InitEnv</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lowLevelApi</span>.<span style=color:#a6e22e>LedOn</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;LED on&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>turnLedOff</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Turning LED off&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lowLevelApi</span>.<span style=color:#a6e22e>InitEnv</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lowLevelApi</span>.<span style=color:#a6e22e>LedOff</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;LED off&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>turnLedOn</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>turnLedOff</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¸Šé¢çš„ä»£ç ä¼šè¾“å‡º</p><pre tabindex=0><code>Turning LED on
InitEnv
LedOn
LED on
Turning LED off
InitEnv
LedOff
LED off
</code></pre><p>ä¸ºäº†é˜²æ­¢é‡å¤è°ƒç”¨<code>InitEnv()</code>å¯èƒ½å¸¦æ¥çš„é—®é¢˜, åˆ™å¯ä»¥ä½¿ç”¨<code>sync.Once</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>once</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Once</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>InitEnv</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>once</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;InitEnv&#34;</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™æ ·<code>InitEnv()</code>å³ä½¿è¢«å¤šæ¬¡è°ƒç”¨, å…¶å†…éƒ¨é€»è¾‘åªä¼šæ‰§è¡Œä¸€æ¬¡</p><pre tabindex=0><code>Turning LED on
InitEnv
LedOn
LED on
Turning LED off
LedOff
LED off
</code></pre><p><code>sync.Once</code> å¸¸åº”ç”¨äºå•ä¾‹æ¨¡å¼ï¼Œä¾‹å¦‚åˆå§‹åŒ–é…ç½®ã€ä¿æŒæ•°æ®åº“è¿æ¥ç­‰ã€‚ä½œç”¨ä¸ <code>init</code> å‡½æ•°ç±»ä¼¼ï¼Œä½†æœ‰åŒºåˆ«ã€‚</p><ul><li>init å‡½æ•°æ˜¯å½“æ‰€åœ¨çš„ package é¦–æ¬¡è¢«åŠ è½½æ—¶æ‰§è¡Œï¼Œè‹¥è¿Ÿè¿Ÿæœªè¢«ä½¿ç”¨ï¼Œåˆ™æ—¢æµªè´¹äº†å†…å­˜ï¼Œåˆå»¶é•¿äº†ç¨‹åºåŠ è½½æ—¶é—´ã€‚</li><li>sync.Once å¯ä»¥åœ¨ä»£ç çš„ä»»æ„ä½ç½®åˆå§‹åŒ–å’Œè°ƒç”¨ï¼Œå› æ­¤å¯ä»¥å»¶è¿Ÿåˆ°ä½¿ç”¨æ—¶å†æ‰§è¡Œï¼Œå¹¶å‘åœºæ™¯ä¸‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li></ul><h2 id=synccond-æ¡ä»¶å˜é‡>sync.Cond æ¡ä»¶å˜é‡<a hidden class=anchor aria-hidden=true href=#synccond-æ¡ä»¶å˜é‡>#</a></h2><p><code>sync.Cond</code> ç”¨äºåè°ƒå¤šä¸ªåç¨‹è®¿é—®å…±äº«èµ„æº, å…¶ä¸­æŸäº›åç¨‹å¤„äºé˜»å¡çŠ¶æ€, å¦å¤–ä¸€ä¸ªåç¨‹åœ¨æ¡ä»¶å‡†å¤‡å¥½çš„æ—¶å€™æ¥è®²å…¶å®ƒåç¨‹å”¤é†’.</p><p>ä¸‹é¢çš„ä¾‹å­ä¸­ <code>InitEnv</code>å‡½æ•°éœ€è¦ä¸€ç‚¹æ—¶é—´åœ¨å‡†å¤‡<code>sharedCounter</code> çš„åˆå§‹å€¼, åœ¨è¿™æœŸé—´<code>Add</code>å’Œ<code>sub</code>å¤„äº<code>Wait</code>çŠ¶æ€, å½“å‡†å¤‡å¥½å, å°†é€šçŸ¥ <code>Add</code>å’Œ<code>Sub</code>ç»§ç»­å‘ä¸‹æ‰§è¡Œ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sharedCounter</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>InitEnv</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Cond</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;begin InitEnv&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>L</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sharedCounter</span> = <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>L</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Init Env Done, broadcast...&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Broadcast</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>cout</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Cond</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>L</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sharedCounter</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>cout</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>L</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Add Done&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Sub</span>(<span style=color:#a6e22e>count</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Cond</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>L</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sharedCounter</span> <span style=color:#f92672>-=</span> <span style=color:#a6e22e>count</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>L</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Sub Done&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cond</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>NewCond</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>{})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>InitEnv</span>(<span style=color:#a6e22e>cond</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>5</span>, <span style=color:#a6e22e>cond</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>Sub</span>(<span style=color:#ae81ff>2</span>, <span style=color:#a6e22e>cond</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Final Counter:&#34;</span>, <span style=color:#a6e22e>sharedCounter</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¾“å‡º</p><pre tabindex=0><code>begin InitEnv
Init Env Done, broadcast...
Add Done
Sub Done
Final Counter: 13
</code></pre><p><code>c.Broadcast()</code>å”¤é†’æ‰€æœ‰ç­‰å¾…çš„åç¨‹, å¦å¤–è¿˜æœ‰ä¸€ä¸ª<code>Signal()</code>æ–¹æ³•, ç”¨äºå”¤é†’ä¸€ä¸ªåç¨‹. <code>sync.Cond</code>ä¸€èˆ¬ç”¨äºä¸€å¯¹å¤šçš„æƒ…å†µ, å¦‚æœæ˜¯ä¸€å¯¹ä¸€çš„æƒ…å†µ, ç”¨ä¸€ä¸ªä¿¡é“å°±å¯ä»¥è½»æ¾è§£å†³äº†</p><h2 id=syncmap>sync.Map<a hidden class=anchor aria-hidden=true href=#syncmap>#</a></h2><p>å†…ç½®çš„<code>map</code>ä¸æ˜¯å¹¶å‘å®‰å…¨çš„, æ‰€ä»¥ <code>sync.Map</code> æä¾›äº†ä¸€ä¸ªåŠŸèƒ½ä¸<code>map</code>ç±»ä¼¼ä½†æ˜¯å¹¶å‘å®‰å…¨çš„ç‰ˆæœ¬</p><p>å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç«  <a href=https://juejin.cn/post/6844903895227957262>https://juejin.cn/post/6844903895227957262</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=../../tags/#go%23/>#go#</a></li><li><a href=../../tags/#golang%23/>#golang#</a></li><li><a href=../../tags/#sync%23/>#sync#</a></li></ul><nav class=paginav><a class=prev href=../../posts/golang_http_server/><span class=title>Â« Prev Page</span><br><span>[Golang]Http Server</span></a>
<a class=next href=../../posts/golang_overseer_restart_app/><span class=title>Next Page Â»</span><br><span>[Golang] ä½¿ç”¨overseerå®ç°APPé‡å¯</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href>Zhouyinhui's Space</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>