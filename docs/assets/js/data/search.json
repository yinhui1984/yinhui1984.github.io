[
  
  {
    "title": "golang GetHashCode",
    "url": "/posts/golang-gethashcode/",
    "categories": "BlockChain, golang",
    "tags": "hash",
    "date": "2022-06-23 00:00:00 +0800",
    





    "snippet": "ä¸€ä¸ªç®€å•çš„helperå‡½æ•°package helpersimport (\t\"crypto/sha256\"\t\"encoding/hex\"\t\"encoding/json\")func GetHashCode(i interface{}) string {\ts := GetHashCodeHex(i)\treturn hex.EncodeToString(s[:])}func GetHashCodeHex(i interface{}) [32]byte {\tj, err := json.Marshal(i)\tif err != nil {\t\tpanic(\"can not Marshal\")\t}\treturn sha256.Sum256(j)}  ç¼ºé™·:  å¯¹äºç»“æ„ä½“, ç”Ÿæˆhashcodeæ—¶åªä½¿ç”¨äº†publicå­—æ®µ, å¦‚æœåŒä¸€ç»“æ„ä½“ç±»å‹çš„ä¸¤ä¸ªå¯¹è±¡åªæœ‰privateå­—æ®µä¸åŒ, é‚£ä¹ˆå…¶ç”Ÿæˆçš„hashcodeæ˜¯ä¸€æ ·çš„æµ‹è¯•:package main_testimport (\t\"goplayground/helpers\"\t\"testing\")func TestGetHashCode(t *testing.T) {\tt.Run(\"åŸºæœ¬ç±»å‹æµ‹è¯•\", func(t *testing.T) {\t\tt.Helper()\t\t_ = helpers.GetHashCode(1)\t\t_ = helpers.GetHashCode(1.23)\t\t_ = helpers.GetHashCode(\"abc\")\t\tif helpers.GetHashCode(\"123456\") != helpers.GetHashCode(\"123456\") {\t\t\tt.Error(\"ç›¸åŒå­—é¢é‡,åº”è¯¥æœ‰ç›¸åŒhash\")\t\t}\t})\tt.Run(\"nilæµ‹è¯•\", func(t *testing.T) {\t\tt.Helper()\t\tif helpers.GetHashCode(nil) != helpers.GetHashCode(nil) {\t\t\tt.Error(\"nilåº”è¯¥æœ‰ç›¸åŒhash\")\t\t}\t})\tt.Run(\"mapæµ‹è¯•\", func(t *testing.T) {\t\tt.Helper()\t\tm1 := make(map[int]string)\t\tm1[0] = \"hi\"\t\tm1[1] = \"world\"\t\tm2 := make(map[int]string)\t\tm2[0] = \"hi\"\t\tm2[1] = \"world\"\t\tif helpers.GetHashCode(m1) != helpers.GetHashCode(m2) {\t\t\tt.Error(\"ç›¸åŒmapåº”è¯¥æœ‰ç›¸åŒhash\")\t\t}\t\tm3 := make(map[int]string)\t\tm3[0] = \"hello\"\t\tm3[1] = \"world\"\t\tif helpers.GetHashCode(m1) == helpers.GetHashCode(m3) {\t\t\tt.Error(\"ä¸åŒmapåº”è¯¥æœ‰ä¸åŒhash\")\t\t}\t})\tt.Run(\"ç»“æ„ä½“æµ‹è¯•\", func(t *testing.T) {\t\tt.Helper()\t\ttype people struct {\t\t\tName string\t\t\tAge  uint\t\t}\t\tp1 := people{}\t\tp2 := people{}\t\tif helpers.GetHashCode(p1) != helpers.GetHashCode(p2) {\t\t\tt.Error(\"ç›¸åŒç±»å‹ç©ºç»“æ„ä½“åº”è¯¥æœ‰ç›¸åŒhash\")\t\t}\t\tp3 := people{\t\t\tName: \"zhangSan\",\t\t\tAge:  20,\t\t}\t\tp4 := people{\t\t\tName: \"zhangSan\",\t\t\tAge:  20,\t\t}\t\tif helpers.GetHashCode(p3) != helpers.GetHashCode(p4) {\t\t\tt.Error(\"ç›¸åŒç»“æ„ä½“åº”è¯¥æœ‰ç›¸åŒhash\")\t\t}\t\tp5 := people{\t\t\tName: \"liSi\",\t\t\tAge:  20,\t\t}\t\tif helpers.GetHashCode(p3) == helpers.GetHashCode(p5) {\t\t\tt.Error(\"ä¸åŒç»“æ„ä½“åº”è¯¥æœ‰ä¸åŒhash\")\t\t}\t})}"
  },
  
  {
    "title": "golang1.18ä»¥åsliceæ‰©å®¹ç­–ç•¥å˜åŒ–",
    "url": "/posts/golang1.18%E4%BB%A5%E5%90%8Eslice%E6%89%A9%E5%AE%B9%E7%AD%96%E7%95%A5%E5%8F%98%E5%8C%96/",
    "categories": "BlockChain, golang",
    "tags": "slice",
    "date": "2022-06-22 00:00:00 +0800",
    





    "snippet": "golang1.18ç‰ˆæœ¬ä»¥å‰, æ‰©å®¹ç­–ç•¥:  å½“åŸ slice å®¹é‡å°äº 1024 çš„æ—¶å€™ï¼Œæ–° slice å®¹é‡å˜æˆåŸæ¥çš„ 2 å€ï¼›åŸ slice å®¹é‡è¶…è¿‡ 1024ï¼Œæ–° slice å®¹é‡å˜æˆåŸæ¥çš„1.25å€ã€‚åœ¨1.18ç‰ˆæœ¬æ›´æ–°ä¹‹åï¼Œsliceçš„æ‰©å®¹ç­–ç•¥å˜ä¸ºäº†:  å½“åŸsliceå®¹é‡å°äº256çš„æ—¶å€™ï¼Œæ–°sliceå®¹é‡ä¸ºåŸæ¥çš„2å€ï¼›åŸsliceå®¹é‡è¶…è¿‡256ï¼Œæ–°sliceå®¹é‡newcap = oldcap+(oldcap+3*256)/4// go@1.17   slice.gofunc growslice(et *_type, old slice, cap int) slice {    //....  newcap := old.cap\tdoublecap := newcap + newcap\tif cap &gt; doublecap {\t\tnewcap = cap\t} else {\t\tif old.cap &lt; 1024 {\t\t\tnewcap = doublecap\t\t} else {\t\t\t// Check 0 &lt; newcap to detect overflow\t\t\t// and prevent an infinite loop.\t\t\tfor 0 &lt; newcap &amp;&amp; newcap &lt; cap {\t\t\t\tnewcap += newcap / 4\t\t\t}\t\t\t// Set newcap to the requested cap when\t\t\t// the newcap calculation overflowed.\t\t\tif newcap &lt;= 0 {\t\t\t\tnewcap = cap\t\t\t}\t\t}\t}    //....  }// go 1.18 slice.gofunc growslice(et *_type, old slice, cap int) slice {    // â€¦â€¦    newcap := old.cap\tdoublecap := newcap + newcap\tif cap &gt; doublecap {\t\tnewcap = cap\t} else {\t\tconst threshold = 256\t\tif old.cap &lt; threshold {\t\t\tnewcap = doublecap\t\t} else {\t\t\tfor 0 &lt; newcap &amp;&amp; newcap &lt; cap {                // Transition from growing 2x for small slices\t\t\t\t// to growing 1.25x for large slices. This formula\t\t\t\t// gives a smooth-ish transition between the two.\t\t\t\tnewcap += (newcap + 3*threshold) / 4\t\t\t}\t\t\tif newcap &lt;= 0 {\t\t\t\tnewcap = cap\t\t\t}\t\t}\t}\t// â€¦â€¦    }å¯ä»¥é€šè¿‡ä¸‹é¢çš„demoç¨‹åºæ¥çœ‹æ‰©å®¹å˜åŒ–package mainimport \"fmt\"func main() {\ts := make([]int, 0)\toldCap := cap(s)\tfor i := 0; i &lt; 2048; i++ {\t\ts = append(s, i)\t\tcurrentCap := cap(s)\t\tif oldCap != currentCap {\t\t\tfmt.Printf(\"current cap: %d\\n\", currentCap)\t\t\toldCap = currentCap\t\t}\t}}"
  },
  
  {
    "title": "ä½¿ç”¨delveå¯¹goä»£ç è¿›è¡Œè°ƒè¯•",
    "url": "/posts/%E4%BD%BF%E7%94%A8delve%E5%AF%B9go%E4%BB%A3%E7%A0%81%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/",
    "categories": "BlockChain, golang",
    "tags": "delve, debug",
    "date": "2022-06-21 00:00:00 +0800",
    





    "snippet": "delveå°±æ˜¯goè¯­è¨€çš„gdb,è™½ç„¶ gdbä¹Ÿå¯ä»¥è°ƒè¯•goç¨‹åº (https://go.dev/doc/gdb). ä½†æ˜¯, ç”¨gdbè°ƒè¯•goç¨‹åºæœ‰è¿™äº›å·²çŸ¥é—®é¢˜:å·²çŸ¥é—®é¢˜  å­—ç¬¦ä¸²pretty printing åªå¯¹å­—ç¬¦ä¸²ç±»å‹è§¦å‘ï¼Œè€Œä¸æ˜¯å¯¹å…¶æ´¾ç”Ÿç±»å‹ã€‚  è¿è¡Œåº“çš„ C éƒ¨åˆ†ç¼ºå°‘ç±»å‹ä¿¡æ¯ã€‚  GDB ä¸ç†è§£ Go çš„åç§°èµ„æ ¼ï¼Œå¹¶å°† â€œfmt.Print â€œè§†ä¸ºå¸¦æœ‰â€. â€œçš„éç»“æ„åŒ–å­—é¢ï¼Œéœ€è¦åŠ ä»¥å¼•å·ã€‚å®ƒå¯¹pkg.(*MyType).Methå½¢å¼çš„æ–¹æ³•ååå¯¹å¾—æ›´å‰å®³ã€‚  ä»Go 1.11å¼€å§‹ï¼Œè°ƒè¯•ä¿¡æ¯é»˜è®¤æ˜¯å‹ç¼©çš„ã€‚æ—§ç‰ˆæœ¬çš„gdbï¼Œä¾‹å¦‚MacOSä¸Šé»˜è®¤æä¾›çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸ç†è§£å‹ç¼©ã€‚ä½ å¯ä»¥ä½¿ç”¨go build -ldflags=-compressdwarf=falseæ¥ç”Ÿæˆæœªå‹ç¼©çš„è°ƒè¯•ä¿¡æ¯ã€‚(ä¸ºäº†æ–¹ä¾¿ï¼Œä½ å¯ä»¥æŠŠ-ldflagsé€‰é¡¹æ”¾åœ¨GOFLAGSç¯å¢ƒå˜é‡ä¸­ï¼Œè¿™æ ·ä½ å°±ä¸å¿…æ¯æ¬¡éƒ½æŒ‡å®šå®ƒ)ã€‚ä½¿ç”¨ delve  https://github.com/go-delve/delve æ›´ç®€å•èˆ’é€‚é¦–æ¬¡å®‰è£…go install github.com/go-delve/delve/cmd/dlv@lateståŸºæœ¬ä½¿ç”¨  å¦‚æœæ˜¯è°ƒè¯•ä¸»ç¨‹åº, cdåˆ°main.goæ‰€åœ¨ç›®å½•, è¿è¡Œ dlv debug  å¦‚æœæ˜¯è°ƒè¯•æµ‹è¯•ä»£ç ,  cdåˆ°*_test.goæ‰€åœ¨ç›®å½•, è¿è¡Œ dlv testç„¶å å’Œ gdbç”¨æ³•ç±»ä¼¼  break: æ‰“æ–­ç‚¹ b packageName.functionName  æˆ– b fileName:lineNumberæ¯”å¦‚ b main.Add,  b main.main  continue: å¼€å§‹æ‰§è¡Œæˆ–ç»§ç»­æ‰§è¡Œ c   (å¼€å§‹æ‰§è¡Œä¹Ÿç”¨c)  next :æ‰§è¡Œä¸‹ä¸€è¡Œ n  step: å•æ­¥è¿›å…¥ s  stepout: å•æ­¥é€€å‡ºso  print:æ‰“å° p thevar   quité€€å‡ºè°ƒè¯• qæ›´å¤šçš„  https://github.com/go-delve/delve/blob/master/Documentation/cli/README.mdé«˜çº§ä½¿ç”¨dlv attach - é™„åŠ åˆ°æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹å¹¶å¼€å§‹è°ƒè¯•ã€‚dlv connect - ç”¨ç»ˆç«¯å®¢æˆ·ç«¯è¿æ¥åˆ°headless debug serverã€‚dlv core - æ£€æŸ¥ä¸€ä¸ªæ ¸å¿ƒè½¬å‚¨ã€‚dlv dap - å¯åŠ¨ä¸€ä¸ªé€šè¿‡è°ƒè¯•é€‚é…å™¨åè®®ï¼ˆDAPï¼‰é€šä¿¡çš„æ— å¤´TCPæœåŠ¡å™¨ã€‚dlv debug - ç¼–è¯‘å¹¶å¼€å§‹è°ƒè¯•å½“å‰ç›®å½•ä¸‹çš„ä¸»åŒ…ï¼Œæˆ–æŒ‡å®šçš„åŒ…ã€‚dlv exec - æ‰§è¡Œä¸€ä¸ªé¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶å¼€å§‹ä¸€ä¸ªè°ƒè¯•ä¼šè¯ã€‚dlv replay - å›æ”¾ä¸€ä¸ªrrè·Ÿè¸ªã€‚dlv run - åºŸå¼ƒçš„å‘½ä»¤ã€‚ä½¿ç”¨â€™debugâ€™ä»£æ›¿ã€‚dlv test - ç¼–è¯‘æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶å¹¶å¼€å§‹è°ƒè¯•ç¨‹åºã€‚dlv trace - ç¼–è¯‘å¹¶å¼€å§‹è¿½è¸ªç¨‹åºã€‚dlv version - æ‰“å°ç‰ˆæœ¬ã€‚dlv log - å…³äºè®°å½•æ ‡è®°çš„å¸®åŠ©dlv backend -  --backend flagçš„å¸®åŠ©"
  },
  
  {
    "title": "golangå®ç°ä¸€ä¸ªç®€å•çš„äº‹ä»¶å¤„ç†ç¨‹åº",
    "url": "/posts/golang%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F/",
    "categories": "BlockChain, golang",
    "tags": "event",
    "date": "2022-06-14 00:00:00 +0800",
    





    "snippet": "ä¸€ä¸ªç®€å•çš„äº‹ä»¶å¤„ç†ç¨‹åº.demoç›®å½•ç»“æ„.â”œâ”€â”€ eventsâ”‚Â Â  â””â”€â”€ event.goâ”œâ”€â”€ go.modâ”œâ”€â”€ main.goâ””â”€â”€ user    â””â”€â”€ login.goevent.gopackage eventsimport \"sync\"type EventHandler func(event Event, arg interface{})var lock sync.Mutextype Event interface {\tName() string\tRegister(EventHandler) error\tTrigger(arg interface{}) error}type SimpleEvent struct {\tname     string\thandlers []EventHandler}func (e SimpleEvent) Name() string {\treturn e.name}func (e *SimpleEvent) Register(h EventHandler) error {\tlock.Lock()\te.handlers = append(e.handlers, h)\tlock.Unlock()\treturn nil}func (e *SimpleEvent) Trigger(arg interface{}) error {\tlock.Lock()\tfor _, h := range e.handlers {\t\tgo h(e, arg)\t}\tlock.Unlock()\treturn nil}func NewSimpleEvent(name string) Event {\treturn &amp;SimpleEvent{name: name}}demologin.goæ¨¡æ‹Ÿç™»å½•ç™»å‡ºçš„æ—¶å€™,å‘é€äº‹ä»¶package userimport (\t\"goplayground/events\"\t\"time\")var (\tLoginEvent  = events.NewSimpleEvent(\"user.login\")\tLogoutEvent = events.NewSimpleEvent(\"user.logout\"))type LoginArg struct {\tUsername string\tPassword string\tTime     time.Time}type LogoutArg struct {\tUsername string\tTime     time.Time}func Login(username, password string) (bool, error) {\t_ = LoginEvent.Trigger(LoginArg{username, password, time.Now()})\treturn true, nil}func Logout(username string) error {\t_ = LogoutEvent.Trigger(LogoutArg{username, time.Now()})\treturn nil}main.gopackage mainimport (\t\"fmt\"\t\"goplayground/events\"\t\"goplayground/user\"\t\"time\")func main() {\t//äº‹ä»¶å¤„ç†ç¨‹åº æ³¨å†Œ\tuser.LoginEvent.Register(func(event events.Event, arg interface{}) {\t\ta := arg.(user.LoginArg)\t\tfmt.Printf(\"%q: %q %q %q\\n\", event.Name(), a.Username, a.Password, a.Time)\t})\tuser.LogoutEvent.Register(func(event events.Event, arg interface{}) {\t\ta := arg.(user.LogoutArg)\t\tfmt.Printf(\"%q: %q %q\\n\", event.Name(), a.Username, a.Time)\t})\t//æ¨¡æ‹Ÿ\tuser.Login(\"admin\", \"admin\")\ttime.Sleep(time.Second)\tuser.Logout(\"admin\")\ttime.Sleep(time.Second)}"
  },
  
  {
    "title": "goè¯­è¨€ä¸­Channelæ˜¯å¦‚ä½•å·¥ä½œçš„",
    "url": "/posts/go%E8%AF%AD%E8%A8%80%E4%B8%ADchannel%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84/",
    "categories": "BlockChain, golang",
    "tags": "chan",
    "date": "2022-06-13 00:00:00 +0800",
    





    "snippet": "äº†è§£Golangé€šé“çš„å†…éƒ¨å·¥ä½œåŸç†goroutine(åç¨‹)å’Œé€šé“goroutineæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ç”¨æˆ·ç©ºé—´çº¿ç¨‹ï¼Œç”±Goè¿è¡Œæ—¶ç®¡ç†ã€‚å®ƒåŒæ—¶æ‰§è¡Œä»»åŠ¡ï¼Œå¯èƒ½æ˜¯å¹¶è¡Œçš„ã€‚é€šé“æ˜¯ç”¨äºgoroutineä¹‹é—´çš„é€šä¿¡ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥äº†è§£é€šé“çš„å†…éƒ¨è¿ä½œå’Œå®ƒçš„å‘é€/æ¥æ”¶æ“ä½œã€‚ç¼“å†²é€šé“æˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªç¼“å†²é€šé“ç”¨äºä¸‹é¢çš„è§£é‡Šã€‚ch := make(chan int, 3)      ä¸Šé¢çš„è¯­å¥åˆ›å»ºäº†ä¸€ä¸ªç¼“å†²é€šé“ï¼Œæœ€å¤šå¯ä»¥å®¹çº³ 3 ä¸ª int ç±»å‹çš„å€¼ã€‚åœ¨åº•å±‚ï¼Œmakeå‡½æ•° åœ¨å †ä¸Šåˆ†é…äº†ä¸€ä¸ª hchan ç»“æ„å¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘å®ƒçš„æŒ‡é’ˆã€‚ä»¥ä¸‹æ˜¯ hchan ç»“æ„çš„ä¸€äº›å­—æ®µåŠå…¶è§£é‡Šã€‚![img](./( ../../assets/img/1*wprFXP6zyl8FPC1PhvslsQ.png)some fields of hchan structtype hchan struct { buf      unsafe.Pointer sendx    uint recvx    uint lock     mutex  ...   // other fields}  buf æ˜¯ä¸€ä¸ªæŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆï¼Œå®ƒç»´æŠ¤ç€ä¸€ä¸ªå¾ªç¯é˜Ÿåˆ—ã€‚  sendx æ˜¯æ•°ç»„ä¸­å‘é€å…ƒç´ çš„ç´¢å¼•  recvx æ˜¯æ”¶åˆ°çš„å…ƒç´ åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•  lock ç¡®ä¿é€šé“çš„è¯»å†™æ˜¯ä¸€ä¸ªåŸå­æ€§çš„æ“ä½œéé˜»å¡çš„å‘é€å’Œæ¥æ”¶å½“é€šé“æœªæ»¡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¾ªç¯é˜Ÿåˆ—çš„åé¢æ’å…¥å…ƒç´ ï¼Œè€Œä¸ä¼šæœ‰é˜»å¡ã€‚// G1 sends three elements into the channel, capicity = 3ch &lt;- elem1ch &lt;- elem2ch &lt;- elem3â€‹å½“é€šé“ä¸æ˜¯ç©ºçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä»å¾ªç¯é˜Ÿåˆ—çš„å‰é¢æ¥æ”¶å…ƒç´ ï¼Œè€Œä¸ä¼šæœ‰é˜»å¡ã€‚// G2 receive three elements from the channel, capicity = 3&lt;- ch&lt;- ch&lt;- châ€‹é˜»å¡åœ¨å¤„ç†goroutineä¹‹é—´çš„é˜»å¡æ—¶ï¼Œå…¶ä»–å­—æ®µä¹Ÿå¾ˆé‡è¦ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ã€‚some fields of hchan struct  recvq (é“¾è¡¨)å­˜å‚¨è¯•å›¾åœ¨é€šé“ä¸Šè¯»å–æ•°æ®æ—¶è¢«é˜»å¡çš„goroutinesã€‚  sendq(é“¾è¡¨) å­˜å‚¨è¯•å›¾ä»é€šé“å‘é€æ•°æ®æ—¶è¢«é˜»å¡çš„goroutinesã€‚  Remember that Both of recq and sendq are linked list.type hchan struct { buf      unsafe.Pointer sendx    uint recvx    uint lock     mutex  sendq    waitq    recvq    waitq  ...   // more fields}type waitq struct {  first *sudog        last  *sudog}// pseudo goroutinetype sudog struct {  g     *g  elem  unsafe.Pointer   next  *sudog        prev  *sudog  ...  c     *hchan}ä»ç©ºä¿¡é“è¿›è¡Œæ¥æ”¶å½“é€šé“ä¸ºç©ºæ—¶ï¼Œä¸€ä¸ªæ¥æ”¶æ“ä½œä¼šå¯¼è‡´å½“å‰çš„åç¨‹è¢«é˜»å¡ã€‚æ‰€æœ‰è¢«é˜»å¡çš„åç¨‹éƒ½å­˜å‚¨åœ¨recvqé˜Ÿåˆ—ä¸­ã€‚  é˜»å¡çš„æ˜¯goroutinesï¼Œä½†ä¸æ˜¯OSçº¿ç¨‹ã€‚é‚£ä¹ˆï¼Œè¢«é˜»å¡çš„goroutineä½•æ—¶ä¼šè¢«æ¢å¤å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å½“ä¸€ä¸ªæ–°çš„goroutineåœ¨é€šé“ä¸Šæ‰§è¡Œå‘é€æ“ä½œæ—¶ã€‚ä¸‹é¢æ˜¯è¯¦ç»†æƒ…å†µã€‚  ä¸€ä¸ªæ–°çš„goroutineå°†æ–°æ•°æ®ç›´æ¥å¤åˆ¶åˆ°ç¬¬ä¸€ä¸ªç­‰å¾…çš„goroutineçš„å…ƒç´ ä¸­  ç¬¬ä¸€ä¸ªç­‰å¾…çš„goroutineä»recvqä¸­å¼¹å‡ºã€‚  è¿è¡Œæ—¶è°ƒåº¦å™¨è®¾ç½®è¢«å¼¹å‡ºçš„goroutineä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œå¹¶å°†å…¶æ”¾åœ¨ â€œè¿è¡Œé˜Ÿåˆ— â€œä¸­ã€‚ç„¶åï¼Œè¢«é˜»å¡çš„ç¨‹åºè¢«è§¦å‘å¹¶å‡†å¤‡å†æ¬¡è¿è¡Œã€‚åœ¨â€æ»¡â€é€šé“ä¸Šè¿›è¡Œå‘é€å½“é€šé“æ»¡äº†ï¼Œæ¥ä¸‹æ¥çš„å‘é€æ“ä½œä¼šé˜»å¡å„è‡ªçš„goroutineã€‚æ‰€æœ‰è¢«é˜»å¡çš„goroutineséƒ½å­˜å‚¨åœ¨sendqé˜Ÿåˆ—ä¸­ã€‚(æ²¡æœ‰ç¼“å†²åŒºæˆ–è€…è¯´ç¼“å†²åŒºå¤§å°ä¸º0çš„é€šé“, å’Œç¼“å†²åŒºæ»¡äº†çš„é€šé“æƒ…å†µä¸€æ ·)ç›´åˆ°å¦ä¸€ä¸ªgoroutineçš„æ¥æ”¶ï¼Œè¢«é˜»å¡çš„goroutineè¢«æ¢å¤ã€‚ä¸‹é¢æ˜¯è¯¦ç»†æƒ…å†µã€‚  å½“ä¸€ä¸ªæ–°çš„goroutineåœ¨é€šé“ä¸Šæ‰§è¡Œæ¥æ”¶æ“ä½œæ—¶ï¼Œç¼“å†²åŒºçš„ç¬¬ä¸€ä¸ªå…ƒç´ è¢«ç§»é™¤  ç¬¬ä¸€ä¸ªç­‰å¾…çš„goroutineä»sendqå¼¹å‡ºã€‚  å¼¹å‡ºçš„goroutineçš„å…ƒç´ è¢«å¤åˆ¶åˆ°ç¼“å†²åŒºä¸­  è¿è¡Œæ—¶è°ƒåº¦å™¨è®¾ç½®è¢«å¼¹å‡ºçš„goroutineä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œå¹¶å°†å…¶æ”¾åœ¨ â€œè¿è¡Œé˜Ÿåˆ— â€œä¸­ã€‚ç„¶åï¼Œè¢«é˜»å¡çš„ç¨‹åºè¢«è§¦å‘å¹¶å‡†å¤‡å†æ¬¡è¿è¡Œã€‚é€šé“æ˜¯goä¸­ä¸€ä¸ªéå¸¸å¼ºå¤§å’Œæœ‰è¶£çš„æœºåˆ¶ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿè§£é‡Šå›´æ£‹ä¸­é€šé“çš„åŸºæœ¬å·¥ä½œåŸç†ã€‚å‚è€ƒæ–‡ç«   Diving Deep Into The Golang Channels  Concurrency And Parallelism in Golang  Go a Tale of Concurrency a Beginners Guideå¦å¤–, è¿™ç¯‡æ–‡ç« ä¹Ÿä¸é”™  https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-channel/"
  },
  
  {
    "title": "golang http server",
    "url": "/posts/golang_http_server/",
    "categories": "BlockChain, golang",
    "tags": "http",
    "date": "2022-06-13 00:00:00 +0800",
    





    "snippet": "golang ä¸­http server åŸºç¡€çŸ¥è¯†.ç®€å•çš„æ–‡ä»¶æœåŠ¡å™¨package mainimport (\t\"log\"\t\"net/http\")func main() {\terr := http.ListenAndServe(\":8080\", http.FileServer(http.Dir(\".\")))\tif err != nil {\t\tlog.Fatal(err)\t}}ä¸Šé¢è¿™ä¸ªä¾‹å­åˆ›å»ºäº†ä¸€ä¸ªä»¥å½“å‰ç›®å½•ä¸ºç«™ç‚¹è·Ÿç›®å½•çš„æ–‡ä»¶æœåŠ¡å™¨,  æˆ‘ä¸€èˆ¬ç”¨è¿™ä¸ªæ¥ä½œä¸ºå±€åŸŸç½‘æ–‡ä»¶å…±äº«.ç„¶åå†™ä¸€ä¸ªå‡½æ•°æ”¾åˆ°bash.rc æˆ–zshrcä¸­#æ–‡ä»¶æœåŠ¡å™¨function fileserver(){\techo \"start file server :12345\"\tcat &lt;&lt;EOF | tee /tmp/fileserver.go | go run /tmp/fileserver.gopackage mainimport (\t\"log\"\t\"net/http\")func main() {\terr := http.ListenAndServe(\":12345\", http.FileServer(http.Dir(\".\")))\tif err != nil {\t\tlog.Fatal(err)\t}}EOF}OSX MP16 ~/Downloads â¯ fileserver                                                         start file server :12345Pythonä¸­æœ‰ç›¸åŒçš„åŠŸèƒ½python3 -m SimpleHTTPServer 7777  æˆ– python3 -m http.serverä¸€ä¸ªç®€å•çš„WebServerpackage mainimport (\t\"log\"\t\"net/http\")func main() {\thttp.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) {\t\t_, err := w.Write([]byte(\"Hello World!\\n\"))\t\tif err != nil {\t\t\tlog.Println(err)\t\t}\t})\terr := http.ListenAndServe(\":12345\", nil)\tif err != nil {\t\tlog.Fatal(err)\t}}è®¿é—®ä¸€ä¸‹è¯•è¯•:OSX MP16 ~/Downloads/goplayground â¯ curl http://localhost:12345          Hello World!http.HandleFunchttp.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) {\t\t//...\t})è¯¥æ–¹æ³•æä¾›äº†ä¸€ç§æŒ‡å®šå¦‚ä½•å¤„ç†ç‰¹å®šè·¯ç”±çš„è¯·æ±‚çš„æ–¹æ³•, ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè·¯ç”±, ç¬¬äºŒä¸ªå‚æ•°ä¸ºå¤„ç†å‡½æ•°. å¤„ç†å‡½æ•°å¯å†™æˆåŒ¿åå‡½æ•°, ä¹Ÿå¯ä»¥å£°æ˜ä¸ºä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•°func rootHandler(w http.ResponseWriter, r *http.Request) {\t_, err := w.Write([]byte(\"&lt;h1 style=\\\"color:Tomato;\\\"&gt;Hello World&lt;/h1&gt;\"))\tif err != nil {\t\tlog.Println(err)\t}}func main() {\thttp.HandleFunc(\"/\", rootHandler)  //...}å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯http.ResponseWriterç±»å‹çš„å€¼ã€‚è¿™æ˜¯ç”¨äºå‘ä»»ä½•è¿æ¥çš„HTTPå®¢æˆ·ç«¯å‘é€å“åº”çš„æœºåˆ¶ã€‚è¿™ä¹Ÿæ˜¯å“åº”æ ‡å¤´çš„è®¾ç½®æ–¹å¼,æ¯”å¦‚w.WriteHeader(http.StatusOK)ã€‚ç¬¬äºŒä¸ªè®ºç‚¹æ˜¯æŒ‡å‘http.Requestçš„æŒ‡é’ˆã€‚è¿™æ˜¯ä»ç½‘ç»œè¯·æ±‚ä¸­æ£€ç´¢æ•°æ®çš„æ–¹å¼ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡è¯·æ±‚æŒ‡é’ˆè®¿é—®è¡¨å•æäº¤çš„è¯¦ç»†ä¿¡æ¯æ¯”å¦‚ ä¸‹é¢çš„æ–¹æ³•, ä½¿ç”¨ http://127.0.0.1:12345/?key=date æ—¶å°†è¿”å›å½“å‰çš„æ—¥æœŸ, ç¡®å®key=æˆ–keyä¸æ­£ç¡®æ—¶è¿”å›http.StatusBadRequestfunc rootHandler(w http.ResponseWriter, r *http.Request) {\tkeys, ok := r.URL.Query()[\"key\"]\tif !ok || len(keys[0]) &lt; 1 {\t\tlog.Println(\"Url Param 'key' is missing\")\t\tw.WriteHeader(http.StatusBadRequest)\t\t_, err := w.Write([]byte(\"Url Param 'key' is missing\"))\t\tif err != nil {\t\t\tlog.Println(err)\t\t\treturn\t\t}\t\treturn\t}\tkey := keys[0]\tswitch key {\tcase \"date\":\t\tw.WriteHeader(http.StatusOK)\t\t_, err := w.Write([]byte(time.Now().Format(\"2006-01-02\")))\t\tif err != nil {\t\t\tlog.Println(err)\t\t}\tdefault:\t\tw.WriteHeader(http.StatusBadRequest)\t\t_, _ = w.Write([]byte(\"Invalid key\"))\t\tlog.Println(\"Invalid key\")\t}}http.ResponseWriterç”¨äºå‘ä»»ä½•è¿æ¥çš„HTTPå®¢æˆ·ç«¯å‘é€å“åº”è®¾ç½®ç›¸åº”æ ‡å¿—å¤´:   w.WriteHeader(http.StatusOK)è·å–æˆ–å®åˆ™å“åº”å¤´   w.Header().Set(\"content-type\", \"application/json\")   w.Header().Add(\"foo\", \"bar\")å†™å…¥ç›¸åº”æ•°æ®:   w.Write([]byte(time.Now().Format(\"2006-01-02\")))ä¾‹å­:package mainimport (\t\"encoding/json\"\t\"log\"\t\"net/http\")type SystemInfo struct {\tHostname string `json:\"hostname\"`\tUptime   string `json:\"uptime\"`}func rootHandler(w http.ResponseWriter, r *http.Request) {\tinfo := SystemInfo{\t\tHostname: \"test\",\t\tUptime:   \"2022-01-01 00:00:00\",\t}\tw.Header().Set(\"Content-Type\", \"application/json\")\tw.WriteHeader(http.StatusOK)\tbytes, _ := json.Marshal(info)\t_, err := w.Write(bytes)\tif err != nil {\t\tlog.Println(\"Error writing response: \", err)\t}}func main() {\thttp.HandleFunc(\"/\", rootHandler)\terr := http.ListenAndServe(\":12345\", nil)\tif err != nil {\t\tlog.Fatal(err)\t}}OSX MP16 ~ â¯ curl localhost:12345                                                         {\"hostname\":\"test\",\"uptime\":\"2022-01-01 00:00:00\"}*http.RequestæŒ‡å‘http.Requestçš„æŒ‡é’ˆ, é€šè¿‡æ”¹æŒ‡é’ˆå¯ä»¥è·å–è¯·æ±‚ä¸­çš„å„ç§æ•°æ®, æ¯”å¦‚è·å–åŸºæœ¬ä¿¡æ¯func rootHandler(w http.ResponseWriter, r *http.Request) {\tfmt.Println(\"User Agent: \", r.UserAgent())\tfmt.Println(\"Host: \", r.Host)\tfmt.Println(\"Remote Address: \", r.RemoteAddr)\tfmt.Println(\"Request URI: \", r.RequestURI)\tfmt.Println(\"Method: \", r.Method)\tfmt.Println(\"URL: \", r.URL)\tfmt.Println(\"Header: \", r.Header)\tw.WriteHeader(http.StatusOK)}è¾“å‡º:User Agent:  curl/7.79.1Host:  localhost:12345Remote Address:  127.0.0.1:58967Request URI:  /Method:  GETURL:  /Header:  map[Accept:[*/*] User-Agent:[curl/7.79.1]]è·å–cookiefunc rootHandler(w http.ResponseWriter, r *http.Request) {\t//è·å–æ‰€æœ‰\tfor _, c := range r.Cookies() {\t\tfmt.Printf(\"%s : %q\\n\", c.Name, c.Value)\t}\t//è·å–æŒ‡å®š\tc, err := r.Cookie(\"token\")\tif err != nil {\t\tlog.Println(err)\t}\tfmt.Printf(\"%s : %q\\n\", c.Name, c.Value)\tw.WriteHeader(http.StatusOK)}curl --cookie \"token=abcdefg\" http://localhost:12345è·å–GETå‚æ•°      è·å–æ‰€æœ‰å‚æ•° args := r.URL.Query()        è·å–æŒ‡å®šå‚æ•°(æ³¨:å‚æ•°å¯èƒ½è¢«é‡å¤å†™å¤šæ¬¡)    æ¯”å¦‚: localhost:12345/?id=5    func rootHandler(w http.ResponseWriter, r *http.Request) {\tids, ok := r.URL.Query()[\"id\"]\tif !ok || len(ids[0]) &lt; 1 {\t\tlog.Println(\"Url Param 'id' is missing\")\t\treturn\t}\tid := ids[0]\tlog.Println(\"Url Param 'id' is: \" + id)  \t\tw.WriteHeader(http.StatusOK)}      æˆ–è€…func rootHandler(w http.ResponseWriter, r *http.Request) {\tid := r.FormValue(\"id\")\tif id == \"\" {\t\tlog.Println(\"Url Param 'id' is missing\")\t}\tfmt.Println(\"id:\", id)\tw.WriteHeader(http.StatusOK)}  ä¹Ÿå¯ä»¥é€šè¿‡r.Formæ¥è·å–Getå‚æ•°è·å–PATCH, POST or PUTå‚æ•°æ¯”å¦‚ curl -d \"id=5&amp;format=1\" http://localhost:12345/func rootHandler(w http.ResponseWriter, r *http.Request) {\t//parse\terr := r.ParseForm()\tif err != nil {\t\tlog.Println(\"ParseForm error:\", err)\t}\t//get post args\tfor k, v := range r.PostForm {\t\tlog.Println(\"key:\", k)\t\tlog.Println(\"val:\", v) // v []string\t}\tw.WriteHeader(http.StatusOK)}è¾“å‡º2022/06/06 15:14:46 key: id2022/06/06 15:14:46 val: [5]2022/06/06 15:14:46 key: format2022/06/06 15:14:46 val: [1]ParseFormä¼šå¡«å……r.Formå’Œr.PostFormã€‚å¯¹äºæ‰€æœ‰çš„è¯·æ±‚ï¼ŒParseFormè§£ææ¥è‡ªURLçš„åŸå§‹æŸ¥è¯¢å¹¶æ›´æ–°r.Formã€‚å¯¹äºPOSTã€PUTå’ŒPATCHè¯·æ±‚ï¼Œå®ƒä¹Ÿè¯»å–è¯·æ±‚æ­£æ–‡ï¼Œå°†å…¶è§£æä¸ºä¸€ä¸ªè¡¨å•ï¼Œå¹¶å°†ç»“æœæ”¾å…¥r.PostFormå’Œr.Formä¸­ã€‚åœ¨r.Formä¸­ï¼Œè¯·æ±‚æ­£æ–‡å‚æ•°ä¼˜å…ˆäºURLæŸ¥è¯¢å­—ç¬¦ä¸²å€¼ã€‚å¦‚æœè¯·æ±‚ä½“çš„å¤§å°è¿˜æ²¡æœ‰è¢«MaxBytesReaderé™åˆ¶ï¼Œé‚£ä¹ˆå…¶å¤§å°å°†è¢«é™åˆ¶åœ¨10MBã€‚å¯¹äºå…¶ä»–HTTPæ–¹æ³•ï¼Œæˆ–è€…å½“å†…å®¹ç±»å‹ä¸æ˜¯application/x-www-form-urlencodedæ—¶ï¼Œè¯·æ±‚æ­£æ–‡ä¸è¢«è¯»å–ï¼Œå¹¶ä¸”r.PostFormè¢«åˆå§‹åŒ–ä¸ºä¸€ä¸ªéé›¶çš„ç©ºå€¼ã€‚ParseMultipartFormè‡ªåŠ¨è°ƒç”¨ParseFormã€‚ParseFormæ˜¯å¹‚ç­‰çš„ã€‚  r.Formå±æ€§åŒ…å«äº†postè¡¨å•å’Œurlä¸­çš„getå‚æ•°ã€‚  r.PostFormå±æ€§åªåŒ…å«äº†postè¡¨å•å‚æ•°ã€‚è·å–æŒ‡å®šå‚æ•°, æ¯”å¦‚func rootHandler(w http.ResponseWriter, r *http.Request) {\terr := r.ParseForm()\tif err != nil {\t\tlog.Println(\"ParseForm error:\", err)\t}\tids := r.PostForm.Get(\"id\") //è·å–idå‚æ•°çš„ç¬¬ä¸€ä¸ªå€¼\tlog.Println(\"id:\", ids)\tw.WriteHeader(http.StatusOK)}æˆ–è€…func rootHandler(w http.ResponseWriter, r *http.Request) {\tid := r.PostFormValue(\"id\")\tif id == \"\" {\t\tlog.Println(\"Url Param 'id' is missing\")\t}\tfmt.Println(\"id:\", id)\tw.WriteHeader(http.StatusOK)}è·å–ä¸Šä¼ æ–‡ä»¶æ¯”å¦‚ curl -F \"file=@IMG_1526.PNG;type=image/png\" http://localhost:12345/uploadä¸‹é¢ä»£ç ä¸­:r.ParseMultipartForm(10 &lt;&lt; 20)å°†ä¸€ä¸ªè¯·æ±‚ä½“è§£æä¸ºmultipart/form-dataã€‚æ•´ä¸ªè¯·æ±‚æ­£æ–‡è¢«è§£æï¼Œå¹¶ä¸”å…¶æ–‡ä»¶éƒ¨åˆ†æœ€å¤šå­˜å‚¨åœ¨maxMemoryå­—èŠ‚çš„å†…å­˜ä¸­ï¼Œå…¶ä½™éƒ¨åˆ†åˆ™å­˜å‚¨åœ¨ç£ç›˜çš„ä¸´æ—¶æ–‡ä»¶ä¸­ã€‚ParseMultipartFormåœ¨å¿…è¦æ—¶è°ƒç”¨ParseFormã€‚å¦‚æœParseFormè¿”å›ä¸€ä¸ªé”™è¯¯ï¼ŒParseMultipartFormå°†å…¶è¿”å›ï¼Œä½†ä¹Ÿç»§ç»­è§£æè¯·æ±‚æ­£æ–‡ã€‚åœ¨å¯¹ParseMultipartFormè¿›è¡Œä¸€æ¬¡è°ƒç”¨åï¼Œéšåçš„è°ƒç”¨æ²¡æœ‰ä»»ä½•å½±å“.FormFile è¿”å›æä¾›çš„è¡¨å•keyçš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ã€‚å¦‚æœéœ€è¦ï¼ŒFormFileä¼šè°ƒç”¨ParseMultipartFormå’ŒParseFormã€‚package mainimport (\t\"io\"\t\"log\"\t\"mime/multipart\"\t\"net/http\"\t\"os\")func uploadHandler(w http.ResponseWriter, r *http.Request) {\t// Parse the multipart form in the request\terr := r.ParseMultipartForm(10 &lt;&lt; 20) // 10 MiB\tif err != nil {\t\thttp.Error(w, err.Error(), http.StatusInternalServerError)\t\treturn\t}\t\t\t// FormFile returns the first file for the given key `file`\t// it also returns the FileHeader, so we can get the Filename, the Header and the size of the file\tfile, handler, err := r.FormFile(\"file\")\tif err != nil {\t\thttp.Error(w, err.Error(), http.StatusInternalServerError)\t\treturn\t}\tdefer func(file multipart.File) {\t\terr := file.Close()\t\tif err != nil {\t\t\tlog.Println(err)\t\t}\t}(file)\terr = os.MkdirAll(\"./upload\", 0777)\tif err != nil {\t\thttp.Error(w, err.Error(), http.StatusInternalServerError)\t\treturn\t}\tlocalFile, err := os.OpenFile(\"./upload/\"+handler.Filename, os.O_WRONLY|os.O_CREATE, 0666)\tif err != nil {\t\thttp.Error(w, err.Error(), http.StatusInternalServerError)\t\treturn\t}\tdefer func(localFile *os.File) {\t\terr := localFile.Close()\t\tif err != nil {\t\t\tlog.Println(err)\t\t}\t}(localFile)\t_, err = io.Copy(localFile, file)\tif err != nil {\t\thttp.Error(w, \"\", http.StatusInternalServerError)    return\t}\tw.WriteHeader(http.StatusOK)}func main() {\thttp.HandleFunc(\"/upload\", uploadHandler)\terr := http.ListenAndServe(\":12345\", nil)\tif err != nil {\t\tlog.Fatal(err)\t}}ğŸ‘å„ç§è·å–å‚æ•°æ–¹å¼æ¯”è¾ƒ            æ“ä½œ      è§£æ      è¯»å–URLå‚æ•°      è¯»å–Bodyè¡¨å•      æ”¯æŒæ–‡æœ¬      æ”¯æŒäºŒè¿›åˆ¶                  r.Form      r.ParseForm()      Y      Y      Y      Â               r.PostForm      r.ParseForm()      Â       Y      Y      Â               r.FormValue()      è‡ªåŠ¨è°ƒç”¨r.ParseForm()      Y      Y      Y      Â               r.PostFormValue()      è‡ªåŠ¨è°ƒç”¨r.ParseForm()      Â       Y      Y      Â               r.MultipartForm      ParseMultipartForm()      Â       Y      Y      Y              r.FormFile      è‡ªåŠ¨è°ƒç”¨ParseMultipartForm()      Â       Y      Â       Y      Handler , Handle , HandleFunc ä¸ http.ListenAndServeä½¿ç”¨é»˜è®¤çš„Handlerå…ˆçœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­package mainimport \"net/http\"func main() {\thttp.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) {\t\tw.Write([]byte(\"Hello, world!\"))\t})\thttp.HandleFunc(\"/blog\", func(w http.ResponseWriter, r *http.Request) {\t\tw.Write([]byte(\"This is my Blog\"))\t})\thttp.ListenAndServe(\":12345\", nil)}åœ¨å¯åŠ¨ä¸€ä¸ªHttpServerçš„æ—¶å€™, å…¶å®æˆ‘ä»¬å°±å…³å¿ƒ2ä¸ªä¸œè¥¿:  åœ°å€  è·¯ç”±: å°†è¯·æ±‚å¯¹åº”åˆ°ç›¸åº”çš„å¤„ç†å‡½æ•°ä¸­å»è¿™ä¸¤ä¸ªå‚æ•° åœ¨http.ListenAndServe(\":12345\", nil)ä¸­è¿›è¡Œè®¾ç½®çš„, ç¬¬ä¸€ä¸ªä¸ºåœ°å€, ç¬¬äºŒä¸ªä¼ é€’å¤„ç†å‡½æ•°.å¦‚æœä¼ é€’nil, åˆ™é‡‡ç”¨é»˜è®¤çš„  The handler is typically nil, in which case the DefaultServeMux is used.http.ListenAndServeçš„å®ç°å¦‚ä¸‹:func ListenAndServe(addr string, handler Handler) error {\tserver := &amp;Server{Addr: addr, Handler: handler}\treturn server.ListenAndServe()}type Handler interface {   ServeHTTP(ResponseWriter, *Request)}å¯ä»¥çœ‹åˆ° Handleræ˜¯ä¸€ä¸ªæ¥å£, å®ç°è¿™ä¸ªæ¥å£çš„è¯, æˆ‘ä»¬å¯ä»¥åˆ›å»ºè‡ªå·±çš„Handlerè‡ªå®šä¹‰Handlerå®šä¹‰ä¸€ä¸ªç»“æ„ä½“, ç»“æ„ä½“å®ç° ServeHTTP(w http.ResponseWriter, r *http.Request)æ–¹æ³•ç„¶åä½¿ç”¨ Handleå‡½æ•°è¿›è¡Œè·¯ç”±æ³¨å†Œpackage mainimport \"net/http\"type MyIndexHandler struct {}func (h *MyIndexHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) {\tw.Write([]byte(\"Hello World\"))}type MyBlogHandler struct {}func (h *MyBlogHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) {\tw.Write([]byte(\"This is my Blog\"))}func main() {\tmux := http.NewServeMux()\tmux.Handle(\"/\", &amp;MyIndexHandler{})\tmux.Handle(\"/blog\", &amp;MyBlogHandler{})\thttp.ListenAndServe(\":12345\", mux)}OSX MP16 ~ â¯ curl localhost:12345                                                          Hello WorldOSX MP16 ~ â¯ curl localhost:12345/blog                                                     This is my BlogOSX MP16 ~ â¯ä½†è¿™æ˜æ˜¾çœ‹å‡ºæ¥, å¯¹æ¯ä¸€ä¸ªè·¯ç”± éƒ½è¦é«˜å†™ä¸€ä¸ªxxxHandlerç»“æ„ä½“å’Œå®ç°ServeHTTP, çœ‹ä¸Šå»éå¸¸æ··ä¹±è¿™æ—¶å€™å°±å¯ä»¥ç”¨mux.HandleFuncæ¥å®ç°è·¯ç”±package mainimport \"net/http\"func main() {   mux := http.NewServeMux()   mux.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) {      w.Write([]byte(\"Hello World\"))   })   mux.HandleFunc(\"/blog\", func(w http.ResponseWriter, r *http.Request) {      w.Write([]byte(\"This is my Blog\"))   })   http.ListenAndServe(\":12345\", mux)}è‡ªå®šä¹‰ServeMuxåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­, mux := http.NewServeMux()è¿˜æ˜¯ä½¿ç”¨äº†é»˜è®¤router, å…¶ç®€å•çš„åŒæ—¶ä¹Ÿæœ‰ä¸å°‘ç¼ºç‚¹æ¯”å¦‚, å…¶æ˜¯é€šè¿‡urlè¿›è¡Œè·¯ç”±, ä½†ä¸æ”¯æŒåŸºäºæ–¹æ³•(GET, POSTâ€¦)çš„è·¯ç”±, ä¸æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ç­‰ç­‰å‚è€ƒè¿™ä¸ª https://www.alexedwards.net/blog/which-go-router-should-i-useäººæ°”Webæ¡†æ¶å‚è€ƒè¿™ç¯‡æ–‡ç« ,https://blog.51cto.com/coderaction/3001008å…¶ä¸­æœ‰å„æ¡†æ¶çš„å¯¹æ¯”, åŠŸèƒ½ä¸Širisæœ€å…¨https://github.com/kataras/iris"
  },
  
  {
    "title": "èŠèŠgoè¯­è¨€ä¸­çš„sync",
    "url": "/posts/%E8%81%8A%E8%81%8Ago%E8%AF%AD%E8%A8%80%E4%B8%AD%E7%9A%84sync/",
    "categories": "BlockChain, golang",
    "tags": "sync",
    "date": "2022-06-12 00:00:00 +0800",
    





    "snippet": "æˆ‘ä»¬å°†ç”¨äº›ç®€å•çš„ä¾‹å­æ¥å°è¯•golangä¸­syncåŒ…çš„å„ç§æœ‰è¶£çš„æƒ…å†µä¸€ä¸ªç®€å•çš„DEMOpackage mainimport \"fmt\"var (\tsharedCounter = 0)func add(count int) {\tfor i := 0; i &lt; count; i++ {\t\tsharedCounter++\t}}func sub(count int) {\tfor i := 0; i &lt; count; i++ {\t\tsharedCounter--\t}}func show() {\tfmt.Println(sharedCounter)}func main() {\tadd(1000000)\tsub(1000000)\tshow()}ç¨‹åºå¾ˆç®€å•, æˆ‘ä»¬ç”¨ä¸€ä¸ªå…±äº«å˜é‡sharedCounterä½œä¸ºä¸€ä¸ªè®¡æ•°å™¨. addå‡½æ•°åœ¨è®¡æ•°å™¨ä¸Šå¾ªç¯æ·»åŠ ä¸€å®šçš„æ•°å€¼, subåˆ™ç›¸å, showåˆ™æ˜¯æ‰“å°è®¡æ•°å™¨å½“å‰çš„å€¼.ç¨‹åºè¿è¡Œç»“æŸå, sharedCounteråº”è¯¥ä¸º0, ä¸Šé¢ä»£ç çš„è¾“å‡ºçš„ç¡®å¦‚æ­¤.ä½¿ç”¨ä¸€ä¸ªåç¨‹å¦‚æœå¯¹è®¡æ•°å™¨è¿›è¡ŒåŠ å‡çš„è°ƒç”¨åœ¨ä¸åŒçš„åç¨‹é‡Œé¢, ä¼šæ€ä¹ˆæ ·å‘¢?func main() {\tadd(1000000)\tgo sub(1000000)\tshow()}ä¼šå¾—åˆ°1000000 , å› ä¸ºgo sub(1000000)åˆšå¯åŠ¨, ç¨‹åºå°±é€€å‡ºäº†.æˆ–è®¸æˆ‘ä»¬åº”è¯¥ç­‰åˆ°subå‡½æ•°æ‰§è¡Œç»“æŸç­‰å¾…åç¨‹ç»“æŸ      é”™è¯¯çš„æ–¹å¼å¦‚æœæœ‰Cè¯­è¨€å¼€å‘èƒŒæ™¯, å¯èƒ½ä¼šæƒ³åˆ°é€šè¿‡è®¾ç½®ä¸€ä¸ªflagæ¥æŒ‡ç¤ºè¿ç®—æ˜¯å¦ç»“æŸ, æ¯”å¦‚:    func sub(count int, done *bool) {\tfor i := 0; i &lt; count; i++ {\t\tsharedCounter--\t}\t*done = true}//....   func main() {\tadd(1000000)   \tdone := false\tgo sub(1000000, &amp;done)   \tfor !done {\t\ttime.Sleep(time.Millisecond * 10)\t}   \t\tshow()}        è¿™è™½ç„¶ä¹Ÿèƒ½å¾—åˆ°æ­£ç¡®çš„è¾“å‡º, ä½†éå¸¸ä¸ä¼˜é›….        æ­£ç¡®çš„æ–¹å¼1å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ— ç¼“å†²çš„ä¿¡é“(æˆ–è€…è¯´å®¹é‡ä¸º1çš„ä¿¡é“)æ¥å……å½“flag    //...func sub(count int, done chan bool) {\tfor i := 0; i &lt; count; i++ {\t\tsharedCounter--\t}\tdone &lt;- true}//....func main() {\tadd(1000000)   \tdone := make(chan bool)\tgo sub(1000000, done)\t&lt;-subDone\tshow()}        è¿™é‡Œåˆ©ç”¨äº†ä¿¡é“çš„ç‰¹ç‚¹: å½“ä»ä¿¡é“ä¸­è¯»å–æ•°æ®æ—¶,å¦‚æœä¿¡é“ä¸ºç©º,è¯»å–å°†è¢«é˜»å¡ç›´åˆ°æœ‰æ•°æ®åˆ°è¾¾.  æ‰€ä»¥ &lt;-subDone ä¼šä¸€ç›´é˜»å¡, ç›´åˆ°é€šè¿‡subDone &lt;- trueå‘å…¶ä¸­å†™å…¥äº†æ•°æ®  ä½¿ç”¨2ä¸ªåç¨‹ä¸Šé¢çš„ä¾‹å­ä¸­, sub(1000000, done)æ˜¯åœ¨æ–°çš„åç¨‹ä¸­è¿è¡Œçš„, add(1000000)å´ä¸æ˜¯, å¦‚æœä»–ä»¬éƒ½åœ¨æ–°åç¨‹ä¸­è¿è¡Œ, ä¸»ç¨‹åºåº”è¯¥å¦‚ä½•ç­‰å¾…ä»–ä»¬ç»“æŸå‘¢å¾ˆå®¹æ˜“æƒ³åˆ°,  ä½¿ç”¨ä¸¤æ¬¡&lt;-done ä¹Ÿå°±æ˜¯è¯´å‘ä¿¡é“ç´¢è¦ä¸¤ä¸ªè®¡ç®—å®Œæˆçš„æ ‡å¿—, addå’Œ sub    è®¡ç®—å®Œæˆååˆ†åˆ«å‘å…¶ä¸­æ”¾å…¥æ ‡å¿—.package mainimport \"fmt\"var (\tsharedCounter = 0)func add(count int, done chan bool) {\tfor i := 0; i &lt; count; i++ {\t\tsharedCounter++\t}\tfmt.Println(\"add done\")\tdone &lt;- true}func sub(count int, done chan bool) {\tfor i := 0; i &lt; count; i++ {\t\tsharedCounter--\t}\tfmt.Println(\"sub done\")\tdone &lt;- true}func show() {\tfmt.Println(sharedCounter)}func main() {\tdone := make(chan bool)\tgo add(1000000, done)\tgo sub(1000000, done)\t&lt;-done\t&lt;-done\tshow()}ä¸ºäº†æ˜ç¡®çŸ¥é“mainå‡½æ•°çš„ç¡®æ˜¯ç­‰å¾…ä¸¤ä¸ªåç¨‹æ‰§è¡Œå®Œæ¯•äº†çš„, æˆ‘ä»¬åœ¨å…¶ä¸­åŠ å…¥äº†fmt.Println(\"sub done\")è¿™æ ·çš„è¾“å‡ºè¿è¡Œç¨‹åº, å¾—åˆ°add donesub done824933Opps, è™½ç„¶addå’Œsub éƒ½æ‰§è¡Œå®Œæ¯•äº†,ä½†æ˜¯ç»“æœä¸å¯¹(å¹¶ä¸”å¤šæ¬¡è¿è¡Œçš„ç»“æœè¿˜ä¸ç›¸åŒ), æœŸæœ›æ¥æ”¶åº”è¯¥æ˜¯0å†è¿è¡Œä¸€æ¬¡, å¾—åˆ°:sub doneadd done-481342åŸå› æ˜¯addå’Œsubåœ¨äº¤å‰è¯»å–å’Œå†™å…¥sharedCounterè¿™ä¸ªå˜é‡, ä»–ä»¬å…±äº«äº†å˜é‡, ä½†åœ¨è¯»å–å’Œå†™å…¥çš„æ—¶å€™å‡ºç°â€œç«æ€â€ç«æ€æœ‰å¤šä¸ªåç¨‹è¿è¡Œæ—¶, å¯¹äºæ¯ä¸ªåç¨‹è€Œè¨€,å…¶å†…éƒ¨ä»£ç æ—¶é¡ºåºæ‰§è¡Œçš„, ä½†æ— æ³•ç¡®å®šåç¨‹ä¹‹é—´çš„æ‰§è¡Œé¡ºåº, é‚£ä¹ˆå°±è¯´è¿™äº›åç¨‹æ˜¯å¹¶å‘çš„å¦‚æœä¸€æ®µä»£ç æ— è®ºæ˜¯é¡ºåºæ‰§è¡Œè¿˜æ˜¯å¹¶å‘æ‰§è¡Œ,å…¶ç»“æœéƒ½æ˜¯ç¡®å®šçš„,é‚£ä¹ˆè¿™ä¸ªä»£ç å°±æ˜¯å¹¶å‘å®‰å…¨çš„.ç›¸å, å¹¶å‘ä¸å®‰å…¨çš„ä»£ç ,å¯èƒ½ä¼šå‡ºç°æ­»é”,æ´»é”,ç«æ€ç«æ€åˆ™è¡¨ç¤ºä»£ç å¯æ‰§è¡Œ,ä½†å¯èƒ½å‡ºç°ç»“æœä¸ä¸€è‡´(é”™è¯¯ç»“æœ)###è§£å†³æ–¹æ³•1, åˆ©ç”¨ä¿¡é“func main() {\tdone := make(chan bool)\tgo add(1000000, done)\t&lt;-done //1\tgo sub(1000000, done)\t&lt;-done //2\tshow()}åœ¨addæ‰§è¡Œå®Œæ¯•ä¹‹å‰, é¦–å…ˆä¼šå µå¡åœ¨//1å¤„,func add(count int, done chan bool) {\t//....\tdone &lt;- true}addå‡½æ•°æ‰§è¡Œæœ€åä¸€å¥ done &lt;- true  å &lt;-done //1èƒ½å–åˆ°å€¼, æ¥è§¦é˜»å¡. ç„¶åç»§ç»­å¾€ä¸‹æ‰§è¡Œsubå‡½æ•°.è¿™è™½ç„¶èƒ½å¾—åˆ°æ­£ç¡®è¾“å‡º, ä½†, æˆ‘ä»¬å‘ç°, è¿™å®é™…æ˜¯å°†å¹¶è¡Œæ‰§è¡Œä¿®æ”¹æˆäº†ä¸²è¡Œæ‰§è¡Œ.è§£å†³æ–¹æ³•2, åˆ©ç”¨ Mutex æˆ– RWMutexsync.Mutex å¯èƒ½æ˜¯åŒæ­¥åŒ…ä¸­ä½¿ç”¨æœ€å¹¿æ³›çš„åŸè¯­ã€‚å®ƒå…è®¸å¯¹å…±äº«èµ„æºè¿›è¡Œäº’æ–¥ï¼ˆä¸èƒ½åŒæ—¶è®¿é—®).mutex := &amp;sync.Mutex{}mutex.Lock()//.... æ›´æ–°å…±äº«å˜é‡mutex.Unlock()æ³¨æ„: åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æœ‰è¿™ä¹ˆä¸€å¥ â€œValues containing the types defined in this package should not be copied.â€   (â€œåŒ…å«è¿™ä¸ªåŒ…ä¸­å®šä¹‰çš„ç±»å‹çš„å€¼ä¸åº”è¯¥è¢«å¤åˆ¶ã€‚â€) . æˆ‘ä»¬ç›´åˆ°å€¼ä¼ é€’å°±æ˜¯å¤åˆ¶ç„¶åä¼ é€’, æ‰€ä»¥æˆ‘ä»¬ä»£ç ä¸­çš„mutexç”¨çš„æ˜¯å¼•ç”¨ä¼ é€’.package mainimport (\t\"fmt\"\t\"sync\")var (\tsharedCounter = 0\tmutex         = &amp;sync.Mutex{})func add(count int, done chan bool) {\tfor i := 0; i &lt; count; i++ {\t\tmutex.Lock()\t\tsharedCounter++\t\tmutex.Unlock()\t}\tfmt.Println(\"add done\")\tdone &lt;- true}func sub(count int, done chan bool) {\tfor i := 0; i &lt; count; i++ {\t\tmutex.Lock()\t\tsharedCounter--\t\tmutex.Unlock()\t}\tfmt.Println(\"sub done\")\tdone &lt;- true}func show() {\tfmt.Println(sharedCounter)}func main() {\tdone := make(chan bool)\tgo add(1000000, done)\tgo sub(1000000, done)\t&lt;-done\t&lt;-done\tshow()}åœ¨è¯»å†™sharedCounterä¹‹å‰å…ˆLock(), ç”¨å®ŒåUnlock()å¦‚æœæˆ‘ä»¬åœ¨è¿›è¡Œè®¡ç®—çš„æ—¶å€™åŠ ä¸Šç‚¹æ‰“å°(ä»…æµ‹è¯•ç”¨,éå¸¸å½±å“é€Ÿåº¦)for i := 0; i &lt; count; i++ {\t\tmutex.Lock()\t\tfmt.Println(\"--\") // fmt.Println(\"++\")\t\tsharedCounter--   // sharedCounter++\t\tmutex.Unlock()\t}åˆ™å¯ä»¥çœ‹åˆ° ++ å’Œ â€“ æ˜¯äº¤å‰ç€æ‰“å°çš„, è¯´æ˜æ˜¯å¹¶è¡Œæ‰§è¡Œçš„.å¦å¤–, è¿˜æœ‰RWMutex (è¯»å†™é”), é™¤äº†ä¸Mutexç›¸åŒçš„Lock()å’ŒUnlock()æ–¹æ³•å¤–,  å…¶è¿˜æœ‰ç”¨äºå…±äº«è¯»æ“ä½œçš„RLock()å’ŒRUnlock(), åœ¨è¯»å–å…±äº«å˜é‡æ—¶å…è®¸åŒæ—¶å¤šä¸ªè¯»å–å™¨èƒ½æé«˜æ•ˆç‡.  æ‰€ä»¥åœ¨é¢‘ç¹è¯»å†™æ“ä½œçš„ä»£ç ä¸­, ä½¿ç”¨RWMutexæ•ˆç‡è¦æ¯”Mutexé«˜è§£å†³æ–¹æ³•3, åˆ©ç”¨åŸå­æ“ä½œåŸå­æ“ä½œåœ¨\"sync/atomic\"åŒ…ä¸­. åˆ©ç”¨è¿™ä¸ªåŒ…ä¸­æä¾›çš„å‡½æ•°å¯å®ç°â€æ— é”ç‰ˆâ€çš„å…±äº«å˜é‡è¯»å†™åŸå­æ“ä½œå³æ˜¯è¿›è¡Œè¿‡ç¨‹ä¸­ä¸èƒ½è¢«ä¸­æ–­çš„æ“ä½œï¼Œé’ˆå¯¹æŸä¸ªå€¼çš„åŸå­æ“ä½œåœ¨è¢«è¿›è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒCPUç»ä¸ä¼šå†å»è¿›è¡Œå…¶ä»–çš„é’ˆå¯¹è¯¥å€¼çš„æ“ä½œã€‚ä¸ºäº†å®ç°è¿™æ ·çš„ä¸¥è°¨æ€§ï¼ŒåŸå­æ“ä½œä»…ä¼šç”±ä¸€ä¸ªç‹¬ç«‹çš„CPUæŒ‡ä»¤ä»£è¡¨å’Œå®Œæˆã€‚åŸå­æ“ä½œæ˜¯æ— é”çš„ï¼Œå¸¸å¸¸ç›´æ¥é€šè¿‡CPUæŒ‡ä»¤ç›´æ¥å®ç°ã€‚ äº‹å®ä¸Šï¼Œå…¶å®ƒåŒæ­¥æŠ€æœ¯çš„å®ç°å¸¸å¸¸ä¾èµ–äºåŸå­æ“ä½œpackage mainimport (\t\"fmt\"\t\"sync/atomic\")var (\tsharedCounter = int64(0))func add(count int, done chan bool) {\tfor i := 0; i &lt; count; i++ {\t\tatomic.AddInt64(&amp;sharedCounter, 1) //\t}\tfmt.Println(\"add done\")\tdone &lt;- true}func sub(count int, done chan bool) {\tfor i := 0; i &lt; count; i++ {\t\tatomic.AddInt64(&amp;sharedCounter, -1) //\t}\tfmt.Println(\"sub done\")\tdone &lt;- true}func show() {\tfmt.Println(sharedCounter)}func main() {\tdone := make(chan bool)\tgo add(1000000, done)\tgo sub(1000000, done)\t&lt;-done\t&lt;-done\tshow()}åŸå­æ“ä½œçš„å¸¸ç”¨æ¥å£å¦‚ä¸‹(ä»¥int32ä¸ºä¾‹)//å°†addræŒ‡å‘çš„å€¼å’Œoldè¿›è¡Œæ¯”è¾ƒ, å¦‚æœç›¸ç­‰,åˆ™å°†newèµ‹å€¼åˆ°addræŒ‡å‘çš„ä½ç½®,å¹¶è¿”å›true, å¦‚æœä¸ç›¸ç­‰,åˆ™ç›´æ¥è¿”å›falsefunc CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool)//ä½¿ç”¨åŸå­æ“ä½œ,å°†addræŒ‡å‘çš„ä½ç½®å¢åŠ ä¸€ä¸ªdeltafunc AddInt32(addr *int32, delta int32) (new int32)//åŸå­è¯»å–//å½“æˆ‘ä»¬è¦è¯»å–ä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œå¾ˆæœ‰å¯èƒ½è¿™ä¸ªå˜é‡æ­£åœ¨è¢«å†™å…¥ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¾ˆæœ‰å¯èƒ½è¯»å–åˆ°å†™åˆ°ä¸€åŠçš„æ•°æ®ã€‚ æ‰€ä»¥è¯»å–æ“ä½œæ˜¯éœ€è¦ä¸€ä¸ªåŸå­è¡Œä¸ºçš„ã€‚func LoadInt32(addr *int32) (val int32)//è¯»å–æ˜¯æœ‰åŸå­æ€§çš„æ“ä½œçš„ï¼ŒåŒæ ·å†™å…¥atomicåŒ…ä¹Ÿæä¾›äº†ç›¸å…³çš„æ“ä½œåŒ…func StoreInt32(addr *int32, val int32)//æ­¤ç±»å‹çš„å€¼ç›¸å½“äºä¸€ä¸ªå®¹å™¨ï¼Œå¯ä»¥è¢«ç”¨æ¥â€œåŸå­åœ°\"å­˜å‚¨ï¼ˆStoreï¼‰å’ŒåŠ è½½ï¼ˆLoadï¼‰ä»»æ„ç±»å‹çš„å€¼ã€‚å½“ç„¶è¿™ä¸ªç±»å‹ä¹Ÿæ˜¯åŸå­æ€§çš„ã€‚//æœ‰äº†atomic.Valueè¿™ä¸ªç±»å‹ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥åœ¨ä¸ä¾èµ–Goå†…éƒ¨ç±»å‹unsafe.Pointerçš„æƒ…å†µä¸‹ä½¿ç”¨åˆ°atomicæä¾›çš„åŸå­æ“ä½œã€‚// A Value must not be copied after first use.type Value struct {\tv interface{}}  åŸå­æ“ä½œä¸äº’æ–¥é”çš„åŒºåˆ«  é¦–å…ˆatomicæ“ä½œçš„ä¼˜åŠ¿æ˜¯æ›´è½»é‡ï¼Œæ¯”å¦‚CASå¯ä»¥åœ¨ä¸å½¢æˆä¸´ç•ŒåŒºå’Œåˆ›å»ºäº’æ–¥é‡çš„æƒ…å†µä¸‹å®Œæˆå¹¶å‘å®‰å…¨çš„å€¼æ›¿æ¢æ“ä½œã€‚è¿™å¯ä»¥å¤§å¤§çš„å‡å°‘åŒæ­¥å¯¹ç¨‹åºæ€§èƒ½çš„æŸè€—ã€‚  åŸå­æ“ä½œä¹Ÿæœ‰åŠ£åŠ¿ã€‚è¿˜æ˜¯ä»¥CASæ“ä½œä¸ºä¾‹ï¼Œä½¿ç”¨CASæ“ä½œçš„åšæ³•è¶‹äºä¹è§‚ï¼Œæ€»æ˜¯å‡è®¾è¢«æ“ä½œå€¼æœªæ›¾è¢«æ”¹å˜ï¼ˆå³ä¸æ—§å€¼ç›¸ç­‰ï¼‰ï¼Œå¹¶ä¸€æ—¦ç¡®è®¤è¿™ä¸ªå‡è®¾çš„çœŸå®æ€§å°±ç«‹å³è¿›è¡Œå€¼æ›¿æ¢ï¼Œé‚£ä¹ˆåœ¨è¢«æ“ä½œå€¼è¢«é¢‘ç¹å˜æ›´çš„æƒ…å†µä¸‹ï¼ŒCASæ“ä½œå¹¶ä¸é‚£ä¹ˆå®¹æ˜“æˆåŠŸã€‚è€Œä½¿ç”¨äº’æ–¥é”çš„åšæ³•åˆ™è¶‹äºæ‚²è§‚ï¼Œæˆ‘ä»¬æ€»å‡è®¾ä¼šæœ‰å¹¶å‘çš„æ“ä½œè¦ä¿®æ”¹è¢«æ“ä½œçš„å€¼ï¼Œå¹¶ä½¿ç”¨é”å°†ç›¸å…³æ“ä½œæ”¾å…¥ä¸´ç•ŒåŒºä¸­åŠ ä»¥ä¿æŠ¤ã€‚  ä¸‹é¢æ˜¯å‡ ç‚¹åŒºåˆ«ï¼š      äº’æ–¥é”æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œç”¨æ¥è®©ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç¨‹åºçš„å…³é”®éƒ¨åˆ†ï¼Œå®Œæˆäº’æ–¥çš„å¤šä¸ªæ“ä½œ    åŸå­æ“ä½œæ˜¯æ— é”çš„ï¼Œå¸¸å¸¸ç›´æ¥é€šè¿‡CPUæŒ‡ä»¤ç›´æ¥å®ç°    åŸå­æ“ä½œä¸­çš„casè¶‹äºä¹è§‚é”ï¼ŒCASæ“ä½œå¹¶ä¸é‚£ä¹ˆå®¹æ˜“æˆåŠŸï¼Œéœ€è¦åˆ¤æ–­ï¼Œç„¶åå°è¯•å¤„ç†    å¯ä»¥æŠŠäº’æ–¥é”ç†è§£ä¸ºæ‚²è§‚é”ï¼Œå…±äº«èµ„æºæ¯æ¬¡åªç»™ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œå…¶å®ƒçº¿ç¨‹é˜»å¡ï¼Œç”¨å®Œåå†æŠŠèµ„æºè½¬è®©ç»™å…¶å®ƒçº¿ç¨‹    ä¸è¦è½»æ˜“ä½¿ç”¨atomic  https://texlution.com/post/golang-lock-free-values-with-atomic-value/å…¶å®ƒå¹¶å‘æ§åˆ¶æ–¹æ³•ä¸Šé¢çš„ä¾‹å­ä¸­, æˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨çš„ä¿¡é“æ¥è¿›è¡Œå¹¶å‘æ§åˆ¶ (done &lt;- trueä¸&lt;-done), è¿™åªæ˜¯å¸¸ç”¨çš„æ–¹æ³•ä¹‹ä¸€WaitGroupsync.WaitGroup æ‹¥æœ‰ä¸€ä¸ªå†…éƒ¨è®¡æ•°å™¨ã€‚å¦‚æœæ­¤è®¡æ•°å™¨ç­‰äº 0ï¼Œåˆ™ Wait() æ–¹æ³•ç«‹å³è¿”å›ã€‚å¦åˆ™ï¼Œå®ƒå°†è¢«é˜»å¡ï¼Œç›´åˆ°è®¡æ•°å™¨ä¸º 0ã€‚è¦å¢åŠ è®¡æ•°å™¨ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨ Add(int)ã€‚è¦å‡å°‘å®ƒï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Done() ï¼ˆå°†å‡å°‘ 1ï¼‰æˆ–å…·æœ‰è´Ÿå€¼çš„ç›¸åŒ Add(int) æ–¹æ³•ã€‚package mainimport (   \"fmt\"   \"sync\"   \"sync/atomic\")var (   sharedCounter = int64(0))func add(count int, wg *sync.WaitGroup) {   for i := 0; i &lt; count; i++ {      atomic.AddInt64(&amp;sharedCounter, 1)   }   fmt.Println(\"add done\")   wg.Done()}func sub(count int, wg *sync.WaitGroup) {   for i := 0; i &lt; count; i++ {      atomic.AddInt64(&amp;sharedCounter, -1)   }   fmt.Println(\"sub done\")   wg.Done()}func show() {   fmt.Println(sharedCounter)}func main() {   wg := sync.WaitGroup{}   wg.Add(2)   go add(1000000, &amp;wg)   go sub(1000000, &amp;wg)   wg.Wait()   show()}æ³¨æ„:ä¼ é€’ WaitGroupæ—¶è¦ä½¿ç”¨å¼•ç”¨ä¼ é€’(æŒ‡é’ˆ), å…¶ä¸åº”è¯¥è¢«å¤åˆ¶. func sub(count int, wg *sync.WaitGroup)context.ContextContextæä¾›äº†2ä¸ªåŠŸèƒ½  æ§åˆ¶å­åç¨‹ç»“æŸ  ä¼ é€’å€¼å…¶ä¸åœ¨syncåŒ…ä¸­, åé¢ä¸“é—¨è®²sync.Pool å¯¹è±¡å¤ç”¨å…¶æä¾›ä¸€ä¸ªâ€å¹¶å‘å®‰å…¨â€çš„å¯å¤ç”¨çš„å¯¹è±¡æ± . ç”¨æ¥å‡å°‘é¢‘ç¹GCæ‰€ä»£ç†çš„å‹åŠ›.å…¶å¤§æ¦‚æ„æ€æ˜¯: å¦‚æœæœ‰æ—§å¯¹è±¡å¯ç”¨,åˆ™ç”¨æ—§çš„, æ²¡æœ‰å†Newä¸€ä¸ªå‚è€ƒè¿™æ‰¹æ–‡ç« : https://www.cnblogs.com/qcrao-2018/p/12736031.htmlä»¥åŠè¿™é‡Œ https://geektutu.com/post/hpg-sync-pool.htmlåœ¨å®é™…å¼€å‘å·¥ä½œä¸­, ä¸è¦ä¸€ä¸Šæ¥å°±æƒ³åšä½¿ç”¨sync.Poolå®ƒé€šå¸¸ä¼šå¸¦æ¥é—®é¢˜(å› ä¸ºå…¶Getå‡ºæ¥çš„å¯¹è±¡çš„çŠ¶æ€æ˜¯ä¸ç¡®å®šçš„), è€Œåº”è¯¥éµå¾ªä¸‹é¢çš„åŸåˆ™:  æ ¹æ®ä½ æ”¶é›†åˆ°çš„éœ€æ±‚è®¾è®¡ä½ çš„ä»£ç ï¼ˆä¸è¦è·³è¿‡è¿™ä¸ªæ­¥éª¤ï¼‰ã€‚  ç¼–å†™æœ€ç®€å•ã€æœ€æ¸…æ™°ã€æœ€æ„šè ¢çš„è®¾è®¡å®ç°ã€‚  å¦‚æœå®¢æˆ·æ»¡æ„ï¼Œå°±åœæ­¢  å¦‚æœå®¢æˆ·ä¸æ»¡æ„ï¼Œè€Œä¸”ä»–ä»¬è®¤ä¸ºåº”ç”¨ç¨‹åºçš„æ€§èƒ½ä¸èƒ½æ»¡è¶³ä»–ä»¬çš„è¦æ±‚ï¼Œé‚£ä¹ˆå°±å‰–æã€‚  è§£å†³æœ€é«˜æ€§èƒ½çš„ä¸»å¯¼è€…  å‰–æå¹¶è¿›å…¥ç¬¬äº”é˜¶æ®µã€‚ç„¶åè¿›å…¥3  å¦‚æœå®åœ¨æä¸å®š, å†æƒ³æƒ³sync.Poolsync.Once åªæ‰§è¡Œä¸€æ¬¡sync.Once æä¾›äº†ä¸€ç§æ–¹æ³•, è®©ç›¸å…³ä»£ç åªè¢«æ‰§è¡Œä¸€æ¬¡å®é™…å¼€å‘è¿‡ç¨‹ä¸­, ç»å¸¸æœ‰è¿™æ ·çš„åœºæ™¯: ä½ åšäº†ä¸€ä¸ªå«åšlowLevelApiçš„åŒ…, ç”¨äºæ§åˆ¶åº•å±‚è®¾å¤‡, æ¯”å¦‚å¼€å…³LED,  ä½†åœ¨è°ƒç”¨å¼€å…³LEDä¹‹å‰éœ€è¦ç¡®ä¿ä¸€äº›åˆå§‹åŒ–å·¥ä½œå·²ç»å®Œæˆ, æ‰€ä»¥ä½ å†™äº†ä¸€ä¸ªInitEnvçš„å‡½æ•°, å¹¶å‘Šè¯‰å…¶å®ƒå¼€å‘äººå‘˜: ä¸€å®šè¦å…ˆåˆå§‹åŒ–å“¦.package lowLevelApiimport \"fmt\"func InitEnv() {\tfmt.Println(\"init environment\")}func LedOn() {\tfmt.Println(\"LedOn\")}func LedOff() {\tfmt.Println(\"LedOff\")}å…¶å®ƒå¼€å‘äººå‘˜ç»å¸¸ä¼šé—®ä½ : è¿™ä¸ªåˆå§‹åŒ–å‡½æ•°å¦‚æœè¢«é‡å¤è°ƒç”¨ä¸ä¼šå‡ºé—®é¢˜å§?å› ä¸ºä»–ä»¬çš„ä»£ç é€šå¸¸ä¼šè¿™æ ·å†™:package mainimport (\t\"fmt\"\t\"goplayground/lowLevelApi\")func turnLedOn() {\tfmt.Println(\"Turning LED on\")\tlowLevelApi.InitEnv()\tlowLevelApi.LedOn()\tfmt.Println(\"LED on\")}func turnLedOff() {\tfmt.Println(\"Turning LED off\")\tlowLevelApi.InitEnv()\tlowLevelApi.LedOff()\tfmt.Println(\"LED off\")}func main() {\tturnLedOn()\tturnLedOff()}ä¸Šé¢çš„ä»£ç ä¼šè¾“å‡ºTurning LED onInitEnvLedOnLED onTurning LED offInitEnvLedOffLED offä¸ºäº†é˜²æ­¢é‡å¤è°ƒç”¨InitEnv()å¯èƒ½å¸¦æ¥çš„é—®é¢˜, åˆ™å¯ä»¥ä½¿ç”¨sync.Oncevar (\tonce sync.Once)func InitEnv() {\tonce.Do(func() {\t\tfmt.Println(\"InitEnv\")\t})}è¿™æ ·InitEnv()å³ä½¿è¢«å¤šæ¬¡è°ƒç”¨, å…¶å†…éƒ¨é€»è¾‘åªä¼šæ‰§è¡Œä¸€æ¬¡Turning LED onInitEnvLedOnLED onTurning LED offLedOffLED offsync.Once å¸¸åº”ç”¨äºå•ä¾‹æ¨¡å¼ï¼Œä¾‹å¦‚åˆå§‹åŒ–é…ç½®ã€ä¿æŒæ•°æ®åº“è¿æ¥ç­‰ã€‚ä½œç”¨ä¸ init å‡½æ•°ç±»ä¼¼ï¼Œä½†æœ‰åŒºåˆ«ã€‚  init å‡½æ•°æ˜¯å½“æ‰€åœ¨çš„ package é¦–æ¬¡è¢«åŠ è½½æ—¶æ‰§è¡Œï¼Œè‹¥è¿Ÿè¿Ÿæœªè¢«ä½¿ç”¨ï¼Œåˆ™æ—¢æµªè´¹äº†å†…å­˜ï¼Œåˆå»¶é•¿äº†ç¨‹åºåŠ è½½æ—¶é—´ã€‚  sync.Once å¯ä»¥åœ¨ä»£ç çš„ä»»æ„ä½ç½®åˆå§‹åŒ–å’Œè°ƒç”¨ï¼Œå› æ­¤å¯ä»¥å»¶è¿Ÿåˆ°ä½¿ç”¨æ—¶å†æ‰§è¡Œï¼Œå¹¶å‘åœºæ™¯ä¸‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚sync.Cond æ¡ä»¶å˜é‡sync.Cond ç”¨äºåè°ƒå¤šä¸ªåç¨‹è®¿é—®å…±äº«èµ„æº, å…¶ä¸­æŸäº›åç¨‹å¤„äºé˜»å¡çŠ¶æ€, å¦å¤–ä¸€ä¸ªåç¨‹åœ¨æ¡ä»¶å‡†å¤‡å¥½çš„æ—¶å€™æ¥è®²å…¶å®ƒåç¨‹å”¤é†’.ä¸‹é¢çš„ä¾‹å­ä¸­ InitEnvå‡½æ•°éœ€è¦ä¸€ç‚¹æ—¶é—´åœ¨å‡†å¤‡sharedCounter çš„åˆå§‹å€¼, åœ¨è¿™æœŸé—´Addå’Œsubå¤„äºWaitçŠ¶æ€,  å½“å‡†å¤‡å¥½å, å°†é€šçŸ¥ Addå’ŒSubç»§ç»­å‘ä¸‹æ‰§è¡Œpackage mainimport (\t\"fmt\"\t\"sync\"\t\"time\")var (\tsharedCounter int)func InitEnv(c *sync.Cond) {\tfmt.Println(\"begin InitEnv\")\ttime.Sleep(time.Second * 1)\tc.L.Lock()\tsharedCounter = 10\tc.L.Unlock()\tfmt.Println(\"Init Env Done, broadcast...\")\tc.Broadcast()}func Add(cout int, c *sync.Cond) {\tc.L.Lock()\tc.Wait()\tsharedCounter += cout\tc.L.Unlock()\tfmt.Println(\"Add Done\")}func Sub(count int, c *sync.Cond) {\tc.L.Lock()\tc.Wait()\tsharedCounter -= count\tc.L.Unlock()\tfmt.Println(\"Sub Done\")}func main() {\tcond := sync.NewCond(&amp;sync.Mutex{})\tgo InitEnv(cond)\tgo Add(5, cond)\tgo Sub(2, cond)\ttime.Sleep(2 * time.Second)\tfmt.Println(\"Final Counter:\", sharedCounter)}è¾“å‡ºbegin InitEnvInit Env Done, broadcast...Add DoneSub DoneFinal Counter: 13c.Broadcast()å”¤é†’æ‰€æœ‰ç­‰å¾…çš„åç¨‹,   å¦å¤–è¿˜æœ‰ä¸€ä¸ªSignal()æ–¹æ³•, ç”¨äºå”¤é†’ä¸€ä¸ªåç¨‹.  sync.Condä¸€èˆ¬ç”¨äºä¸€å¯¹å¤šçš„æƒ…å†µ, å¦‚æœæ˜¯ä¸€å¯¹ä¸€çš„æƒ…å†µ, ç”¨ä¸€ä¸ªä¿¡é“å°±å¯ä»¥è½»æ¾è§£å†³äº†sync.Mapå†…ç½®çš„mapä¸æ˜¯å¹¶å‘å®‰å…¨çš„, æ‰€ä»¥ sync.Map æä¾›äº†ä¸€ä¸ªåŠŸèƒ½ä¸mapç±»ä¼¼ä½†æ˜¯å¹¶å‘å®‰å…¨çš„ç‰ˆæœ¬å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç«   https://juejin.cn/post/6844903895227957262"
  }
  
]

